<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="generator" content="ApiGen 2.6.1" />
	<meta name="robots" content="noindex" />

	<title>File inc/functions.php</title>

	<script type="text/javascript" src="resources/combined.js?144019575"></script>
	<script type="text/javascript" src="elementlist.js?322722881"></script>
	<link rel="stylesheet" type="text/css" media="all" href="resources/style.css?1532301413" />

</head>

<body>
<div id="left">
	<div id="menu">
		<a href="index.html" title="Overview"><span>Overview</span></a>


		<div id="groups">
		</div>



		<div id="elements">
			<h3>Classes</h3>
			<ul>
				<li><a href="class-Akismet.html">Akismet</a></li>
				<li><a href="class-bitwise.html">bitwise</a></li>
				<li><a href="class-captcha.html">captcha</a></li>
				<li><a href="class-CustomModeration.html">CustomModeration</a></li>
				<li><a href="class-datacache.html">datacache</a></li>
				<li><a href="class-DataHandler.html">DataHandler</a></li>
				<li><a href="class-DB_MySQL.html">DB_MySQL</a></li>
				<li><a href="class-DB_MySQLi.html">DB_MySQLi</a></li>
				<li><a href="class-DB_PgSQL.html">DB_PgSQL</a></li>
				<li><a href="class-DB_SQLite.html">DB_SQLite</a></li>
				<li><a href="class-dbpdoEngine.html">dbpdoEngine</a></li>
				<li><a href="class-DefaultForm.html">DefaultForm</a></li>
				<li><a href="class-DefaultFormContainer.html">DefaultFormContainer</a></li>
				<li><a href="class-DefaultPage.html">DefaultPage</a></li>
				<li><a href="class-DefaultPopupMenu.html">DefaultPopupMenu</a></li>
				<li><a href="class-DefaultSidebarItem.html">DefaultSidebarItem</a></li>
				<li><a href="class-DefaultTable.html">DefaultTable</a></li>
				<li><a href="class-diskCacheHandler.html">diskCacheHandler</a></li>
				<li><a href="class-eacceleratorCacheHandler.html">eacceleratorCacheHandler</a></li>
				<li><a href="class-errorHandler.html">errorHandler</a></li>
				<li><a href="class-EventDataHandler.html">EventDataHandler</a></li>
				<li><a href="class-FeedGenerator.html">FeedGenerator</a></li>
				<li><a href="class-FeedParser.html">FeedParser</a></li>
				<li><a href="class-Form.html" class="invalid">Form</a></li>
				<li><a href="class-FormContainer.html" class="invalid">FormContainer</a></li>
				<li><a href="class-Graph.html">Graph</a></li>
				<li><a href="class-installerOutput.html">installerOutput</a></li>
				<li><a href="class-MailHandler.html">MailHandler</a></li>
				<li><a href="class-memcacheCacheHandler.html">memcacheCacheHandler</a></li>
				<li><a href="class-Moderation.html">Moderation</a></li>
				<li><a href="class-MyBB.html">MyBB</a></li>
				<li><a href="class-MyLanguage.html">MyLanguage</a></li>
				<li><a href="class-Page.html" class="invalid">Page</a></li>
				<li><a href="class-PhpMail.html">PhpMail</a></li>
				<li><a href="class-pluginSystem.html">pluginSystem</a></li>
				<li><a href="class-PMDataHandler.html">PMDataHandler</a></li>
				<li><a href="class-PopupMenu.html" class="invalid">PopupMenu</a></li>
				<li><a href="class-PostDataHandler.html">PostDataHandler</a></li>
				<li><a href="class-postParser.html">postParser</a></li>
				<li><a href="class-session.html">session</a></li>
				<li><a href="class-SidebarItem.html" class="invalid">SidebarItem</a></li>
				<li><a href="class-SmtpMail.html">SmtpMail</a></li>
				<li><a href="class-Table.html" class="invalid">Table</a></li>
				<li><a href="class-templates.html">templates</a></li>
				<li><a href="class-Text_Diff.html">Text_Diff</a></li>
				<li><a href="class-Text_Diff3.html">Text_Diff3</a></li>
				<li><a href="class-Text_Diff3_BlockBuilder.html">Text_Diff3_BlockBuilder</a></li>
				<li><a href="class-Text_Diff3_Op.html">Text_Diff3_Op</a></li>
				<li><a href="class-Text_Diff3_Op_copy.html">Text_Diff3_Op_copy</a></li>
				<li><a href="class-Text_Diff_Engine_native.html">Text_Diff_Engine_native</a></li>
				<li><a href="class-Text_Diff_Engine_shell.html">Text_Diff_Engine_shell</a></li>
				<li><a href="class-Text_Diff_Engine_string.html">Text_Diff_Engine_string</a></li>
				<li><a href="class-Text_Diff_Engine_xdiff.html">Text_Diff_Engine_xdiff</a></li>
				<li><a href="class-Text_Diff_Mapped.html">Text_Diff_Mapped</a></li>
				<li><a href="class-Text_Diff_Op.html">Text_Diff_Op</a></li>
				<li><a href="class-Text_Diff_Op_add.html">Text_Diff_Op_add</a></li>
				<li><a href="class-Text_Diff_Op_change.html">Text_Diff_Op_change</a></li>
				<li><a href="class-Text_Diff_Op_copy.html">Text_Diff_Op_copy</a></li>
				<li><a href="class-Text_Diff_Op_delete.html">Text_Diff_Op_delete</a></li>
				<li><a href="class-Text_Diff_Renderer.html">Text_Diff_Renderer</a></li>
				<li><a href="class-Text_Diff_Renderer_inline.html">Text_Diff_Renderer_inline</a></li>
				<li><a href="class-Text_Diff_Renderer_unified.html">Text_Diff_Renderer_unified</a></li>
				<li><a href="class-Text_Diff_ThreeWay.html">Text_Diff_ThreeWay</a></li>
				<li><a href="class-Text_Diff_ThreeWay_BlockBuilder.html">Text_Diff_ThreeWay_BlockBuilder</a></li>
				<li><a href="class-Text_Diff_ThreeWay_Op.html">Text_Diff_ThreeWay_Op</a></li>
				<li><a href="class-Text_Diff_ThreeWay_Op_copy.html">Text_Diff_ThreeWay_Op_copy</a></li>
				<li><a href="class-Text_MappedDiff.html">Text_MappedDiff</a></li>
				<li><a href="class-timer.html">timer</a></li>
				<li><a href="class-UserDataHandler.html">UserDataHandler</a></li>
				<li><a href="class-xcacheCacheHandler.html">xcacheCacheHandler</a></li>
				<li><a href="class-XMLParser.html">XMLParser</a></li>
			</ul>





			<h3>Functions</h3>
			<ul>
				<li><a href="function-_adodb_getdate.html">_adodb_getdate</a></li>
				<li><a href="function-_adodb_is_leap_year.html">_adodb_is_leap_year</a></li>
				<li><a href="function-acp_rebuild_attachment_thumbnails.html">acp_rebuild_attachment_thumbnails</a></li>
				<li><a href="function-acp_rebuild_forum_counters.html">acp_rebuild_forum_counters</a></li>
				<li><a href="function-acp_rebuild_thread_counters.html">acp_rebuild_thread_counters</a></li>
				<li><a href="function-acp_recount_user_posts.html">acp_recount_user_posts</a></li>
				<li><a href="function-add_breadcrumb.html">add_breadcrumb</a></li>
				<li><a href="function-add_shutdown.html">add_shutdown</a></li>
				<li><a href="function-add_subscribed_forum.html">add_subscribed_forum</a></li>
				<li><a href="function-add_subscribed_thread.html">add_subscribed_thread</a></li>
				<li><a href="function-add_task_log.html">add_task_log</a></li>
				<li><a href="function-admin_redirect.html">admin_redirect</a></li>
				<li><a href="function-adodb_date.html">adodb_date</a></li>
				<li><a href="function-adodb_date2.html">adodb_date2</a></li>
				<li><a href="function-adodb_dow.html">adodb_dow</a></li>
				<li><a href="function-adodb_get_gmt_diff.html">adodb_get_gmt_diff</a></li>
				<li><a href="function-adodb_get_gmt_diff_ts.html">adodb_get_gmt_diff_ts</a></li>
				<li><a href="function-adodb_getdate.html">adodb_getdate</a></li>
				<li><a href="function-adodb_gmdate.html">adodb_gmdate</a></li>
				<li><a href="function-adodb_gmmktime.html">adodb_gmmktime</a></li>
				<li><a href="function-adodb_gmstrftime.html">adodb_gmstrftime</a></li>
				<li><a href="function-adodb_is_leap_year.html">adodb_is_leap_year</a></li>
				<li><a href="function-adodb_mktime.html">adodb_mktime</a></li>
				<li><a href="function-adodb_strftime.html">adodb_strftime</a></li>
				<li><a href="function-adodb_tz_offset.html">adodb_tz_offset</a></li>
				<li><a href="function-adodb_year_digit_check.html">adodb_year_digit_check</a></li>
				<li><a href="function-akismet_action_handler.html">akismet_action_handler</a></li>
				<li><a href="function-akismet_activate.html">akismet_activate</a></li>
				<li><a href="function-akismet_admin.html">akismet_admin</a></li>
				<li><a href="function-akismet_admin_nav.html">akismet_admin_nav</a></li>
				<li><a href="function-akismet_admin_permissions.html">akismet_admin_permissions</a></li>
				<li><a href="function-akismet_deactivate.html">akismet_deactivate</a></li>
				<li><a href="function-akismet_fake_draft.html">akismet_fake_draft</a></li>
				<li><a href="function-akismet_info.html">akismet_info</a></li>
				<li><a href="function-akismet_install.html">akismet_install</a></li>
				<li><a href="function-akismet_is_installed.html">akismet_is_installed</a></li>
				<li><a href="function-akismet_key.html">akismet_key</a></li>
				<li><a href="function-akismet_moderation_start.html">akismet_moderation_start</a></li>
				<li><a href="function-akismet_postbit.html">akismet_postbit</a></li>
				<li><a href="function-akismet_redirect_forum.html">akismet_redirect_forum</a></li>
				<li><a href="function-akismet_redirect_thread.html">akismet_redirect_thread</a></li>
				<li><a href="function-akismet_show_confirm_page.html">akismet_show_confirm_page</a></li>
				<li><a href="function-akismet_uninstall.html">akismet_uninstall</a></li>
				<li><a href="function-akismet_verify.html">akismet_verify</a></li>
				<li><a href="function-alt_trow.html">alt_trow</a></li>
				<li><a href="function-archive_error.html">archive_error</a></li>
				<li><a href="function-archive_error_no_permission.html">archive_error_no_permission</a></li>
				<li><a href="function-archive_footer.html">archive_footer</a></li>
				<li><a href="function-archive_header.html">archive_header</a></li>
				<li><a href="function-archive_multipage.html">archive_multipage</a></li>
				<li><a href="function-archive_navigation.html">archive_navigation</a></li>
				<li><a href="function-ban_date2timestamp.html">ban_date2timestamp</a></li>
				<li><a href="function-build_archive_link.html">build_archive_link</a></li>
				<li><a href="function-build_breadcrumb.html">build_breadcrumb</a></li>
				<li><a href="function-build_calendar_jump.html">build_calendar_jump</a></li>
				<li><a href="function-build_clickable_smilies.html">build_clickable_smilies</a></li>
				<li><a href="function-build_forum_breadcrumb.html">build_forum_breadcrumb</a></li>
				<li><a href="function-build_forum_jump.html">build_forum_jump</a></li>
				<li><a href="function-build_forumbits.html">build_forumbits</a></li>
				<li><a href="function-build_friendly_wol_location.html">build_friendly_wol_location</a></li>
				<li><a href="function-build_highlight_array.html">build_highlight_array</a></li>
				<li><a href="function-build_mass_mail_query.html">build_mass_mail_query</a></li>
				<li><a href="function-build_mini_calendar.html">build_mini_calendar</a></li>
				<li><a href="function-build_mycode_inserter.html">build_mycode_inserter</a></li>
				<li><a href="function-build_new_theme.html">build_new_theme</a></li>
				<li><a href="function-build_next_run_bit.html">build_next_run_bit</a></li>
				<li><a href="function-build_parent_list.html">build_parent_list</a></li>
				<li><a href="function-build_postbit.html">build_postbit</a></li>
				<li><a href="function-build_prefix_select.html">build_prefix_select</a></li>
				<li><a href="function-build_prefixes.html">build_prefixes</a></li>
				<li><a href="function-build_profile_link.html">build_profile_link</a></li>
				<li><a href="function-build_server_stats.html">build_server_stats</a></li>
				<li><a href="function-build_theme_array.html">build_theme_array</a></li>
				<li><a href="function-build_theme_list.html">build_theme_list</a></li>
				<li><a href="function-build_theme_select.html">build_theme_select</a></li>
				<li><a href="function-build_timezone_select.html">build_timezone_select</a></li>
				<li><a href="function-build_wol_row.html">build_wol_row</a></li>
				<li><a href="function-cache_calendars.html">cache_calendars</a></li>
				<li><a href="function-cache_forums.html">cache_forums</a></li>
				<li><a href="function-cache_stylesheet.html">cache_stylesheet</a></li>
				<li><a href="function-cache_themes.html">cache_themes</a></li>
				<li><a href="function-change_admin_permission.html">change_admin_permission</a></li>
				<li><a href="function-check_admin_permissions.html">check_admin_permissions</a></li>
				<li><a href="function-check_forum_password.html">check_forum_password</a></li>
				<li><a href="function-check_forum_password_archive.html">check_forum_password_archive</a></li>
				<li><a href="function-check_proceed.html">check_proceed</a></li>
				<li><a href="function-check_template.html">check_template</a></li>
				<li><a href="function-check_thumbnail_memory.html">check_thumbnail_memory</a></li>
				<li><a href="function-check_time_values.html">check_time_values</a></li>
				<li><a href="function-clean_keywords.html">clean_keywords</a></li>
				<li><a href="function-clean_keywords_ft.html">clean_keywords_ft</a></li>
				<li><a href="function-clear_overflow.html" class="invalid">clear_overflow</a></li>
				<li><a href="function-config_action_handler.html">config_action_handler</a></li>
				<li><a href="function-config_admin_permissions.html">config_admin_permissions</a></li>
				<li><a href="function-config_meta.html">config_meta</a></li>
				<li><a href="function-configure.html">configure</a></li>
				<li><a href="function-convert_through_utf8.html">convert_through_utf8</a></li>
				<li><a href="function-copy_stylesheet_to_theme.html">copy_stylesheet_to_theme</a></li>
				<li><a href="function-create_admin_user.html">create_admin_user</a></li>
				<li><a href="function-create_tables.html">create_tables</a></li>
				<li><a href="function-create_text_message.html">create_text_message</a></li>
				<li><a href="function-css_selectors_sort_cmp.html">css_selectors_sort_cmp</a></li>
				<li><a href="function-css_to_array.html">css_to_array</a></li>
				<li><a href="function-database_info.html">database_info</a></li>
				<li><a href="function-db_connection.html">db_connection</a></li>
				<li><a href="function-debug_page.html">debug_page</a></li>
				<li><a href="function-dec_to_utf8.html">dec_to_utf8</a></li>
				<li><a href="function-delete_post.html">delete_post</a></li>
				<li><a href="function-delete_thread.html">delete_thread</a></li>
				<li><a href="function-delete_user_posts.html">delete_user_posts</a></li>
				<li><a href="function-draw_admin_pagination.html">draw_admin_pagination</a></li>
				<li><a href="function-draw_circles.html">draw_circles</a></li>
				<li><a href="function-draw_dots.html">draw_dots</a></li>
				<li><a href="function-draw_lines.html">draw_lines</a></li>
				<li><a href="function-draw_squares.html">draw_squares</a></li>
				<li><a href="function-draw_string.html">draw_string</a></li>
				<li><a href="function-email_already_in_use.html">email_already_in_use</a></li>
				<li><a href="function-error.html">error</a></li>
				<li><a href="function-error_list.html">error_list</a></li>
				<li><a href="function-error_no_permission.html">error_no_permission</a></li>
				<li><a href="function-escaped_explode.html">escaped_explode</a></li>
				<li><a href="function-expire_warnings.html">expire_warnings</a></li>
				<li><a href="function-fetch_ban_times.html">fetch_ban_times</a></li>
				<li><a href="function-fetch_calendar_permissions.html">fetch_calendar_permissions</a></li>
				<li><a href="function-fetch_default_view.html">fetch_default_view</a></li>
				<li><a href="function-fetch_first_run_time.html">fetch_first_run_time</a></li>
				<li><a href="function-fetch_forum_announcements.html">fetch_forum_announcements</a></li>
				<li><a href="function-fetch_forum_permissions.html">fetch_forum_permissions</a></li>
				<li><a href="function-fetch_friendly_expiration.html">fetch_friendly_expiration</a></li>
				<li><a href="function-fetch_friendly_repetition.html">fetch_friendly_repetition</a></li>
				<li><a href="function-fetch_iconv_encoding.html">fetch_iconv_encoding</a></li>
				<li><a href="function-fetch_longipv4_range.html">fetch_longipv4_range</a></li>
				<li><a href="function-fetch_next_occurance.html">fetch_next_occurance</a></li>
				<li><a href="function-fetch_next_run.html">fetch_next_run</a></li>
				<li><a href="function-fetch_page_url.html">fetch_page_url</a></li>
				<li><a href="function-fetch_remote_file.html">fetch_remote_file</a></li>
				<li><a href="function-fetch_time_length.html">fetch_time_length</a></li>
				<li><a href="function-fetch_unread_count.html">fetch_unread_count</a></li>
				<li><a href="function-fetch_weekday_monthly_repetition.html">fetch_weekday_monthly_repetition</a></li>
				<li><a href="function-fetch_weekday_name.html">fetch_weekday_name</a></li>
				<li><a href="function-fetch_weekday_structure.html">fetch_weekday_structure</a></li>
				<li><a href="function-fetch_wol_activity.html">fetch_wol_activity</a></li>
				<li><a href="function-find_replace_templatesets.html">find_replace_templatesets</a></li>
				<li><a href="function-fix_css_urls.html">fix_css_urls</a></li>
				<li><a href="function-fix_mktime.html">fix_mktime</a></li>
				<li><a href="function-flash_message.html">flash_message</a></li>
				<li><a href="function-format_bdays.html">format_bdays</a></li>
				<li><a href="function-format_name.html">format_name</a></li>
				<li><a href="function-forum_action_handler.html">forum_action_handler</a></li>
				<li><a href="function-forum_admin_permissions.html">forum_admin_permissions</a></li>
				<li><a href="function-forum_meta.html">forum_meta</a></li>
				<li><a href="function-forum_permissions.html">forum_permissions</a></li>
				<li><a href="function-gd_version.html">gd_version</a></li>
				<li><a href="function-generate_loginkey.html">generate_loginkey</a></li>
				<li><a href="function-generate_post_check.html">generate_post_check</a></li>
				<li><a href="function-generate_salt.html">generate_salt</a></li>
				<li><a href="function-generate_thumbnail.html">generate_thumbnail</a></li>
				<li><a href="function-get_admin_permissions.html">get_admin_permissions</a></li>
				<li><a href="function-get_age.html">get_age</a></li>
				<li><a href="function-get_announcement_link.html">get_announcement_link</a></li>
				<li><a href="function-get_attachment_icon.html">get_attachment_icon</a></li>
				<li><a href="function-get_bdays.html">get_bdays</a></li>
				<li><a href="function-get_birthdays.html">get_birthdays</a></li>
				<li><a href="function-get_calendar_link.html">get_calendar_link</a></li>
				<li><a href="function-get_calendar_permissions.html">get_calendar_permissions</a></li>
				<li><a href="function-get_calendar_week_link.html">get_calendar_week_link</a></li>
				<li><a href="function-get_child_list.html">get_child_list</a></li>
				<li><a href="function-get_colored_warning_level.html">get_colored_warning_level</a></li>
				<li><a href="function-get_css_properties.html">get_css_properties</a></li>
				<li><a href="function-get_current_location.html">get_current_location</a></li>
				<li><a href="function-get_event_date.html">get_event_date</a></li>
				<li><a href="function-get_event_link.html">get_event_link</a></li>
				<li><a href="function-get_event_poster.html">get_event_poster</a></li>
				<li><a href="function-get_events.html">get_events</a></li>
				<li><a href="function-get_extension.html">get_extension</a></li>
				<li><a href="function-get_forum.html">get_forum</a></li>
				<li><a href="function-get_forum_lightbulb.html">get_forum_lightbulb</a></li>
				<li><a href="function-get_forum_link.html">get_forum_link</a></li>
				<li><a href="function-get_forum_unapproved.html">get_forum_unapproved</a></li>
				<li><a href="function-get_friendly_size.html">get_friendly_size</a></li>
				<li><a href="function-get_inactive_forums.html">get_inactive_forums</a></li>
				<li><a href="function-get_ip.html">get_ip</a></li>
				<li><a href="function-get_moderator_permissions.html">get_moderator_permissions</a></li>
				<li><a href="function-get_next_month.html">get_next_month</a></li>
				<li><a href="function-get_parent_list.html">get_parent_list</a></li>
				<li><a href="function-get_password_protected_forums.html">get_password_protected_forums</a></li>
				<li><a href="function-get_pm_folder_name.html">get_pm_folder_name</a></li>
				<li><a href="function-get_post.html">get_post</a></li>
				<li><a href="function-get_post_attachments.html">get_post_attachments</a></li>
				<li><a href="function-get_post_icons.html">get_post_icons</a></li>
				<li><a href="function-get_post_link.html">get_post_link</a></li>
				<li><a href="function-get_prev_month.html">get_prev_month</a></li>
				<li><a href="function-get_profile_link.html">get_profile_link</a></li>
				<li><a href="function-get_reputation.html">get_reputation</a></li>
				<li><a href="function-get_selectors_as_options.html">get_selectors_as_options</a></li>
				<li><a href="function-get_server_load.html">get_server_load</a></li>
				<li><a href="function-get_thread.html">get_thread</a></li>
				<li><a href="function-get_thread_link.html">get_thread_link</a></li>
				<li><a href="function-get_unsearchable_forums.html">get_unsearchable_forums</a></li>
				<li><a href="function-get_unviewable_forums.html">get_unviewable_forums</a></li>
				<li><a href="function-get_user.html">get_user</a></li>
				<li><a href="function-get_usertitle.html">get_usertitle</a></li>
				<li><a href="function-get_weekday.html">get_weekday</a></li>
				<li><a href="function-gzip_encode.html">gzip_encode</a></li>
				<li><a href="function-hello_info.html">hello_info</a></li>
				<li><a href="function-hello_world.html">hello_world</a></li>
				<li><a href="function-hello_world_postbit.html">hello_world_postbit</a></li>
				<li><a href="function-home_action_handler.html">home_action_handler</a></li>
				<li><a href="function-home_meta.html">home_meta</a></li>
				<li><a href="function-htmlspecialchars_uni.html">htmlspecialchars_uni</a></li>
				<li><a href="function-import_theme_xml.html">import_theme_xml</a></li>
				<li><a href="function-inline_error.html">inline_error</a></li>
				<li><a href="function-insert_into_css.html">insert_into_css</a></li>
				<li><a href="function-insert_templates.html">insert_templates</a></li>
				<li><a href="function-install_done.html">install_done</a></li>
				<li><a href="function-intro.html">intro</a></li>
				<li><a href="function-is_banned_email.html">is_banned_email</a></li>
				<li><a href="function-is_banned_ip.html">is_banned_ip</a></li>
				<li><a href="function-is_banned_username.html">is_banned_username</a></li>
				<li><a href="function-is_moderator.html">is_moderator</a></li>
				<li><a href="function-is_super_admin.html">is_super_admin</a></li>
				<li><a href="function-join_usergroup.html">join_usergroup</a></li>
				<li><a href="function-kill_tags.html">kill_tags</a></li>
				<li><a href="function-leave_usergroup.html">leave_usergroup</a></li>
				<li><a href="function-license_agreement.html">license_agreement</a></li>
				<li><a href="function-log_admin_action.html">log_admin_action</a></li>
				<li><a href="function-log_moderator_action.html">log_moderator_action</a></li>
				<li><a href="function-login_attempt_check.html">login_attempt_check</a></li>
				<li><a href="function-login_attempt_check_acp.html">login_attempt_check_acp</a></li>
				<li><a href="function-make_child_theme_list.html">make_child_theme_list</a></li>
				<li><a href="function-make_parent_list.html">make_parent_list</a></li>
				<li><a href="function-make_parent_theme_list.html">make_parent_theme_list</a></li>
				<li><a href="function-make_pretty_links.html">make_pretty_links</a></li>
				<li><a href="function-make_searchable_forums.html">make_searchable_forums</a></li>
				<li><a href="function-mark_all_forums_read.html">mark_all_forums_read</a></li>
				<li><a href="function-mark_forum_read.html">mark_forum_read</a></li>
				<li><a href="function-mark_reports.html">mark_reports</a></li>
				<li><a href="function-mark_thread_read.html">mark_thread_read</a></li>
				<li><a href="function-match_sequence.html">match_sequence</a></li>
				<li><a href="function-memory_get_peak_usage.html">memory_get_peak_usage</a></li>
				<li><a href="function-modcp_can_manage_user.html">modcp_can_manage_user</a></li>
				<li><a href="function-multipage.html">multipage</a></li>
				<li><a href="function-my_chmod.html">my_chmod</a></li>
				<li><a href="function-my_date.html">my_date</a></li>
				<li><a href="function-my_get_array_cookie.html">my_get_array_cookie</a></li>
				<li><a href="function-my_ip2long.html">my_ip2long</a></li>
				<li><a href="function-my_long2ip.html">my_long2ip</a></li>
				<li class="active"><a href="function-my_mail.html">my_mail</a></li>
				<li><a href="function-my_number_format.html">my_number_format</a></li>
				<li><a href="function-my_rand.html">my_rand</a></li>
				<li><a href="function-my_rmdir_recursive.html">my_rmdir_recursive</a></li>
				<li><a href="function-my_set_array_cookie.html">my_set_array_cookie</a></li>
				<li><a href="function-my_setcookie.html">my_setcookie</a></li>
				<li><a href="function-my_strlen.html">my_strlen</a></li>
				<li><a href="function-my_strpos.html">my_strpos</a></li>
				<li><a href="function-my_strtolower.html">my_strtolower</a></li>
				<li><a href="function-my_strtoupper.html">my_strtoupper</a></li>
				<li><a href="function-my_substr.html">my_substr</a></li>
				<li><a href="function-my_unserialize.html">my_unserialize</a></li>
				<li><a href="function-my_unsetcookie.html">my_unsetcookie</a></li>
				<li><a href="function-my_wordwrap.html">my_wordwrap</a></li>
				<li><a href="function-nice_time.html">nice_time</a></li>
				<li><a href="function-output_logo.html">output_logo</a></li>
				<li><a href="function-output_page.html">output_page</a></li>
				<li><a href="function-parse_css_properties.html">parse_css_properties</a></li>
				<li><a href="function-parse_page.html">parse_page</a></li>
				<li><a href="function-parse_php_info.html">parse_php_info</a></li>
				<li><a href="function-parse_quoted_message.html">parse_quoted_message</a></li>
				<li><a href="function-parse_theme_variables.html">parse_theme_variables</a></li>
				<li><a href="function-perform_search_mysql.html">perform_search_mysql</a></li>
				<li><a href="function-perform_search_mysql_ft.html">perform_search_mysql_ft</a></li>
				<li><a href="function-populate_tables.html">populate_tables</a></li>
				<li><a href="function-privatemessage_perform_search_mysql.html">privatemessage_perform_search_mysql</a></li>
				<li><a href="function-random_str.html">random_str</a></li>
				<li><a href="function-rebuild_forum_counters.html">rebuild_forum_counters</a></li>
				<li><a href="function-rebuild_settings.html">rebuild_settings</a></li>
				<li><a href="function-rebuild_stats.html">rebuild_stats</a></li>
				<li><a href="function-rebuild_thread_counters.html">rebuild_thread_counters</a></li>
				<li><a href="function-rebuildsettings.html">rebuildsettings</a></li>
				<li><a href="function-redirect.html">redirect</a></li>
				<li><a href="function-remove_attachment.html">remove_attachment</a></li>
				<li><a href="function-remove_attachments.html">remove_attachments</a></li>
				<li><a href="function-remove_avatars.html">remove_avatars</a></li>
				<li><a href="function-remove_message_quotes.html">remove_message_quotes</a></li>
				<li><a href="function-remove_subscribed_forum.html">remove_subscribed_forum</a></li>
				<li><a href="function-remove_subscribed_thread.html">remove_subscribed_thread</a></li>
				<li><a href="function-requirements_check.html">requirements_check</a></li>
				<li><a href="function-reset_breadcrumb.html">reset_breadcrumb</a></li>
				<li><a href="function-resync_stylesheet.html">resync_stylesheet</a></li>
				<li><a href="function-run_shutdown.html">run_shutdown</a></li>
				<li><a href="function-run_task.html">run_task</a></li>
				<li><a href="function-run_time_exists.html">run_time_exists</a></li>
				<li><a href="function-salt_password.html">salt_password</a></li>
				<li><a href="function-save_quick_perms.html">save_quick_perms</a></li>
				<li><a href="function-scale_image.html">scale_image</a></li>
				<li><a href="function-secure_seed_rng.html">secure_seed_rng</a></li>
				<li><a href="function-send_mail_queue.html">send_mail_queue</a></li>
				<li><a href="function-send_page_headers.html">send_page_headers</a></li>
				<li><a href="function-set_default_view.html">set_default_view</a></li>
				<li><a href="function-signed.html">signed</a></li>
				<li><a href="function-style_action_handler.html">style_action_handler</a></li>
				<li><a href="function-style_admin_permissions.html">style_admin_permissions</a></li>
				<li><a href="function-style_meta.html">style_meta</a></li>
				<li><a href="function-subforums_count.html">subforums_count</a></li>
				<li><a href="function-task_backupdb.html">task_backupdb</a></li>
				<li><a href="function-task_checktables.html">task_checktables</a></li>
				<li><a href="function-task_dailycleanup.html">task_dailycleanup</a></li>
				<li><a href="function-task_delayedmoderation.html">task_delayedmoderation</a></li>
				<li><a href="function-task_hourlycleanup.html">task_hourlycleanup</a></li>
				<li><a href="function-task_logcleanup.html">task_logcleanup</a></li>
				<li><a href="function-task_massmail.html">task_massmail</a></li>
				<li><a href="function-task_promotions.html">task_promotions</a></li>
				<li><a href="function-task_threadviews.html">task_threadviews</a></li>
				<li><a href="function-task_usercleanup.html">task_usercleanup</a></li>
				<li><a href="function-task_userpruning.html">task_userpruning</a></li>
				<li><a href="function-tools_action_handler.html">tools_action_handler</a></li>
				<li><a href="function-tools_admin_permissions.html">tools_admin_permissions</a></li>
				<li><a href="function-tools_meta.html">tools_meta</a></li>
				<li><a href="function-trim_blank_chrs.html">trim_blank_chrs</a></li>
				<li><a href="function-unfix_css_urls.html">unfix_css_urls</a></li>
				<li><a href="function-unhtmlentities.html">unhtmlentities</a></li>
				<li><a href="function-unichr.html">unichr</a></li>
				<li><a href="function-update_admin_session.html">update_admin_session</a></li>
				<li><a href="function-update_first_post.html">update_first_post</a></li>
				<li><a href="function-update_forum_count.html">update_forum_count</a></li>
				<li><a href="function-update_forum_counters.html">update_forum_counters</a></li>
				<li><a href="function-update_forum_lastpost.html">update_forum_lastpost</a></li>
				<li><a href="function-update_loginkey.html">update_loginkey</a></li>
				<li><a href="function-update_password.html">update_password</a></li>
				<li><a href="function-update_pm_count.html">update_pm_count</a></li>
				<li><a href="function-update_salt.html">update_salt</a></li>
				<li><a href="function-update_stats.html">update_stats</a></li>
				<li><a href="function-update_theme_stylesheet_list.html">update_theme_stylesheet_list</a></li>
				<li><a href="function-update_thread_attachment_count.html">update_thread_attachment_count</a></li>
				<li><a href="function-update_thread_count.html">update_thread_count</a></li>
				<li><a href="function-update_thread_counters.html">update_thread_counters</a></li>
				<li><a href="function-update_thread_data.html">update_thread_data</a></li>
				<li><a href="function-upgrade10_dbchanges.html">upgrade10_dbchanges</a></li>
				<li><a href="function-upgrade11_dbchanges.html">upgrade11_dbchanges</a></li>
				<li><a href="function-upgrade12_dbchanges.html">upgrade12_dbchanges</a></li>
				<li><a href="function-upgrade12_dbchanges1.html">upgrade12_dbchanges1</a></li>
				<li><a href="function-upgrade12_dbchanges2.html">upgrade12_dbchanges2</a></li>
				<li><a href="function-upgrade12_dbchanges3.html">upgrade12_dbchanges3</a></li>
				<li><a href="function-upgrade12_dbchanges4.html">upgrade12_dbchanges4</a></li>
				<li><a href="function-upgrade12_dbchanges5.html">upgrade12_dbchanges5</a></li>
				<li><a href="function-upgrade12_dbchanges6.html">upgrade12_dbchanges6</a></li>
				<li><a href="function-upgrade12_dbchanges7.html">upgrade12_dbchanges7</a></li>
				<li><a href="function-upgrade12_dbchanges8.html">upgrade12_dbchanges8</a></li>
				<li><a href="function-upgrade12_dbchanges_post1.html">upgrade12_dbchanges_post1</a></li>
				<li><a href="function-upgrade12_dbchanges_post2.html">upgrade12_dbchanges_post2</a></li>
				<li><a href="function-upgrade12_dbchanges_user.html">upgrade12_dbchanges_user</a></li>
				<li><a href="function-upgrade12_redoconfig.html">upgrade12_redoconfig</a></li>
				<li><a href="function-upgrade12_redothemes.html">upgrade12_redothemes</a></li>
				<li><a href="function-upgrade13_dbchanges.html">upgrade13_dbchanges</a></li>
				<li><a href="function-upgrade13_dbchanges1.html">upgrade13_dbchanges1</a></li>
				<li><a href="function-upgrade13_dbchanges2.html">upgrade13_dbchanges2</a></li>
				<li><a href="function-upgrade14_dbchanges.html">upgrade14_dbchanges</a></li>
				<li><a href="function-upgrade14_dbchanges1.html">upgrade14_dbchanges1</a></li>
				<li><a href="function-upgrade14_dbchanges2.html">upgrade14_dbchanges2</a></li>
				<li><a href="function-upgrade15_dbchanges.html">upgrade15_dbchanges</a></li>
				<li><a href="function-upgrade15_usernameupdate.html">upgrade15_usernameupdate</a></li>
				<li><a href="function-upgrade15_usernameverify.html">upgrade15_usernameverify</a></li>
				<li><a href="function-upgrade17_dbchanges.html">upgrade17_dbchanges</a></li>
				<li><a href="function-upgrade17_dbchanges2.html">upgrade17_dbchanges2</a></li>
				<li><a href="function-upgrade17_dbchanges3.html">upgrade17_dbchanges3</a></li>
				<li><a href="function-upgrade17_dbchanges4.html">upgrade17_dbchanges4</a></li>
				<li><a href="function-upgrade17_dbchanges5.html">upgrade17_dbchanges5</a></li>
				<li><a href="function-upgrade17_dbchanges6.html">upgrade17_dbchanges6</a></li>
				<li><a href="function-upgrade17_dbchanges7.html">upgrade17_dbchanges7</a></li>
				<li><a href="function-upgrade17_redoconfig.html">upgrade17_redoconfig</a></li>
				<li><a href="function-upgrade17_updatecss.html">upgrade17_updatecss</a></li>
				<li><a href="function-upgrade18_dbchanges.html">upgrade18_dbchanges</a></li>
				<li><a href="function-upgrade18_updatecache.html">upgrade18_updatecache</a></li>
				<li><a href="function-upgrade1_dbchanges.html">upgrade1_dbchanges</a></li>
				<li><a href="function-upgrade1_dbchanges2.html">upgrade1_dbchanges2</a></li>
				<li><a href="function-upgrade1_dbchanges3.html">upgrade1_dbchanges3</a></li>
				<li><a href="function-upgrade20_dbchanges.html">upgrade20_dbchanges</a></li>
				<li><a href="function-upgrade21_dbchanges.html">upgrade21_dbchanges</a></li>
				<li><a href="function-upgrade23_dbchanges.html">upgrade23_dbchanges</a></li>
				<li><a href="function-upgrade2_dbchanges.html">upgrade2_dbchanges</a></li>
				<li><a href="function-upgrade2_dbchanges2.html">upgrade2_dbchanges2</a></li>
				<li><a href="function-upgrade3_convertattachments.html">upgrade3_convertattachments</a></li>
				<li><a href="function-upgrade3_convertavatars.html">upgrade3_convertavatars</a></li>
				<li><a href="function-upgrade3_dbchanges.html">upgrade3_dbchanges</a></li>
				<li><a href="function-upgrade3_dbchanges2.html">upgrade3_dbchanges2</a></li>
				<li><a href="function-upgrade3_dbchanges3.html">upgrade3_dbchanges3</a></li>
				<li><a href="function-upgrade4_dbchanges.html">upgrade4_dbchanges</a></li>
				<li><a href="function-upgrade5_dbchanges.html">upgrade5_dbchanges</a></li>
				<li><a href="function-upgrade5_forumlastposts.html">upgrade5_forumlastposts</a></li>
				<li><a href="function-upgrade5_indexes.html">upgrade5_indexes</a></li>
				<li><a href="function-upgrade5_lastposts.html">upgrade5_lastposts</a></li>
				<li><a href="function-upgrade5_redoconfig.html">upgrade5_redoconfig</a></li>
				<li><a href="function-upgrade6_dbchanges.html">upgrade6_dbchanges</a></li>
				<li><a href="function-upgrade8_dbchanges.html">upgrade8_dbchanges</a></li>
				<li><a href="function-upgrade_css_120_to_140.html">upgrade_css_120_to_140</a></li>
				<li><a href="function-upgrade_css_140_to_160.html">upgrade_css_140_to_160</a></li>
				<li><a href="function-upload_attachment.html">upload_attachment</a></li>
				<li><a href="function-upload_avatar.html">upload_avatar</a></li>
				<li><a href="function-upload_file.html">upload_file</a></li>
				<li><a href="function-user_action_handler.html">user_action_handler</a></li>
				<li><a href="function-user_admin_permissions.html">user_admin_permissions</a></li>
				<li><a href="function-user_exists.html">user_exists</a></li>
				<li><a href="function-user_meta.html">user_meta</a></li>
				<li><a href="function-user_permissions.html">user_permissions</a></li>
				<li><a href="function-usercp_menu.html">usercp_menu</a></li>
				<li><a href="function-usercp_menu_messenger.html">usercp_menu_messenger</a></li>
				<li><a href="function-usercp_menu_misc.html">usercp_menu_misc</a></li>
				<li><a href="function-usercp_menu_profile.html">usercp_menu_profile</a></li>
				<li><a href="function-usergroup_displaygroup.html">usergroup_displaygroup</a></li>
				<li><a href="function-usergroup_permissions.html">usergroup_permissions</a></li>
				<li><a href="function-username_exists.html">username_exists</a></li>
				<li><a href="function-validate_email_format.html">validate_email_format</a></li>
				<li><a href="function-validate_password_from_uid.html">validate_password_from_uid</a></li>
				<li><a href="function-validate_password_from_username.html">validate_password_from_username</a></li>
				<li><a href="function-verify_files.html">verify_files</a></li>
				<li><a href="function-verify_post_check.html">verify_post_check</a></li>
				<li><a href="function-view_manager.html">view_manager</a></li>
				<li><a href="function-write_settings.html">write_settings</a></li>
			</ul>
		</div>
	</div>
</div>

<div id="splitter"></div>

<div id="right">
<div id="rightInner">
	<form id="search">
		<input type="hidden" name="cx" value="" />
		<input type="hidden" name="ie" value="UTF-8" />
		<input type="text" name="q" class="text" />
		<input type="submit" value="Search" />
	</form>

	<div id="navigation">
		<ul>
			<li>
				<a href="index.html" title="Overview"><span>Overview</span></a>
			</li>
			<li>
				<a href="function-my_mail.html" title="Summary of my_mail"><span>Function</span></a>
			</li>
		</ul>
		<ul>
			<li>
				<a href="tree.html" title="Tree view of classes, interfaces, traits and exceptions"><span>Tree</span></a>
			</li>
			<li>
				<a href="deprecated.html" title="List of deprecated elements"><span>Deprecated</span></a>
			</li>
		</ul>
		<ul>
		</ul>
	</div>

<pre><code><a href="#1" id="1" class="l">   1: </a><span class="xlang">&lt;?php</span>
<a href="#2" id="2" class="l">   2: </a><span class="php-comment">/**
</span><a href="#3" id="3" class="l">   3: </a><span class="php-comment"> * MyBB 1.6
</span><a href="#4" id="4" class="l">   4: </a><span class="php-comment"> * Copyright 2010 MyBB Group, All Rights Reserved
</span><a href="#5" id="5" class="l">   5: </a><span class="php-comment"> *
</span><a href="#6" id="6" class="l">   6: </a><span class="php-comment"> * Website: http://mybb.com
</span><a href="#7" id="7" class="l">   7: </a><span class="php-comment"> * License: http://mybb.com/about/license
</span><a href="#8" id="8" class="l">   8: </a><span class="php-comment"> *
</span><a href="#9" id="9" class="l">   9: </a><span class="php-comment"> * $Id: functions.php 5819 2012-04-27 15:39:09Z Tomm $
</span><a href="#10" id="10" class="l">  10: </a><span class="php-comment"> */</span>
<a href="#11" id="11" class="l">  11: </a>
<a href="#12" id="12" class="l">  12: </a><span class="php-comment">/**
</span><a href="#13" id="13" class="l">  13: </a><span class="php-comment"> * Outputs a page directly to the browser, parsing anything which needs to be parsed.
</span><a href="#14" id="14" class="l">  14: </a><span class="php-comment"> *
</span><a href="#15" id="15" class="l">  15: </a><span class="php-comment"> * @param string The contents of the page.
</span><a href="#16" id="16" class="l">  16: </a><span class="php-comment"> */</span>
<a href="#17" id="17" class="l">  17: </a><span class="php-keyword1">function</span> output_page(<span class="php-var">$contents</span>)
<a href="#18" id="18" class="l">  18: </a>{
<a href="#19" id="19" class="l">  19: </a>    <span class="php-keyword1">global</span> <span class="php-var">$db</span>, <span class="php-var">$lang</span>, <span class="php-var">$theme</span>, <span class="php-var">$plugins</span>, <span class="php-var">$mybb</span>;
<a href="#20" id="20" class="l">  20: </a>    <span class="php-keyword1">global</span> <span class="php-var">$debug</span>, <span class="php-var">$templatecache</span>, <span class="php-var">$templatelist</span>, <span class="php-var">$maintimer</span>, <span class="php-var">$globaltime</span>, <span class="php-var">$parsetime</span>;
<a href="#21" id="21" class="l">  21: </a>
<a href="#22" id="22" class="l">  22: </a>    <span class="php-var">$contents</span> = parse_page(<span class="php-var">$contents</span>);
<a href="#23" id="23" class="l">  23: </a>    <span class="php-var">$totaltime</span> = <span class="php-var">$maintimer</span>-&gt;stop();
<a href="#24" id="24" class="l">  24: </a>
<a href="#25" id="25" class="l">  25: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;usergroup[<span class="php-quote">'cancp'</span>] == <span class="php-num">1</span>)
<a href="#26" id="26" class="l">  26: </a>    {
<a href="#27" id="27" class="l">  27: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'extraadmininfo'</span>] != <span class="php-num">0</span>)
<a href="#28" id="28" class="l">  28: </a>        {
<a href="#29" id="29" class="l">  29: </a>            <span class="php-var">$phptime</span> = <span class="php-var">$maintimer</span>-&gt;format(<span class="php-var">$maintimer</span>-&gt;totaltime - <span class="php-var">$db</span>-&gt;query_time);
<a href="#30" id="30" class="l">  30: </a>            <span class="php-var">$query_time</span> = <span class="php-var">$maintimer</span>-&gt;format(<span class="php-var">$db</span>-&gt;query_time);
<a href="#31" id="31" class="l">  31: </a>
<a href="#32" id="32" class="l">  32: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$maintimer</span>-&gt;totaltime &gt; <span class="php-num">0</span>)
<a href="#33" id="33" class="l">  33: </a>            {
<a href="#34" id="34" class="l">  34: </a>                <span class="php-var">$percentphp</span> = <span class="php-keyword2">number_format</span>(((<span class="php-var">$phptime</span>/<span class="php-var">$maintimer</span>-&gt;totaltime) * <span class="php-num">100</span>), <span class="php-num">2</span>);
<a href="#35" id="35" class="l">  35: </a>                <span class="php-var">$percentsql</span> = <span class="php-keyword2">number_format</span>(((<span class="php-var">$query_time</span>/<span class="php-var">$maintimer</span>-&gt;totaltime) * <span class="php-num">100</span>), <span class="php-num">2</span>);
<a href="#36" id="36" class="l">  36: </a>            }
<a href="#37" id="37" class="l">  37: </a>            <span class="php-keyword1">else</span>
<a href="#38" id="38" class="l">  38: </a>            {
<a href="#39" id="39" class="l">  39: </a>                <span class="php-comment">// if we've got a super fast script...  all we can do is assume something</span>
<a href="#40" id="40" class="l">  40: </a>                <span class="php-var">$percentphp</span> = <span class="php-num">0</span>;
<a href="#41" id="41" class="l">  41: </a>                <span class="php-var">$percentsql</span> = <span class="php-num">0</span>;
<a href="#42" id="42" class="l">  42: </a>            }
<a href="#43" id="43" class="l">  43: </a>
<a href="#44" id="44" class="l">  44: </a>            <span class="php-var">$phpversion</span> = PHP_VERSION;
<a href="#45" id="45" class="l">  45: </a>
<a href="#46" id="46" class="l">  46: </a>            <span class="php-var">$serverload</span> = get_server_load();
<a href="#47" id="47" class="l">  47: </a>
<a href="#48" id="48" class="l">  48: </a>            <span class="php-keyword1">if</span>(my_strpos(<span class="php-keyword2">getenv</span>(<span class="php-quote">&quot;REQUEST_URI&quot;</span>), <span class="php-quote">&quot;?&quot;</span>))
<a href="#49" id="49" class="l">  49: </a>            {
<a href="#50" id="50" class="l">  50: </a>                <span class="php-var">$debuglink</span> = <span class="php-keyword2">htmlspecialchars</span>(<span class="php-keyword2">getenv</span>(<span class="php-quote">&quot;REQUEST_URI&quot;</span>)) . <span class="php-quote">&quot;&amp;amp;debug=1&quot;</span>;
<a href="#51" id="51" class="l">  51: </a>            }
<a href="#52" id="52" class="l">  52: </a>            <span class="php-keyword1">else</span>
<a href="#53" id="53" class="l">  53: </a>            {
<a href="#54" id="54" class="l">  54: </a>                <span class="php-var">$debuglink</span> = <span class="php-keyword2">htmlspecialchars</span>(<span class="php-keyword2">getenv</span>(<span class="php-quote">&quot;REQUEST_URI&quot;</span>)) . <span class="php-quote">&quot;?debug=1&quot;</span>;
<a href="#55" id="55" class="l">  55: </a>            }
<a href="#56" id="56" class="l">  56: </a>
<a href="#57" id="57" class="l">  57: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'gzipoutput'</span>] != <span class="php-num">0</span>)
<a href="#58" id="58" class="l">  58: </a>            {
<a href="#59" id="59" class="l">  59: </a>                <span class="php-var">$gzipen</span> = <span class="php-quote">&quot;Enabled&quot;</span>;
<a href="#60" id="60" class="l">  60: </a>            }
<a href="#61" id="61" class="l">  61: </a>            <span class="php-keyword1">else</span>
<a href="#62" id="62" class="l">  62: </a>            {
<a href="#63" id="63" class="l">  63: </a>                <span class="php-var">$gzipen</span> = <span class="php-quote">&quot;Disabled&quot;</span>;
<a href="#64" id="64" class="l">  64: </a>            }
<a href="#65" id="65" class="l">  65: </a>
<a href="#66" id="66" class="l">  66: </a>            <span class="php-keyword1">if</span>(<span class="php-keyword2">function_exists</span>(<span class="php-quote">&quot;memory_get_usage&quot;</span>))
<a href="#67" id="67" class="l">  67: </a>            {
<a href="#68" id="68" class="l">  68: </a>                <span class="php-var">$memory_usage</span> = <span class="php-quote">&quot; / Memory Usage: &quot;</span>.get_friendly_size(<span class="php-keyword2">memory_get_peak_usage</span>(<span class="php-keyword1">true</span>));
<a href="#69" id="69" class="l">  69: </a>            }
<a href="#70" id="70" class="l">  70: </a>
<a href="#71" id="71" class="l">  71: </a>            <span class="php-var">$other</span> = <span class="php-quote">&quot;PHP version: </span><span class="php-var">$phpversion</span><span class="php-quote"> / Server Load: </span><span class="php-var">$serverload</span><span class="php-quote"> / GZip Compression: </span><span class="php-var">$gzipen</span><span class="php-quote">&quot;</span>;
<a href="#72" id="72" class="l">  72: </a>            <span class="php-var">$debugstuff</span> = <span class="php-quote">&quot;Generated in </span><span class="php-var">$totaltime</span><span class="php-quote"> seconds (</span><span class="php-var">$percentphp</span><span class="php-quote">% PHP / </span><span class="php-var">$percentsql</span><span class="php-quote">% MySQL)&lt;br /&gt;SQL Queries: </span><span class="php-var">$db</span><span class="php-quote">-&gt;query_count /  Global Parsing Time: </span><span class="php-var">$globaltime$memory_usage</span><span class="php-quote">&lt;br /&gt;</span><span class="php-var">$other</span><span class="php-quote">&lt;br /&gt;[&lt;a href=\&quot;</span><span class="php-var">$debuglink</span><span class="php-quote">\&quot; target=\&quot;_blank\&quot;&gt;advanced details&lt;/a&gt;]&lt;br /&gt;&quot;</span>;
<a href="#73" id="73" class="l">  73: </a>            <span class="php-var">$contents</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;&lt;debugstuff&gt;&quot;</span>, <span class="php-var">$debugstuff</span>, <span class="php-var">$contents</span>);
<a href="#74" id="74" class="l">  74: </a>        }
<a href="#75" id="75" class="l">  75: </a>
<a href="#76" id="76" class="l">  76: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;debug_mode == <span class="php-keyword1">true</span>)
<a href="#77" id="77" class="l">  77: </a>        {
<a href="#78" id="78" class="l">  78: </a>            debug_page();
<a href="#79" id="79" class="l">  79: </a>        }
<a href="#80" id="80" class="l">  80: </a>    }
<a href="#81" id="81" class="l">  81: </a>
<a href="#82" id="82" class="l">  82: </a>    <span class="php-var">$contents</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;&lt;debugstuff&gt;&quot;</span>, <span class="php-quote">&quot;&quot;</span>, <span class="php-var">$contents</span>);
<a href="#83" id="83" class="l">  83: </a>    <span class="php-var">$contents</span> = <span class="php-var">$plugins</span>-&gt;run_hooks(<span class="php-quote">&quot;pre_output_page&quot;</span>, <span class="php-var">$contents</span>);
<a href="#84" id="84" class="l">  84: </a>
<a href="#85" id="85" class="l">  85: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'gzipoutput'</span>] == <span class="php-num">1</span>)
<a href="#86" id="86" class="l">  86: </a>    {
<a href="#87" id="87" class="l">  87: </a>        <span class="php-var">$contents</span> = gzip_encode(<span class="php-var">$contents</span>, <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'gziplevel'</span>]);
<a href="#88" id="88" class="l">  88: </a>    }
<a href="#89" id="89" class="l">  89: </a>    
<a href="#90" id="90" class="l">  90: </a>    @<span class="php-keyword2">header</span>(<span class="php-quote">&quot;Content-type: text/html; charset=</span><span class="php-var">{$lang-&gt;settings['charset']}</span><span class="php-quote">&quot;</span>);
<a href="#91" id="91" class="l">  91: </a>    
<a href="#92" id="92" class="l">  92: </a>    <span class="php-keyword1">echo</span> <span class="php-var">$contents</span>;
<a href="#93" id="93" class="l">  93: </a>
<a href="#94" id="94" class="l">  94: </a>    <span class="php-var">$plugins</span>-&gt;run_hooks(<span class="php-quote">&quot;post_output_page&quot;</span>);
<a href="#95" id="95" class="l">  95: </a>}
<a href="#96" id="96" class="l">  96: </a>
<a href="#97" id="97" class="l">  97: </a><span class="php-comment">/**
</span><a href="#98" id="98" class="l">  98: </a><span class="php-comment"> * Adds a function or class to the list of code to run on shutdown.
</span><a href="#99" id="99" class="l">  99: </a><span class="php-comment"> *
</span><a href="#100" id="100" class="l"> 100: </a><span class="php-comment"> * @param mixed The name of the function.
</span><a href="#101" id="101" class="l"> 101: </a><span class="php-comment"> * @param mixed An array of arguments for the function
</span><a href="#102" id="102" class="l"> 102: </a><span class="php-comment"> * @return boolean True if function exists, otherwise false.
</span><a href="#103" id="103" class="l"> 103: </a><span class="php-comment"> */</span>
<a href="#104" id="104" class="l"> 104: </a><span class="php-keyword1">function</span> add_shutdown(<span class="php-var">$name</span>, <span class="php-var">$arguments</span>=<span class="php-keyword1">array</span>())
<a href="#105" id="105" class="l"> 105: </a>{
<a href="#106" id="106" class="l"> 106: </a>    <span class="php-keyword1">global</span> <span class="php-var">$shutdown_functions</span>;
<a href="#107" id="107" class="l"> 107: </a>    
<a href="#108" id="108" class="l"> 108: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$arguments</span>))
<a href="#109" id="109" class="l"> 109: </a>    {
<a href="#110" id="110" class="l"> 110: </a>        <span class="php-var">$arguments</span> = <span class="php-keyword1">array</span>(<span class="php-var">$arguments</span>);
<a href="#111" id="111" class="l"> 111: </a>    }
<a href="#112" id="112" class="l"> 112: </a>
<a href="#113" id="113" class="l"> 113: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$name</span>) &amp;&amp; <span class="php-keyword2">method_exists</span>(<span class="php-var">$name</span>[<span class="php-num">0</span>], <span class="php-var">$name</span>[<span class="php-num">1</span>]))
<a href="#114" id="114" class="l"> 114: </a>    {
<a href="#115" id="115" class="l"> 115: </a>        <span class="php-var">$shutdown_functions</span>[<span class="php-quote">&quot;class_&quot;</span>.<span class="php-keyword2">get_class</span>(<span class="php-var">$name</span>[<span class="php-num">0</span>]).<span class="php-quote">&quot;_&quot;</span>.<span class="php-var">$name</span>[<span class="php-num">1</span>]] = <span class="php-keyword1">array</span>(<span class="php-quote">'function'</span> =&gt; <span class="php-var">$name</span>, <span class="php-quote">'arguments'</span> =&gt; <span class="php-var">$arguments</span>);
<a href="#116" id="116" class="l"> 116: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
<a href="#117" id="117" class="l"> 117: </a>    }
<a href="#118" id="118" class="l"> 118: </a>    <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$name</span>) &amp;&amp; <span class="php-keyword2">function_exists</span>(<span class="php-var">$name</span>))
<a href="#119" id="119" class="l"> 119: </a>    {
<a href="#120" id="120" class="l"> 120: </a>        <span class="php-var">$shutdown_functions</span>[<span class="php-var">$name</span>] = <span class="php-keyword1">array</span>(<span class="php-quote">'function'</span> =&gt; <span class="php-var">$name</span>, <span class="php-quote">'arguments'</span> =&gt; <span class="php-var">$arguments</span>);
<a href="#121" id="121" class="l"> 121: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
<a href="#122" id="122" class="l"> 122: </a>    }
<a href="#123" id="123" class="l"> 123: </a>
<a href="#124" id="124" class="l"> 124: </a>    <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#125" id="125" class="l"> 125: </a>}
<a href="#126" id="126" class="l"> 126: </a>
<a href="#127" id="127" class="l"> 127: </a><span class="php-comment">/**
</span><a href="#128" id="128" class="l"> 128: </a><span class="php-comment"> * Runs the shutdown items after the page has been sent to the browser.
</span><a href="#129" id="129" class="l"> 129: </a><span class="php-comment"> *
</span><a href="#130" id="130" class="l"> 130: </a><span class="php-comment"> */</span>
<a href="#131" id="131" class="l"> 131: </a><span class="php-keyword1">function</span> run_shutdown()
<a href="#132" id="132" class="l"> 132: </a>{
<a href="#133" id="133" class="l"> 133: </a>    <span class="php-keyword1">global</span> <span class="php-var">$config</span>, <span class="php-var">$db</span>, <span class="php-var">$cache</span>, <span class="php-var">$plugins</span>, <span class="php-var">$error_handler</span>, <span class="php-var">$shutdown_functions</span>, <span class="php-var">$shutdown_queries</span>, <span class="php-var">$done_shutdown</span>, <span class="php-var">$mybb</span>;
<a href="#134" id="134" class="l"> 134: </a>
<a href="#135" id="135" class="l"> 135: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$done_shutdown</span> == <span class="php-keyword1">true</span> || !<span class="php-var">$config</span> || <span class="php-var">$error_handler</span>-&gt;has_errors)
<a href="#136" id="136" class="l"> 136: </a>    {
<a href="#137" id="137" class="l"> 137: </a>        <span class="php-keyword1">return</span>;
<a href="#138" id="138" class="l"> 138: </a>    }
<a href="#139" id="139" class="l"> 139: </a>
<a href="#140" id="140" class="l"> 140: </a>    <span class="php-comment">// Missing the core? Build</span>
<a href="#141" id="141" class="l"> 141: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_object</span>(<span class="php-var">$mybb</span>))
<a href="#142" id="142" class="l"> 142: </a>    {
<a href="#143" id="143" class="l"> 143: </a>        <span class="php-keyword1">require_once</span> MYBB_ROOT.<span class="php-quote">&quot;inc/class_core.php&quot;</span>;
<a href="#144" id="144" class="l"> 144: </a>        <span class="php-var">$mybb</span> = <span class="php-keyword1">new</span> MyBB;
<a href="#145" id="145" class="l"> 145: </a>
<a href="#146" id="146" class="l"> 146: </a>        <span class="php-comment">// Load the settings</span>
<a href="#147" id="147" class="l"> 147: </a>        <span class="php-keyword1">require</span> MYBB_ROOT.<span class="php-quote">&quot;inc/settings.php&quot;</span>;
<a href="#148" id="148" class="l"> 148: </a>        <span class="php-var">$mybb</span>-&gt;settings = &amp;<span class="php-var">$settings</span>;
<a href="#149" id="149" class="l"> 149: </a>    }
<a href="#150" id="150" class="l"> 150: </a>
<a href="#151" id="151" class="l"> 151: </a>
<a href="#152" id="152" class="l"> 152: </a>    <span class="php-comment">// If our DB has been deconstructed already (bad PHP 5.2.0), reconstruct</span>
<a href="#153" id="153" class="l"> 153: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_object</span>(<span class="php-var">$db</span>))
<a href="#154" id="154" class="l"> 154: </a>    {
<a href="#155" id="155" class="l"> 155: </a>        <span class="php-keyword1">if</span>(!<span class="php-keyword1">isset</span>(<span class="php-var">$config</span>) || <span class="php-keyword1">empty</span>(<span class="php-var">$config</span>[<span class="php-quote">'database'</span>][<span class="php-quote">'type'</span>]))
<a href="#156" id="156" class="l"> 156: </a>        {
<a href="#157" id="157" class="l"> 157: </a>            <span class="php-keyword1">require</span> MYBB_ROOT.<span class="php-quote">&quot;inc/config.php&quot;</span>;
<a href="#158" id="158" class="l"> 158: </a>        }
<a href="#159" id="159" class="l"> 159: </a>        
<a href="#160" id="160" class="l"> 160: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword1">isset</span>(<span class="php-var">$config</span>))
<a href="#161" id="161" class="l"> 161: </a>        {
<a href="#162" id="162" class="l"> 162: </a>            <span class="php-keyword1">require_once</span> MYBB_ROOT.<span class="php-quote">&quot;inc/db_&quot;</span>.<span class="php-var">$config</span>[<span class="php-quote">'database'</span>][<span class="php-quote">'type'</span>].<span class="php-quote">&quot;.php&quot;</span>;
<a href="#163" id="163" class="l"> 163: </a>            <span class="php-keyword1">switch</span>(<span class="php-var">$config</span>[<span class="php-quote">'database'</span>][<span class="php-quote">'type'</span>])
<a href="#164" id="164" class="l"> 164: </a>            {
<a href="#165" id="165" class="l"> 165: </a>                <span class="php-keyword1">case</span> <span class="php-quote">&quot;sqlite&quot;</span>:
<a href="#166" id="166" class="l"> 166: </a>                    <span class="php-var">$db</span> = <span class="php-keyword1">new</span> DB_SQLite;
<a href="#167" id="167" class="l"> 167: </a>                    <span class="php-keyword1">break</span>;
<a href="#168" id="168" class="l"> 168: </a>                <span class="php-keyword1">case</span> <span class="php-quote">&quot;pgsql&quot;</span>:
<a href="#169" id="169" class="l"> 169: </a>                    <span class="php-var">$db</span> = <span class="php-keyword1">new</span> DB_PgSQL;
<a href="#170" id="170" class="l"> 170: </a>                    <span class="php-keyword1">break</span>;
<a href="#171" id="171" class="l"> 171: </a>                <span class="php-keyword1">case</span> <span class="php-quote">&quot;mysqli&quot;</span>:
<a href="#172" id="172" class="l"> 172: </a>                    <span class="php-var">$db</span> = <span class="php-keyword1">new</span> DB_MySQLi;
<a href="#173" id="173" class="l"> 173: </a>                    <span class="php-keyword1">break</span>;
<a href="#174" id="174" class="l"> 174: </a>                <span class="php-keyword1">default</span>:
<a href="#175" id="175" class="l"> 175: </a>                    <span class="php-var">$db</span> = <span class="php-keyword1">new</span> DB_MySQL;
<a href="#176" id="176" class="l"> 176: </a>            }
<a href="#177" id="177" class="l"> 177: </a>            
<a href="#178" id="178" class="l"> 178: </a>            
<a href="#179" id="179" class="l"> 179: </a>            <span class="php-var">$db</span>-&gt;connect(<span class="php-var">$config</span>[<span class="php-quote">'database'</span>]);
<a href="#180" id="180" class="l"> 180: </a>            <span class="php-keyword2">define</span>(<span class="php-quote">&quot;TABLE_PREFIX&quot;</span>, <span class="php-var">$config</span>[<span class="php-quote">'database'</span>][<span class="php-quote">'table_prefix'</span>]);
<a href="#181" id="181" class="l"> 181: </a>            <span class="php-var">$db</span>-&gt;set_table_prefix(TABLE_PREFIX);
<a href="#182" id="182" class="l"> 182: </a>        }
<a href="#183" id="183" class="l"> 183: </a>    }
<a href="#184" id="184" class="l"> 184: </a>
<a href="#185" id="185" class="l"> 185: </a>    <span class="php-comment">// Cache object deconstructed? reconstruct</span>
<a href="#186" id="186" class="l"> 186: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_object</span>(<span class="php-var">$cache</span>))
<a href="#187" id="187" class="l"> 187: </a>    {
<a href="#188" id="188" class="l"> 188: </a>        <span class="php-keyword1">require_once</span> MYBB_ROOT.<span class="php-quote">&quot;inc/class_datacache.php&quot;</span>;
<a href="#189" id="189" class="l"> 189: </a>        <span class="php-var">$cache</span> = <span class="php-keyword1">new</span> datacache;
<a href="#190" id="190" class="l"> 190: </a>        <span class="php-var">$cache</span>-&gt;cache();
<a href="#191" id="191" class="l"> 191: </a>    }
<a href="#192" id="192" class="l"> 192: </a>
<a href="#193" id="193" class="l"> 193: </a>    <span class="php-comment">// And finally.. plugins</span>
<a href="#194" id="194" class="l"> 194: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_object</span>(<span class="php-var">$plugins</span>) &amp;&amp; !<span class="php-keyword2">defined</span>(<span class="php-quote">&quot;NO_PLUGINS&quot;</span>) &amp;&amp; !(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'no_plugins'</span>] == <span class="php-num">1</span>))
<a href="#195" id="195" class="l"> 195: </a>    {
<a href="#196" id="196" class="l"> 196: </a>        <span class="php-keyword1">require_once</span> MYBB_ROOT.<span class="php-quote">&quot;inc/class_plugins.php&quot;</span>;
<a href="#197" id="197" class="l"> 197: </a>        <span class="php-var">$plugins</span> = <span class="php-keyword1">new</span> pluginSystem;
<a href="#198" id="198" class="l"> 198: </a>        <span class="php-var">$plugins</span>-&gt;load();
<a href="#199" id="199" class="l"> 199: </a>    }
<a href="#200" id="200" class="l"> 200: </a>
<a href="#201" id="201" class="l"> 201: </a>    <span class="php-comment">// We have some shutdown queries needing to be run</span>
<a href="#202" id="202" class="l"> 202: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$shutdown_queries</span>))
<a href="#203" id="203" class="l"> 203: </a>    {
<a href="#204" id="204" class="l"> 204: </a>        <span class="php-comment">// Loop through and run them all</span>
<a href="#205" id="205" class="l"> 205: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$shutdown_queries</span> <span class="php-keyword1">as</span> <span class="php-var">$query</span>)
<a href="#206" id="206" class="l"> 206: </a>        {
<a href="#207" id="207" class="l"> 207: </a>            <span class="php-var">$db</span>-&gt;query(<span class="php-var">$query</span>);
<a href="#208" id="208" class="l"> 208: </a>        }
<a href="#209" id="209" class="l"> 209: </a>    }
<a href="#210" id="210" class="l"> 210: </a>
<a href="#211" id="211" class="l"> 211: </a>    <span class="php-comment">// Run any shutdown functions if we have them</span>
<a href="#212" id="212" class="l"> 212: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$shutdown_functions</span>))
<a href="#213" id="213" class="l"> 213: </a>    {
<a href="#214" id="214" class="l"> 214: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$shutdown_functions</span> <span class="php-keyword1">as</span> <span class="php-var">$function</span>)
<a href="#215" id="215" class="l"> 215: </a>        {
<a href="#216" id="216" class="l"> 216: </a>            <span class="php-keyword2">call_user_func_array</span>(<span class="php-var">$function</span>[<span class="php-quote">'function'</span>], <span class="php-var">$function</span>[<span class="php-quote">'arguments'</span>]);
<a href="#217" id="217" class="l"> 217: </a>        }
<a href="#218" id="218" class="l"> 218: </a>    }
<a href="#219" id="219" class="l"> 219: </a>
<a href="#220" id="220" class="l"> 220: </a>    <span class="php-var">$done_shutdown</span> = <span class="php-keyword1">true</span>;
<a href="#221" id="221" class="l"> 221: </a>}
<a href="#222" id="222" class="l"> 222: </a>
<a href="#223" id="223" class="l"> 223: </a><span class="php-comment">/**
</span><a href="#224" id="224" class="l"> 224: </a><span class="php-comment"> * Sends a specified amount of messages from the mail queue
</span><a href="#225" id="225" class="l"> 225: </a><span class="php-comment"> *
</span><a href="#226" id="226" class="l"> 226: </a><span class="php-comment"> * @param int The number of messages to send (Defaults to 10)
</span><a href="#227" id="227" class="l"> 227: </a><span class="php-comment"> */</span>
<a href="#228" id="228" class="l"> 228: </a><span class="php-keyword1">function</span> send_mail_queue(<span class="php-var">$count</span>=<span class="php-num">10</span>)
<a href="#229" id="229" class="l"> 229: </a>{
<a href="#230" id="230" class="l"> 230: </a>    <span class="php-keyword1">global</span> <span class="php-var">$db</span>, <span class="php-var">$cache</span>, <span class="php-var">$plugins</span>;
<a href="#231" id="231" class="l"> 231: </a>
<a href="#232" id="232" class="l"> 232: </a>    <span class="php-var">$plugins</span>-&gt;run_hooks(<span class="php-quote">&quot;send_mail_queue_start&quot;</span>);
<a href="#233" id="233" class="l"> 233: </a>
<a href="#234" id="234" class="l"> 234: </a>    <span class="php-comment">// Check to see if the mail queue has messages needing to be sent</span>
<a href="#235" id="235" class="l"> 235: </a>    <span class="php-var">$mailcache</span> = <span class="php-var">$cache</span>-&gt;read(<span class="php-quote">&quot;mailqueue&quot;</span>);
<a href="#236" id="236" class="l"> 236: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$mailcache</span>[<span class="php-quote">'queue_size'</span>] &gt; <span class="php-num">0</span> &amp;&amp; (<span class="php-var">$mailcache</span>[<span class="php-quote">'locked'</span>] == <span class="php-num">0</span> || <span class="php-var">$mailcache</span>[<span class="php-quote">'locked'</span>] &lt; TIME_NOW-<span class="php-num">300</span>))
<a href="#237" id="237" class="l"> 237: </a>    {
<a href="#238" id="238" class="l"> 238: </a>        <span class="php-comment">// Lock the queue so no other messages can be sent whilst these are (for popular boards)</span>
<a href="#239" id="239" class="l"> 239: </a>        <span class="php-var">$cache</span>-&gt;update_mailqueue(<span class="php-num">0</span>, TIME_NOW);
<a href="#240" id="240" class="l"> 240: </a>
<a href="#241" id="241" class="l"> 241: </a>        <span class="php-comment">// Fetch emails for this page view - and send them</span>
<a href="#242" id="242" class="l"> 242: </a>        <span class="php-var">$query</span> = <span class="php-var">$db</span>-&gt;simple_select(<span class="php-quote">&quot;mailqueue&quot;</span>, <span class="php-quote">&quot;*&quot;</span>, <span class="php-quote">&quot;&quot;</span>, <span class="php-keyword1">array</span>(<span class="php-quote">&quot;order_by&quot;</span> =&gt; <span class="php-quote">&quot;mid&quot;</span>, <span class="php-quote">&quot;order_dir&quot;</span> =&gt; <span class="php-quote">&quot;asc&quot;</span>, <span class="php-quote">&quot;limit_start&quot;</span> =&gt; <span class="php-num">0</span>, <span class="php-quote">&quot;limit&quot;</span> =&gt; <span class="php-var">$count</span>));
<a href="#243" id="243" class="l"> 243: </a>
<a href="#244" id="244" class="l"> 244: </a>        <span class="php-keyword1">while</span>(<span class="php-var">$email</span> = <span class="php-var">$db</span>-&gt;fetch_array(<span class="php-var">$query</span>))
<a href="#245" id="245" class="l"> 245: </a>        {
<a href="#246" id="246" class="l"> 246: </a>            <span class="php-comment">// Delete the message from the queue</span>
<a href="#247" id="247" class="l"> 247: </a>            <span class="php-var">$db</span>-&gt;delete_query(<span class="php-quote">&quot;mailqueue&quot;</span>, <span class="php-quote">&quot;mid='</span><span class="php-var">{$email['mid']}</span><span class="php-quote">'&quot;</span>);
<a href="#248" id="248" class="l"> 248: </a>            
<a href="#249" id="249" class="l"> 249: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$db</span>-&gt;affected_rows() == <span class="php-num">1</span>)
<a href="#250" id="250" class="l"> 250: </a>            {
<a href="#251" id="251" class="l"> 251: </a>                my_mail(<span class="php-var">$email</span>[<span class="php-quote">'mailto'</span>], <span class="php-var">$email</span>[<span class="php-quote">'subject'</span>], <span class="php-var">$email</span>[<span class="php-quote">'message'</span>], <span class="php-var">$email</span>[<span class="php-quote">'mailfrom'</span>], <span class="php-quote">&quot;&quot;</span>, <span class="php-var">$email</span>[<span class="php-quote">'headers'</span>]);
<a href="#252" id="252" class="l"> 252: </a>            }
<a href="#253" id="253" class="l"> 253: </a>        }
<a href="#254" id="254" class="l"> 254: </a>        <span class="php-comment">// Update the mailqueue cache and remove the lock</span>
<a href="#255" id="255" class="l"> 255: </a>        <span class="php-var">$cache</span>-&gt;update_mailqueue(TIME_NOW, <span class="php-num">0</span>);
<a href="#256" id="256" class="l"> 256: </a>    }
<a href="#257" id="257" class="l"> 257: </a>
<a href="#258" id="258" class="l"> 258: </a>    <span class="php-var">$plugins</span>-&gt;run_hooks(<span class="php-quote">&quot;send_mail_queue_end&quot;</span>);
<a href="#259" id="259" class="l"> 259: </a>}
<a href="#260" id="260" class="l"> 260: </a>
<a href="#261" id="261" class="l"> 261: </a><span class="php-comment">/**
</span><a href="#262" id="262" class="l"> 262: </a><span class="php-comment"> * Parses the contents of a page before outputting it.
</span><a href="#263" id="263" class="l"> 263: </a><span class="php-comment"> *
</span><a href="#264" id="264" class="l"> 264: </a><span class="php-comment"> * @param string The contents of the page.
</span><a href="#265" id="265" class="l"> 265: </a><span class="php-comment"> * @return string The parsed page.
</span><a href="#266" id="266" class="l"> 266: </a><span class="php-comment"> */</span>
<a href="#267" id="267" class="l"> 267: </a><span class="php-keyword1">function</span> parse_page(<span class="php-var">$contents</span>)
<a href="#268" id="268" class="l"> 268: </a>{
<a href="#269" id="269" class="l"> 269: </a>    <span class="php-keyword1">global</span> <span class="php-var">$lang</span>, <span class="php-var">$theme</span>, <span class="php-var">$mybb</span>, <span class="php-var">$htmldoctype</span>, <span class="php-var">$archive_url</span>, <span class="php-var">$error_handler</span>;
<a href="#270" id="270" class="l"> 270: </a>
<a href="#271" id="271" class="l"> 271: </a>    <span class="php-var">$contents</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">'&lt;navigation&gt;'</span>, build_breadcrumb(<span class="php-num">1</span>), <span class="php-var">$contents</span>);
<a href="#272" id="272" class="l"> 272: </a>    <span class="php-var">$contents</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">'&lt;archive_url&gt;'</span>, <span class="php-var">$archive_url</span>, <span class="php-var">$contents</span>);
<a href="#273" id="273" class="l"> 273: </a>
<a href="#274" id="274" class="l"> 274: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$htmldoctype</span>)
<a href="#275" id="275" class="l"> 275: </a>    {
<a href="#276" id="276" class="l"> 276: </a>        <span class="php-var">$contents</span> = <span class="php-var">$htmldoctype</span>.<span class="php-var">$contents</span>;
<a href="#277" id="277" class="l"> 277: </a>    }
<a href="#278" id="278" class="l"> 278: </a>    <span class="php-keyword1">else</span>
<a href="#279" id="279" class="l"> 279: </a>    {
<a href="#280" id="280" class="l"> 280: </a>        <span class="php-var">$contents</span> = <span class="php-quote">&quot;&lt;!DOCTYPE html PUBLIC \&quot;-//W3C//DTD XHTML 1.0 Transitional//EN\&quot; \&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\&quot;&gt;\n&quot;</span>.<span class="php-var">$contents</span>;
<a href="#281" id="281" class="l"> 281: </a>    }
<a href="#282" id="282" class="l"> 282: </a>    
<a href="#283" id="283" class="l"> 283: </a>    <span class="php-var">$contents</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;&lt;html&quot;</span>, <span class="php-quote">&quot;&lt;html xmlns=\&quot;http://www.w3.org/1999/xhtml\&quot;&quot;</span>, <span class="php-var">$contents</span>); 
<a href="#284" id="284" class="l"> 284: </a>
<a href="#285" id="285" class="l"> 285: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$lang</span>-&gt;settings[<span class="php-quote">'rtl'</span>] == <span class="php-num">1</span>)
<a href="#286" id="286" class="l"> 286: </a>    {
<a href="#287" id="287" class="l"> 287: </a>        <span class="php-var">$contents</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;&lt;html&quot;</span>, <span class="php-quote">&quot;&lt;html dir=\&quot;rtl\&quot;&quot;</span>, <span class="php-var">$contents</span>);
<a href="#288" id="288" class="l"> 288: </a>    }
<a href="#289" id="289" class="l"> 289: </a>
<a href="#290" id="290" class="l"> 290: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$lang</span>-&gt;settings[<span class="php-quote">'htmllang'</span>])
<a href="#291" id="291" class="l"> 291: </a>    {
<a href="#292" id="292" class="l"> 292: </a>        <span class="php-var">$contents</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;&lt;html&quot;</span>, <span class="php-quote">&quot;&lt;html xml:lang=\&quot;&quot;</span>.<span class="php-var">$lang</span>-&gt;settings[<span class="php-quote">'htmllang'</span>].<span class="php-quote">&quot;\&quot; lang=\&quot;&quot;</span>.<span class="php-var">$lang</span>-&gt;settings[<span class="php-quote">'htmllang'</span>].<span class="php-quote">&quot;\&quot;&quot;</span>, <span class="php-var">$contents</span>);
<a href="#293" id="293" class="l"> 293: </a>    }
<a href="#294" id="294" class="l"> 294: </a>
<a href="#295" id="295" class="l"> 295: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$error_handler</span>-&gt;warnings)
<a href="#296" id="296" class="l"> 296: </a>    {
<a href="#297" id="297" class="l"> 297: </a>        <span class="php-var">$contents</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;&lt;body&gt;&quot;</span>, <span class="php-quote">&quot;&lt;body&gt;\n&quot;</span>.<span class="php-var">$error_handler</span>-&gt;show_warnings(), <span class="php-var">$contents</span>);
<a href="#298" id="298" class="l"> 298: </a>    }
<a href="#299" id="299" class="l"> 299: </a>    
<a href="#300" id="300" class="l"> 300: </a>    <span class="php-keyword1">return</span> <span class="php-var">$contents</span>;
<a href="#301" id="301" class="l"> 301: </a>}
<a href="#302" id="302" class="l"> 302: </a>
<a href="#303" id="303" class="l"> 303: </a><span class="php-comment">/**
</span><a href="#304" id="304" class="l"> 304: </a><span class="php-comment"> * Turn a unix timestamp in to a &quot;friendly&quot; date/time format for the user.
</span><a href="#305" id="305" class="l"> 305: </a><span class="php-comment"> *
</span><a href="#306" id="306" class="l"> 306: </a><span class="php-comment"> * @param string A date format according to PHP's date structure.
</span><a href="#307" id="307" class="l"> 307: </a><span class="php-comment"> * @param int The unix timestamp the date should be generated for.
</span><a href="#308" id="308" class="l"> 308: </a><span class="php-comment"> * @param int The offset in hours that should be applied to times. (timezones)
</span><a href="#309" id="309" class="l"> 309: </a><span class="php-comment"> * @param int Whether or not to use today/yesterday formatting.
</span><a href="#310" id="310" class="l"> 310: </a><span class="php-comment"> * @param boolean Whether or not to use the adodb time class for &lt; 1970 or &gt; 2038 times
</span><a href="#311" id="311" class="l"> 311: </a><span class="php-comment"> * @return string The formatted timestamp.
</span><a href="#312" id="312" class="l"> 312: </a><span class="php-comment"> */</span>
<a href="#313" id="313" class="l"> 313: </a><span class="php-keyword1">function</span> my_date(<span class="php-var">$format</span>, <span class="php-var">$stamp</span>=<span class="php-quote">&quot;&quot;</span>, <span class="php-var">$offset</span>=<span class="php-quote">&quot;&quot;</span>, <span class="php-var">$ty</span>=<span class="php-num">1</span>, <span class="php-var">$adodb</span>=<span class="php-keyword1">false</span>)
<a href="#314" id="314" class="l"> 314: </a>{
<a href="#315" id="315" class="l"> 315: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>, <span class="php-var">$lang</span>, <span class="php-var">$mybbadmin</span>, <span class="php-var">$plugins</span>;
<a href="#316" id="316" class="l"> 316: </a>
<a href="#317" id="317" class="l"> 317: </a>    <span class="php-comment">// If the stamp isn't set, use TIME_NOW</span>
<a href="#318" id="318" class="l"> 318: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword1">empty</span>(<span class="php-var">$stamp</span>))
<a href="#319" id="319" class="l"> 319: </a>    {
<a href="#320" id="320" class="l"> 320: </a>        <span class="php-var">$stamp</span> = TIME_NOW;
<a href="#321" id="321" class="l"> 321: </a>    }
<a href="#322" id="322" class="l"> 322: </a>
<a href="#323" id="323" class="l"> 323: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$offset</span> &amp;&amp; <span class="php-var">$offset</span> != <span class="php-quote">'0'</span>)
<a href="#324" id="324" class="l"> 324: </a>    {
<a href="#325" id="325" class="l"> 325: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'uid'</span>] != <span class="php-num">0</span> &amp;&amp; <span class="php-keyword2">array_key_exists</span>(<span class="php-quote">&quot;timezone&quot;</span>, <span class="php-var">$mybb</span>-&gt;user))
<a href="#326" id="326" class="l"> 326: </a>        {
<a href="#327" id="327" class="l"> 327: </a>            <span class="php-var">$offset</span> = <span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'timezone'</span>];
<a href="#328" id="328" class="l"> 328: </a>            <span class="php-var">$dstcorrection</span> = <span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'dst'</span>];
<a href="#329" id="329" class="l"> 329: </a>        }
<a href="#330" id="330" class="l"> 330: </a>        <span class="php-keyword1">elseif</span>(<span class="php-keyword2">defined</span>(<span class="php-quote">&quot;IN_ADMINCP&quot;</span>))
<a href="#331" id="331" class="l"> 331: </a>        {
<a href="#332" id="332" class="l"> 332: </a>            <span class="php-var">$offset</span> =  <span class="php-var">$mybbadmin</span>[<span class="php-quote">'timezone'</span>];
<a href="#333" id="333" class="l"> 333: </a>            <span class="php-var">$dstcorrection</span> = <span class="php-var">$mybbadmin</span>[<span class="php-quote">'dst'</span>];
<a href="#334" id="334" class="l"> 334: </a>        }
<a href="#335" id="335" class="l"> 335: </a>        <span class="php-keyword1">else</span>
<a href="#336" id="336" class="l"> 336: </a>        {
<a href="#337" id="337" class="l"> 337: </a>            <span class="php-var">$offset</span> = <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'timezoneoffset'</span>];
<a href="#338" id="338" class="l"> 338: </a>            <span class="php-var">$dstcorrection</span> = <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'dstcorrection'</span>];
<a href="#339" id="339" class="l"> 339: </a>        }
<a href="#340" id="340" class="l"> 340: </a>
<a href="#341" id="341" class="l"> 341: </a>        <span class="php-comment">// If DST correction is enabled, add an additional hour to the timezone.</span>
<a href="#342" id="342" class="l"> 342: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$dstcorrection</span> == <span class="php-num">1</span>)
<a href="#343" id="343" class="l"> 343: </a>        {
<a href="#344" id="344" class="l"> 344: </a>            ++<span class="php-var">$offset</span>;
<a href="#345" id="345" class="l"> 345: </a>            <span class="php-keyword1">if</span>(my_substr(<span class="php-var">$offset</span>, <span class="php-num">0</span>, <span class="php-num">1</span>) != <span class="php-quote">&quot;-&quot;</span>)
<a href="#346" id="346" class="l"> 346: </a>            {
<a href="#347" id="347" class="l"> 347: </a>                <span class="php-var">$offset</span> = <span class="php-quote">&quot;+&quot;</span>.<span class="php-var">$offset</span>;
<a href="#348" id="348" class="l"> 348: </a>            }
<a href="#349" id="349" class="l"> 349: </a>        }
<a href="#350" id="350" class="l"> 350: </a>    }
<a href="#351" id="351" class="l"> 351: </a>
<a href="#352" id="352" class="l"> 352: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$offset</span> == <span class="php-quote">&quot;-&quot;</span>)
<a href="#353" id="353" class="l"> 353: </a>    {
<a href="#354" id="354" class="l"> 354: </a>        <span class="php-var">$offset</span> = <span class="php-num">0</span>;
<a href="#355" id="355" class="l"> 355: </a>    }
<a href="#356" id="356" class="l"> 356: </a>    
<a href="#357" id="357" class="l"> 357: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$adodb</span> == <span class="php-keyword1">true</span> &amp;&amp; <span class="php-keyword2">function_exists</span>(<span class="php-quote">'adodb_date'</span>))
<a href="#358" id="358" class="l"> 358: </a>    {
<a href="#359" id="359" class="l"> 359: </a>        <span class="php-var">$date</span> = adodb_date(<span class="php-var">$format</span>, <span class="php-var">$stamp</span> + (<span class="php-var">$offset</span> * <span class="php-num">3600</span>));
<a href="#360" id="360" class="l"> 360: </a>    }
<a href="#361" id="361" class="l"> 361: </a>    <span class="php-keyword1">else</span>
<a href="#362" id="362" class="l"> 362: </a>    {
<a href="#363" id="363" class="l"> 363: </a>        <span class="php-var">$date</span> = <span class="php-keyword2">gmdate</span>(<span class="php-var">$format</span>, <span class="php-var">$stamp</span> + (<span class="php-var">$offset</span> * <span class="php-num">3600</span>));
<a href="#364" id="364" class="l"> 364: </a>    }
<a href="#365" id="365" class="l"> 365: </a>    
<a href="#366" id="366" class="l"> 366: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'dateformat'</span>] == <span class="php-var">$format</span> &amp;&amp; <span class="php-var">$ty</span>)
<a href="#367" id="367" class="l"> 367: </a>    {
<a href="#368" id="368" class="l"> 368: </a>        <span class="php-var">$stamp</span> = TIME_NOW;
<a href="#369" id="369" class="l"> 369: </a>        
<a href="#370" id="370" class="l"> 370: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$adodb</span> == <span class="php-keyword1">true</span> &amp;&amp; <span class="php-keyword2">function_exists</span>(<span class="php-quote">'adodb_date'</span>))
<a href="#371" id="371" class="l"> 371: </a>        {
<a href="#372" id="372" class="l"> 372: </a>            <span class="php-var">$todaysdate</span> = adodb_date(<span class="php-var">$format</span>, <span class="php-var">$stamp</span> + (<span class="php-var">$offset</span> * <span class="php-num">3600</span>));
<a href="#373" id="373" class="l"> 373: </a>            <span class="php-var">$yesterdaysdate</span> = adodb_date(<span class="php-var">$format</span>, (<span class="php-var">$stamp</span> - <span class="php-num">86400</span>) + (<span class="php-var">$offset</span> * <span class="php-num">3600</span>));
<a href="#374" id="374" class="l"> 374: </a>        }
<a href="#375" id="375" class="l"> 375: </a>        <span class="php-keyword1">else</span>
<a href="#376" id="376" class="l"> 376: </a>        {
<a href="#377" id="377" class="l"> 377: </a>            <span class="php-var">$todaysdate</span> = <span class="php-keyword2">gmdate</span>(<span class="php-var">$format</span>, <span class="php-var">$stamp</span> + (<span class="php-var">$offset</span> * <span class="php-num">3600</span>));
<a href="#378" id="378" class="l"> 378: </a>            <span class="php-var">$yesterdaysdate</span> = <span class="php-keyword2">gmdate</span>(<span class="php-var">$format</span>, (<span class="php-var">$stamp</span> - <span class="php-num">86400</span>) + (<span class="php-var">$offset</span> * <span class="php-num">3600</span>));
<a href="#379" id="379" class="l"> 379: </a>        }
<a href="#380" id="380" class="l"> 380: </a>
<a href="#381" id="381" class="l"> 381: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$todaysdate</span> == <span class="php-var">$date</span>)
<a href="#382" id="382" class="l"> 382: </a>        {
<a href="#383" id="383" class="l"> 383: </a>            <span class="php-var">$date</span> = <span class="php-var">$lang</span>-&gt;today;
<a href="#384" id="384" class="l"> 384: </a>        }
<a href="#385" id="385" class="l"> 385: </a>        <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(<span class="php-var">$yesterdaysdate</span> == <span class="php-var">$date</span>)
<a href="#386" id="386" class="l"> 386: </a>        {
<a href="#387" id="387" class="l"> 387: </a>            <span class="php-var">$date</span> = <span class="php-var">$lang</span>-&gt;yesterday;
<a href="#388" id="388" class="l"> 388: </a>        }
<a href="#389" id="389" class="l"> 389: </a>    }
<a href="#390" id="390" class="l"> 390: </a>
<a href="#391" id="391" class="l"> 391: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">is_object</span>(<span class="php-var">$plugins</span>))
<a href="#392" id="392" class="l"> 392: </a>    {
<a href="#393" id="393" class="l"> 393: </a>        <span class="php-var">$date</span> = <span class="php-var">$plugins</span>-&gt;run_hooks(<span class="php-quote">&quot;my_date&quot;</span>, <span class="php-var">$date</span>);
<a href="#394" id="394" class="l"> 394: </a>    }
<a href="#395" id="395" class="l"> 395: </a>
<a href="#396" id="396" class="l"> 396: </a>    <span class="php-keyword1">return</span> <span class="php-var">$date</span>;
<a href="#397" id="397" class="l"> 397: </a>}
<a href="#398" id="398" class="l"> 398: </a>
<a href="#399" id="399" class="l"> 399: </a><span class="php-comment">/**
</span><a href="#400" id="400" class="l"> 400: </a><span class="php-comment"> * Sends an email using PHP's mail function, formatting it appropriately.
</span><a href="#401" id="401" class="l"> 401: </a><span class="php-comment"> *
</span><a href="#402" id="402" class="l"> 402: </a><span class="php-comment"> * @param string Address the email should be addressed to.
</span><a href="#403" id="403" class="l"> 403: </a><span class="php-comment"> * @param string The subject of the email being sent.
</span><a href="#404" id="404" class="l"> 404: </a><span class="php-comment"> * @param string The message being sent.
</span><a href="#405" id="405" class="l"> 405: </a><span class="php-comment"> * @param string The from address of the email, if blank, the board name will be used.
</span><a href="#406" id="406" class="l"> 406: </a><span class="php-comment"> * @param string The chracter set being used to send this email.
</span><a href="#407" id="407" class="l"> 407: </a><span class="php-comment"> * @param boolean Do we wish to keep the connection to the mail server alive to send more than one message (SMTP only)
</span><a href="#408" id="408" class="l"> 408: </a><span class="php-comment"> * @param string The format of the email to be sent (text or html). text is default
</span><a href="#409" id="409" class="l"> 409: </a><span class="php-comment"> * @param string The text message of the email if being sent in html format, for email clients that don't support html
</span><a href="#410" id="410" class="l"> 410: </a><span class="php-comment"> * @param string The email address to return to. Defaults to admin return email address.
</span><a href="#411" id="411" class="l"> 411: </a><span class="php-comment"> */</span>
<a href="#412" id="412" class="l"> 412: </a><span class="php-keyword1">function</span> my_mail(<span class="php-var">$to</span>, <span class="php-var">$subject</span>, <span class="php-var">$message</span>, <span class="php-var">$from</span>=<span class="php-quote">&quot;&quot;</span>, <span class="php-var">$charset</span>=<span class="php-quote">&quot;&quot;</span>, <span class="php-var">$headers</span>=<span class="php-quote">&quot;&quot;</span>, <span class="php-var">$keep_alive</span>=<span class="php-keyword1">false</span>, <span class="php-var">$format</span>=<span class="php-quote">&quot;text&quot;</span>, <span class="php-var">$message_text</span>=<span class="php-quote">&quot;&quot;</span>, <span class="php-var">$return_email</span>=<span class="php-quote">&quot;&quot;</span>)
<a href="#413" id="413" class="l"> 413: </a>{
<a href="#414" id="414" class="l"> 414: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>;
<a href="#415" id="415" class="l"> 415: </a>    <span class="php-keyword1">static</span> <span class="php-var">$mail</span>;
<a href="#416" id="416" class="l"> 416: </a>    
<a href="#417" id="417" class="l"> 417: </a>    <span class="php-comment">// Does our object not exist? Create it</span>
<a href="#418" id="418" class="l"> 418: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_object</span>(<span class="php-var">$mail</span>))
<a href="#419" id="419" class="l"> 419: </a>    {
<a href="#420" id="420" class="l"> 420: </a>        <span class="php-keyword1">require_once</span> MYBB_ROOT.<span class="php-quote">&quot;inc/class_mailhandler.php&quot;</span>;
<a href="#421" id="421" class="l"> 421: </a>        
<a href="#422" id="422" class="l"> 422: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'mail_handler'</span>] == <span class="php-quote">'smtp'</span>)
<a href="#423" id="423" class="l"> 423: </a>        {
<a href="#424" id="424" class="l"> 424: </a>            <span class="php-keyword1">require_once</span> MYBB_ROOT.<span class="php-quote">&quot;inc/mailhandlers/smtp.php&quot;</span>;
<a href="#425" id="425" class="l"> 425: </a>            <span class="php-var">$mail</span> = <span class="php-keyword1">new</span> SmtpMail();
<a href="#426" id="426" class="l"> 426: </a>        }
<a href="#427" id="427" class="l"> 427: </a>        <span class="php-keyword1">else</span>
<a href="#428" id="428" class="l"> 428: </a>        {
<a href="#429" id="429" class="l"> 429: </a>            <span class="php-keyword1">require_once</span> MYBB_ROOT.<span class="php-quote">&quot;inc/mailhandlers/php.php&quot;</span>;
<a href="#430" id="430" class="l"> 430: </a>            <span class="php-var">$mail</span> = <span class="php-keyword1">new</span> PhpMail();
<a href="#431" id="431" class="l"> 431: </a>        }
<a href="#432" id="432" class="l"> 432: </a>    }
<a href="#433" id="433" class="l"> 433: </a>    
<a href="#434" id="434" class="l"> 434: </a>    <span class="php-comment">// Using SMTP based mail</span>
<a href="#435" id="435" class="l"> 435: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'mail_handler'</span>] == <span class="php-quote">'smtp'</span>)
<a href="#436" id="436" class="l"> 436: </a>    {
<a href="#437" id="437" class="l"> 437: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$keep_alive</span> == <span class="php-keyword1">true</span>)
<a href="#438" id="438" class="l"> 438: </a>        {
<a href="#439" id="439" class="l"> 439: </a>            <span class="php-var">$mail</span>-&gt;keep_alive = <span class="php-keyword1">true</span>;
<a href="#440" id="440" class="l"> 440: </a>        }
<a href="#441" id="441" class="l"> 441: </a>    }
<a href="#442" id="442" class="l"> 442: </a>    
<a href="#443" id="443" class="l"> 443: </a>    <span class="php-comment">// Using PHP based mail()</span>
<a href="#444" id="444" class="l"> 444: </a>    <span class="php-keyword1">else</span>
<a href="#445" id="445" class="l"> 445: </a>    {
<a href="#446" id="446" class="l"> 446: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'mail_parameters'</span>] != <span class="php-quote">''</span>)
<a href="#447" id="447" class="l"> 447: </a>        {
<a href="#448" id="448" class="l"> 448: </a>            <span class="php-var">$mail</span>-&gt;additional_parameters = <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'mail_parameters'</span>];
<a href="#449" id="449" class="l"> 449: </a>        }
<a href="#450" id="450" class="l"> 450: </a>    }
<a href="#451" id="451" class="l"> 451: </a>    
<a href="#452" id="452" class="l"> 452: </a>    <span class="php-comment">// Build and send</span>
<a href="#453" id="453" class="l"> 453: </a>    <span class="php-var">$mail</span>-&gt;build_message(<span class="php-var">$to</span>, <span class="php-var">$subject</span>, <span class="php-var">$message</span>, <span class="php-var">$from</span>, <span class="php-var">$charset</span>, <span class="php-var">$headers</span>, <span class="php-var">$format</span>, <span class="php-var">$message_text</span>, <span class="php-var">$return_email</span>);
<a href="#454" id="454" class="l"> 454: </a>    <span class="php-keyword1">return</span> <span class="php-var">$mail</span>-&gt;send();
<a href="#455" id="455" class="l"> 455: </a>}
<a href="#456" id="456" class="l"> 456: </a>
<a href="#457" id="457" class="l"> 457: </a><span class="php-comment">/**
</span><a href="#458" id="458" class="l"> 458: </a><span class="php-comment"> * Generates a unique code for POST requests to prevent XSS/CSRF attacks
</span><a href="#459" id="459" class="l"> 459: </a><span class="php-comment"> *
</span><a href="#460" id="460" class="l"> 460: </a><span class="php-comment"> * @return string The generated code
</span><a href="#461" id="461" class="l"> 461: </a><span class="php-comment"> */</span>
<a href="#462" id="462" class="l"> 462: </a><span class="php-keyword1">function</span> generate_post_check()
<a href="#463" id="463" class="l"> 463: </a>{
<a href="#464" id="464" class="l"> 464: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>;
<a href="#465" id="465" class="l"> 465: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'uid'</span>])
<a href="#466" id="466" class="l"> 466: </a>    {
<a href="#467" id="467" class="l"> 467: </a>        <span class="php-keyword1">return</span> <span class="php-keyword2">md5</span>(<span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'loginkey'</span>].<span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'salt'</span>].<span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'regdate'</span>]);
<a href="#468" id="468" class="l"> 468: </a>    }
<a href="#469" id="469" class="l"> 469: </a>    <span class="php-comment">// Guests get a special string</span>
<a href="#470" id="470" class="l"> 470: </a>    <span class="php-keyword1">else</span>
<a href="#471" id="471" class="l"> 471: </a>    {
<a href="#472" id="472" class="l"> 472: </a>        <span class="php-keyword1">return</span> <span class="php-keyword2">md5</span>(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'bburl'</span>].<span class="php-var">$mybb</span>-&gt;config[<span class="php-quote">'database'</span>][<span class="php-quote">'username'</span>].<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'internal'</span>][<span class="php-quote">'encryption_key'</span>]);
<a href="#473" id="473" class="l"> 473: </a>    }
<a href="#474" id="474" class="l"> 474: </a>}
<a href="#475" id="475" class="l"> 475: </a>
<a href="#476" id="476" class="l"> 476: </a><span class="php-comment">/**
</span><a href="#477" id="477" class="l"> 477: </a><span class="php-comment"> * Verifies a POST check code is valid, if not shows an error (silently returns false on silent parameter)
</span><a href="#478" id="478" class="l"> 478: </a><span class="php-comment"> *
</span><a href="#479" id="479" class="l"> 479: </a><span class="php-comment"> * @param string The incoming POST check code
</span><a href="#480" id="480" class="l"> 480: </a><span class="php-comment"> * @param boolean Silent mode or not (silent mode will not show the error to the user but returns false)
</span><a href="#481" id="481" class="l"> 481: </a><span class="php-comment"> */</span>
<a href="#482" id="482" class="l"> 482: </a><span class="php-keyword1">function</span> verify_post_check(<span class="php-var">$code</span>, <span class="php-var">$silent</span>=<span class="php-keyword1">false</span>)
<a href="#483" id="483" class="l"> 483: </a>{
<a href="#484" id="484" class="l"> 484: </a>    <span class="php-keyword1">global</span> <span class="php-var">$lang</span>;
<a href="#485" id="485" class="l"> 485: </a>    <span class="php-keyword1">if</span>(generate_post_check() != <span class="php-var">$code</span>)
<a href="#486" id="486" class="l"> 486: </a>    {
<a href="#487" id="487" class="l"> 487: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$silent</span> == <span class="php-keyword1">true</span>)
<a href="#488" id="488" class="l"> 488: </a>        {
<a href="#489" id="489" class="l"> 489: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#490" id="490" class="l"> 490: </a>        }
<a href="#491" id="491" class="l"> 491: </a>        <span class="php-keyword1">else</span>
<a href="#492" id="492" class="l"> 492: </a>        {
<a href="#493" id="493" class="l"> 493: </a>            <span class="php-keyword1">if</span>(<span class="php-keyword2">defined</span>(<span class="php-quote">&quot;IN_ADMINCP&quot;</span>))
<a href="#494" id="494" class="l"> 494: </a>            {
<a href="#495" id="495" class="l"> 495: </a>                <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#496" id="496" class="l"> 496: </a>            }
<a href="#497" id="497" class="l"> 497: </a>            <span class="php-keyword1">else</span>
<a href="#498" id="498" class="l"> 498: </a>            {
<a href="#499" id="499" class="l"> 499: </a>                error(<span class="php-var">$lang</span>-&gt;invalid_post_code);
<a href="#500" id="500" class="l"> 500: </a>            }
<a href="#501" id="501" class="l"> 501: </a>        }
<a href="#502" id="502" class="l"> 502: </a>    }
<a href="#503" id="503" class="l"> 503: </a>    <span class="php-keyword1">else</span>
<a href="#504" id="504" class="l"> 504: </a>    {
<a href="#505" id="505" class="l"> 505: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
<a href="#506" id="506" class="l"> 506: </a>    }
<a href="#507" id="507" class="l"> 507: </a>}
<a href="#508" id="508" class="l"> 508: </a>
<a href="#509" id="509" class="l"> 509: </a><span class="php-comment">/**
</span><a href="#510" id="510" class="l"> 510: </a><span class="php-comment"> * Return a parent list for the specified forum.
</span><a href="#511" id="511" class="l"> 511: </a><span class="php-comment"> *
</span><a href="#512" id="512" class="l"> 512: </a><span class="php-comment"> * @param int The forum id to get the parent list for.
</span><a href="#513" id="513" class="l"> 513: </a><span class="php-comment"> * @return string The comma-separated parent list.
</span><a href="#514" id="514" class="l"> 514: </a><span class="php-comment"> */</span>
<a href="#515" id="515" class="l"> 515: </a><span class="php-keyword1">function</span> get_parent_list(<span class="php-var">$fid</span>)
<a href="#516" id="516" class="l"> 516: </a>{
<a href="#517" id="517" class="l"> 517: </a>    <span class="php-keyword1">global</span> <span class="php-var">$forum_cache</span>;
<a href="#518" id="518" class="l"> 518: </a>    <span class="php-keyword1">static</span> <span class="php-var">$forumarraycache</span>;
<a href="#519" id="519" class="l"> 519: </a>
<a href="#520" id="520" class="l"> 520: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$forumarraycache</span>[<span class="php-var">$fid</span>])
<a href="#521" id="521" class="l"> 521: </a>    {
<a href="#522" id="522" class="l"> 522: </a>        <span class="php-keyword1">return</span> <span class="php-var">$forumarraycache</span>[<span class="php-var">$fid</span>][<span class="php-quote">'parentlist'</span>];
<a href="#523" id="523" class="l"> 523: </a>    }
<a href="#524" id="524" class="l"> 524: </a>    <span class="php-keyword1">elseif</span>(<span class="php-var">$forum_cache</span>[<span class="php-var">$fid</span>])
<a href="#525" id="525" class="l"> 525: </a>    {
<a href="#526" id="526" class="l"> 526: </a>        <span class="php-keyword1">return</span> <span class="php-var">$forum_cache</span>[<span class="php-var">$fid</span>][<span class="php-quote">'parentlist'</span>];
<a href="#527" id="527" class="l"> 527: </a>    }
<a href="#528" id="528" class="l"> 528: </a>    <span class="php-keyword1">else</span>
<a href="#529" id="529" class="l"> 529: </a>    {
<a href="#530" id="530" class="l"> 530: </a>        cache_forums();
<a href="#531" id="531" class="l"> 531: </a>        <span class="php-keyword1">return</span> <span class="php-var">$forum_cache</span>[<span class="php-var">$fid</span>][<span class="php-quote">'parentlist'</span>];
<a href="#532" id="532" class="l"> 532: </a>    }
<a href="#533" id="533" class="l"> 533: </a>}
<a href="#534" id="534" class="l"> 534: </a>
<a href="#535" id="535" class="l"> 535: </a><span class="php-comment">/**
</span><a href="#536" id="536" class="l"> 536: </a><span class="php-comment"> * Build a parent list of a specific forum, suitable for querying
</span><a href="#537" id="537" class="l"> 537: </a><span class="php-comment"> *
</span><a href="#538" id="538" class="l"> 538: </a><span class="php-comment"> * @param int The forum ID
</span><a href="#539" id="539" class="l"> 539: </a><span class="php-comment"> * @param string The column name to add to the query
</span><a href="#540" id="540" class="l"> 540: </a><span class="php-comment"> * @param string The joiner for each forum for querying (OR | AND | etc)
</span><a href="#541" id="541" class="l"> 541: </a><span class="php-comment"> * @param string The parent list of the forum - if you have it
</span><a href="#542" id="542" class="l"> 542: </a><span class="php-comment"> * @return string The query string generated
</span><a href="#543" id="543" class="l"> 543: </a><span class="php-comment"> */</span>
<a href="#544" id="544" class="l"> 544: </a><span class="php-keyword1">function</span> build_parent_list(<span class="php-var">$fid</span>, <span class="php-var">$column</span>=<span class="php-quote">&quot;fid&quot;</span>, <span class="php-var">$joiner</span>=<span class="php-quote">&quot;OR&quot;</span>, <span class="php-var">$parentlist</span>=<span class="php-quote">&quot;&quot;</span>)
<a href="#545" id="545" class="l"> 545: </a>{
<a href="#546" id="546" class="l"> 546: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$parentlist</span>)
<a href="#547" id="547" class="l"> 547: </a>    {
<a href="#548" id="548" class="l"> 548: </a>        <span class="php-var">$parentlist</span> = get_parent_list(<span class="php-var">$fid</span>);
<a href="#549" id="549" class="l"> 549: </a>    }
<a href="#550" id="550" class="l"> 550: </a>
<a href="#551" id="551" class="l"> 551: </a>    <span class="php-var">$parentsexploded</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">&quot;,&quot;</span>, <span class="php-var">$parentlist</span>);
<a href="#552" id="552" class="l"> 552: </a>    <span class="php-var">$builtlist</span> = <span class="php-quote">&quot;(&quot;</span>;
<a href="#553" id="553" class="l"> 553: </a>    <span class="php-var">$sep</span> = <span class="php-quote">''</span>;
<a href="#554" id="554" class="l"> 554: </a>
<a href="#555" id="555" class="l"> 555: </a>    <span class="php-keyword1">foreach</span>(<span class="php-var">$parentsexploded</span> <span class="php-keyword1">as</span> <span class="php-var">$key</span> =&gt; <span class="php-var">$val</span>)
<a href="#556" id="556" class="l"> 556: </a>    {
<a href="#557" id="557" class="l"> 557: </a>        <span class="php-var">$builtlist</span> .= <span class="php-quote">&quot;</span><span class="php-var">$sep$column</span><span class="php-quote">='</span><span class="php-var">$val</span><span class="php-quote">'&quot;</span>;
<a href="#558" id="558" class="l"> 558: </a>        <span class="php-var">$sep</span> = <span class="php-quote">&quot; </span><span class="php-var">$joiner</span><span class="php-quote"> &quot;</span>;
<a href="#559" id="559" class="l"> 559: </a>    }
<a href="#560" id="560" class="l"> 560: </a>
<a href="#561" id="561" class="l"> 561: </a>    <span class="php-var">$builtlist</span> .= <span class="php-quote">&quot;)&quot;</span>;
<a href="#562" id="562" class="l"> 562: </a>
<a href="#563" id="563" class="l"> 563: </a>    <span class="php-keyword1">return</span> <span class="php-var">$builtlist</span>;
<a href="#564" id="564" class="l"> 564: </a>}
<a href="#565" id="565" class="l"> 565: </a>
<a href="#566" id="566" class="l"> 566: </a><span class="php-comment">/**
</span><a href="#567" id="567" class="l"> 567: </a><span class="php-comment"> * Load the forum cache in to memory
</span><a href="#568" id="568" class="l"> 568: </a><span class="php-comment"> *
</span><a href="#569" id="569" class="l"> 569: </a><span class="php-comment"> * @param boolean True to force a reload of the cache
</span><a href="#570" id="570" class="l"> 570: </a><span class="php-comment"> */</span>
<a href="#571" id="571" class="l"> 571: </a><span class="php-keyword1">function</span> cache_forums(<span class="php-var">$force</span>=<span class="php-keyword1">false</span>)
<a href="#572" id="572" class="l"> 572: </a>{
<a href="#573" id="573" class="l"> 573: </a>    <span class="php-keyword1">global</span> <span class="php-var">$forum_cache</span>, <span class="php-var">$cache</span>;
<a href="#574" id="574" class="l"> 574: </a>    
<a href="#575" id="575" class="l"> 575: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$force</span> == <span class="php-keyword1">true</span>)
<a href="#576" id="576" class="l"> 576: </a>    {
<a href="#577" id="577" class="l"> 577: </a>        <span class="php-var">$forum_cache</span> = <span class="php-var">$cache</span>-&gt;read(<span class="php-quote">&quot;forums&quot;</span>, <span class="php-num">1</span>);
<a href="#578" id="578" class="l"> 578: </a>        <span class="php-keyword1">return</span> <span class="php-var">$forum_cache</span>;
<a href="#579" id="579" class="l"> 579: </a>    }
<a href="#580" id="580" class="l"> 580: </a>
<a href="#581" id="581" class="l"> 581: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$forum_cache</span>)
<a href="#582" id="582" class="l"> 582: </a>    {
<a href="#583" id="583" class="l"> 583: </a>        <span class="php-var">$forum_cache</span> = <span class="php-var">$cache</span>-&gt;read(<span class="php-quote">&quot;forums&quot;</span>);
<a href="#584" id="584" class="l"> 584: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$forum_cache</span>)
<a href="#585" id="585" class="l"> 585: </a>        {
<a href="#586" id="586" class="l"> 586: </a>            <span class="php-var">$cache</span>-&gt;update_forums();
<a href="#587" id="587" class="l"> 587: </a>            <span class="php-var">$forum_cache</span> = <span class="php-var">$cache</span>-&gt;read(<span class="php-quote">&quot;forums&quot;</span>, <span class="php-num">1</span>);
<a href="#588" id="588" class="l"> 588: </a>        }
<a href="#589" id="589" class="l"> 589: </a>    }
<a href="#590" id="590" class="l"> 590: </a>    <span class="php-keyword1">return</span> <span class="php-var">$forum_cache</span>;
<a href="#591" id="591" class="l"> 591: </a>}
<a href="#592" id="592" class="l"> 592: </a>
<a href="#593" id="593" class="l"> 593: </a><span class="php-comment">/**
</span><a href="#594" id="594" class="l"> 594: </a><span class="php-comment"> * Generate an array of all child and descendant forums for a specific forum.
</span><a href="#595" id="595" class="l"> 595: </a><span class="php-comment"> *
</span><a href="#596" id="596" class="l"> 596: </a><span class="php-comment"> * @param int The forum ID
</span><a href="#597" id="597" class="l"> 597: </a><span class="php-comment"> * @param return Array of descendants
</span><a href="#598" id="598" class="l"> 598: </a><span class="php-comment"> */</span>
<a href="#599" id="599" class="l"> 599: </a><span class="php-keyword1">function</span> get_child_list(<span class="php-var">$fid</span>)
<a href="#600" id="600" class="l"> 600: </a>{
<a href="#601" id="601" class="l"> 601: </a>    <span class="php-keyword1">static</span> <span class="php-var">$forums_by_parent</span>;
<a href="#602" id="602" class="l"> 602: </a>
<a href="#603" id="603" class="l"> 603: </a>    <span class="php-var">$forums</span> = <span class="php-keyword1">array</span>();
<a href="#604" id="604" class="l"> 604: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$forums_by_parent</span>))
<a href="#605" id="605" class="l"> 605: </a>    {
<a href="#606" id="606" class="l"> 606: </a>        <span class="php-var">$forum_cache</span> = cache_forums();
<a href="#607" id="607" class="l"> 607: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$forum_cache</span> <span class="php-keyword1">as</span> <span class="php-var">$forum</span>)
<a href="#608" id="608" class="l"> 608: </a>        {
<a href="#609" id="609" class="l"> 609: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$forum</span>[<span class="php-quote">'active'</span>] != <span class="php-num">0</span>)
<a href="#610" id="610" class="l"> 610: </a>            {
<a href="#611" id="611" class="l"> 611: </a>                <span class="php-var">$forums_by_parent</span>[<span class="php-var">$forum</span>[<span class="php-quote">'pid'</span>]][<span class="php-var">$forum</span>[<span class="php-quote">'fid'</span>]] = <span class="php-var">$forum</span>;
<a href="#612" id="612" class="l"> 612: </a>            }
<a href="#613" id="613" class="l"> 613: </a>        }
<a href="#614" id="614" class="l"> 614: </a>    }
<a href="#615" id="615" class="l"> 615: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$forums_by_parent</span>[<span class="php-var">$fid</span>]))
<a href="#616" id="616" class="l"> 616: </a>    {
<a href="#617" id="617" class="l"> 617: </a>        <span class="php-keyword1">return</span>;
<a href="#618" id="618" class="l"> 618: </a>    }
<a href="#619" id="619" class="l"> 619: </a>    
<a href="#620" id="620" class="l"> 620: </a>    <span class="php-keyword1">foreach</span>(<span class="php-var">$forums_by_parent</span>[<span class="php-var">$fid</span>] <span class="php-keyword1">as</span> <span class="php-var">$forum</span>)
<a href="#621" id="621" class="l"> 621: </a>    {
<a href="#622" id="622" class="l"> 622: </a>        <span class="php-var">$forums</span>[] = <span class="php-var">$forum</span>[<span class="php-quote">'fid'</span>];
<a href="#623" id="623" class="l"> 623: </a>        <span class="php-var">$children</span> = get_child_list(<span class="php-var">$forum</span>[<span class="php-quote">'fid'</span>]);
<a href="#624" id="624" class="l"> 624: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$children</span>))
<a href="#625" id="625" class="l"> 625: </a>        {
<a href="#626" id="626" class="l"> 626: </a>            <span class="php-var">$forums</span> = <span class="php-keyword2">array_merge</span>(<span class="php-var">$forums</span>, <span class="php-var">$children</span>);
<a href="#627" id="627" class="l"> 627: </a>        }
<a href="#628" id="628" class="l"> 628: </a>    }
<a href="#629" id="629" class="l"> 629: </a>    <span class="php-keyword1">return</span> <span class="php-var">$forums</span>;
<a href="#630" id="630" class="l"> 630: </a>}
<a href="#631" id="631" class="l"> 631: </a>
<a href="#632" id="632" class="l"> 632: </a><span class="php-comment">/**
</span><a href="#633" id="633" class="l"> 633: </a><span class="php-comment"> * Produce a friendly error message page
</span><a href="#634" id="634" class="l"> 634: </a><span class="php-comment"> *
</span><a href="#635" id="635" class="l"> 635: </a><span class="php-comment"> * @param string The error message to be shown
</span><a href="#636" id="636" class="l"> 636: </a><span class="php-comment"> * @param string The title of the message shown in the title of the page and the error table
</span><a href="#637" id="637" class="l"> 637: </a><span class="php-comment"> */</span>
<a href="#638" id="638" class="l"> 638: </a><span class="php-keyword1">function</span> error(<span class="php-var">$error</span>=<span class="php-quote">&quot;&quot;</span>, <span class="php-var">$title</span>=<span class="php-quote">&quot;&quot;</span>)
<a href="#639" id="639" class="l"> 639: </a>{
<a href="#640" id="640" class="l"> 640: </a>    <span class="php-keyword1">global</span> <span class="php-var">$header</span>, <span class="php-var">$footer</span>, <span class="php-var">$theme</span>, <span class="php-var">$headerinclude</span>, <span class="php-var">$db</span>, <span class="php-var">$templates</span>, <span class="php-var">$lang</span>, <span class="php-var">$mybb</span>, <span class="php-var">$plugins</span>;
<a href="#641" id="641" class="l"> 641: </a>
<a href="#642" id="642" class="l"> 642: </a>    <span class="php-var">$error</span> = <span class="php-var">$plugins</span>-&gt;run_hooks(<span class="php-quote">&quot;error&quot;</span>, <span class="php-var">$error</span>);
<a href="#643" id="643" class="l"> 643: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$error</span>)
<a href="#644" id="644" class="l"> 644: </a>    {
<a href="#645" id="645" class="l"> 645: </a>        <span class="php-var">$error</span> = <span class="php-var">$lang</span>-&gt;unknown_error;
<a href="#646" id="646" class="l"> 646: </a>    }
<a href="#647" id="647" class="l"> 647: </a>
<a href="#648" id="648" class="l"> 648: </a>    <span class="php-comment">// AJAX error message?</span>
<a href="#649" id="649" class="l"> 649: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;input[<span class="php-quote">'ajax'</span>])
<a href="#650" id="650" class="l"> 650: </a>    {
<a href="#651" id="651" class="l"> 651: </a>        <span class="php-comment">// Send our headers.</span>
<a href="#652" id="652" class="l"> 652: </a>        @<span class="php-keyword2">header</span>(<span class="php-quote">&quot;Content-type: text/html; charset=</span><span class="php-var">{$lang-&gt;settings['charset']}</span><span class="php-quote">&quot;</span>);
<a href="#653" id="653" class="l"> 653: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;error&gt;</span><span class="php-var">{$error}</span><span class="php-quote">&lt;/error&gt;\n&quot;</span>;
<a href="#654" id="654" class="l"> 654: </a>        <span class="php-keyword1">exit</span>;
<a href="#655" id="655" class="l"> 655: </a>    }
<a href="#656" id="656" class="l"> 656: </a>
<a href="#657" id="657" class="l"> 657: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$title</span>)
<a href="#658" id="658" class="l"> 658: </a>    {
<a href="#659" id="659" class="l"> 659: </a>        <span class="php-var">$title</span> = <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'bbname'</span>];
<a href="#660" id="660" class="l"> 660: </a>    }
<a href="#661" id="661" class="l"> 661: </a>
<a href="#662" id="662" class="l"> 662: </a>    <span class="php-var">$timenow</span> = my_date(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'dateformat'</span>], TIME_NOW) . <span class="php-quote">&quot; &quot;</span> . my_date(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'timeformat'</span>], TIME_NOW);
<a href="#663" id="663" class="l"> 663: </a>    reset_breadcrumb();
<a href="#664" id="664" class="l"> 664: </a>    add_breadcrumb(<span class="php-var">$lang</span>-&gt;error);
<a href="#665" id="665" class="l"> 665: </a>
<a href="#666" id="666" class="l"> 666: </a>    <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$errorpage</span><span class="php-quote"> = \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;error&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#667" id="667" class="l"> 667: </a>    output_page(<span class="php-var">$errorpage</span>);
<a href="#668" id="668" class="l"> 668: </a>
<a href="#669" id="669" class="l"> 669: </a>    <span class="php-keyword1">exit</span>;
<a href="#670" id="670" class="l"> 670: </a>}
<a href="#671" id="671" class="l"> 671: </a>
<a href="#672" id="672" class="l"> 672: </a><span class="php-comment">/**
</span><a href="#673" id="673" class="l"> 673: </a><span class="php-comment"> * Produce an error message for displaying inline on a page
</span><a href="#674" id="674" class="l"> 674: </a><span class="php-comment"> *
</span><a href="#675" id="675" class="l"> 675: </a><span class="php-comment"> * @param array Array of errors to be shown
</span><a href="#676" id="676" class="l"> 676: </a><span class="php-comment"> * @param string The title of the error message
</span><a href="#677" id="677" class="l"> 677: </a><span class="php-comment"> * @return string The inline error HTML
</span><a href="#678" id="678" class="l"> 678: </a><span class="php-comment"> */</span>
<a href="#679" id="679" class="l"> 679: </a><span class="php-keyword1">function</span> inline_error(<span class="php-var">$errors</span>, <span class="php-var">$title</span>=<span class="php-quote">&quot;&quot;</span>)
<a href="#680" id="680" class="l"> 680: </a>{
<a href="#681" id="681" class="l"> 681: </a>    <span class="php-keyword1">global</span> <span class="php-var">$theme</span>, <span class="php-var">$mybb</span>, <span class="php-var">$db</span>, <span class="php-var">$lang</span>, <span class="php-var">$templates</span>;
<a href="#682" id="682" class="l"> 682: </a>
<a href="#683" id="683" class="l"> 683: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$title</span>)
<a href="#684" id="684" class="l"> 684: </a>    {
<a href="#685" id="685" class="l"> 685: </a>        <span class="php-var">$title</span> = <span class="php-var">$lang</span>-&gt;please_correct_errors;
<a href="#686" id="686" class="l"> 686: </a>    }
<a href="#687" id="687" class="l"> 687: </a>
<a href="#688" id="688" class="l"> 688: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$errors</span>))
<a href="#689" id="689" class="l"> 689: </a>    {
<a href="#690" id="690" class="l"> 690: </a>        <span class="php-var">$errors</span> = <span class="php-keyword1">array</span>(<span class="php-var">$errors</span>);
<a href="#691" id="691" class="l"> 691: </a>    }
<a href="#692" id="692" class="l"> 692: </a>
<a href="#693" id="693" class="l"> 693: </a>    <span class="php-comment">// AJAX error message?</span>
<a href="#694" id="694" class="l"> 694: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;input[<span class="php-quote">'ajax'</span>])
<a href="#695" id="695" class="l"> 695: </a>    {
<a href="#696" id="696" class="l"> 696: </a>        <span class="php-var">$error</span> = <span class="php-keyword2">implode</span>(<span class="php-quote">&quot;\n\n&quot;</span>, <span class="php-var">$errors</span>);
<a href="#697" id="697" class="l"> 697: </a>        <span class="php-comment">// Send our headers.</span>
<a href="#698" id="698" class="l"> 698: </a>        @<span class="php-keyword2">header</span>(<span class="php-quote">&quot;Content-type: text/html; charset=</span><span class="php-var">{$lang-&gt;settings['charset']}</span><span class="php-quote">&quot;</span>);
<a href="#699" id="699" class="l"> 699: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;error&gt;</span><span class="php-var">{$error}</span><span class="php-quote">&lt;/error&gt;\n&quot;</span>;
<a href="#700" id="700" class="l"> 700: </a>        <span class="php-keyword1">exit</span>;
<a href="#701" id="701" class="l"> 701: </a>    }
<a href="#702" id="702" class="l"> 702: </a>
<a href="#703" id="703" class="l"> 703: </a>    <span class="php-keyword1">foreach</span>(<span class="php-var">$errors</span> <span class="php-keyword1">as</span> <span class="php-var">$error</span>)
<a href="#704" id="704" class="l"> 704: </a>    {
<a href="#705" id="705" class="l"> 705: </a>        <span class="php-var">$errorlist</span> .= <span class="php-quote">&quot;&lt;li&gt;&quot;</span>.<span class="php-var">$error</span>.<span class="php-quote">&quot;&lt;/li&gt;\n&quot;</span>;
<a href="#706" id="706" class="l"> 706: </a>    }
<a href="#707" id="707" class="l"> 707: </a>
<a href="#708" id="708" class="l"> 708: </a>    <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$errors</span><span class="php-quote"> = \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;error_inline&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#709" id="709" class="l"> 709: </a>
<a href="#710" id="710" class="l"> 710: </a>    <span class="php-keyword1">return</span> <span class="php-var">$errors</span>;
<a href="#711" id="711" class="l"> 711: </a>}
<a href="#712" id="712" class="l"> 712: </a>
<a href="#713" id="713" class="l"> 713: </a><span class="php-comment">/**
</span><a href="#714" id="714" class="l"> 714: </a><span class="php-comment"> * Presents the user with a &quot;no permission&quot; page
</span><a href="#715" id="715" class="l"> 715: </a><span class="php-comment"> */</span>
<a href="#716" id="716" class="l"> 716: </a><span class="php-keyword1">function</span> error_no_permission()
<a href="#717" id="717" class="l"> 717: </a>{
<a href="#718" id="718" class="l"> 718: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>, <span class="php-var">$theme</span>, <span class="php-var">$templates</span>, <span class="php-var">$db</span>, <span class="php-var">$lang</span>, <span class="php-var">$plugins</span>, <span class="php-var">$session</span>;
<a href="#719" id="719" class="l"> 719: </a>
<a href="#720" id="720" class="l"> 720: </a>    <span class="php-var">$time</span> = TIME_NOW;
<a href="#721" id="721" class="l"> 721: </a>    <span class="php-var">$plugins</span>-&gt;run_hooks(<span class="php-quote">&quot;no_permission&quot;</span>);
<a href="#722" id="722" class="l"> 722: </a>
<a href="#723" id="723" class="l"> 723: </a>    <span class="php-var">$noperm_array</span> = <span class="php-keyword1">array</span> (
<a href="#724" id="724" class="l"> 724: </a>        <span class="php-quote">&quot;nopermission&quot;</span> =&gt; <span class="php-quote">'1'</span>,
<a href="#725" id="725" class="l"> 725: </a>        <span class="php-quote">&quot;location1&quot;</span> =&gt; <span class="php-num">0</span>,
<a href="#726" id="726" class="l"> 726: </a>        <span class="php-quote">&quot;location2&quot;</span> =&gt; <span class="php-num">0</span>
<a href="#727" id="727" class="l"> 727: </a>    );
<a href="#728" id="728" class="l"> 728: </a>
<a href="#729" id="729" class="l"> 729: </a>    <span class="php-var">$db</span>-&gt;update_query(<span class="php-quote">&quot;sessions&quot;</span>, <span class="php-var">$noperm_array</span>, <span class="php-quote">&quot;sid='</span><span class="php-var">{$session-&gt;sid}</span><span class="php-quote">'&quot;</span>, <span class="php-num">1</span>);
<a href="#730" id="730" class="l"> 730: </a>
<a href="#731" id="731" class="l"> 731: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;input[<span class="php-quote">'ajax'</span>])
<a href="#732" id="732" class="l"> 732: </a>    {
<a href="#733" id="733" class="l"> 733: </a>        <span class="php-comment">// Send our headers.</span>
<a href="#734" id="734" class="l"> 734: </a>        <span class="php-keyword2">header</span>(<span class="php-quote">&quot;Content-type: text/html; charset=</span><span class="php-var">{$lang-&gt;settings['charset']}</span><span class="php-quote">&quot;</span>);
<a href="#735" id="735" class="l"> 735: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;error&gt;</span><span class="php-var">{$lang-&gt;error_nopermission_user_ajax}</span><span class="php-quote">&lt;/error&gt;\n&quot;</span>;
<a href="#736" id="736" class="l"> 736: </a>        <span class="php-keyword1">exit</span>;
<a href="#737" id="737" class="l"> 737: </a>    }
<a href="#738" id="738" class="l"> 738: </a>
<a href="#739" id="739" class="l"> 739: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'uid'</span>])
<a href="#740" id="740" class="l"> 740: </a>    {
<a href="#741" id="741" class="l"> 741: </a>        <span class="php-var">$lang</span>-&gt;error_nopermission_user_username = <span class="php-var">$lang</span>-&gt;<span class="php-keyword2">sprintf</span>(<span class="php-var">$lang</span>-&gt;error_nopermission_user_username, <span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'username'</span>]);
<a href="#742" id="742" class="l"> 742: </a>        <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$errorpage</span><span class="php-quote"> = \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;error_nopermission_loggedin&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#743" id="743" class="l"> 743: </a>    }
<a href="#744" id="744" class="l"> 744: </a>    <span class="php-keyword1">else</span>
<a href="#745" id="745" class="l"> 745: </a>    {
<a href="#746" id="746" class="l"> 746: </a>        <span class="php-comment">// Redirect to where the user came from</span>
<a href="#747" id="747" class="l"> 747: </a>        <span class="php-var">$redirect_url</span> = <span class="php-var">$_SERVER</span>[<span class="php-quote">'PHP_SELF'</span>];
<a href="#748" id="748" class="l"> 748: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$_SERVER</span>[<span class="php-quote">'QUERY_STRING'</span>])
<a href="#749" id="749" class="l"> 749: </a>        {
<a href="#750" id="750" class="l"> 750: </a>            <span class="php-var">$redirect_url</span> .= <span class="php-quote">'?'</span>.<span class="php-var">$_SERVER</span>[<span class="php-quote">'QUERY_STRING'</span>];
<a href="#751" id="751" class="l"> 751: </a>        }
<a href="#752" id="752" class="l"> 752: </a>
<a href="#753" id="753" class="l"> 753: </a>        <span class="php-var">$redirect_url</span> = htmlspecialchars_uni(<span class="php-var">$redirect_url</span>);
<a href="#754" id="754" class="l"> 754: </a>        
<a href="#755" id="755" class="l"> 755: </a>        <span class="php-keyword1">switch</span>(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'username_method'</span>])
<a href="#756" id="756" class="l"> 756: </a>        {
<a href="#757" id="757" class="l"> 757: </a>            <span class="php-keyword1">case</span> <span class="php-num">0</span>:
<a href="#758" id="758" class="l"> 758: </a>                <span class="php-var">$lang_username</span> = <span class="php-var">$lang</span>-&gt;username;
<a href="#759" id="759" class="l"> 759: </a>                <span class="php-keyword1">break</span>;
<a href="#760" id="760" class="l"> 760: </a>            <span class="php-keyword1">case</span> <span class="php-num">1</span>:
<a href="#761" id="761" class="l"> 761: </a>                <span class="php-var">$lang_username</span> = <span class="php-var">$lang</span>-&gt;username1;
<a href="#762" id="762" class="l"> 762: </a>                <span class="php-keyword1">break</span>;
<a href="#763" id="763" class="l"> 763: </a>            <span class="php-keyword1">case</span> <span class="php-num">2</span>:
<a href="#764" id="764" class="l"> 764: </a>                <span class="php-var">$lang_username</span> = <span class="php-var">$lang</span>-&gt;username2;
<a href="#765" id="765" class="l"> 765: </a>                <span class="php-keyword1">break</span>;
<a href="#766" id="766" class="l"> 766: </a>            <span class="php-keyword1">default</span>:
<a href="#767" id="767" class="l"> 767: </a>                <span class="php-var">$lang_username</span> = <span class="php-var">$lang</span>-&gt;username;
<a href="#768" id="768" class="l"> 768: </a>                <span class="php-keyword1">break</span>;
<a href="#769" id="769" class="l"> 769: </a>        }
<a href="#770" id="770" class="l"> 770: </a>        <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$errorpage</span><span class="php-quote"> = \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;error_nopermission&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#771" id="771" class="l"> 771: </a>    }
<a href="#772" id="772" class="l"> 772: </a>
<a href="#773" id="773" class="l"> 773: </a>    error(<span class="php-var">$errorpage</span>);
<a href="#774" id="774" class="l"> 774: </a>}
<a href="#775" id="775" class="l"> 775: </a>
<a href="#776" id="776" class="l"> 776: </a><span class="php-comment">/**
</span><a href="#777" id="777" class="l"> 777: </a><span class="php-comment"> * Redirect the user to a given URL with a given message
</span><a href="#778" id="778" class="l"> 778: </a><span class="php-comment"> *
</span><a href="#779" id="779" class="l"> 779: </a><span class="php-comment"> * @param string The URL to redirect the user to
</span><a href="#780" id="780" class="l"> 780: </a><span class="php-comment"> * @param string The redirection message to be shown
</span><a href="#781" id="781" class="l"> 781: </a><span class="php-comment"> */</span>
<a href="#782" id="782" class="l"> 782: </a><span class="php-keyword1">function</span> redirect(<span class="php-var">$url</span>, <span class="php-var">$message</span>=<span class="php-quote">&quot;&quot;</span>, <span class="php-var">$title</span>=<span class="php-quote">&quot;&quot;</span>)
<a href="#783" id="783" class="l"> 783: </a>{
<a href="#784" id="784" class="l"> 784: </a>    <span class="php-keyword1">global</span> <span class="php-var">$header</span>, <span class="php-var">$footer</span>, <span class="php-var">$mybb</span>, <span class="php-var">$theme</span>, <span class="php-var">$headerinclude</span>, <span class="php-var">$templates</span>, <span class="php-var">$lang</span>, <span class="php-var">$plugins</span>;
<a href="#785" id="785" class="l"> 785: </a>
<a href="#786" id="786" class="l"> 786: </a>    <span class="php-var">$redirect_args</span> = <span class="php-keyword1">array</span>(<span class="php-quote">'url'</span> =&gt; &amp;<span class="php-var">$url</span>, <span class="php-quote">'message'</span> =&gt; &amp;<span class="php-var">$message</span>, <span class="php-quote">'title'</span> =&gt; &amp;<span class="php-var">$title</span>);
<a href="#787" id="787" class="l"> 787: </a>    
<a href="#788" id="788" class="l"> 788: </a>    <span class="php-var">$plugins</span>-&gt;run_hooks(<span class="php-quote">&quot;redirect&quot;</span>, <span class="php-var">$redirect_args</span>);
<a href="#789" id="789" class="l"> 789: </a>
<a href="#790" id="790" class="l"> 790: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;input[<span class="php-quote">'ajax'</span>])
<a href="#791" id="791" class="l"> 791: </a>    {
<a href="#792" id="792" class="l"> 792: </a>        <span class="php-comment">// Send our headers.</span>
<a href="#793" id="793" class="l"> 793: </a>        @<span class="php-keyword2">header</span>(<span class="php-quote">&quot;Content-type: text/html; charset=</span><span class="php-var">{$lang-&gt;settings['charset']}</span><span class="php-quote">&quot;</span>);
<a href="#794" id="794" class="l"> 794: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;script type=\&quot;text/javascript\&quot;&gt;\n&quot;</span>;
<a href="#795" id="795" class="l"> 795: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$message</span> != <span class="php-quote">&quot;&quot;</span>)
<a href="#796" id="796" class="l"> 796: </a>        {
<a href="#797" id="797" class="l"> 797: </a>            <span class="php-keyword1">echo</span> <span class="php-quote">'alert(&quot;'</span>.<span class="php-keyword2">addslashes</span>(<span class="php-var">$message</span>).<span class="php-quote">'&quot;);'</span>;
<a href="#798" id="798" class="l"> 798: </a>        }
<a href="#799" id="799" class="l"> 799: </a>        <span class="php-var">$url</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;#&quot;</span>, <span class="php-quote">&quot;&amp;#&quot;</span>, <span class="php-var">$url</span>);
<a href="#800" id="800" class="l"> 800: </a>        <span class="php-var">$url</span> = <span class="php-keyword2">htmlspecialchars_decode</span>(<span class="php-var">$url</span>);
<a href="#801" id="801" class="l"> 801: </a>        <span class="php-var">$url</span> = <span class="php-keyword2">str_replace</span>(<span class="php-keyword1">array</span>(<span class="php-quote">&quot;\n&quot;</span>,<span class="php-quote">&quot;\r&quot;</span>,<span class="php-quote">&quot;;&quot;</span>), <span class="php-quote">&quot;&quot;</span>, <span class="php-var">$url</span>);
<a href="#802" id="802" class="l"> 802: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">'window.location = &quot;'</span>.<span class="php-keyword2">addslashes</span>(<span class="php-var">$url</span>).<span class="php-quote">'&quot;;'</span>.<span class="php-quote">&quot;\n&quot;</span>;
<a href="#803" id="803" class="l"> 803: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;/script&gt;\n&quot;</span>;
<a href="#804" id="804" class="l"> 804: </a>        <span class="php-keyword1">exit</span>;
<a href="#805" id="805" class="l"> 805: </a>    }
<a href="#806" id="806" class="l"> 806: </a>
<a href="#807" id="807" class="l"> 807: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$message</span>)
<a href="#808" id="808" class="l"> 808: </a>    {
<a href="#809" id="809" class="l"> 809: </a>        <span class="php-var">$message</span> = <span class="php-var">$lang</span>-&gt;redirect;
<a href="#810" id="810" class="l"> 810: </a>    }
<a href="#811" id="811" class="l"> 811: </a>
<a href="#812" id="812" class="l"> 812: </a>    <span class="php-var">$time</span> = TIME_NOW;
<a href="#813" id="813" class="l"> 813: </a>    <span class="php-var">$timenow</span> = my_date(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'dateformat'</span>], <span class="php-var">$time</span>) . <span class="php-quote">&quot; &quot;</span> . my_date(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'timeformat'</span>], <span class="php-var">$time</span>);
<a href="#814" id="814" class="l"> 814: </a>
<a href="#815" id="815" class="l"> 815: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$title</span>)
<a href="#816" id="816" class="l"> 816: </a>    {
<a href="#817" id="817" class="l"> 817: </a>        <span class="php-var">$title</span> = <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'bbname'</span>];
<a href="#818" id="818" class="l"> 818: </a>    }
<a href="#819" id="819" class="l"> 819: </a>    
<a href="#820" id="820" class="l"> 820: </a>    <span class="php-comment">// Show redirects only if both ACP and UCP settings are enabled, or ACP is enabled, and user is a guest.</span>
<a href="#821" id="821" class="l"> 821: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'redirects'</span>] == <span class="php-num">1</span> &amp;&amp; (<span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'showredirect'</span>] != <span class="php-num">0</span> || !<span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'uid'</span>]))
<a href="#822" id="822" class="l"> 822: </a>    {
<a href="#823" id="823" class="l"> 823: </a>        <span class="php-var">$url</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;&amp;amp;&quot;</span>, <span class="php-quote">&quot;&amp;&quot;</span>, <span class="php-var">$url</span>);
<a href="#824" id="824" class="l"> 824: </a>        <span class="php-var">$url</span> = <span class="php-keyword2">htmlspecialchars</span>(<span class="php-var">$url</span>);
<a href="#825" id="825" class="l"> 825: </a>
<a href="#826" id="826" class="l"> 826: </a>        <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$redirectpage</span><span class="php-quote"> = \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;redirect&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#827" id="827" class="l"> 827: </a>        output_page(<span class="php-var">$redirectpage</span>);
<a href="#828" id="828" class="l"> 828: </a>    }
<a href="#829" id="829" class="l"> 829: </a>    <span class="php-keyword1">else</span>
<a href="#830" id="830" class="l"> 830: </a>    {
<a href="#831" id="831" class="l"> 831: </a>        <span class="php-var">$url</span> = <span class="php-keyword2">htmlspecialchars_decode</span>(<span class="php-var">$url</span>);
<a href="#832" id="832" class="l"> 832: </a>        <span class="php-var">$url</span> = <span class="php-keyword2">str_replace</span>(<span class="php-keyword1">array</span>(<span class="php-quote">&quot;\n&quot;</span>,<span class="php-quote">&quot;\r&quot;</span>,<span class="php-quote">&quot;;&quot;</span>), <span class="php-quote">&quot;&quot;</span>, <span class="php-var">$url</span>);
<a href="#833" id="833" class="l"> 833: </a>
<a href="#834" id="834" class="l"> 834: </a>        run_shutdown();
<a href="#835" id="835" class="l"> 835: </a>        
<a href="#836" id="836" class="l"> 836: </a>        <span class="php-keyword1">if</span>(my_substr(<span class="php-var">$url</span>, <span class="php-num">0</span>, <span class="php-num">7</span>) !== <span class="php-quote">'http://'</span> &amp;&amp; my_substr(<span class="php-var">$url</span>, <span class="php-num">0</span>, <span class="php-num">8</span>) !== <span class="php-quote">'https://'</span> &amp;&amp; my_substr(<span class="php-var">$url</span>, <span class="php-num">0</span>, <span class="php-num">1</span>) !== <span class="php-quote">'/'</span>)
<a href="#837" id="837" class="l"> 837: </a>        {
<a href="#838" id="838" class="l"> 838: </a>            <span class="php-keyword2">header</span>(<span class="php-quote">&quot;Location: </span><span class="php-var">{$mybb-&gt;settings['bburl']}</span><span class="php-quote">/</span><span class="php-var">{$url}</span><span class="php-quote">&quot;</span>);
<a href="#839" id="839" class="l"> 839: </a>        }
<a href="#840" id="840" class="l"> 840: </a>        <span class="php-keyword1">else</span>
<a href="#841" id="841" class="l"> 841: </a>        {
<a href="#842" id="842" class="l"> 842: </a>            <span class="php-keyword2">header</span>(<span class="php-quote">&quot;Location: </span><span class="php-var">{$url}</span><span class="php-quote">&quot;</span>);
<a href="#843" id="843" class="l"> 843: </a>        }
<a href="#844" id="844" class="l"> 844: </a>    }
<a href="#845" id="845" class="l"> 845: </a>
<a href="#846" id="846" class="l"> 846: </a>    <span class="php-keyword1">exit</span>;
<a href="#847" id="847" class="l"> 847: </a>}
<a href="#848" id="848" class="l"> 848: </a>
<a href="#849" id="849" class="l"> 849: </a><span class="php-comment">/**
</span><a href="#850" id="850" class="l"> 850: </a><span class="php-comment"> * Generate a listing of page - pagination
</span><a href="#851" id="851" class="l"> 851: </a><span class="php-comment"> *
</span><a href="#852" id="852" class="l"> 852: </a><span class="php-comment"> * @param int The number of items
</span><a href="#853" id="853" class="l"> 853: </a><span class="php-comment"> * @param int The number of items to be shown per page
</span><a href="#854" id="854" class="l"> 854: </a><span class="php-comment"> * @param int The current page number
</span><a href="#855" id="855" class="l"> 855: </a><span class="php-comment"> * @param string The URL to have page numbers tacked on to (If {page} is specified, the value will be replaced with the page #)
</span><a href="#856" id="856" class="l"> 856: </a><span class="php-comment"> * @return string The generated pagination
</span><a href="#857" id="857" class="l"> 857: </a><span class="php-comment"> */</span>
<a href="#858" id="858" class="l"> 858: </a><span class="php-keyword1">function</span> multipage(<span class="php-var">$count</span>, <span class="php-var">$perpage</span>, <span class="php-var">$page</span>, <span class="php-var">$url</span>, <span class="php-var">$breadcrumb</span>=<span class="php-keyword1">false</span>)
<a href="#859" id="859" class="l"> 859: </a>{
<a href="#860" id="860" class="l"> 860: </a>    <span class="php-keyword1">global</span> <span class="php-var">$theme</span>, <span class="php-var">$templates</span>, <span class="php-var">$lang</span>, <span class="php-var">$mybb</span>;
<a href="#861" id="861" class="l"> 861: </a>
<a href="#862" id="862" class="l"> 862: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$count</span> &lt;= <span class="php-var">$perpage</span>)
<a href="#863" id="863" class="l"> 863: </a>    {
<a href="#864" id="864" class="l"> 864: </a>        <span class="php-keyword1">return</span>;
<a href="#865" id="865" class="l"> 865: </a>    }
<a href="#866" id="866" class="l"> 866: </a>    
<a href="#867" id="867" class="l"> 867: </a>    <span class="php-var">$url</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;&amp;amp;&quot;</span>, <span class="php-quote">&quot;&amp;&quot;</span>, <span class="php-var">$url</span>);
<a href="#868" id="868" class="l"> 868: </a>    <span class="php-var">$url</span> = htmlspecialchars_uni(<span class="php-var">$url</span>);
<a href="#869" id="869" class="l"> 869: </a>
<a href="#870" id="870" class="l"> 870: </a>    <span class="php-var">$pages</span> = <span class="php-keyword2">ceil</span>(<span class="php-var">$count</span> / <span class="php-var">$perpage</span>);
<a href="#871" id="871" class="l"> 871: </a>
<a href="#872" id="872" class="l"> 872: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$page</span> &gt; <span class="php-num">1</span>)
<a href="#873" id="873" class="l"> 873: </a>    {
<a href="#874" id="874" class="l"> 874: </a>        <span class="php-var">$prev</span> = <span class="php-var">$page</span>-<span class="php-num">1</span>;
<a href="#875" id="875" class="l"> 875: </a>        <span class="php-var">$page_url</span> = fetch_page_url(<span class="php-var">$url</span>, <span class="php-var">$prev</span>);
<a href="#876" id="876" class="l"> 876: </a>        <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$prevpage</span><span class="php-quote"> = \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;multipage_prevpage&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#877" id="877" class="l"> 877: </a>    }
<a href="#878" id="878" class="l"> 878: </a>
<a href="#879" id="879" class="l"> 879: </a>    <span class="php-comment">// Maximum number of &quot;page bits&quot; to show</span>
<a href="#880" id="880" class="l"> 880: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'maxmultipagelinks'</span>])
<a href="#881" id="881" class="l"> 881: </a>    {
<a href="#882" id="882" class="l"> 882: </a>        <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'maxmultipagelinks'</span>] = <span class="php-num">5</span>;
<a href="#883" id="883" class="l"> 883: </a>    }
<a href="#884" id="884" class="l"> 884: </a>
<a href="#885" id="885" class="l"> 885: </a>    <span class="php-var">$from</span> = <span class="php-var">$page</span>-<span class="php-keyword2">floor</span>(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'maxmultipagelinks'</span>]/<span class="php-num">2</span>);
<a href="#886" id="886" class="l"> 886: </a>    <span class="php-var">$to</span> = <span class="php-var">$page</span>+<span class="php-keyword2">floor</span>(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'maxmultipagelinks'</span>]/<span class="php-num">2</span>);
<a href="#887" id="887" class="l"> 887: </a>
<a href="#888" id="888" class="l"> 888: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$from</span> &lt;= <span class="php-num">0</span>)
<a href="#889" id="889" class="l"> 889: </a>    {
<a href="#890" id="890" class="l"> 890: </a>        <span class="php-var">$from</span> = <span class="php-num">1</span>;
<a href="#891" id="891" class="l"> 891: </a>        <span class="php-var">$to</span> = <span class="php-var">$from</span>+<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'maxmultipagelinks'</span>]-<span class="php-num">1</span>;
<a href="#892" id="892" class="l"> 892: </a>    }
<a href="#893" id="893" class="l"> 893: </a>
<a href="#894" id="894" class="l"> 894: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$to</span> &gt; <span class="php-var">$pages</span>)
<a href="#895" id="895" class="l"> 895: </a>    {
<a href="#896" id="896" class="l"> 896: </a>        <span class="php-var">$to</span> = <span class="php-var">$pages</span>;
<a href="#897" id="897" class="l"> 897: </a>        <span class="php-var">$from</span> = <span class="php-var">$pages</span>-<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'maxmultipagelinks'</span>]+<span class="php-num">1</span>;
<a href="#898" id="898" class="l"> 898: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$from</span> &lt;= <span class="php-num">0</span>)
<a href="#899" id="899" class="l"> 899: </a>        {
<a href="#900" id="900" class="l"> 900: </a>            <span class="php-var">$from</span> = <span class="php-num">1</span>;
<a href="#901" id="901" class="l"> 901: </a>        }
<a href="#902" id="902" class="l"> 902: </a>    }
<a href="#903" id="903" class="l"> 903: </a>
<a href="#904" id="904" class="l"> 904: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$to</span> == <span class="php-num">0</span>)
<a href="#905" id="905" class="l"> 905: </a>    {
<a href="#906" id="906" class="l"> 906: </a>        <span class="php-var">$to</span> = <span class="php-var">$pages</span>;
<a href="#907" id="907" class="l"> 907: </a>    }
<a href="#908" id="908" class="l"> 908: </a>
<a href="#909" id="909" class="l"> 909: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$from</span> &gt; <span class="php-num">1</span>)
<a href="#910" id="910" class="l"> 910: </a>    {
<a href="#911" id="911" class="l"> 911: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$from</span>-<span class="php-num">1</span> == <span class="php-num">1</span>)
<a href="#912" id="912" class="l"> 912: </a>        {
<a href="#913" id="913" class="l"> 913: </a>            <span class="php-var">$lang</span>-&gt;multipage_link_start = <span class="php-quote">''</span>;
<a href="#914" id="914" class="l"> 914: </a>        }
<a href="#915" id="915" class="l"> 915: </a>
<a href="#916" id="916" class="l"> 916: </a>        <span class="php-var">$page_url</span> = fetch_page_url(<span class="php-var">$url</span>, <span class="php-num">1</span>);
<a href="#917" id="917" class="l"> 917: </a>        <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$start</span><span class="php-quote"> = \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;multipage_start&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#918" id="918" class="l"> 918: </a>    }
<a href="#919" id="919" class="l"> 919: </a>
<a href="#920" id="920" class="l"> 920: </a>    <span class="php-keyword1">for</span>(<span class="php-var">$i</span> = <span class="php-var">$from</span>; <span class="php-var">$i</span> &lt;= <span class="php-var">$to</span>; ++<span class="php-var">$i</span>)
<a href="#921" id="921" class="l"> 921: </a>    {
<a href="#922" id="922" class="l"> 922: </a>        <span class="php-var">$page_url</span> = fetch_page_url(<span class="php-var">$url</span>, <span class="php-var">$i</span>);
<a href="#923" id="923" class="l"> 923: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$page</span> == <span class="php-var">$i</span>)
<a href="#924" id="924" class="l"> 924: </a>        {
<a href="#925" id="925" class="l"> 925: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$breadcrumb</span> == <span class="php-keyword1">true</span>)
<a href="#926" id="926" class="l"> 926: </a>            {
<a href="#927" id="927" class="l"> 927: </a>                <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$mppage</span><span class="php-quote"> .= \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;multipage_page_link_current&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#928" id="928" class="l"> 928: </a>            }
<a href="#929" id="929" class="l"> 929: </a>            <span class="php-keyword1">else</span>
<a href="#930" id="930" class="l"> 930: </a>            {
<a href="#931" id="931" class="l"> 931: </a>                <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$mppage</span><span class="php-quote"> .= \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;multipage_page_current&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#932" id="932" class="l"> 932: </a>            }
<a href="#933" id="933" class="l"> 933: </a>        }
<a href="#934" id="934" class="l"> 934: </a>        <span class="php-keyword1">else</span>
<a href="#935" id="935" class="l"> 935: </a>        {
<a href="#936" id="936" class="l"> 936: </a>            <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$mppage</span><span class="php-quote"> .= \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;multipage_page&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#937" id="937" class="l"> 937: </a>        }
<a href="#938" id="938" class="l"> 938: </a>    }
<a href="#939" id="939" class="l"> 939: </a>
<a href="#940" id="940" class="l"> 940: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$to</span> &lt; <span class="php-var">$pages</span>)
<a href="#941" id="941" class="l"> 941: </a>    {
<a href="#942" id="942" class="l"> 942: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$to</span>+<span class="php-num">1</span> == <span class="php-var">$pages</span>)
<a href="#943" id="943" class="l"> 943: </a>        {
<a href="#944" id="944" class="l"> 944: </a>            <span class="php-var">$lang</span>-&gt;multipage_link_end = <span class="php-quote">''</span>;
<a href="#945" id="945" class="l"> 945: </a>        }
<a href="#946" id="946" class="l"> 946: </a>
<a href="#947" id="947" class="l"> 947: </a>        <span class="php-var">$page_url</span> = fetch_page_url(<span class="php-var">$url</span>, <span class="php-var">$pages</span>);
<a href="#948" id="948" class="l"> 948: </a>        <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$end</span><span class="php-quote"> = \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;multipage_end&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#949" id="949" class="l"> 949: </a>    }
<a href="#950" id="950" class="l"> 950: </a>
<a href="#951" id="951" class="l"> 951: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$page</span> &lt; <span class="php-var">$pages</span>)
<a href="#952" id="952" class="l"> 952: </a>    {
<a href="#953" id="953" class="l"> 953: </a>        <span class="php-var">$next</span> = <span class="php-var">$page</span>+<span class="php-num">1</span>;
<a href="#954" id="954" class="l"> 954: </a>        <span class="php-var">$page_url</span> = fetch_page_url(<span class="php-var">$url</span>, <span class="php-var">$next</span>);
<a href="#955" id="955" class="l"> 955: </a>        <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$nextpage</span><span class="php-quote"> = \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;multipage_nextpage&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#956" id="956" class="l"> 956: </a>    }
<a href="#957" id="957" class="l"> 957: </a>    <span class="php-var">$lang</span>-&gt;multipage_pages = <span class="php-var">$lang</span>-&gt;<span class="php-keyword2">sprintf</span>(<span class="php-var">$lang</span>-&gt;multipage_pages, <span class="php-var">$pages</span>);
<a href="#958" id="958" class="l"> 958: </a>    
<a href="#959" id="959" class="l"> 959: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$breadcrumb</span> == <span class="php-keyword1">true</span>)
<a href="#960" id="960" class="l"> 960: </a>    {
<a href="#961" id="961" class="l"> 961: </a>        <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$multipage</span><span class="php-quote"> = \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;multipage_breadcrumb&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#962" id="962" class="l"> 962: </a>    }
<a href="#963" id="963" class="l"> 963: </a>    <span class="php-keyword1">else</span>
<a href="#964" id="964" class="l"> 964: </a>    {
<a href="#965" id="965" class="l"> 965: </a>        <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$multipage</span><span class="php-quote"> = \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;multipage&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#966" id="966" class="l"> 966: </a>    }
<a href="#967" id="967" class="l"> 967: </a>
<a href="#968" id="968" class="l"> 968: </a>    <span class="php-keyword1">return</span> <span class="php-var">$multipage</span>;
<a href="#969" id="969" class="l"> 969: </a>}
<a href="#970" id="970" class="l"> 970: </a>
<a href="#971" id="971" class="l"> 971: </a><span class="php-comment">/**
</span><a href="#972" id="972" class="l"> 972: </a><span class="php-comment"> * Generate a page URL for use by the multipage function
</span><a href="#973" id="973" class="l"> 973: </a><span class="php-comment"> *
</span><a href="#974" id="974" class="l"> 974: </a><span class="php-comment"> * @param string The URL being passed
</span><a href="#975" id="975" class="l"> 975: </a><span class="php-comment"> * @param int The page number
</span><a href="#976" id="976" class="l"> 976: </a><span class="php-comment"> */</span>
<a href="#977" id="977" class="l"> 977: </a><span class="php-keyword1">function</span> fetch_page_url(<span class="php-var">$url</span>, <span class="php-var">$page</span>)
<a href="#978" id="978" class="l"> 978: </a>{
<a href="#979" id="979" class="l"> 979: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$page</span> &lt;= <span class="php-num">1</span>)
<a href="#980" id="980" class="l"> 980: </a>    {
<a href="#981" id="981" class="l"> 981: </a>        <span class="php-var">$find</span> = <span class="php-keyword1">array</span>(
<a href="#982" id="982" class="l"> 982: </a>            <span class="php-quote">&quot;-page-{page}&quot;</span>,
<a href="#983" id="983" class="l"> 983: </a>            <span class="php-quote">&quot;&amp;amp;page={page}&quot;</span>,
<a href="#984" id="984" class="l"> 984: </a>            <span class="php-quote">&quot;{page}&quot;</span>
<a href="#985" id="985" class="l"> 985: </a>        );
<a href="#986" id="986" class="l"> 986: </a>
<a href="#987" id="987" class="l"> 987: </a>        <span class="php-comment">// Remove &quot;Page 1&quot; to the defacto URL</span>
<a href="#988" id="988" class="l"> 988: </a>        <span class="php-var">$url</span> = <span class="php-keyword2">str_replace</span>(<span class="php-var">$find</span>, <span class="php-keyword1">array</span>(<span class="php-quote">&quot;&quot;</span>, <span class="php-quote">&quot;&quot;</span>, <span class="php-var">$page</span>), <span class="php-var">$url</span>);
<a href="#989" id="989" class="l"> 989: </a>        <span class="php-keyword1">return</span> <span class="php-var">$url</span>;
<a href="#990" id="990" class="l"> 990: </a>    }
<a href="#991" id="991" class="l"> 991: </a>    <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(<span class="php-keyword2">strpos</span>(<span class="php-var">$url</span>, <span class="php-quote">&quot;{page}&quot;</span>) === <span class="php-keyword1">false</span>)
<a href="#992" id="992" class="l"> 992: </a>    {
<a href="#993" id="993" class="l"> 993: </a>        <span class="php-comment">// If no page identifier is specified we tack it on to the end of the URL</span>
<a href="#994" id="994" class="l"> 994: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">strpos</span>(<span class="php-var">$url</span>, <span class="php-quote">&quot;?&quot;</span>) === <span class="php-keyword1">false</span>)
<a href="#995" id="995" class="l"> 995: </a>        {
<a href="#996" id="996" class="l"> 996: </a>            <span class="php-var">$url</span> .= <span class="php-quote">&quot;?&quot;</span>;
<a href="#997" id="997" class="l"> 997: </a>        }
<a href="#998" id="998" class="l"> 998: </a>        <span class="php-keyword1">else</span>
<a href="#999" id="999" class="l"> 999: </a>        {
<a href="#1000" id="1000" class="l">1000: </a>            <span class="php-var">$url</span> .= <span class="php-quote">&quot;&amp;amp;&quot;</span>;
<a href="#1001" id="1001" class="l">1001: </a>        }
<a href="#1002" id="1002" class="l">1002: </a>
<a href="#1003" id="1003" class="l">1003: </a>        <span class="php-var">$url</span> .= <span class="php-quote">&quot;page=</span><span class="php-var">$page</span><span class="php-quote">&quot;</span>;
<a href="#1004" id="1004" class="l">1004: </a>    }
<a href="#1005" id="1005" class="l">1005: </a>    <span class="php-keyword1">else</span>
<a href="#1006" id="1006" class="l">1006: </a>    {
<a href="#1007" id="1007" class="l">1007: </a>        <span class="php-var">$url</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{page}&quot;</span>, <span class="php-var">$page</span>, <span class="php-var">$url</span>);
<a href="#1008" id="1008" class="l">1008: </a>    }
<a href="#1009" id="1009" class="l">1009: </a>
<a href="#1010" id="1010" class="l">1010: </a>    <span class="php-keyword1">return</span> <span class="php-var">$url</span>;
<a href="#1011" id="1011" class="l">1011: </a>}
<a href="#1012" id="1012" class="l">1012: </a>
<a href="#1013" id="1013" class="l">1013: </a><span class="php-comment">/**
</span><a href="#1014" id="1014" class="l">1014: </a><span class="php-comment"> * Fetch the permissions for a specific user
</span><a href="#1015" id="1015" class="l">1015: </a><span class="php-comment"> *
</span><a href="#1016" id="1016" class="l">1016: </a><span class="php-comment"> * @param int The user ID
</span><a href="#1017" id="1017" class="l">1017: </a><span class="php-comment"> * @return array Array of user permissions for the specified user
</span><a href="#1018" id="1018" class="l">1018: </a><span class="php-comment"> */</span>
<a href="#1019" id="1019" class="l">1019: </a><span class="php-keyword1">function</span> user_permissions(<span class="php-var">$uid</span>=<span class="php-num">0</span>)
<a href="#1020" id="1020" class="l">1020: </a>{
<a href="#1021" id="1021" class="l">1021: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>, <span class="php-var">$cache</span>, <span class="php-var">$groupscache</span>, <span class="php-var">$user_cache</span>;
<a href="#1022" id="1022" class="l">1022: </a>
<a href="#1023" id="1023" class="l">1023: </a>    <span class="php-comment">// If no user id is specified, assume it is the current user</span>
<a href="#1024" id="1024" class="l">1024: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$uid</span> == <span class="php-num">0</span>)
<a href="#1025" id="1025" class="l">1025: </a>    {
<a href="#1026" id="1026" class="l">1026: </a>        <span class="php-var">$uid</span> = <span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'uid'</span>];
<a href="#1027" id="1027" class="l">1027: </a>    }
<a href="#1028" id="1028" class="l">1028: </a>
<a href="#1029" id="1029" class="l">1029: </a>    <span class="php-comment">// User id does not match current user, fetch permissions</span>
<a href="#1030" id="1030" class="l">1030: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$uid</span> != <span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'uid'</span>])
<a href="#1031" id="1031" class="l">1031: </a>    {
<a href="#1032" id="1032" class="l">1032: </a>        <span class="php-comment">// We've already cached permissions for this user, return them.</span>
<a href="#1033" id="1033" class="l">1033: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$user_cache</span>[<span class="php-var">$uid</span>][<span class="php-quote">'permissions'</span>])
<a href="#1034" id="1034" class="l">1034: </a>        {
<a href="#1035" id="1035" class="l">1035: </a>            <span class="php-keyword1">return</span> <span class="php-var">$user_cache</span>[<span class="php-var">$uid</span>][<span class="php-quote">'permissions'</span>];
<a href="#1036" id="1036" class="l">1036: </a>        }
<a href="#1037" id="1037" class="l">1037: </a>
<a href="#1038" id="1038" class="l">1038: </a>        <span class="php-comment">// This user was not already cached, fetch their user information.</span>
<a href="#1039" id="1039" class="l">1039: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$user_cache</span>[<span class="php-var">$uid</span>])
<a href="#1040" id="1040" class="l">1040: </a>        {
<a href="#1041" id="1041" class="l">1041: </a>            <span class="php-var">$user_cache</span>[<span class="php-var">$uid</span>] = get_user(<span class="php-var">$uid</span>);
<a href="#1042" id="1042" class="l">1042: </a>        }
<a href="#1043" id="1043" class="l">1043: </a>
<a href="#1044" id="1044" class="l">1044: </a>        <span class="php-comment">// Collect group permissions.</span>
<a href="#1045" id="1045" class="l">1045: </a>        <span class="php-var">$gid</span> = <span class="php-var">$user_cache</span>[<span class="php-var">$uid</span>][<span class="php-quote">'usergroup'</span>].<span class="php-quote">&quot;,&quot;</span>.<span class="php-var">$user_cache</span>[<span class="php-var">$uid</span>][<span class="php-quote">'additionalgroups'</span>];
<a href="#1046" id="1046" class="l">1046: </a>        <span class="php-var">$groupperms</span> = usergroup_permissions(<span class="php-var">$gid</span>);
<a href="#1047" id="1047" class="l">1047: </a>
<a href="#1048" id="1048" class="l">1048: </a>        <span class="php-comment">// Store group permissions in user cache.</span>
<a href="#1049" id="1049" class="l">1049: </a>        <span class="php-var">$user_cache</span>[<span class="php-var">$uid</span>][<span class="php-quote">'permissions'</span>] = <span class="php-var">$groupperms</span>;
<a href="#1050" id="1050" class="l">1050: </a>        <span class="php-keyword1">return</span> <span class="php-var">$groupperms</span>;
<a href="#1051" id="1051" class="l">1051: </a>    }
<a href="#1052" id="1052" class="l">1052: </a>    <span class="php-comment">// This user is the current user, return their permissions</span>
<a href="#1053" id="1053" class="l">1053: </a>    <span class="php-keyword1">else</span>
<a href="#1054" id="1054" class="l">1054: </a>    {
<a href="#1055" id="1055" class="l">1055: </a>        <span class="php-keyword1">return</span> <span class="php-var">$mybb</span>-&gt;usergroup;
<a href="#1056" id="1056" class="l">1056: </a>    }
<a href="#1057" id="1057" class="l">1057: </a>}
<a href="#1058" id="1058" class="l">1058: </a>
<a href="#1059" id="1059" class="l">1059: </a><span class="php-comment">/**
</span><a href="#1060" id="1060" class="l">1060: </a><span class="php-comment"> * Fetch the usergroup permissions for a specic group or series of groups combined
</span><a href="#1061" id="1061" class="l">1061: </a><span class="php-comment"> *
</span><a href="#1062" id="1062" class="l">1062: </a><span class="php-comment"> * @param mixed A list of groups (Can be a single integer, or a list of groups separated by a comma)
</span><a href="#1063" id="1063" class="l">1063: </a><span class="php-comment"> * @return array Array of permissions generated for the groups
</span><a href="#1064" id="1064" class="l">1064: </a><span class="php-comment"> */</span>
<a href="#1065" id="1065" class="l">1065: </a><span class="php-keyword1">function</span> usergroup_permissions(<span class="php-var">$gid</span>=<span class="php-num">0</span>)
<a href="#1066" id="1066" class="l">1066: </a>{
<a href="#1067" id="1067" class="l">1067: </a>    <span class="php-keyword1">global</span> <span class="php-var">$cache</span>, <span class="php-var">$groupscache</span>, <span class="php-var">$grouppermignore</span>, <span class="php-var">$groupzerogreater</span>;
<a href="#1068" id="1068" class="l">1068: </a>
<a href="#1069" id="1069" class="l">1069: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$groupscache</span>))
<a href="#1070" id="1070" class="l">1070: </a>    {
<a href="#1071" id="1071" class="l">1071: </a>        <span class="php-var">$groupscache</span> = <span class="php-var">$cache</span>-&gt;read(<span class="php-quote">&quot;usergroups&quot;</span>);
<a href="#1072" id="1072" class="l">1072: </a>    }
<a href="#1073" id="1073" class="l">1073: </a>
<a href="#1074" id="1074" class="l">1074: </a>    <span class="php-var">$groups</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">&quot;,&quot;</span>, <span class="php-var">$gid</span>);
<a href="#1075" id="1075" class="l">1075: </a>
<a href="#1076" id="1076" class="l">1076: </a>
<a href="#1077" id="1077" class="l">1077: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">count</span>(<span class="php-var">$groups</span>) == <span class="php-num">1</span>)
<a href="#1078" id="1078" class="l">1078: </a>    {
<a href="#1079" id="1079" class="l">1079: </a>        <span class="php-keyword1">return</span> <span class="php-var">$groupscache</span>[<span class="php-var">$gid</span>];
<a href="#1080" id="1080" class="l">1080: </a>    }
<a href="#1081" id="1081" class="l">1081: </a>
<a href="#1082" id="1082" class="l">1082: </a>    <span class="php-keyword1">foreach</span>(<span class="php-var">$groups</span> <span class="php-keyword1">as</span> <span class="php-var">$gid</span>)
<a href="#1083" id="1083" class="l">1083: </a>    {
<a href="#1084" id="1084" class="l">1084: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">trim</span>(<span class="php-var">$gid</span>) == <span class="php-quote">&quot;&quot;</span> || !<span class="php-var">$groupscache</span>[<span class="php-var">$gid</span>])
<a href="#1085" id="1085" class="l">1085: </a>        {
<a href="#1086" id="1086" class="l">1086: </a>            <span class="php-keyword1">continue</span>;
<a href="#1087" id="1087" class="l">1087: </a>        }
<a href="#1088" id="1088" class="l">1088: </a>
<a href="#1089" id="1089" class="l">1089: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$groupscache</span>[<span class="php-var">$gid</span>] <span class="php-keyword1">as</span> <span class="php-var">$perm</span> =&gt; <span class="php-var">$access</span>)
<a href="#1090" id="1090" class="l">1090: </a>        {
<a href="#1091" id="1091" class="l">1091: </a>            <span class="php-keyword1">if</span>(!<span class="php-keyword2">in_array</span>(<span class="php-var">$perm</span>, <span class="php-var">$grouppermignore</span>))
<a href="#1092" id="1092" class="l">1092: </a>            {
<a href="#1093" id="1093" class="l">1093: </a>                <span class="php-keyword1">if</span>(<span class="php-keyword1">isset</span>(<span class="php-var">$usergroup</span>[<span class="php-var">$perm</span>]))
<a href="#1094" id="1094" class="l">1094: </a>                {
<a href="#1095" id="1095" class="l">1095: </a>                    <span class="php-var">$permbit</span> = <span class="php-var">$usergroup</span>[<span class="php-var">$perm</span>];
<a href="#1096" id="1096" class="l">1096: </a>                }
<a href="#1097" id="1097" class="l">1097: </a>                <span class="php-keyword1">else</span>
<a href="#1098" id="1098" class="l">1098: </a>                {
<a href="#1099" id="1099" class="l">1099: </a>                    <span class="php-var">$permbit</span> = <span class="php-quote">&quot;&quot;</span>;
<a href="#1100" id="1100" class="l">1100: </a>                }
<a href="#1101" id="1101" class="l">1101: </a>
<a href="#1102" id="1102" class="l">1102: </a>                <span class="php-comment">// 0 represents unlimited for numerical group permissions (i.e. private message limit) so take that into account.</span>
<a href="#1103" id="1103" class="l">1103: </a>                <span class="php-keyword1">if</span>(<span class="php-keyword2">in_array</span>(<span class="php-var">$perm</span>, <span class="php-var">$groupzerogreater</span>) &amp;&amp; (<span class="php-var">$access</span> == <span class="php-num">0</span> || <span class="php-var">$permbit</span> === <span class="php-num">0</span>))
<a href="#1104" id="1104" class="l">1104: </a>                {
<a href="#1105" id="1105" class="l">1105: </a>                    <span class="php-var">$usergroup</span>[<span class="php-var">$perm</span>] = <span class="php-num">0</span>;
<a href="#1106" id="1106" class="l">1106: </a>                    <span class="php-keyword1">continue</span>;
<a href="#1107" id="1107" class="l">1107: </a>                } 
<a href="#1108" id="1108" class="l">1108: </a>
<a href="#1109" id="1109" class="l">1109: </a>                <span class="php-keyword1">if</span>(<span class="php-var">$access</span> &gt; <span class="php-var">$permbit</span> || (<span class="php-var">$access</span> == <span class="php-quote">&quot;yes&quot;</span> &amp;&amp; <span class="php-var">$permbit</span> == <span class="php-quote">&quot;no&quot;</span>) || !<span class="php-var">$permbit</span>) <span class="php-comment">// Keep yes/no for compatibility?</span>
<a href="#1110" id="1110" class="l">1110: </a>                {
<a href="#1111" id="1111" class="l">1111: </a>                    <span class="php-var">$usergroup</span>[<span class="php-var">$perm</span>] = <span class="php-var">$access</span>;
<a href="#1112" id="1112" class="l">1112: </a>                }
<a href="#1113" id="1113" class="l">1113: </a>            }
<a href="#1114" id="1114" class="l">1114: </a>        }
<a href="#1115" id="1115" class="l">1115: </a>    }
<a href="#1116" id="1116" class="l">1116: </a>
<a href="#1117" id="1117" class="l">1117: </a>    <span class="php-keyword1">return</span> <span class="php-var">$usergroup</span>;
<a href="#1118" id="1118" class="l">1118: </a>}
<a href="#1119" id="1119" class="l">1119: </a>
<a href="#1120" id="1120" class="l">1120: </a><span class="php-comment">/**
</span><a href="#1121" id="1121" class="l">1121: </a><span class="php-comment"> * Fetch the display group properties for a specific display group
</span><a href="#1122" id="1122" class="l">1122: </a><span class="php-comment"> *
</span><a href="#1123" id="1123" class="l">1123: </a><span class="php-comment"> * @param int The group ID to fetch the display properties for
</span><a href="#1124" id="1124" class="l">1124: </a><span class="php-comment"> * @return array Array of display properties for the group
</span><a href="#1125" id="1125" class="l">1125: </a><span class="php-comment"> */</span>
<a href="#1126" id="1126" class="l">1126: </a><span class="php-keyword1">function</span> usergroup_displaygroup(<span class="php-var">$gid</span>)
<a href="#1127" id="1127" class="l">1127: </a>{
<a href="#1128" id="1128" class="l">1128: </a>    <span class="php-keyword1">global</span> <span class="php-var">$cache</span>, <span class="php-var">$groupscache</span>, <span class="php-var">$displaygroupfields</span>;
<a href="#1129" id="1129" class="l">1129: </a>
<a href="#1130" id="1130" class="l">1130: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$groupscache</span>))
<a href="#1131" id="1131" class="l">1131: </a>    {
<a href="#1132" id="1132" class="l">1132: </a>        <span class="php-var">$groupscache</span> = <span class="php-var">$cache</span>-&gt;read(<span class="php-quote">&quot;usergroups&quot;</span>);
<a href="#1133" id="1133" class="l">1133: </a>    }
<a href="#1134" id="1134" class="l">1134: </a>
<a href="#1135" id="1135" class="l">1135: </a>    <span class="php-var">$displaygroup</span> = <span class="php-keyword1">array</span>();
<a href="#1136" id="1136" class="l">1136: </a>    <span class="php-var">$group</span> = <span class="php-var">$groupscache</span>[<span class="php-var">$gid</span>];
<a href="#1137" id="1137" class="l">1137: </a>
<a href="#1138" id="1138" class="l">1138: </a>    <span class="php-keyword1">foreach</span>(<span class="php-var">$displaygroupfields</span> <span class="php-keyword1">as</span> <span class="php-var">$field</span>)
<a href="#1139" id="1139" class="l">1139: </a>    {
<a href="#1140" id="1140" class="l">1140: </a>        <span class="php-var">$displaygroup</span>[<span class="php-var">$field</span>] = <span class="php-var">$group</span>[<span class="php-var">$field</span>];
<a href="#1141" id="1141" class="l">1141: </a>    }
<a href="#1142" id="1142" class="l">1142: </a>
<a href="#1143" id="1143" class="l">1143: </a>    <span class="php-keyword1">return</span> <span class="php-var">$displaygroup</span>;
<a href="#1144" id="1144" class="l">1144: </a>}
<a href="#1145" id="1145" class="l">1145: </a>
<a href="#1146" id="1146" class="l">1146: </a><span class="php-comment">/**
</span><a href="#1147" id="1147" class="l">1147: </a><span class="php-comment"> * Build the forum permissions for a specific forum, user or group
</span><a href="#1148" id="1148" class="l">1148: </a><span class="php-comment"> *
</span><a href="#1149" id="1149" class="l">1149: </a><span class="php-comment"> * @param int The forum ID to build permissions for (0 builds for all forums)
</span><a href="#1150" id="1150" class="l">1150: </a><span class="php-comment"> * @param int The user to build the permissions for (0 will select the uid automatically)
</span><a href="#1151" id="1151" class="l">1151: </a><span class="php-comment"> * @param int The group of the user to build permissions for (0 will fetch it)
</span><a href="#1152" id="1152" class="l">1152: </a><span class="php-comment"> * @return array Forum permissions for the specific forum or forums
</span><a href="#1153" id="1153" class="l">1153: </a><span class="php-comment"> */</span>
<a href="#1154" id="1154" class="l">1154: </a><span class="php-keyword1">function</span> forum_permissions(<span class="php-var">$fid</span>=<span class="php-num">0</span>, <span class="php-var">$uid</span>=<span class="php-num">0</span>, <span class="php-var">$gid</span>=<span class="php-num">0</span>)
<a href="#1155" id="1155" class="l">1155: </a>{
<a href="#1156" id="1156" class="l">1156: </a>    <span class="php-keyword1">global</span> <span class="php-var">$db</span>, <span class="php-var">$cache</span>, <span class="php-var">$groupscache</span>, <span class="php-var">$forum_cache</span>, <span class="php-var">$fpermcache</span>, <span class="php-var">$mybb</span>, <span class="php-var">$usercache</span>, <span class="php-var">$cached_forum_permissions_permissions</span>, <span class="php-var">$cached_forum_permissions</span>;
<a href="#1157" id="1157" class="l">1157: </a>
<a href="#1158" id="1158" class="l">1158: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$uid</span> == <span class="php-num">0</span>)
<a href="#1159" id="1159" class="l">1159: </a>    {
<a href="#1160" id="1160" class="l">1160: </a>        <span class="php-var">$uid</span> = <span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'uid'</span>];
<a href="#1161" id="1161" class="l">1161: </a>    }
<a href="#1162" id="1162" class="l">1162: </a>
<a href="#1163" id="1163" class="l">1163: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$gid</span> || <span class="php-var">$gid</span> == <span class="php-num">0</span>) <span class="php-comment">// If no group, we need to fetch it</span>
<a href="#1164" id="1164" class="l">1164: </a>    {
<a href="#1165" id="1165" class="l">1165: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$uid</span> != <span class="php-num">0</span> &amp;&amp; <span class="php-var">$uid</span> != <span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'uid'</span>])
<a href="#1166" id="1166" class="l">1166: </a>        {
<a href="#1167" id="1167" class="l">1167: </a>            <span class="php-keyword1">if</span>(!<span class="php-var">$usercache</span>[<span class="php-var">$uid</span>])
<a href="#1168" id="1168" class="l">1168: </a>            {
<a href="#1169" id="1169" class="l">1169: </a>                <span class="php-var">$query</span> = <span class="php-var">$db</span>-&gt;simple_select(<span class="php-quote">&quot;users&quot;</span>, <span class="php-quote">&quot;*&quot;</span>, <span class="php-quote">&quot;uid='</span><span class="php-var">$uid</span><span class="php-quote">'&quot;</span>);
<a href="#1170" id="1170" class="l">1170: </a>                <span class="php-var">$usercache</span>[<span class="php-var">$uid</span>] = <span class="php-var">$db</span>-&gt;fetch_array(<span class="php-var">$query</span>);
<a href="#1171" id="1171" class="l">1171: </a>            }
<a href="#1172" id="1172" class="l">1172: </a>
<a href="#1173" id="1173" class="l">1173: </a>            <span class="php-var">$gid</span> = <span class="php-var">$usercache</span>[<span class="php-var">$uid</span>][<span class="php-quote">'usergroup'</span>].<span class="php-quote">&quot;,&quot;</span>.<span class="php-var">$usercache</span>[<span class="php-var">$uid</span>][<span class="php-quote">'additionalgroups'</span>];
<a href="#1174" id="1174" class="l">1174: </a>            <span class="php-var">$groupperms</span> = usergroup_permissions(<span class="php-var">$gid</span>);
<a href="#1175" id="1175" class="l">1175: </a>        }
<a href="#1176" id="1176" class="l">1176: </a>        <span class="php-keyword1">else</span>
<a href="#1177" id="1177" class="l">1177: </a>        {
<a href="#1178" id="1178" class="l">1178: </a>            <span class="php-var">$gid</span> = <span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'usergroup'</span>];
<a href="#1179" id="1179" class="l">1179: </a>
<a href="#1180" id="1180" class="l">1180: </a>            <span class="php-keyword1">if</span>(<span class="php-keyword1">isset</span>(<span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'additionalgroups'</span>]))
<a href="#1181" id="1181" class="l">1181: </a>            {
<a href="#1182" id="1182" class="l">1182: </a>                <span class="php-var">$gid</span> .= <span class="php-quote">&quot;,&quot;</span>.<span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'additionalgroups'</span>];
<a href="#1183" id="1183" class="l">1183: </a>            }
<a href="#1184" id="1184" class="l">1184: </a>
<a href="#1185" id="1185" class="l">1185: </a>            <span class="php-var">$groupperms</span> = <span class="php-var">$mybb</span>-&gt;usergroup;
<a href="#1186" id="1186" class="l">1186: </a>        }
<a href="#1187" id="1187" class="l">1187: </a>    }
<a href="#1188" id="1188" class="l">1188: </a>
<a href="#1189" id="1189" class="l">1189: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$forum_cache</span>))
<a href="#1190" id="1190" class="l">1190: </a>    {
<a href="#1191" id="1191" class="l">1191: </a>        <span class="php-var">$forum_cache</span> = cache_forums();
<a href="#1192" id="1192" class="l">1192: </a>
<a href="#1193" id="1193" class="l">1193: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$forum_cache</span>)
<a href="#1194" id="1194" class="l">1194: </a>        {
<a href="#1195" id="1195" class="l">1195: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#1196" id="1196" class="l">1196: </a>        }
<a href="#1197" id="1197" class="l">1197: </a>    }
<a href="#1198" id="1198" class="l">1198: </a>
<a href="#1199" id="1199" class="l">1199: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$fpermcache</span>))
<a href="#1200" id="1200" class="l">1200: </a>    {
<a href="#1201" id="1201" class="l">1201: </a>        <span class="php-var">$fpermcache</span> = <span class="php-var">$cache</span>-&gt;read(<span class="php-quote">&quot;forumpermissions&quot;</span>);
<a href="#1202" id="1202" class="l">1202: </a>    }
<a href="#1203" id="1203" class="l">1203: </a>
<a href="#1204" id="1204" class="l">1204: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$fid</span>) <span class="php-comment">// Fetch the permissions for a single forum</span>
<a href="#1205" id="1205" class="l">1205: </a>    {
<a href="#1206" id="1206" class="l">1206: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$cached_forum_permissions_permissions</span>[<span class="php-var">$gid</span>][<span class="php-var">$fid</span>])
<a href="#1207" id="1207" class="l">1207: </a>        {
<a href="#1208" id="1208" class="l">1208: </a>            <span class="php-var">$cached_forum_permissions_permissions</span>[<span class="php-var">$gid</span>][<span class="php-var">$fid</span>] = fetch_forum_permissions(<span class="php-var">$fid</span>, <span class="php-var">$gid</span>, <span class="php-var">$groupperms</span>);
<a href="#1209" id="1209" class="l">1209: </a>        }
<a href="#1210" id="1210" class="l">1210: </a>        <span class="php-keyword1">return</span> <span class="php-var">$cached_forum_permissions_permissions</span>[<span class="php-var">$gid</span>][<span class="php-var">$fid</span>];
<a href="#1211" id="1211" class="l">1211: </a>    }
<a href="#1212" id="1212" class="l">1212: </a>    <span class="php-keyword1">else</span>
<a href="#1213" id="1213" class="l">1213: </a>    {
<a href="#1214" id="1214" class="l">1214: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$cached_forum_permissions</span>[<span class="php-var">$gid</span>])
<a href="#1215" id="1215" class="l">1215: </a>        {
<a href="#1216" id="1216" class="l">1216: </a>            <span class="php-keyword1">foreach</span>(<span class="php-var">$forum_cache</span> <span class="php-keyword1">as</span> <span class="php-var">$forum</span>)
<a href="#1217" id="1217" class="l">1217: </a>            {
<a href="#1218" id="1218" class="l">1218: </a>                <span class="php-var">$cached_forum_permissions</span>[<span class="php-var">$gid</span>][<span class="php-var">$forum</span>[<span class="php-quote">'fid'</span>]] = fetch_forum_permissions(<span class="php-var">$forum</span>[<span class="php-quote">'fid'</span>], <span class="php-var">$gid</span>, <span class="php-var">$groupperms</span>);
<a href="#1219" id="1219" class="l">1219: </a>            }
<a href="#1220" id="1220" class="l">1220: </a>        }
<a href="#1221" id="1221" class="l">1221: </a>        <span class="php-keyword1">return</span> <span class="php-var">$cached_forum_permissions</span>[<span class="php-var">$gid</span>];
<a href="#1222" id="1222" class="l">1222: </a>    }
<a href="#1223" id="1223" class="l">1223: </a>}
<a href="#1224" id="1224" class="l">1224: </a>
<a href="#1225" id="1225" class="l">1225: </a><span class="php-comment">/**
</span><a href="#1226" id="1226" class="l">1226: </a><span class="php-comment"> * Fetches the permissions for a specific forum/group applying the inheritance scheme.
</span><a href="#1227" id="1227" class="l">1227: </a><span class="php-comment"> * Called by forum_permissions()
</span><a href="#1228" id="1228" class="l">1228: </a><span class="php-comment"> *
</span><a href="#1229" id="1229" class="l">1229: </a><span class="php-comment"> * @param int The forum ID
</span><a href="#1230" id="1230" class="l">1230: </a><span class="php-comment"> * @param string A comma separated list of usergroups
</span><a href="#1231" id="1231" class="l">1231: </a><span class="php-comment"> * @param array Group permissions
</span><a href="#1232" id="1232" class="l">1232: </a><span class="php-comment"> * @return array Permissions for this forum
</span><a href="#1233" id="1233" class="l">1233: </a><span class="php-comment">*/</span>
<a href="#1234" id="1234" class="l">1234: </a><span class="php-keyword1">function</span> fetch_forum_permissions(<span class="php-var">$fid</span>, <span class="php-var">$gid</span>, <span class="php-var">$groupperms</span>)
<a href="#1235" id="1235" class="l">1235: </a>{
<a href="#1236" id="1236" class="l">1236: </a>    <span class="php-keyword1">global</span> <span class="php-var">$groupscache</span>, <span class="php-var">$forum_cache</span>, <span class="php-var">$fpermcache</span>, <span class="php-var">$mybb</span>, <span class="php-var">$fpermfields</span>;
<a href="#1237" id="1237" class="l">1237: </a>
<a href="#1238" id="1238" class="l">1238: </a>    <span class="php-var">$groups</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">&quot;,&quot;</span>, <span class="php-var">$gid</span>);
<a href="#1239" id="1239" class="l">1239: </a>
<a href="#1240" id="1240" class="l">1240: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$fpermcache</span>[<span class="php-var">$fid</span>]) <span class="php-comment">// This forum has no custom or inherited permissions so lets just return the group permissions</span>
<a href="#1241" id="1241" class="l">1241: </a>    {
<a href="#1242" id="1242" class="l">1242: </a>        <span class="php-keyword1">return</span> <span class="php-var">$groupperms</span>;
<a href="#1243" id="1243" class="l">1243: </a>    }
<a href="#1244" id="1244" class="l">1244: </a>    
<a href="#1245" id="1245" class="l">1245: </a>    <span class="php-var">$current_permissions</span> = <span class="php-keyword1">array</span>();
<a href="#1246" id="1246" class="l">1246: </a>    <span class="php-var">$only_view_own_threads</span> = <span class="php-num">1</span>;
<a href="#1247" id="1247" class="l">1247: </a>    
<a href="#1248" id="1248" class="l">1248: </a>    <span class="php-keyword1">foreach</span>(<span class="php-var">$groups</span> <span class="php-keyword1">as</span> <span class="php-var">$gid</span>)
<a href="#1249" id="1249" class="l">1249: </a>    {
<a href="#1250" id="1250" class="l">1250: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$groupscache</span>[<span class="php-var">$gid</span>])
<a href="#1251" id="1251" class="l">1251: </a>        {
<a href="#1252" id="1252" class="l">1252: </a>            <span class="php-var">$level_permissions</span> = <span class="php-var">$fpermcache</span>[<span class="php-var">$fid</span>][<span class="php-var">$gid</span>];
<a href="#1253" id="1253" class="l">1253: </a>            
<a href="#1254" id="1254" class="l">1254: </a>            <span class="php-comment">// If our permissions arn't inherited we need to figure them out</span>
<a href="#1255" id="1255" class="l">1255: </a>            <span class="php-keyword1">if</span>(<span class="php-keyword1">empty</span>(<span class="php-var">$level_permissions</span>))
<a href="#1256" id="1256" class="l">1256: </a>            {
<a href="#1257" id="1257" class="l">1257: </a>                <span class="php-var">$parents</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">','</span>, <span class="php-var">$forum_cache</span>[<span class="php-var">$fid</span>][<span class="php-quote">'parentlist'</span>]);
<a href="#1258" id="1258" class="l">1258: </a>                <span class="php-keyword2">rsort</span>(<span class="php-var">$parents</span>);
<a href="#1259" id="1259" class="l">1259: </a>                <span class="php-keyword1">if</span>(!<span class="php-keyword1">empty</span>(<span class="php-var">$parents</span>))
<a href="#1260" id="1260" class="l">1260: </a>                {
<a href="#1261" id="1261" class="l">1261: </a>                    <span class="php-keyword1">foreach</span>(<span class="php-var">$parents</span> <span class="php-keyword1">as</span> <span class="php-var">$parent_id</span>)
<a href="#1262" id="1262" class="l">1262: </a>                    {
<a href="#1263" id="1263" class="l">1263: </a>                        <span class="php-keyword1">if</span>(!<span class="php-keyword1">empty</span>(<span class="php-var">$fpermcache</span>[<span class="php-var">$parent_id</span>][<span class="php-var">$gid</span>]))
<a href="#1264" id="1264" class="l">1264: </a>                        {
<a href="#1265" id="1265" class="l">1265: </a>                            <span class="php-var">$level_permissions</span> = <span class="php-var">$fpermcache</span>[<span class="php-var">$parent_id</span>][<span class="php-var">$gid</span>];
<a href="#1266" id="1266" class="l">1266: </a>                            <span class="php-keyword1">break</span>;
<a href="#1267" id="1267" class="l">1267: </a>                        }
<a href="#1268" id="1268" class="l">1268: </a>                    }
<a href="#1269" id="1269" class="l">1269: </a>                    
<a href="#1270" id="1270" class="l">1270: </a>                    <span class="php-comment">// If we STILL don't have forum permissions we use the usergroup itself</span>
<a href="#1271" id="1271" class="l">1271: </a>                    <span class="php-keyword1">if</span>(<span class="php-keyword1">empty</span>(<span class="php-var">$level_permissions</span>))
<a href="#1272" id="1272" class="l">1272: </a>                    {
<a href="#1273" id="1273" class="l">1273: </a>                        <span class="php-var">$level_permissions</span> = <span class="php-var">$groupscache</span>[<span class="php-var">$gid</span>];
<a href="#1274" id="1274" class="l">1274: </a>                    }                   
<a href="#1275" id="1275" class="l">1275: </a>                }
<a href="#1276" id="1276" class="l">1276: </a>            }
<a href="#1277" id="1277" class="l">1277: </a>            
<a href="#1278" id="1278" class="l">1278: </a>            <span class="php-keyword1">foreach</span>(<span class="php-var">$level_permissions</span> <span class="php-keyword1">as</span> <span class="php-var">$permission</span> =&gt; <span class="php-var">$access</span>)
<a href="#1279" id="1279" class="l">1279: </a>            {
<a href="#1280" id="1280" class="l">1280: </a>                <span class="php-keyword1">if</span>(<span class="php-var">$access</span> &gt;= <span class="php-var">$current_permissions</span>[<span class="php-var">$permission</span>] || (<span class="php-var">$access</span> == <span class="php-quote">&quot;yes&quot;</span> &amp;&amp; <span class="php-var">$current_permissions</span>[<span class="php-var">$permission</span>] == <span class="php-quote">&quot;no&quot;</span>) || !<span class="php-var">$current_permissions</span>[<span class="php-var">$permission</span>])
<a href="#1281" id="1281" class="l">1281: </a>                {
<a href="#1282" id="1282" class="l">1282: </a>                    <span class="php-var">$current_permissions</span>[<span class="php-var">$permission</span>] = <span class="php-var">$access</span>;
<a href="#1283" id="1283" class="l">1283: </a>                }
<a href="#1284" id="1284" class="l">1284: </a>            }
<a href="#1285" id="1285" class="l">1285: </a>
<a href="#1286" id="1286" class="l">1286: </a>            <span class="php-keyword1">if</span>(!<span class="php-var">$level_permissions</span>[<span class="php-quote">&quot;canonlyviewownthreads&quot;</span>])
<a href="#1287" id="1287" class="l">1287: </a>            {
<a href="#1288" id="1288" class="l">1288: </a>                <span class="php-var">$only_view_own_threads</span> = <span class="php-num">0</span>;
<a href="#1289" id="1289" class="l">1289: </a>            }
<a href="#1290" id="1290" class="l">1290: </a>        }
<a href="#1291" id="1291" class="l">1291: </a>    }
<a href="#1292" id="1292" class="l">1292: </a>
<a href="#1293" id="1293" class="l">1293: </a>    <span class="php-comment">// Figure out if we can view more than our own threads</span>
<a href="#1294" id="1294" class="l">1294: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$only_view_own_threads</span> == <span class="php-num">0</span>)
<a href="#1295" id="1295" class="l">1295: </a>    {
<a href="#1296" id="1296" class="l">1296: </a>        <span class="php-var">$current_permissions</span>[<span class="php-quote">&quot;canonlyviewownthreads&quot;</span>] = <span class="php-num">0</span>;
<a href="#1297" id="1297" class="l">1297: </a>    }
<a href="#1298" id="1298" class="l">1298: </a>
<a href="#1299" id="1299" class="l">1299: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">count</span>(<span class="php-var">$current_permissions</span>) == <span class="php-num">0</span>)
<a href="#1300" id="1300" class="l">1300: </a>    {
<a href="#1301" id="1301" class="l">1301: </a>        <span class="php-var">$current_permissions</span> = <span class="php-var">$groupperms</span>;
<a href="#1302" id="1302" class="l">1302: </a>    }
<a href="#1303" id="1303" class="l">1303: </a>    <span class="php-keyword1">return</span> <span class="php-var">$current_permissions</span>;
<a href="#1304" id="1304" class="l">1304: </a>}
<a href="#1305" id="1305" class="l">1305: </a>
<a href="#1306" id="1306" class="l">1306: </a><span class="php-comment">/**
</span><a href="#1307" id="1307" class="l">1307: </a><span class="php-comment"> * Check the password given on a certain forum for validity
</span><a href="#1308" id="1308" class="l">1308: </a><span class="php-comment"> *
</span><a href="#1309" id="1309" class="l">1309: </a><span class="php-comment"> * @param int The forum ID
</span><a href="#1310" id="1310" class="l">1310: </a><span class="php-comment"> * @param boolean The Parent ID
</span><a href="#1311" id="1311" class="l">1311: </a><span class="php-comment"> */</span>
<a href="#1312" id="1312" class="l">1312: </a><span class="php-keyword1">function</span> check_forum_password(<span class="php-var">$fid</span>, <span class="php-var">$pid</span>=<span class="php-num">0</span>)
<a href="#1313" id="1313" class="l">1313: </a>{
<a href="#1314" id="1314" class="l">1314: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>, <span class="php-var">$header</span>, <span class="php-var">$footer</span>, <span class="php-var">$headerinclude</span>, <span class="php-var">$theme</span>, <span class="php-var">$templates</span>, <span class="php-var">$lang</span>, <span class="php-var">$forum_cache</span>;
<a href="#1315" id="1315" class="l">1315: </a>    
<a href="#1316" id="1316" class="l">1316: </a>    <span class="php-var">$showform</span> = <span class="php-keyword1">true</span>;
<a href="#1317" id="1317" class="l">1317: </a>    
<a href="#1318" id="1318" class="l">1318: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$forum_cache</span>))
<a href="#1319" id="1319" class="l">1319: </a>    {
<a href="#1320" id="1320" class="l">1320: </a>        <span class="php-var">$forum_cache</span> = cache_forums();
<a href="#1321" id="1321" class="l">1321: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$forum_cache</span>)
<a href="#1322" id="1322" class="l">1322: </a>        {
<a href="#1323" id="1323" class="l">1323: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#1324" id="1324" class="l">1324: </a>        }
<a href="#1325" id="1325" class="l">1325: </a>    }
<a href="#1326" id="1326" class="l">1326: </a>
<a href="#1327" id="1327" class="l">1327: </a>    <span class="php-comment">// Loop through each of parent forums to ensure we have a password for them too</span>
<a href="#1328" id="1328" class="l">1328: </a>    <span class="php-var">$parents</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">','</span>, <span class="php-var">$forum_cache</span>[<span class="php-var">$fid</span>][<span class="php-quote">'parentlist'</span>]);
<a href="#1329" id="1329" class="l">1329: </a>    <span class="php-keyword2">rsort</span>(<span class="php-var">$parents</span>);
<a href="#1330" id="1330" class="l">1330: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword1">empty</span>(<span class="php-var">$parents</span>))
<a href="#1331" id="1331" class="l">1331: </a>    {
<a href="#1332" id="1332" class="l">1332: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$parents</span> <span class="php-keyword1">as</span> <span class="php-var">$parent_id</span>)
<a href="#1333" id="1333" class="l">1333: </a>        {
<a href="#1334" id="1334" class="l">1334: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$parent_id</span> == <span class="php-var">$fid</span> || <span class="php-var">$parent_id</span> == <span class="php-var">$pid</span>)
<a href="#1335" id="1335" class="l">1335: </a>            {
<a href="#1336" id="1336" class="l">1336: </a>                <span class="php-keyword1">continue</span>;
<a href="#1337" id="1337" class="l">1337: </a>            }
<a href="#1338" id="1338" class="l">1338: </a>            
<a href="#1339" id="1339" class="l">1339: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$forum_cache</span>[<span class="php-var">$parent_id</span>][<span class="php-quote">'password'</span>] != <span class="php-quote">&quot;&quot;</span>)
<a href="#1340" id="1340" class="l">1340: </a>            {
<a href="#1341" id="1341" class="l">1341: </a>                check_forum_password(<span class="php-var">$parent_id</span>, <span class="php-var">$fid</span>);
<a href="#1342" id="1342" class="l">1342: </a>            }
<a href="#1343" id="1343" class="l">1343: </a>        }
<a href="#1344" id="1344" class="l">1344: </a>    }
<a href="#1345" id="1345" class="l">1345: </a>    
<a href="#1346" id="1346" class="l">1346: </a>    <span class="php-var">$password</span> = <span class="php-var">$forum_cache</span>[<span class="php-var">$fid</span>][<span class="php-quote">'password'</span>];
<a href="#1347" id="1347" class="l">1347: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$password</span>)
<a href="#1348" id="1348" class="l">1348: </a>    {
<a href="#1349" id="1349" class="l">1349: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;input[<span class="php-quote">'pwverify'</span>] &amp;&amp; <span class="php-var">$pid</span> == <span class="php-num">0</span>)
<a href="#1350" id="1350" class="l">1350: </a>        {
<a href="#1351" id="1351" class="l">1351: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$password</span> == <span class="php-var">$mybb</span>-&gt;input[<span class="php-quote">'pwverify'</span>])
<a href="#1352" id="1352" class="l">1352: </a>            {
<a href="#1353" id="1353" class="l">1353: </a>                my_setcookie(<span class="php-quote">&quot;forumpass[</span><span class="php-var">$fid</span><span class="php-quote">]&quot;</span>, <span class="php-keyword2">md5</span>(<span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'uid'</span>].<span class="php-var">$mybb</span>-&gt;input[<span class="php-quote">'pwverify'</span>]), <span class="php-keyword1">null</span>, <span class="php-keyword1">true</span>);
<a href="#1354" id="1354" class="l">1354: </a>                <span class="php-var">$showform</span> = <span class="php-keyword1">false</span>;
<a href="#1355" id="1355" class="l">1355: </a>            }
<a href="#1356" id="1356" class="l">1356: </a>            <span class="php-keyword1">else</span>
<a href="#1357" id="1357" class="l">1357: </a>            {
<a href="#1358" id="1358" class="l">1358: </a>                <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$pwnote</span><span class="php-quote"> = \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;forumdisplay_password_wrongpass&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#1359" id="1359" class="l">1359: </a>                <span class="php-var">$showform</span> = <span class="php-keyword1">true</span>;
<a href="#1360" id="1360" class="l">1360: </a>            }
<a href="#1361" id="1361" class="l">1361: </a>        }
<a href="#1362" id="1362" class="l">1362: </a>        <span class="php-keyword1">else</span>
<a href="#1363" id="1363" class="l">1363: </a>        {
<a href="#1364" id="1364" class="l">1364: </a>            <span class="php-keyword1">if</span>(!<span class="php-var">$mybb</span>-&gt;cookies[<span class="php-quote">'forumpass'</span>][<span class="php-var">$fid</span>] || (<span class="php-var">$mybb</span>-&gt;cookies[<span class="php-quote">'forumpass'</span>][<span class="php-var">$fid</span>] &amp;&amp; <span class="php-keyword2">md5</span>(<span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'uid'</span>].<span class="php-var">$password</span>) != <span class="php-var">$mybb</span>-&gt;cookies[<span class="php-quote">'forumpass'</span>][<span class="php-var">$fid</span>]))
<a href="#1365" id="1365" class="l">1365: </a>            {
<a href="#1366" id="1366" class="l">1366: </a>                <span class="php-var">$showform</span> = <span class="php-keyword1">true</span>;
<a href="#1367" id="1367" class="l">1367: </a>            }
<a href="#1368" id="1368" class="l">1368: </a>            <span class="php-keyword1">else</span>
<a href="#1369" id="1369" class="l">1369: </a>            {
<a href="#1370" id="1370" class="l">1370: </a>                <span class="php-var">$showform</span> = <span class="php-keyword1">false</span>;
<a href="#1371" id="1371" class="l">1371: </a>            }
<a href="#1372" id="1372" class="l">1372: </a>        }
<a href="#1373" id="1373" class="l">1373: </a>    }
<a href="#1374" id="1374" class="l">1374: </a>    <span class="php-keyword1">else</span>
<a href="#1375" id="1375" class="l">1375: </a>    {
<a href="#1376" id="1376" class="l">1376: </a>        <span class="php-var">$showform</span> = <span class="php-keyword1">false</span>;
<a href="#1377" id="1377" class="l">1377: </a>    }
<a href="#1378" id="1378" class="l">1378: </a>
<a href="#1379" id="1379" class="l">1379: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$showform</span>)
<a href="#1380" id="1380" class="l">1380: </a>    {
<a href="#1381" id="1381" class="l">1381: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$pid</span>)
<a href="#1382" id="1382" class="l">1382: </a>        {
<a href="#1383" id="1383" class="l">1383: </a>            <span class="php-keyword2">header</span>(<span class="php-quote">&quot;Location: &quot;</span>.<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'bburl'</span>].<span class="php-quote">&quot;/&quot;</span>.get_forum_link(<span class="php-var">$fid</span>));
<a href="#1384" id="1384" class="l">1384: </a>        }
<a href="#1385" id="1385" class="l">1385: </a>        <span class="php-keyword1">else</span>
<a href="#1386" id="1386" class="l">1386: </a>        {
<a href="#1387" id="1387" class="l">1387: </a>            <span class="php-var">$_SERVER</span>[<span class="php-quote">'REQUEST_URI'</span>] = htmlspecialchars_uni(<span class="php-var">$_SERVER</span>[<span class="php-quote">'REQUEST_URI'</span>]);
<a href="#1388" id="1388" class="l">1388: </a>            <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$pwform</span><span class="php-quote"> = \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;forumdisplay_password&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#1389" id="1389" class="l">1389: </a>            output_page(<span class="php-var">$pwform</span>);
<a href="#1390" id="1390" class="l">1390: </a>        }
<a href="#1391" id="1391" class="l">1391: </a>        <span class="php-keyword1">exit</span>;
<a href="#1392" id="1392" class="l">1392: </a>    }
<a href="#1393" id="1393" class="l">1393: </a>}
<a href="#1394" id="1394" class="l">1394: </a>
<a href="#1395" id="1395" class="l">1395: </a><span class="php-comment">/**
</span><a href="#1396" id="1396" class="l">1396: </a><span class="php-comment"> * Return the permissions for a moderator in a specific forum
</span><a href="#1397" id="1397" class="l">1397: </a><span class="php-comment"> *
</span><a href="#1398" id="1398" class="l">1398: </a><span class="php-comment"> * @param fid The forum ID
</span><a href="#1399" id="1399" class="l">1399: </a><span class="php-comment"> * @param uid The user ID to fetch permissions for (0 assumes current logged in user)
</span><a href="#1400" id="1400" class="l">1400: </a><span class="php-comment"> * @param string The parent list for the forum (if blank, will be fetched)
</span><a href="#1401" id="1401" class="l">1401: </a><span class="php-comment"> * @return array Array of moderator permissions for the specific forum
</span><a href="#1402" id="1402" class="l">1402: </a><span class="php-comment"> */</span>
<a href="#1403" id="1403" class="l">1403: </a><span class="php-keyword1">function</span> get_moderator_permissions(<span class="php-var">$fid</span>, <span class="php-var">$uid</span>=<span class="php-quote">&quot;0&quot;</span>, <span class="php-var">$parentslist</span>=<span class="php-quote">&quot;&quot;</span>)
<a href="#1404" id="1404" class="l">1404: </a>{
<a href="#1405" id="1405" class="l">1405: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>, <span class="php-var">$cache</span>, <span class="php-var">$db</span>;
<a href="#1406" id="1406" class="l">1406: </a>    <span class="php-keyword1">static</span> <span class="php-var">$modpermscache</span>;
<a href="#1407" id="1407" class="l">1407: </a>
<a href="#1408" id="1408" class="l">1408: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$uid</span> &lt; <span class="php-num">1</span>)
<a href="#1409" id="1409" class="l">1409: </a>    {
<a href="#1410" id="1410" class="l">1410: </a>        <span class="php-var">$uid</span> = <span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'uid'</span>];
<a href="#1411" id="1411" class="l">1411: </a>    }
<a href="#1412" id="1412" class="l">1412: </a>    
<a href="#1413" id="1413" class="l">1413: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$uid</span> == <span class="php-num">0</span>)
<a href="#1414" id="1414" class="l">1414: </a>    {
<a href="#1415" id="1415" class="l">1415: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#1416" id="1416" class="l">1416: </a>    }
<a href="#1417" id="1417" class="l">1417: </a>
<a href="#1418" id="1418" class="l">1418: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword1">isset</span>(<span class="php-var">$modpermscache</span>[<span class="php-var">$fid</span>][<span class="php-var">$uid</span>]))
<a href="#1419" id="1419" class="l">1419: </a>    {
<a href="#1420" id="1420" class="l">1420: </a>        <span class="php-keyword1">return</span> <span class="php-var">$modpermscache</span>[<span class="php-var">$fid</span>][<span class="php-var">$uid</span>];
<a href="#1421" id="1421" class="l">1421: </a>    }
<a href="#1422" id="1422" class="l">1422: </a>
<a href="#1423" id="1423" class="l">1423: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$parentslist</span>)
<a href="#1424" id="1424" class="l">1424: </a>    {
<a href="#1425" id="1425" class="l">1425: </a>        <span class="php-var">$parentslist</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">','</span>, get_parent_list(<span class="php-var">$fid</span>));
<a href="#1426" id="1426" class="l">1426: </a>    }
<a href="#1427" id="1427" class="l">1427: </a>
<a href="#1428" id="1428" class="l">1428: </a>    <span class="php-comment">// Get user groups</span>
<a href="#1429" id="1429" class="l">1429: </a>    <span class="php-var">$perms</span> = <span class="php-keyword1">array</span>();
<a href="#1430" id="1430" class="l">1430: </a>    <span class="php-var">$user</span> = get_user(<span class="php-var">$uid</span>);
<a href="#1431" id="1431" class="l">1431: </a>
<a href="#1432" id="1432" class="l">1432: </a>    <span class="php-var">$groups</span> = <span class="php-keyword1">array</span>(<span class="php-var">$user</span>[<span class="php-quote">'usergroup'</span>]);
<a href="#1433" id="1433" class="l">1433: </a>
<a href="#1434" id="1434" class="l">1434: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword1">empty</span>(<span class="php-var">$user</span>[<span class="php-quote">'additionalgroups'</span>]))
<a href="#1435" id="1435" class="l">1435: </a>    {
<a href="#1436" id="1436" class="l">1436: </a>        <span class="php-var">$extra_groups</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">&quot;,&quot;</span>, <span class="php-var">$user</span>[<span class="php-quote">'additionalgroups'</span>]);
<a href="#1437" id="1437" class="l">1437: </a>
<a href="#1438" id="1438" class="l">1438: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$extra_groups</span> <span class="php-keyword1">as</span> <span class="php-var">$extra_group</span>)
<a href="#1439" id="1439" class="l">1439: </a>        {
<a href="#1440" id="1440" class="l">1440: </a>            <span class="php-var">$groups</span>[] = <span class="php-var">$extra_group</span>;
<a href="#1441" id="1441" class="l">1441: </a>        }
<a href="#1442" id="1442" class="l">1442: </a>    }
<a href="#1443" id="1443" class="l">1443: </a>
<a href="#1444" id="1444" class="l">1444: </a>    <span class="php-var">$mod_cache</span> = <span class="php-var">$cache</span>-&gt;read(<span class="php-quote">&quot;moderators&quot;</span>);
<a href="#1445" id="1445" class="l">1445: </a>
<a href="#1446" id="1446" class="l">1446: </a>    <span class="php-keyword1">foreach</span>(<span class="php-var">$mod_cache</span> <span class="php-keyword1">as</span> <span class="php-var">$fid</span> =&gt; <span class="php-var">$forum</span>)
<a href="#1447" id="1447" class="l">1447: </a>    {
<a href="#1448" id="1448" class="l">1448: </a>        <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$forum</span>) || !<span class="php-keyword2">in_array</span>(<span class="php-var">$fid</span>, <span class="php-var">$parentslist</span>))
<a href="#1449" id="1449" class="l">1449: </a>        {
<a href="#1450" id="1450" class="l">1450: </a>            <span class="php-comment">// No perms or we're not after this forum</span>
<a href="#1451" id="1451" class="l">1451: </a>            <span class="php-keyword1">continue</span>;
<a href="#1452" id="1452" class="l">1452: </a>        }
<a href="#1453" id="1453" class="l">1453: </a>
<a href="#1454" id="1454" class="l">1454: </a>        <span class="php-comment">// User settings override usergroup settings</span>
<a href="#1455" id="1455" class="l">1455: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$forum</span>[<span class="php-quote">'users'</span>][<span class="php-var">$uid</span>]))
<a href="#1456" id="1456" class="l">1456: </a>        {
<a href="#1457" id="1457" class="l">1457: </a>            <span class="php-var">$perm</span> = <span class="php-var">$forum</span>[<span class="php-quote">'users'</span>][<span class="php-var">$uid</span>];
<a href="#1458" id="1458" class="l">1458: </a>            <span class="php-keyword1">foreach</span>(<span class="php-var">$perm</span> <span class="php-keyword1">as</span> <span class="php-var">$action</span> =&gt; <span class="php-var">$value</span>)
<a href="#1459" id="1459" class="l">1459: </a>            {
<a href="#1460" id="1460" class="l">1460: </a>                <span class="php-keyword1">if</span>(<span class="php-keyword2">strpos</span>(<span class="php-var">$action</span>, <span class="php-quote">&quot;can&quot;</span>) === <span class="php-keyword1">false</span>)
<a href="#1461" id="1461" class="l">1461: </a>                {
<a href="#1462" id="1462" class="l">1462: </a>                    <span class="php-keyword1">continue</span>;
<a href="#1463" id="1463" class="l">1463: </a>                }
<a href="#1464" id="1464" class="l">1464: </a>
<a href="#1465" id="1465" class="l">1465: </a>                <span class="php-comment">// Figure out the user permissions</span>
<a href="#1466" id="1466" class="l">1466: </a>                <span class="php-keyword1">if</span>(<span class="php-var">$value</span> == <span class="php-num">0</span>)
<a href="#1467" id="1467" class="l">1467: </a>                {
<a href="#1468" id="1468" class="l">1468: </a>                    <span class="php-comment">// The user doesn't have permission to set this action</span>
<a href="#1469" id="1469" class="l">1469: </a>                    <span class="php-var">$perms</span>[<span class="php-var">$action</span>] = <span class="php-num">0</span>;
<a href="#1470" id="1470" class="l">1470: </a>                }
<a href="#1471" id="1471" class="l">1471: </a>                <span class="php-keyword1">else</span>
<a href="#1472" id="1472" class="l">1472: </a>                {
<a href="#1473" id="1473" class="l">1473: </a>                    <span class="php-var">$perms</span>[<span class="php-var">$action</span>] = <span class="php-keyword2">max</span>(<span class="php-var">$perm</span>[<span class="php-var">$action</span>], <span class="php-var">$perms</span>[<span class="php-var">$action</span>]);
<a href="#1474" id="1474" class="l">1474: </a>                }
<a href="#1475" id="1475" class="l">1475: </a>            }
<a href="#1476" id="1476" class="l">1476: </a>        }
<a href="#1477" id="1477" class="l">1477: </a>
<a href="#1478" id="1478" class="l">1478: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$groups</span> <span class="php-keyword1">as</span> <span class="php-var">$group</span>)
<a href="#1479" id="1479" class="l">1479: </a>        {
<a href="#1480" id="1480" class="l">1480: </a>            <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$forum</span>[<span class="php-quote">'usergroups'</span>][<span class="php-var">$group</span>]))
<a href="#1481" id="1481" class="l">1481: </a>            {
<a href="#1482" id="1482" class="l">1482: </a>                <span class="php-comment">// There are no permissions set for this group</span>
<a href="#1483" id="1483" class="l">1483: </a>                <span class="php-keyword1">continue</span>;
<a href="#1484" id="1484" class="l">1484: </a>            }
<a href="#1485" id="1485" class="l">1485: </a>
<a href="#1486" id="1486" class="l">1486: </a>            <span class="php-var">$perm</span> = <span class="php-var">$forum</span>[<span class="php-quote">'usergroups'</span>][<span class="php-var">$group</span>];
<a href="#1487" id="1487" class="l">1487: </a>            <span class="php-keyword1">foreach</span>(<span class="php-var">$perm</span> <span class="php-keyword1">as</span> <span class="php-var">$action</span> =&gt; <span class="php-var">$value</span>)
<a href="#1488" id="1488" class="l">1488: </a>            {
<a href="#1489" id="1489" class="l">1489: </a>                <span class="php-keyword1">if</span>(<span class="php-keyword2">strpos</span>(<span class="php-var">$action</span>, <span class="php-quote">&quot;can&quot;</span>) === <span class="php-keyword1">false</span>)
<a href="#1490" id="1490" class="l">1490: </a>                {
<a href="#1491" id="1491" class="l">1491: </a>                    <span class="php-keyword1">continue</span>;
<a href="#1492" id="1492" class="l">1492: </a>                }
<a href="#1493" id="1493" class="l">1493: </a>
<a href="#1494" id="1494" class="l">1494: </a>                <span class="php-var">$perms</span>[<span class="php-var">$action</span>] = <span class="php-keyword2">max</span>(<span class="php-var">$perm</span>[<span class="php-var">$action</span>], <span class="php-var">$perms</span>[<span class="php-var">$action</span>]);
<a href="#1495" id="1495" class="l">1495: </a>            }
<a href="#1496" id="1496" class="l">1496: </a>        }
<a href="#1497" id="1497" class="l">1497: </a>    }
<a href="#1498" id="1498" class="l">1498: </a>
<a href="#1499" id="1499" class="l">1499: </a>    <span class="php-var">$modpermscache</span>[<span class="php-var">$fid</span>][<span class="php-var">$uid</span>] = <span class="php-var">$perms</span>;
<a href="#1500" id="1500" class="l">1500: </a>
<a href="#1501" id="1501" class="l">1501: </a>    <span class="php-keyword1">return</span> <span class="php-var">$perms</span>;
<a href="#1502" id="1502" class="l">1502: </a>}
<a href="#1503" id="1503" class="l">1503: </a>
<a href="#1504" id="1504" class="l">1504: </a><span class="php-comment">/**
</span><a href="#1505" id="1505" class="l">1505: </a><span class="php-comment"> * Checks if a moderator has permissions to perform an action in a specific forum
</span><a href="#1506" id="1506" class="l">1506: </a><span class="php-comment"> *
</span><a href="#1507" id="1507" class="l">1507: </a><span class="php-comment"> * @param int The forum ID (0 assumes global)
</span><a href="#1508" id="1508" class="l">1508: </a><span class="php-comment"> * @param string The action tyring to be performed. (blank assumes any action at all)
</span><a href="#1509" id="1509" class="l">1509: </a><span class="php-comment"> * @param int The user ID (0 assumes current user)
</span><a href="#1510" id="1510" class="l">1510: </a><span class="php-comment"> * @return bool Returns true if the user has permission, false if they do not
</span><a href="#1511" id="1511" class="l">1511: </a><span class="php-comment"> */</span>
<a href="#1512" id="1512" class="l">1512: </a><span class="php-keyword1">function</span> is_moderator(<span class="php-var">$fid</span>=<span class="php-quote">&quot;0&quot;</span>, <span class="php-var">$action</span>=<span class="php-quote">&quot;&quot;</span>, <span class="php-var">$uid</span>=<span class="php-quote">&quot;0&quot;</span>)
<a href="#1513" id="1513" class="l">1513: </a>{
<a href="#1514" id="1514" class="l">1514: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>, <span class="php-var">$cache</span>;
<a href="#1515" id="1515" class="l">1515: </a>
<a href="#1516" id="1516" class="l">1516: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$uid</span> == <span class="php-num">0</span>)
<a href="#1517" id="1517" class="l">1517: </a>    {
<a href="#1518" id="1518" class="l">1518: </a>        <span class="php-var">$uid</span> = <span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'uid'</span>];
<a href="#1519" id="1519" class="l">1519: </a>    }
<a href="#1520" id="1520" class="l">1520: </a>    
<a href="#1521" id="1521" class="l">1521: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$uid</span> == <span class="php-num">0</span>)
<a href="#1522" id="1522" class="l">1522: </a>    {
<a href="#1523" id="1523" class="l">1523: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#1524" id="1524" class="l">1524: </a>    }
<a href="#1525" id="1525" class="l">1525: </a>
<a href="#1526" id="1526" class="l">1526: </a>    <span class="php-var">$user_perms</span> = user_permissions(<span class="php-var">$uid</span>);
<a href="#1527" id="1527" class="l">1527: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$user_perms</span>[<span class="php-quote">'issupermod'</span>] == <span class="php-num">1</span>)
<a href="#1528" id="1528" class="l">1528: </a>    {
<a href="#1529" id="1529" class="l">1529: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
<a href="#1530" id="1530" class="l">1530: </a>    }
<a href="#1531" id="1531" class="l">1531: </a>    <span class="php-keyword1">else</span>
<a href="#1532" id="1532" class="l">1532: </a>    {
<a href="#1533" id="1533" class="l">1533: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$fid</span>)
<a href="#1534" id="1534" class="l">1534: </a>        {
<a href="#1535" id="1535" class="l">1535: </a>            <span class="php-var">$modcache</span> = <span class="php-var">$cache</span>-&gt;read(<span class="php-quote">'moderators'</span>);
<a href="#1536" id="1536" class="l">1536: </a>            <span class="php-keyword1">if</span>(!<span class="php-keyword1">empty</span>(<span class="php-var">$modcache</span>))
<a href="#1537" id="1537" class="l">1537: </a>            {
<a href="#1538" id="1538" class="l">1538: </a>                <span class="php-keyword1">foreach</span>(<span class="php-var">$modcache</span> <span class="php-keyword1">as</span> <span class="php-var">$modusers</span>)
<a href="#1539" id="1539" class="l">1539: </a>                {
<a href="#1540" id="1540" class="l">1540: </a>                    <span class="php-keyword1">if</span>(<span class="php-keyword1">isset</span>(<span class="php-var">$modusers</span>[<span class="php-quote">'users'</span>][<span class="php-var">$uid</span>]) &amp;&amp; <span class="php-var">$modusers</span>[<span class="php-quote">'users'</span>][<span class="php-var">$uid</span>][<span class="php-quote">'mid'</span>])
<a href="#1541" id="1541" class="l">1541: </a>                    {
<a href="#1542" id="1542" class="l">1542: </a>                        <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
<a href="#1543" id="1543" class="l">1543: </a>                    }
<a href="#1544" id="1544" class="l">1544: </a>                    <span class="php-keyword1">elseif</span>(<span class="php-keyword1">isset</span>(<span class="php-var">$modusers</span>[<span class="php-quote">'usergroups'</span>][<span class="php-var">$user_perms</span>[<span class="php-quote">'gid'</span>]]))
<a href="#1545" id="1545" class="l">1545: </a>                    {
<a href="#1546" id="1546" class="l">1546: </a>                        <span class="php-comment">// Moderating usergroup</span>
<a href="#1547" id="1547" class="l">1547: </a>                        <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
<a href="#1548" id="1548" class="l">1548: </a>                    }
<a href="#1549" id="1549" class="l">1549: </a>                }
<a href="#1550" id="1550" class="l">1550: </a>            }
<a href="#1551" id="1551" class="l">1551: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#1552" id="1552" class="l">1552: </a>        }
<a href="#1553" id="1553" class="l">1553: </a>        <span class="php-keyword1">else</span>
<a href="#1554" id="1554" class="l">1554: </a>        {
<a href="#1555" id="1555" class="l">1555: </a>            <span class="php-var">$modperms</span> = get_moderator_permissions(<span class="php-var">$fid</span>, <span class="php-var">$uid</span>);
<a href="#1556" id="1556" class="l">1556: </a>            
<a href="#1557" id="1557" class="l">1557: </a>            <span class="php-keyword1">if</span>(!<span class="php-var">$action</span> &amp;&amp; <span class="php-var">$modperms</span>)
<a href="#1558" id="1558" class="l">1558: </a>            {
<a href="#1559" id="1559" class="l">1559: </a>                <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
<a href="#1560" id="1560" class="l">1560: </a>            }
<a href="#1561" id="1561" class="l">1561: </a>            <span class="php-keyword1">else</span>
<a href="#1562" id="1562" class="l">1562: </a>            {
<a href="#1563" id="1563" class="l">1563: </a>                <span class="php-keyword1">if</span>(<span class="php-var">$modperms</span>[<span class="php-var">$action</span>] == <span class="php-num">1</span>)
<a href="#1564" id="1564" class="l">1564: </a>                {
<a href="#1565" id="1565" class="l">1565: </a>                    <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
<a href="#1566" id="1566" class="l">1566: </a>                }
<a href="#1567" id="1567" class="l">1567: </a>                <span class="php-keyword1">else</span>
<a href="#1568" id="1568" class="l">1568: </a>                {
<a href="#1569" id="1569" class="l">1569: </a>                    <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#1570" id="1570" class="l">1570: </a>                }
<a href="#1571" id="1571" class="l">1571: </a>            }
<a href="#1572" id="1572" class="l">1572: </a>        }
<a href="#1573" id="1573" class="l">1573: </a>    }
<a href="#1574" id="1574" class="l">1574: </a>}
<a href="#1575" id="1575" class="l">1575: </a>
<a href="#1576" id="1576" class="l">1576: </a><span class="php-comment">/**
</span><a href="#1577" id="1577" class="l">1577: </a><span class="php-comment"> * Generate a list of the posticons.
</span><a href="#1578" id="1578" class="l">1578: </a><span class="php-comment"> *
</span><a href="#1579" id="1579" class="l">1579: </a><span class="php-comment"> * @return string The template of posticons.
</span><a href="#1580" id="1580" class="l">1580: </a><span class="php-comment"> */</span>
<a href="#1581" id="1581" class="l">1581: </a><span class="php-keyword1">function</span> get_post_icons()
<a href="#1582" id="1582" class="l">1582: </a>{
<a href="#1583" id="1583" class="l">1583: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>, <span class="php-var">$cache</span>, <span class="php-var">$icon</span>, <span class="php-var">$theme</span>, <span class="php-var">$templates</span>, <span class="php-var">$lang</span>;
<a href="#1584" id="1584" class="l">1584: </a>
<a href="#1585" id="1585" class="l">1585: </a>    <span class="php-var">$listed</span> = <span class="php-num">0</span>;
<a href="#1586" id="1586" class="l">1586: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;input[<span class="php-quote">'icon'</span>])
<a href="#1587" id="1587" class="l">1587: </a>    {
<a href="#1588" id="1588" class="l">1588: </a>        <span class="php-var">$icon</span> = <span class="php-var">$mybb</span>-&gt;input[<span class="php-quote">'icon'</span>];
<a href="#1589" id="1589" class="l">1589: </a>    }
<a href="#1590" id="1590" class="l">1590: </a>
<a href="#1591" id="1591" class="l">1591: </a>    <span class="php-var">$no_icons_checked</span> = <span class="php-quote">&quot; checked=\&quot;checked\&quot;&quot;</span>;
<a href="#1592" id="1592" class="l">1592: </a>    <span class="php-comment">// read post icons from cache, and sort them accordingly</span>
<a href="#1593" id="1593" class="l">1593: </a>    <span class="php-var">$posticons_cache</span> = <span class="php-var">$cache</span>-&gt;read(<span class="php-quote">&quot;posticons&quot;</span>);
<a href="#1594" id="1594" class="l">1594: </a>    <span class="php-var">$posticons</span> = <span class="php-keyword1">array</span>();
<a href="#1595" id="1595" class="l">1595: </a>    <span class="php-keyword1">foreach</span>(<span class="php-var">$posticons_cache</span> <span class="php-keyword1">as</span> <span class="php-var">$posticon</span>)
<a href="#1596" id="1596" class="l">1596: </a>    {
<a href="#1597" id="1597" class="l">1597: </a>        <span class="php-var">$posticons</span>[<span class="php-var">$posticon</span>[<span class="php-quote">'name'</span>]] = <span class="php-var">$posticon</span>;
<a href="#1598" id="1598" class="l">1598: </a>    }
<a href="#1599" id="1599" class="l">1599: </a>    <span class="php-keyword2">krsort</span>(<span class="php-var">$posticons</span>);
<a href="#1600" id="1600" class="l">1600: </a>    
<a href="#1601" id="1601" class="l">1601: </a>    <span class="php-keyword1">foreach</span>(<span class="php-var">$posticons</span> <span class="php-keyword1">as</span> <span class="php-var">$dbicon</span>)
<a href="#1602" id="1602" class="l">1602: </a>    {
<a href="#1603" id="1603" class="l">1603: </a>        <span class="php-var">$dbicon</span>[<span class="php-quote">'path'</span>] = htmlspecialchars_uni(<span class="php-var">$dbicon</span>[<span class="php-quote">'path'</span>]);
<a href="#1604" id="1604" class="l">1604: </a>        <span class="php-var">$dbicon</span>[<span class="php-quote">'name'</span>] = htmlspecialchars_uni(<span class="php-var">$dbicon</span>[<span class="php-quote">'name'</span>]);
<a href="#1605" id="1605" class="l">1605: </a>
<a href="#1606" id="1606" class="l">1606: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$icon</span> == <span class="php-var">$dbicon</span>[<span class="php-quote">'iid'</span>])
<a href="#1607" id="1607" class="l">1607: </a>        {
<a href="#1608" id="1608" class="l">1608: </a>            <span class="php-var">$iconlist</span> .= <span class="php-quote">&quot;&lt;label&gt;&lt;input type=\&quot;radio\&quot; name=\&quot;icon\&quot; value=\&quot;&quot;</span>.<span class="php-var">$dbicon</span>[<span class="php-quote">'iid'</span>].<span class="php-quote">&quot;\&quot; checked=\&quot;checked\&quot; /&gt; &lt;img src=\&quot;&quot;</span>.<span class="php-var">$dbicon</span>[<span class="php-quote">'path'</span>].<span class="php-quote">&quot;\&quot; alt=\&quot;&quot;</span>.<span class="php-var">$dbicon</span>[<span class="php-quote">'name'</span>].<span class="php-quote">&quot;\&quot; /&gt;&lt;/label&gt;&quot;</span>;
<a href="#1609" id="1609" class="l">1609: </a>            <span class="php-var">$no_icons_checked</span> = <span class="php-quote">&quot;&quot;</span>;
<a href="#1610" id="1610" class="l">1610: </a>        }
<a href="#1611" id="1611" class="l">1611: </a>        <span class="php-keyword1">else</span>
<a href="#1612" id="1612" class="l">1612: </a>        {
<a href="#1613" id="1613" class="l">1613: </a>            <span class="php-var">$iconlist</span> .= <span class="php-quote">&quot;&lt;label&gt;&lt;input type=\&quot;radio\&quot; name=\&quot;icon\&quot; value=\&quot;&quot;</span>.<span class="php-var">$dbicon</span>[<span class="php-quote">'iid'</span>].<span class="php-quote">&quot;\&quot; /&gt; &lt;img src=\&quot;&quot;</span>.<span class="php-var">$dbicon</span>[<span class="php-quote">'path'</span>].<span class="php-quote">&quot;\&quot; alt=\&quot;&quot;</span>.<span class="php-var">$dbicon</span>[<span class="php-quote">'name'</span>].<span class="php-quote">&quot;\&quot; /&gt;&lt;/label&gt;&quot;</span>;
<a href="#1614" id="1614" class="l">1614: </a>        }
<a href="#1615" id="1615" class="l">1615: </a>
<a href="#1616" id="1616" class="l">1616: </a>        ++<span class="php-var">$listed</span>;
<a href="#1617" id="1617" class="l">1617: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$listed</span> == <span class="php-num">10</span>)
<a href="#1618" id="1618" class="l">1618: </a>        {
<a href="#1619" id="1619" class="l">1619: </a>            <span class="php-var">$iconlist</span> .= <span class="php-quote">&quot;&lt;br /&gt;&quot;</span>;
<a href="#1620" id="1620" class="l">1620: </a>            <span class="php-var">$listed</span> = <span class="php-num">0</span>;
<a href="#1621" id="1621" class="l">1621: </a>        }
<a href="#1622" id="1622" class="l">1622: </a>    }
<a href="#1623" id="1623" class="l">1623: </a>
<a href="#1624" id="1624" class="l">1624: </a>    <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$posticons</span><span class="php-quote"> = \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;posticons&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#1625" id="1625" class="l">1625: </a>
<a href="#1626" id="1626" class="l">1626: </a>    <span class="php-keyword1">return</span> <span class="php-var">$posticons</span>;
<a href="#1627" id="1627" class="l">1627: </a>}
<a href="#1628" id="1628" class="l">1628: </a>
<a href="#1629" id="1629" class="l">1629: </a><span class="php-comment">/**
</span><a href="#1630" id="1630" class="l">1630: </a><span class="php-comment"> * MyBB setcookie() wrapper.
</span><a href="#1631" id="1631" class="l">1631: </a><span class="php-comment"> *
</span><a href="#1632" id="1632" class="l">1632: </a><span class="php-comment"> * @param string The cookie identifier.
</span><a href="#1633" id="1633" class="l">1633: </a><span class="php-comment"> * @param string The cookie value.
</span><a href="#1634" id="1634" class="l">1634: </a><span class="php-comment"> * @param int The timestamp of the expiry date.
</span><a href="#1635" id="1635" class="l">1635: </a><span class="php-comment"> * @param boolean True if setting a HttpOnly cookie (supported by IE, Opera 9, Konqueror)
</span><a href="#1636" id="1636" class="l">1636: </a><span class="php-comment"> */</span>
<a href="#1637" id="1637" class="l">1637: </a><span class="php-keyword1">function</span> my_setcookie(<span class="php-var">$name</span>, <span class="php-var">$value</span>=<span class="php-quote">&quot;&quot;</span>, <span class="php-var">$expires</span>=<span class="php-quote">&quot;&quot;</span>, <span class="php-var">$httponly</span>=<span class="php-keyword1">false</span>)
<a href="#1638" id="1638" class="l">1638: </a>{
<a href="#1639" id="1639" class="l">1639: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>;
<a href="#1640" id="1640" class="l">1640: </a>
<a href="#1641" id="1641" class="l">1641: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'cookiepath'</span>])
<a href="#1642" id="1642" class="l">1642: </a>    {
<a href="#1643" id="1643" class="l">1643: </a>        <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'cookiepath'</span>] = <span class="php-quote">&quot;/&quot;</span>;
<a href="#1644" id="1644" class="l">1644: </a>    }
<a href="#1645" id="1645" class="l">1645: </a>
<a href="#1646" id="1646" class="l">1646: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$expires</span> == -<span class="php-num">1</span>)
<a href="#1647" id="1647" class="l">1647: </a>    {
<a href="#1648" id="1648" class="l">1648: </a>        <span class="php-var">$expires</span> = <span class="php-num">0</span>;
<a href="#1649" id="1649" class="l">1649: </a>    }
<a href="#1650" id="1650" class="l">1650: </a>    <span class="php-keyword1">elseif</span>(<span class="php-var">$expires</span> == <span class="php-quote">&quot;&quot;</span> || <span class="php-var">$expires</span> == <span class="php-keyword1">null</span>)
<a href="#1651" id="1651" class="l">1651: </a>    {
<a href="#1652" id="1652" class="l">1652: </a>        <span class="php-var">$expires</span> = TIME_NOW + (<span class="php-num">60</span>*<span class="php-num">60</span>*<span class="php-num">24</span>*<span class="php-num">365</span>); <span class="php-comment">// Make the cookie expire in a years time</span>
<a href="#1653" id="1653" class="l">1653: </a>    }
<a href="#1654" id="1654" class="l">1654: </a>    <span class="php-keyword1">else</span>
<a href="#1655" id="1655" class="l">1655: </a>    {
<a href="#1656" id="1656" class="l">1656: </a>        <span class="php-var">$expires</span> = TIME_NOW + <span class="php-keyword2">intval</span>(<span class="php-var">$expires</span>);
<a href="#1657" id="1657" class="l">1657: </a>    }
<a href="#1658" id="1658" class="l">1658: </a>
<a href="#1659" id="1659" class="l">1659: </a>    <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'cookiepath'</span>] = <span class="php-keyword2">str_replace</span>(<span class="php-keyword1">array</span>(<span class="php-quote">&quot;\n&quot;</span>,<span class="php-quote">&quot;\r&quot;</span>), <span class="php-quote">&quot;&quot;</span>, <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'cookiepath'</span>]);
<a href="#1660" id="1660" class="l">1660: </a>    <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'cookiedomain'</span>] = <span class="php-keyword2">str_replace</span>(<span class="php-keyword1">array</span>(<span class="php-quote">&quot;\n&quot;</span>,<span class="php-quote">&quot;\r&quot;</span>), <span class="php-quote">&quot;&quot;</span>, <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'cookiedomain'</span>]);
<a href="#1661" id="1661" class="l">1661: </a>    <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'cookieprefix'</span>] = <span class="php-keyword2">str_replace</span>(<span class="php-keyword1">array</span>(<span class="php-quote">&quot;\n&quot;</span>,<span class="php-quote">&quot;\r&quot;</span>, <span class="php-quote">&quot; &quot;</span>), <span class="php-quote">&quot;&quot;</span>, <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'cookieprefix'</span>]);
<a href="#1662" id="1662" class="l">1662: </a>
<a href="#1663" id="1663" class="l">1663: </a>    <span class="php-comment">// Versions of PHP prior to 5.2 do not support HttpOnly cookies and IE is buggy when specifying a blank domain so set the cookie manually</span>
<a href="#1664" id="1664" class="l">1664: </a>    <span class="php-var">$cookie</span> = <span class="php-quote">&quot;Set-Cookie: </span><span class="php-var">{$mybb-&gt;settings['cookieprefix']}{$name}</span><span class="php-quote">=&quot;</span>.<span class="php-keyword2">urlencode</span>(<span class="php-var">$value</span>);
<a href="#1665" id="1665" class="l">1665: </a>
<a href="#1666" id="1666" class="l">1666: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$expires</span> &gt; <span class="php-num">0</span>)
<a href="#1667" id="1667" class="l">1667: </a>    {
<a href="#1668" id="1668" class="l">1668: </a>        <span class="php-var">$cookie</span> .= <span class="php-quote">&quot;; expires=&quot;</span>.@<span class="php-keyword2">gmdate</span>(<span class="php-quote">'D, d-M-Y H:i:s \\G\\M\\T'</span>, <span class="php-var">$expires</span>);
<a href="#1669" id="1669" class="l">1669: </a>    }
<a href="#1670" id="1670" class="l">1670: </a>
<a href="#1671" id="1671" class="l">1671: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword1">empty</span>(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'cookiepath'</span>]))
<a href="#1672" id="1672" class="l">1672: </a>    {
<a href="#1673" id="1673" class="l">1673: </a>        <span class="php-var">$cookie</span> .= <span class="php-quote">&quot;; path=</span><span class="php-var">{$mybb-&gt;settings['cookiepath']}</span><span class="php-quote">&quot;</span>;
<a href="#1674" id="1674" class="l">1674: </a>    }
<a href="#1675" id="1675" class="l">1675: </a>
<a href="#1676" id="1676" class="l">1676: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword1">empty</span>(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'cookiedomain'</span>]))
<a href="#1677" id="1677" class="l">1677: </a>    {
<a href="#1678" id="1678" class="l">1678: </a>        <span class="php-var">$cookie</span> .= <span class="php-quote">&quot;; domain=</span><span class="php-var">{$mybb-&gt;settings['cookiedomain']}</span><span class="php-quote">&quot;</span>;
<a href="#1679" id="1679" class="l">1679: </a>    }
<a href="#1680" id="1680" class="l">1680: </a>
<a href="#1681" id="1681" class="l">1681: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$httponly</span> == <span class="php-keyword1">true</span>)
<a href="#1682" id="1682" class="l">1682: </a>    {
<a href="#1683" id="1683" class="l">1683: </a>        <span class="php-var">$cookie</span> .= <span class="php-quote">&quot;; HttpOnly&quot;</span>;
<a href="#1684" id="1684" class="l">1684: </a>    }
<a href="#1685" id="1685" class="l">1685: </a>    
<a href="#1686" id="1686" class="l">1686: </a>    <span class="php-var">$mybb</span>-&gt;cookies[<span class="php-var">$name</span>] = <span class="php-var">$value</span>;
<a href="#1687" id="1687" class="l">1687: </a>
<a href="#1688" id="1688" class="l">1688: </a>    <span class="php-keyword2">header</span>(<span class="php-var">$cookie</span>, <span class="php-keyword1">false</span>);
<a href="#1689" id="1689" class="l">1689: </a>}
<a href="#1690" id="1690" class="l">1690: </a>
<a href="#1691" id="1691" class="l">1691: </a><span class="php-comment">/**
</span><a href="#1692" id="1692" class="l">1692: </a><span class="php-comment"> * Unset a cookie set by MyBB.
</span><a href="#1693" id="1693" class="l">1693: </a><span class="php-comment"> *
</span><a href="#1694" id="1694" class="l">1694: </a><span class="php-comment"> * @param string The cookie identifier.
</span><a href="#1695" id="1695" class="l">1695: </a><span class="php-comment"> */</span>
<a href="#1696" id="1696" class="l">1696: </a><span class="php-keyword1">function</span> my_unsetcookie(<span class="php-var">$name</span>)
<a href="#1697" id="1697" class="l">1697: </a>{
<a href="#1698" id="1698" class="l">1698: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>;
<a href="#1699" id="1699" class="l">1699: </a>    
<a href="#1700" id="1700" class="l">1700: </a>    <span class="php-var">$expires</span> = -<span class="php-num">3600</span>;
<a href="#1701" id="1701" class="l">1701: </a>    my_setcookie(<span class="php-var">$name</span>, <span class="php-quote">&quot;&quot;</span>, <span class="php-var">$expires</span>);
<a href="#1702" id="1702" class="l">1702: </a>    
<a href="#1703" id="1703" class="l">1703: </a>    <span class="php-keyword1">unset</span>(<span class="php-var">$mybb</span>-&gt;cookies[<span class="php-var">$name</span>]);
<a href="#1704" id="1704" class="l">1704: </a>}
<a href="#1705" id="1705" class="l">1705: </a>
<a href="#1706" id="1706" class="l">1706: </a><span class="php-comment">/**
</span><a href="#1707" id="1707" class="l">1707: </a><span class="php-comment"> * Get the contents from a serialised cookie array.
</span><a href="#1708" id="1708" class="l">1708: </a><span class="php-comment"> *
</span><a href="#1709" id="1709" class="l">1709: </a><span class="php-comment"> * @param string The cookie identifier.
</span><a href="#1710" id="1710" class="l">1710: </a><span class="php-comment"> * @param int The cookie content id.
</span><a href="#1711" id="1711" class="l">1711: </a><span class="php-comment"> * @return array|boolean The cookie id's content array or false when non-existent.
</span><a href="#1712" id="1712" class="l">1712: </a><span class="php-comment"> */</span>
<a href="#1713" id="1713" class="l">1713: </a><span class="php-keyword1">function</span> my_get_array_cookie(<span class="php-var">$name</span>, <span class="php-var">$id</span>)
<a href="#1714" id="1714" class="l">1714: </a>{
<a href="#1715" id="1715" class="l">1715: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>;
<a href="#1716" id="1716" class="l">1716: </a>    
<a href="#1717" id="1717" class="l">1717: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword1">isset</span>(<span class="php-var">$mybb</span>-&gt;cookies[<span class="php-quote">'mybb'</span>][<span class="php-var">$name</span>]))
<a href="#1718" id="1718" class="l">1718: </a>    {
<a href="#1719" id="1719" class="l">1719: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#1720" id="1720" class="l">1720: </a>    }
<a href="#1721" id="1721" class="l">1721: </a>
<a href="#1722" id="1722" class="l">1722: </a>    <span class="php-var">$cookie</span> = my_unserialize(<span class="php-var">$mybb</span>-&gt;cookies[<span class="php-quote">'mybb'</span>][<span class="php-var">$name</span>]);
<a href="#1723" id="1723" class="l">1723: </a>
<a href="#1724" id="1724" class="l">1724: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$cookie</span>) &amp;&amp; <span class="php-keyword1">isset</span>(<span class="php-var">$cookie</span>[<span class="php-var">$id</span>]))
<a href="#1725" id="1725" class="l">1725: </a>    {
<a href="#1726" id="1726" class="l">1726: </a>        <span class="php-keyword1">return</span> <span class="php-var">$cookie</span>[<span class="php-var">$id</span>];
<a href="#1727" id="1727" class="l">1727: </a>    }
<a href="#1728" id="1728" class="l">1728: </a>    <span class="php-keyword1">else</span>
<a href="#1729" id="1729" class="l">1729: </a>    {
<a href="#1730" id="1730" class="l">1730: </a>        <span class="php-keyword1">return</span> <span class="php-num">0</span>;
<a href="#1731" id="1731" class="l">1731: </a>    }
<a href="#1732" id="1732" class="l">1732: </a>}
<a href="#1733" id="1733" class="l">1733: </a>
<a href="#1734" id="1734" class="l">1734: </a><span class="php-comment">/**
</span><a href="#1735" id="1735" class="l">1735: </a><span class="php-comment"> * Set a serialised cookie array.
</span><a href="#1736" id="1736" class="l">1736: </a><span class="php-comment"> *
</span><a href="#1737" id="1737" class="l">1737: </a><span class="php-comment"> * @param string The cookie identifier.
</span><a href="#1738" id="1738" class="l">1738: </a><span class="php-comment"> * @param int The cookie content id.
</span><a href="#1739" id="1739" class="l">1739: </a><span class="php-comment"> * @param string The value to set the cookie to.
</span><a href="#1740" id="1740" class="l">1740: </a><span class="php-comment"> */</span>
<a href="#1741" id="1741" class="l">1741: </a><span class="php-keyword1">function</span> my_set_array_cookie(<span class="php-var">$name</span>, <span class="php-var">$id</span>, <span class="php-var">$value</span>, <span class="php-var">$expires</span>=<span class="php-quote">&quot;&quot;</span>)
<a href="#1742" id="1742" class="l">1742: </a>{
<a href="#1743" id="1743" class="l">1743: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>;
<a href="#1744" id="1744" class="l">1744: </a>    
<a href="#1745" id="1745" class="l">1745: </a>    <span class="php-var">$cookie</span> = <span class="php-var">$mybb</span>-&gt;cookies[<span class="php-quote">'mybb'</span>];
<a href="#1746" id="1746" class="l">1746: </a>    <span class="php-var">$newcookie</span> = my_unserialize(<span class="php-var">$cookie</span>[<span class="php-var">$name</span>]);
<a href="#1747" id="1747" class="l">1747: </a>
<a href="#1748" id="1748" class="l">1748: </a>    <span class="php-var">$newcookie</span>[<span class="php-var">$id</span>] = <span class="php-var">$value</span>;
<a href="#1749" id="1749" class="l">1749: </a>    <span class="php-var">$newcookie</span> = <span class="php-keyword2">serialize</span>(<span class="php-var">$newcookie</span>);
<a href="#1750" id="1750" class="l">1750: </a>    my_setcookie(<span class="php-quote">&quot;mybb[</span><span class="php-var">$name</span><span class="php-quote">]&quot;</span>, <span class="php-keyword2">addslashes</span>(<span class="php-var">$newcookie</span>), <span class="php-var">$expires</span>);
<a href="#1751" id="1751" class="l">1751: </a>
<a href="#1752" id="1752" class="l">1752: </a>    <span class="php-comment">// Make sure our current viarables are up-to-date as well</span>
<a href="#1753" id="1753" class="l">1753: </a>    <span class="php-var">$mybb</span>-&gt;cookies[<span class="php-quote">'mybb'</span>][<span class="php-var">$name</span>] = <span class="php-var">$newcookie</span>;
<a href="#1754" id="1754" class="l">1754: </a>}
<a href="#1755" id="1755" class="l">1755: </a>
<a href="#1756" id="1756" class="l">1756: </a><span class="php-comment">/**
</span><a href="#1757" id="1757" class="l">1757: </a><span class="php-comment"> * Verifies that data passed is an array
</span><a href="#1758" id="1758" class="l">1758: </a><span class="php-comment"> *
</span><a href="#1759" id="1759" class="l">1759: </a><span class="php-comment"> * @param array Data to unserialize
</span><a href="#1760" id="1760" class="l">1760: </a><span class="php-comment"> * @return array Unserialized data array
</span><a href="#1761" id="1761" class="l">1761: </a><span class="php-comment"> */</span>
<a href="#1762" id="1762" class="l">1762: </a><span class="php-keyword1">function</span> my_unserialize(<span class="php-var">$data</span>)
<a href="#1763" id="1763" class="l">1763: </a>{
<a href="#1764" id="1764" class="l">1764: </a>    <span class="php-var">$array</span> = <span class="php-keyword2">unserialize</span>(<span class="php-var">$data</span>);
<a href="#1765" id="1765" class="l">1765: </a>
<a href="#1766" id="1766" class="l">1766: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$array</span>))
<a href="#1767" id="1767" class="l">1767: </a>    {
<a href="#1768" id="1768" class="l">1768: </a>        <span class="php-var">$array</span> = <span class="php-keyword1">array</span>();
<a href="#1769" id="1769" class="l">1769: </a>    }
<a href="#1770" id="1770" class="l">1770: </a>
<a href="#1771" id="1771" class="l">1771: </a>    <span class="php-keyword1">return</span> <span class="php-var">$array</span>;
<a href="#1772" id="1772" class="l">1772: </a>} 
<a href="#1773" id="1773" class="l">1773: </a>
<a href="#1774" id="1774" class="l">1774: </a><span class="php-comment">/**
</span><a href="#1775" id="1775" class="l">1775: </a><span class="php-comment"> * Returns the serverload of the system.
</span><a href="#1776" id="1776" class="l">1776: </a><span class="php-comment"> *
</span><a href="#1777" id="1777" class="l">1777: </a><span class="php-comment"> * @return int The serverload of the system.
</span><a href="#1778" id="1778" class="l">1778: </a><span class="php-comment"> */</span>
<a href="#1779" id="1779" class="l">1779: </a><span class="php-keyword1">function</span> get_server_load()
<a href="#1780" id="1780" class="l">1780: </a>{
<a href="#1781" id="1781" class="l">1781: </a>    <span class="php-keyword1">global</span> <span class="php-var">$lang</span>;
<a href="#1782" id="1782" class="l">1782: </a>
<a href="#1783" id="1783" class="l">1783: </a>    <span class="php-var">$serverload</span> = <span class="php-keyword1">array</span>();
<a href="#1784" id="1784" class="l">1784: </a>
<a href="#1785" id="1785" class="l">1785: </a>    <span class="php-comment">// DIRECTORY_SEPARATOR checks if running windows</span>
<a href="#1786" id="1786" class="l">1786: </a>    <span class="php-keyword1">if</span>(DIRECTORY_SEPARATOR != <span class="php-quote">'\\'</span>)
<a href="#1787" id="1787" class="l">1787: </a>    {
<a href="#1788" id="1788" class="l">1788: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">function_exists</span>(<span class="php-quote">&quot;sys_getloadavg&quot;</span>))
<a href="#1789" id="1789" class="l">1789: </a>        {
<a href="#1790" id="1790" class="l">1790: </a>            <span class="php-comment">// sys_getloadavg() will return an array with [0] being load within the last minute.</span>
<a href="#1791" id="1791" class="l">1791: </a>            <span class="php-var">$serverload</span> = sys_getloadavg();
<a href="#1792" id="1792" class="l">1792: </a>            <span class="php-var">$serverload</span>[<span class="php-num">0</span>] = <span class="php-keyword2">round</span>(<span class="php-var">$serverload</span>[<span class="php-num">0</span>], <span class="php-num">4</span>);
<a href="#1793" id="1793" class="l">1793: </a>        }
<a href="#1794" id="1794" class="l">1794: </a>        <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(@<span class="php-keyword2">file_exists</span>(<span class="php-quote">&quot;/proc/loadavg&quot;</span>) &amp;&amp; <span class="php-var">$load</span> = @<span class="php-keyword2">file_get_contents</span>(<span class="php-quote">&quot;/proc/loadavg&quot;</span>))
<a href="#1795" id="1795" class="l">1795: </a>        {
<a href="#1796" id="1796" class="l">1796: </a>            <span class="php-var">$serverload</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">&quot; &quot;</span>, <span class="php-var">$load</span>);
<a href="#1797" id="1797" class="l">1797: </a>            <span class="php-var">$serverload</span>[<span class="php-num">0</span>] = <span class="php-keyword2">round</span>(<span class="php-var">$serverload</span>[<span class="php-num">0</span>], <span class="php-num">4</span>);
<a href="#1798" id="1798" class="l">1798: </a>        }
<a href="#1799" id="1799" class="l">1799: </a>        <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_numeric</span>(<span class="php-var">$serverload</span>[<span class="php-num">0</span>]))
<a href="#1800" id="1800" class="l">1800: </a>        {
<a href="#1801" id="1801" class="l">1801: </a>            <span class="php-keyword1">if</span>(@<span class="php-keyword2">ini_get</span>(<span class="php-quote">'safe_mode'</span>) == <span class="php-quote">'On'</span>)
<a href="#1802" id="1802" class="l">1802: </a>            {
<a href="#1803" id="1803" class="l">1803: </a>                <span class="php-keyword1">return</span> <span class="php-var">$lang</span>-&gt;unknown;
<a href="#1804" id="1804" class="l">1804: </a>            }
<a href="#1805" id="1805" class="l">1805: </a>            
<a href="#1806" id="1806" class="l">1806: </a>            <span class="php-comment">// Suhosin likes to throw a warning if exec is disabled then die - weird</span>
<a href="#1807" id="1807" class="l">1807: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$func_blacklist</span> = @<span class="php-keyword2">ini_get</span>(<span class="php-quote">'suhosin.executor.func.blacklist'</span>))
<a href="#1808" id="1808" class="l">1808: </a>            {
<a href="#1809" id="1809" class="l">1809: </a>                <span class="php-keyword1">if</span>(<span class="php-keyword2">strpos</span>(<span class="php-quote">&quot;,&quot;</span>.<span class="php-var">$func_blacklist</span>.<span class="php-quote">&quot;,&quot;</span>, <span class="php-quote">'exec'</span>) !== <span class="php-keyword1">false</span>)
<a href="#1810" id="1810" class="l">1810: </a>                {
<a href="#1811" id="1811" class="l">1811: </a>                    <span class="php-keyword1">return</span> <span class="php-var">$lang</span>-&gt;unknown;
<a href="#1812" id="1812" class="l">1812: </a>                }
<a href="#1813" id="1813" class="l">1813: </a>            }
<a href="#1814" id="1814" class="l">1814: </a>            <span class="php-comment">// PHP disabled functions?</span>
<a href="#1815" id="1815" class="l">1815: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$func_blacklist</span> = @<span class="php-keyword2">ini_get</span>(<span class="php-quote">'disable_functions'</span>))
<a href="#1816" id="1816" class="l">1816: </a>            {
<a href="#1817" id="1817" class="l">1817: </a>                <span class="php-keyword1">if</span>(<span class="php-keyword2">strpos</span>(<span class="php-quote">&quot;,&quot;</span>.<span class="php-var">$func_blacklist</span>.<span class="php-quote">&quot;,&quot;</span>, <span class="php-quote">'exec'</span>) !== <span class="php-keyword1">false</span>)
<a href="#1818" id="1818" class="l">1818: </a>                {
<a href="#1819" id="1819" class="l">1819: </a>                    <span class="php-keyword1">return</span> <span class="php-var">$lang</span>-&gt;unknown;
<a href="#1820" id="1820" class="l">1820: </a>                }
<a href="#1821" id="1821" class="l">1821: </a>            }
<a href="#1822" id="1822" class="l">1822: </a>
<a href="#1823" id="1823" class="l">1823: </a>            <span class="php-var">$load</span> = @<span class="php-keyword2">exec</span>(<span class="php-quote">&quot;uptime&quot;</span>);
<a href="#1824" id="1824" class="l">1824: </a>            <span class="php-var">$load</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">&quot;load average: &quot;</span>, <span class="php-var">$load</span>);
<a href="#1825" id="1825" class="l">1825: </a>            <span class="php-var">$serverload</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">&quot;,&quot;</span>, <span class="php-var">$load</span>[<span class="php-num">1</span>]);
<a href="#1826" id="1826" class="l">1826: </a>            <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$serverload</span>))
<a href="#1827" id="1827" class="l">1827: </a>            {
<a href="#1828" id="1828" class="l">1828: </a>                <span class="php-keyword1">return</span> <span class="php-var">$lang</span>-&gt;unknown;
<a href="#1829" id="1829" class="l">1829: </a>            }
<a href="#1830" id="1830" class="l">1830: </a>        }
<a href="#1831" id="1831" class="l">1831: </a>    }
<a href="#1832" id="1832" class="l">1832: </a>    <span class="php-keyword1">else</span>
<a href="#1833" id="1833" class="l">1833: </a>    {
<a href="#1834" id="1834" class="l">1834: </a>        <span class="php-keyword1">return</span> <span class="php-var">$lang</span>-&gt;unknown;
<a href="#1835" id="1835" class="l">1835: </a>    }
<a href="#1836" id="1836" class="l">1836: </a>
<a href="#1837" id="1837" class="l">1837: </a>    <span class="php-var">$returnload</span> = <span class="php-keyword2">trim</span>(<span class="php-var">$serverload</span>[<span class="php-num">0</span>]);
<a href="#1838" id="1838" class="l">1838: </a>
<a href="#1839" id="1839" class="l">1839: </a>    <span class="php-keyword1">return</span> <span class="php-var">$returnload</span>;
<a href="#1840" id="1840" class="l">1840: </a>}
<a href="#1841" id="1841" class="l">1841: </a>
<a href="#1842" id="1842" class="l">1842: </a><span class="php-comment">/**
</span><a href="#1843" id="1843" class="l">1843: </a><span class="php-comment"> * Updates the forum statistics with specific values (or addition/subtraction of the previous value)
</span><a href="#1844" id="1844" class="l">1844: </a><span class="php-comment"> *
</span><a href="#1845" id="1845" class="l">1845: </a><span class="php-comment"> * @param array Array of items being updated (numthreads,numposts,numusers)
</span><a href="#1846" id="1846" class="l">1846: </a><span class="php-comment"> */</span>
<a href="#1847" id="1847" class="l">1847: </a><span class="php-keyword1">function</span> update_stats(<span class="php-var">$changes</span>=<span class="php-keyword1">array</span>())
<a href="#1848" id="1848" class="l">1848: </a>{
<a href="#1849" id="1849" class="l">1849: </a>    <span class="php-keyword1">global</span> <span class="php-var">$cache</span>, <span class="php-var">$db</span>;
<a href="#1850" id="1850" class="l">1850: </a>
<a href="#1851" id="1851" class="l">1851: </a>    <span class="php-var">$stats</span> = <span class="php-var">$cache</span>-&gt;read(<span class="php-quote">&quot;stats&quot;</span>);
<a href="#1852" id="1852" class="l">1852: </a>
<a href="#1853" id="1853" class="l">1853: </a>    <span class="php-var">$counters</span> = <span class="php-keyword1">array</span>(<span class="php-quote">'numthreads'</span>,<span class="php-quote">'numunapprovedthreads'</span>,<span class="php-quote">'numposts'</span>,<span class="php-quote">'numunapprovedposts'</span>,<span class="php-quote">'numusers'</span>);
<a href="#1854" id="1854" class="l">1854: </a>    <span class="php-var">$update</span> = <span class="php-keyword1">array</span>();
<a href="#1855" id="1855" class="l">1855: </a>    <span class="php-keyword1">foreach</span>(<span class="php-var">$counters</span> <span class="php-keyword1">as</span> <span class="php-var">$counter</span>)
<a href="#1856" id="1856" class="l">1856: </a>    {
<a href="#1857" id="1857" class="l">1857: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">array_key_exists</span>(<span class="php-var">$counter</span>, <span class="php-var">$changes</span>))
<a href="#1858" id="1858" class="l">1858: </a>        {
<a href="#1859" id="1859" class="l">1859: </a>            <span class="php-comment">// Adding or subtracting from previous value?</span>
<a href="#1860" id="1860" class="l">1860: </a>            <span class="php-keyword1">if</span>(<span class="php-keyword2">substr</span>(<span class="php-var">$changes</span>[<span class="php-var">$counter</span>], <span class="php-num">0</span>, <span class="php-num">1</span>) == <span class="php-quote">&quot;+&quot;</span> || <span class="php-keyword2">substr</span>(<span class="php-var">$changes</span>[<span class="php-var">$counter</span>], <span class="php-num">0</span>, <span class="php-num">1</span>) == <span class="php-quote">&quot;-&quot;</span>)
<a href="#1861" id="1861" class="l">1861: </a>            {
<a href="#1862" id="1862" class="l">1862: </a>                <span class="php-keyword1">if</span>(<span class="php-keyword2">intval</span>(<span class="php-var">$changes</span>[<span class="php-var">$counter</span>]) != <span class="php-num">0</span>)
<a href="#1863" id="1863" class="l">1863: </a>                {
<a href="#1864" id="1864" class="l">1864: </a>                    <span class="php-var">$new_stats</span>[<span class="php-var">$counter</span>] = <span class="php-var">$stats</span>[<span class="php-var">$counter</span>] + <span class="php-var">$changes</span>[<span class="php-var">$counter</span>];
<a href="#1865" id="1865" class="l">1865: </a>                }
<a href="#1866" id="1866" class="l">1866: </a>            }
<a href="#1867" id="1867" class="l">1867: </a>            <span class="php-keyword1">else</span>
<a href="#1868" id="1868" class="l">1868: </a>            {
<a href="#1869" id="1869" class="l">1869: </a>                <span class="php-var">$new_stats</span>[<span class="php-var">$counter</span>] = <span class="php-var">$changes</span>[<span class="php-var">$counter</span>];
<a href="#1870" id="1870" class="l">1870: </a>            }
<a href="#1871" id="1871" class="l">1871: </a>            <span class="php-comment">// Less than 0? That's bad</span>
<a href="#1872" id="1872" class="l">1872: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$new_stats</span>[<span class="php-var">$counter</span>] &lt; <span class="php-num">0</span>)
<a href="#1873" id="1873" class="l">1873: </a>            {
<a href="#1874" id="1874" class="l">1874: </a>                <span class="php-var">$new_stats</span>[<span class="php-var">$counter</span>] = <span class="php-num">0</span>;
<a href="#1875" id="1875" class="l">1875: </a>            }
<a href="#1876" id="1876" class="l">1876: </a>        }
<a href="#1877" id="1877" class="l">1877: </a>    }
<a href="#1878" id="1878" class="l">1878: </a>
<a href="#1879" id="1879" class="l">1879: </a>    <span class="php-comment">// Fetch latest user if the user count is changing</span>
<a href="#1880" id="1880" class="l">1880: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">array_key_exists</span>(<span class="php-quote">'numusers'</span>, <span class="php-var">$changes</span>))
<a href="#1881" id="1881" class="l">1881: </a>    {
<a href="#1882" id="1882" class="l">1882: </a>        <span class="php-var">$query</span> = <span class="php-var">$db</span>-&gt;simple_select(<span class="php-quote">&quot;users&quot;</span>, <span class="php-quote">&quot;uid, username&quot;</span>, <span class="php-quote">&quot;&quot;</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'order_by'</span> =&gt; <span class="php-quote">'uid'</span>, <span class="php-quote">'order_dir'</span> =&gt; <span class="php-quote">'DESC'</span>, <span class="php-quote">'limit'</span> =&gt; <span class="php-num">1</span>));
<a href="#1883" id="1883" class="l">1883: </a>        <span class="php-var">$lastmember</span> = <span class="php-var">$db</span>-&gt;fetch_array(<span class="php-var">$query</span>);
<a href="#1884" id="1884" class="l">1884: </a>        <span class="php-var">$new_stats</span>[<span class="php-quote">'lastuid'</span>] = <span class="php-var">$lastmember</span>[<span class="php-quote">'uid'</span>];
<a href="#1885" id="1885" class="l">1885: </a>        <span class="php-var">$new_stats</span>[<span class="php-quote">'lastusername'</span>] = <span class="php-var">$lastmember</span>[<span class="php-quote">'username'</span>];
<a href="#1886" id="1886" class="l">1886: </a>    }
<a href="#1887" id="1887" class="l">1887: </a>    
<a href="#1888" id="1888" class="l">1888: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword1">empty</span>(<span class="php-var">$new_stats</span>))
<a href="#1889" id="1889" class="l">1889: </a>    {
<a href="#1890" id="1890" class="l">1890: </a>        <span class="php-keyword1">return</span>;
<a href="#1891" id="1891" class="l">1891: </a>    }
<a href="#1892" id="1892" class="l">1892: </a>    
<a href="#1893" id="1893" class="l">1893: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$stats</span>))
<a href="#1894" id="1894" class="l">1894: </a>    {
<a href="#1895" id="1895" class="l">1895: </a>        <span class="php-var">$stats</span> = <span class="php-keyword2">array_merge</span>(<span class="php-var">$stats</span>, <span class="php-var">$new_stats</span>);
<a href="#1896" id="1896" class="l">1896: </a>    }
<a href="#1897" id="1897" class="l">1897: </a>    <span class="php-keyword1">else</span>
<a href="#1898" id="1898" class="l">1898: </a>    {
<a href="#1899" id="1899" class="l">1899: </a>        <span class="php-var">$stats</span> = <span class="php-var">$new_stats</span>;
<a href="#1900" id="1900" class="l">1900: </a>    }
<a href="#1901" id="1901" class="l">1901: </a>
<a href="#1902" id="1902" class="l">1902: </a>    <span class="php-comment">// Update stats row for today in the database</span>
<a href="#1903" id="1903" class="l">1903: </a>    <span class="php-var">$todays_stats</span> = <span class="php-keyword1">array</span>(
<a href="#1904" id="1904" class="l">1904: </a>        <span class="php-quote">&quot;dateline&quot;</span> =&gt; <span class="php-keyword2">mktime</span>(<span class="php-num">0</span>, <span class="php-num">0</span>, <span class="php-num">0</span>, <span class="php-keyword2">date</span>(<span class="php-quote">&quot;m&quot;</span>), <span class="php-keyword2">date</span>(<span class="php-quote">&quot;j&quot;</span>), <span class="php-keyword2">date</span>(<span class="php-quote">&quot;Y&quot;</span>)),
<a href="#1905" id="1905" class="l">1905: </a>        <span class="php-quote">&quot;numusers&quot;</span> =&gt; <span class="php-var">$stats</span>[<span class="php-quote">'numusers'</span>],
<a href="#1906" id="1906" class="l">1906: </a>        <span class="php-quote">&quot;numthreads&quot;</span> =&gt; <span class="php-var">$stats</span>[<span class="php-quote">'numthreads'</span>],
<a href="#1907" id="1907" class="l">1907: </a>        <span class="php-quote">&quot;numposts&quot;</span> =&gt; <span class="php-var">$stats</span>[<span class="php-quote">'numposts'</span>]
<a href="#1908" id="1908" class="l">1908: </a>    );
<a href="#1909" id="1909" class="l">1909: </a>    <span class="php-var">$db</span>-&gt;replace_query(<span class="php-quote">&quot;stats&quot;</span>, <span class="php-var">$todays_stats</span>, <span class="php-quote">&quot;dateline&quot;</span>);
<a href="#1910" id="1910" class="l">1910: </a>
<a href="#1911" id="1911" class="l">1911: </a>    <span class="php-var">$cache</span>-&gt;update(<span class="php-quote">&quot;stats&quot;</span>, <span class="php-var">$stats</span>, <span class="php-quote">&quot;dateline&quot;</span>);
<a href="#1912" id="1912" class="l">1912: </a>}
<a href="#1913" id="1913" class="l">1913: </a>
<a href="#1914" id="1914" class="l">1914: </a><span class="php-comment">/**
</span><a href="#1915" id="1915" class="l">1915: </a><span class="php-comment"> * Updates the forum counters with a specific value (or addition/subtraction of the previous value)
</span><a href="#1916" id="1916" class="l">1916: </a><span class="php-comment"> *
</span><a href="#1917" id="1917" class="l">1917: </a><span class="php-comment"> * @param int The forum ID
</span><a href="#1918" id="1918" class="l">1918: </a><span class="php-comment"> * @param array Array of items being updated (threads, posts, unapprovedthreads, unapprovedposts) and their value (ex, 1, +1, -1)
</span><a href="#1919" id="1919" class="l">1919: </a><span class="php-comment"> */</span>
<a href="#1920" id="1920" class="l">1920: </a><span class="php-keyword1">function</span> update_forum_counters(<span class="php-var">$fid</span>, <span class="php-var">$changes</span>=<span class="php-keyword1">array</span>())
<a href="#1921" id="1921" class="l">1921: </a>{
<a href="#1922" id="1922" class="l">1922: </a>    <span class="php-keyword1">global</span> <span class="php-var">$db</span>, <span class="php-var">$cache</span>;
<a href="#1923" id="1923" class="l">1923: </a>
<a href="#1924" id="1924" class="l">1924: </a>    <span class="php-var">$update_query</span> = <span class="php-keyword1">array</span>();
<a href="#1925" id="1925" class="l">1925: </a>
<a href="#1926" id="1926" class="l">1926: </a>    <span class="php-var">$counters</span> = <span class="php-keyword1">array</span>(<span class="php-quote">'threads'</span>,<span class="php-quote">'unapprovedthreads'</span>,<span class="php-quote">'posts'</span>,<span class="php-quote">'unapprovedposts'</span>);
<a href="#1927" id="1927" class="l">1927: </a>
<a href="#1928" id="1928" class="l">1928: </a>    <span class="php-comment">// Fetch above counters for this forum</span>
<a href="#1929" id="1929" class="l">1929: </a>    <span class="php-var">$query</span> = <span class="php-var">$db</span>-&gt;simple_select(<span class="php-quote">&quot;forums&quot;</span>, <span class="php-keyword2">implode</span>(<span class="php-quote">&quot;,&quot;</span>, <span class="php-var">$counters</span>), <span class="php-quote">&quot;fid='</span><span class="php-var">{$fid}</span><span class="php-quote">'&quot;</span>);
<a href="#1930" id="1930" class="l">1930: </a>    <span class="php-var">$forum</span> = <span class="php-var">$db</span>-&gt;fetch_array(<span class="php-var">$query</span>);
<a href="#1931" id="1931" class="l">1931: </a>
<a href="#1932" id="1932" class="l">1932: </a>    <span class="php-keyword1">foreach</span>(<span class="php-var">$counters</span> <span class="php-keyword1">as</span> <span class="php-var">$counter</span>)
<a href="#1933" id="1933" class="l">1933: </a>    {
<a href="#1934" id="1934" class="l">1934: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">array_key_exists</span>(<span class="php-var">$counter</span>, <span class="php-var">$changes</span>))
<a href="#1935" id="1935" class="l">1935: </a>        {
<a href="#1936" id="1936" class="l">1936: </a>            <span class="php-comment">// Adding or subtracting from previous value?</span>
<a href="#1937" id="1937" class="l">1937: </a>            <span class="php-keyword1">if</span>(<span class="php-keyword2">substr</span>(<span class="php-var">$changes</span>[<span class="php-var">$counter</span>], <span class="php-num">0</span>, <span class="php-num">1</span>) == <span class="php-quote">&quot;+&quot;</span> || <span class="php-keyword2">substr</span>(<span class="php-var">$changes</span>[<span class="php-var">$counter</span>], <span class="php-num">0</span>, <span class="php-num">1</span>) == <span class="php-quote">&quot;-&quot;</span>)
<a href="#1938" id="1938" class="l">1938: </a>            {
<a href="#1939" id="1939" class="l">1939: </a>                <span class="php-var">$update_query</span>[<span class="php-var">$counter</span>] = <span class="php-var">$forum</span>[<span class="php-var">$counter</span>] + <span class="php-var">$changes</span>[<span class="php-var">$counter</span>];
<a href="#1940" id="1940" class="l">1940: </a>            }
<a href="#1941" id="1941" class="l">1941: </a>            <span class="php-keyword1">else</span>
<a href="#1942" id="1942" class="l">1942: </a>            {
<a href="#1943" id="1943" class="l">1943: </a>                <span class="php-var">$update_query</span>[<span class="php-var">$counter</span>] = <span class="php-var">$changes</span>[<span class="php-var">$counter</span>];
<a href="#1944" id="1944" class="l">1944: </a>            }
<a href="#1945" id="1945" class="l">1945: </a>            
<a href="#1946" id="1946" class="l">1946: </a>            <span class="php-comment">// Less than 0? That's bad</span>
<a href="#1947" id="1947" class="l">1947: </a>            <span class="php-keyword1">if</span>(!<span class="php-var">$update_query</span>[<span class="php-var">$counter</span>])
<a href="#1948" id="1948" class="l">1948: </a>            {
<a href="#1949" id="1949" class="l">1949: </a>                <span class="php-var">$update_query</span>[<span class="php-var">$counter</span>] = <span class="php-num">0</span>;
<a href="#1950" id="1950" class="l">1950: </a>            }
<a href="#1951" id="1951" class="l">1951: </a>        }
<a href="#1952" id="1952" class="l">1952: </a>    }
<a href="#1953" id="1953" class="l">1953: </a>
<a href="#1954" id="1954" class="l">1954: </a>    <span class="php-comment">// Only update if we're actually doing something</span>
<a href="#1955" id="1955" class="l">1955: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">count</span>(<span class="php-var">$update_query</span>) &gt; <span class="php-num">0</span>)
<a href="#1956" id="1956" class="l">1956: </a>    {
<a href="#1957" id="1957" class="l">1957: </a>        <span class="php-var">$db</span>-&gt;update_query(<span class="php-quote">&quot;forums&quot;</span>, <span class="php-var">$update_query</span>, <span class="php-quote">&quot;fid='&quot;</span>.<span class="php-keyword2">intval</span>(<span class="php-var">$fid</span>).<span class="php-quote">&quot;'&quot;</span>);
<a href="#1958" id="1958" class="l">1958: </a>    }
<a href="#1959" id="1959" class="l">1959: </a>
<a href="#1960" id="1960" class="l">1960: </a>    <span class="php-comment">// Guess we should update the statistics too?</span>
<a href="#1961" id="1961" class="l">1961: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword1">isset</span>(<span class="php-var">$update_query</span>[<span class="php-quote">'threads'</span>]) || <span class="php-keyword1">isset</span>(<span class="php-var">$update_query</span>[<span class="php-quote">'posts'</span>]) || <span class="php-keyword1">isset</span>(<span class="php-var">$update_query</span>[<span class="php-quote">'unapprovedthreads'</span>]) || <span class="php-keyword1">isset</span>(<span class="php-var">$update_query</span>[<span class="php-quote">'unapprovedposts'</span>]))
<a href="#1962" id="1962" class="l">1962: </a>    {
<a href="#1963" id="1963" class="l">1963: </a>        <span class="php-var">$new_stats</span> = <span class="php-keyword1">array</span>();
<a href="#1964" id="1964" class="l">1964: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">array_key_exists</span>(<span class="php-quote">'threads'</span>, <span class="php-var">$update_query</span>))
<a href="#1965" id="1965" class="l">1965: </a>        {
<a href="#1966" id="1966" class="l">1966: </a>            <span class="php-var">$threads_diff</span> = <span class="php-var">$update_query</span>[<span class="php-quote">'threads'</span>] - <span class="php-var">$forum</span>[<span class="php-quote">'threads'</span>];
<a href="#1967" id="1967" class="l">1967: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$threads_diff</span> &gt; -<span class="php-num">1</span>)
<a href="#1968" id="1968" class="l">1968: </a>            {
<a href="#1969" id="1969" class="l">1969: </a>                <span class="php-var">$new_stats</span>[<span class="php-quote">'numthreads'</span>] = <span class="php-quote">&quot;+</span><span class="php-var">{$threads_diff}</span><span class="php-quote">&quot;</span>;          
<a href="#1970" id="1970" class="l">1970: </a>            }
<a href="#1971" id="1971" class="l">1971: </a>            <span class="php-keyword1">else</span>
<a href="#1972" id="1972" class="l">1972: </a>            {
<a href="#1973" id="1973" class="l">1973: </a>                <span class="php-var">$new_stats</span>[<span class="php-quote">'numthreads'</span>] = <span class="php-quote">&quot;</span><span class="php-var">{$threads_diff}</span><span class="php-quote">&quot;</span>;
<a href="#1974" id="1974" class="l">1974: </a>            }
<a href="#1975" id="1975" class="l">1975: </a>        }
<a href="#1976" id="1976" class="l">1976: </a>        
<a href="#1977" id="1977" class="l">1977: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">array_key_exists</span>(<span class="php-quote">'unapprovedthreads'</span>, <span class="php-var">$update_query</span>))
<a href="#1978" id="1978" class="l">1978: </a>        {
<a href="#1979" id="1979" class="l">1979: </a>            <span class="php-var">$unapprovedthreads_diff</span> = <span class="php-var">$update_query</span>[<span class="php-quote">'unapprovedthreads'</span>] - <span class="php-var">$forum</span>[<span class="php-quote">'unapprovedthreads'</span>];
<a href="#1980" id="1980" class="l">1980: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$unapprovedthreads_diff</span> &gt; -<span class="php-num">1</span>)
<a href="#1981" id="1981" class="l">1981: </a>            {
<a href="#1982" id="1982" class="l">1982: </a>                <span class="php-var">$new_stats</span>[<span class="php-quote">'numunapprovedthreads'</span>] = <span class="php-quote">&quot;+</span><span class="php-var">{$unapprovedthreads_diff}</span><span class="php-quote">&quot;</span>;
<a href="#1983" id="1983" class="l">1983: </a>            }
<a href="#1984" id="1984" class="l">1984: </a>            <span class="php-keyword1">else</span>
<a href="#1985" id="1985" class="l">1985: </a>            {
<a href="#1986" id="1986" class="l">1986: </a>                <span class="php-var">$new_stats</span>[<span class="php-quote">'numunapprovedthreads'</span>] = <span class="php-quote">&quot;</span><span class="php-var">{$unapprovedthreads_diff}</span><span class="php-quote">&quot;</span>;
<a href="#1987" id="1987" class="l">1987: </a>            }
<a href="#1988" id="1988" class="l">1988: </a>        }
<a href="#1989" id="1989" class="l">1989: </a>        
<a href="#1990" id="1990" class="l">1990: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">array_key_exists</span>(<span class="php-quote">'posts'</span>, <span class="php-var">$update_query</span>))
<a href="#1991" id="1991" class="l">1991: </a>        {
<a href="#1992" id="1992" class="l">1992: </a>            <span class="php-var">$posts_diff</span> = <span class="php-var">$update_query</span>[<span class="php-quote">'posts'</span>] - <span class="php-var">$forum</span>[<span class="php-quote">'posts'</span>];
<a href="#1993" id="1993" class="l">1993: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$posts_diff</span> &gt; -<span class="php-num">1</span>)
<a href="#1994" id="1994" class="l">1994: </a>            {
<a href="#1995" id="1995" class="l">1995: </a>                <span class="php-var">$new_stats</span>[<span class="php-quote">'numposts'</span>] = <span class="php-quote">&quot;+</span><span class="php-var">{$posts_diff}</span><span class="php-quote">&quot;</span>;
<a href="#1996" id="1996" class="l">1996: </a>            }
<a href="#1997" id="1997" class="l">1997: </a>            <span class="php-keyword1">else</span>
<a href="#1998" id="1998" class="l">1998: </a>            {
<a href="#1999" id="1999" class="l">1999: </a>                <span class="php-var">$new_stats</span>[<span class="php-quote">'numposts'</span>] = <span class="php-quote">&quot;</span><span class="php-var">{$posts_diff}</span><span class="php-quote">&quot;</span>;
<a href="#2000" id="2000" class="l">2000: </a>            }
<a href="#2001" id="2001" class="l">2001: </a>        }
<a href="#2002" id="2002" class="l">2002: </a>        
<a href="#2003" id="2003" class="l">2003: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">array_key_exists</span>(<span class="php-quote">'unapprovedposts'</span>, <span class="php-var">$update_query</span>))
<a href="#2004" id="2004" class="l">2004: </a>        {
<a href="#2005" id="2005" class="l">2005: </a>            <span class="php-var">$unapprovedposts_diff</span> = <span class="php-var">$update_query</span>[<span class="php-quote">'unapprovedposts'</span>] - <span class="php-var">$forum</span>[<span class="php-quote">'unapprovedposts'</span>];
<a href="#2006" id="2006" class="l">2006: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$unapprovedposts_diff</span> &gt; -<span class="php-num">1</span>)
<a href="#2007" id="2007" class="l">2007: </a>            {
<a href="#2008" id="2008" class="l">2008: </a>                <span class="php-var">$new_stats</span>[<span class="php-quote">'numunapprovedposts'</span>] = <span class="php-quote">&quot;+</span><span class="php-var">{$unapprovedposts_diff}</span><span class="php-quote">&quot;</span>;
<a href="#2009" id="2009" class="l">2009: </a>            }
<a href="#2010" id="2010" class="l">2010: </a>            <span class="php-keyword1">else</span>
<a href="#2011" id="2011" class="l">2011: </a>            {
<a href="#2012" id="2012" class="l">2012: </a>                <span class="php-var">$new_stats</span>[<span class="php-quote">'numunapprovedposts'</span>] = <span class="php-quote">&quot;</span><span class="php-var">{$unapprovedposts_diff}</span><span class="php-quote">&quot;</span>;
<a href="#2013" id="2013" class="l">2013: </a>            }
<a href="#2014" id="2014" class="l">2014: </a>        }
<a href="#2015" id="2015" class="l">2015: </a>        update_stats(<span class="php-var">$new_stats</span>);
<a href="#2016" id="2016" class="l">2016: </a>    }
<a href="#2017" id="2017" class="l">2017: </a>
<a href="#2018" id="2018" class="l">2018: </a>    <span class="php-comment">// Update last post info</span>
<a href="#2019" id="2019" class="l">2019: </a>    update_forum_lastpost(<span class="php-var">$fid</span>);
<a href="#2020" id="2020" class="l">2020: </a>    
<a href="#2021" id="2021" class="l">2021: </a>    <span class="php-var">$cache</span>-&gt;update_forums();
<a href="#2022" id="2022" class="l">2022: </a>}
<a href="#2023" id="2023" class="l">2023: </a>
<a href="#2024" id="2024" class="l">2024: </a><span class="php-comment">/**
</span><a href="#2025" id="2025" class="l">2025: </a><span class="php-comment"> * Update the last post information for a specific forum
</span><a href="#2026" id="2026" class="l">2026: </a><span class="php-comment"> *
</span><a href="#2027" id="2027" class="l">2027: </a><span class="php-comment"> * @param int The forum ID
</span><a href="#2028" id="2028" class="l">2028: </a><span class="php-comment"> */</span>
<a href="#2029" id="2029" class="l">2029: </a><span class="php-keyword1">function</span> update_forum_lastpost(<span class="php-var">$fid</span>)
<a href="#2030" id="2030" class="l">2030: </a>{
<a href="#2031" id="2031" class="l">2031: </a>    <span class="php-keyword1">global</span> <span class="php-var">$db</span>;
<a href="#2032" id="2032" class="l">2032: </a>
<a href="#2033" id="2033" class="l">2033: </a>    <span class="php-comment">// Fetch the last post for this forum</span>
<a href="#2034" id="2034" class="l">2034: </a>    <span class="php-var">$query</span> = <span class="php-var">$db</span>-&gt;query(<span class="php-quote">&quot;
</span><a href="#2035" id="2035" class="l">2035: </a><span class="php-quote">        SELECT tid, lastpost, lastposter, lastposteruid, subject
</span><a href="#2036" id="2036" class="l">2036: </a><span class="php-quote">        FROM &quot;</span>.TABLE_PREFIX.<span class="php-quote">&quot;threads
</span><a href="#2037" id="2037" class="l">2037: </a><span class="php-quote">        WHERE fid='</span><span class="php-var">{$fid}</span><span class="php-quote">' AND visible='1' AND closed NOT LIKE 'moved|%'
</span><a href="#2038" id="2038" class="l">2038: </a><span class="php-quote">        ORDER BY lastpost DESC
</span><a href="#2039" id="2039" class="l">2039: </a><span class="php-quote">        LIMIT 0, 1
</span><a href="#2040" id="2040" class="l">2040: </a><span class="php-quote">    &quot;</span>);
<a href="#2041" id="2041" class="l">2041: </a>    <span class="php-var">$lastpost</span> = <span class="php-var">$db</span>-&gt;fetch_array(<span class="php-var">$query</span>);
<a href="#2042" id="2042" class="l">2042: </a>
<a href="#2043" id="2043" class="l">2043: </a>    <span class="php-var">$updated_forum</span> = <span class="php-keyword1">array</span>(
<a href="#2044" id="2044" class="l">2044: </a>        <span class="php-quote">&quot;lastpost&quot;</span> =&gt; <span class="php-keyword2">intval</span>(<span class="php-var">$lastpost</span>[<span class="php-quote">'lastpost'</span>]),
<a href="#2045" id="2045" class="l">2045: </a>        <span class="php-quote">&quot;lastposter&quot;</span> =&gt; <span class="php-var">$db</span>-&gt;escape_string(<span class="php-var">$lastpost</span>[<span class="php-quote">'lastposter'</span>]),
<a href="#2046" id="2046" class="l">2046: </a>        <span class="php-quote">&quot;lastposteruid&quot;</span> =&gt; <span class="php-keyword2">intval</span>(<span class="php-var">$lastpost</span>[<span class="php-quote">'lastposteruid'</span>]),
<a href="#2047" id="2047" class="l">2047: </a>        <span class="php-quote">&quot;lastposttid&quot;</span> =&gt; <span class="php-keyword2">intval</span>(<span class="php-var">$lastpost</span>[<span class="php-quote">'tid'</span>]),
<a href="#2048" id="2048" class="l">2048: </a>        <span class="php-quote">&quot;lastpostsubject&quot;</span> =&gt; <span class="php-var">$db</span>-&gt;escape_string(<span class="php-var">$lastpost</span>[<span class="php-quote">'subject'</span>])
<a href="#2049" id="2049" class="l">2049: </a>    );
<a href="#2050" id="2050" class="l">2050: </a>
<a href="#2051" id="2051" class="l">2051: </a>    <span class="php-var">$db</span>-&gt;update_query(<span class="php-quote">&quot;forums&quot;</span>, <span class="php-var">$updated_forum</span>, <span class="php-quote">&quot;fid='</span><span class="php-var">{$fid}</span><span class="php-quote">'&quot;</span>);
<a href="#2052" id="2052" class="l">2052: </a>}
<a href="#2053" id="2053" class="l">2053: </a>
<a href="#2054" id="2054" class="l">2054: </a><span class="php-comment">/**
</span><a href="#2055" id="2055" class="l">2055: </a><span class="php-comment"> * Updates the thread counters with a specific value (or addition/subtraction of the previous value)
</span><a href="#2056" id="2056" class="l">2056: </a><span class="php-comment"> *
</span><a href="#2057" id="2057" class="l">2057: </a><span class="php-comment"> * @param int The thread ID
</span><a href="#2058" id="2058" class="l">2058: </a><span class="php-comment"> * @param array Array of items being updated (replies, unapprovedposts, attachmentcount) and their value (ex, 1, +1, -1)
</span><a href="#2059" id="2059" class="l">2059: </a><span class="php-comment"> */</span>
<a href="#2060" id="2060" class="l">2060: </a><span class="php-keyword1">function</span> update_thread_counters(<span class="php-var">$tid</span>, <span class="php-var">$changes</span>=<span class="php-keyword1">array</span>())
<a href="#2061" id="2061" class="l">2061: </a>{
<a href="#2062" id="2062" class="l">2062: </a>    <span class="php-keyword1">global</span> <span class="php-var">$db</span>;
<a href="#2063" id="2063" class="l">2063: </a>
<a href="#2064" id="2064" class="l">2064: </a>    <span class="php-var">$update_query</span> = <span class="php-keyword1">array</span>();
<a href="#2065" id="2065" class="l">2065: </a>    
<a href="#2066" id="2066" class="l">2066: </a>    <span class="php-var">$counters</span> = <span class="php-keyword1">array</span>(<span class="php-quote">'replies'</span>,<span class="php-quote">'unapprovedposts'</span>,<span class="php-quote">'attachmentcount'</span>, <span class="php-quote">'attachmentcount'</span>);
<a href="#2067" id="2067" class="l">2067: </a>    
<a href="#2068" id="2068" class="l">2068: </a>    <span class="php-comment">// Fetch above counters for this thread</span>
<a href="#2069" id="2069" class="l">2069: </a>    <span class="php-var">$query</span> = <span class="php-var">$db</span>-&gt;simple_select(<span class="php-quote">&quot;threads&quot;</span>, <span class="php-keyword2">implode</span>(<span class="php-quote">&quot;,&quot;</span>, <span class="php-var">$counters</span>), <span class="php-quote">&quot;tid='</span><span class="php-var">{$tid}</span><span class="php-quote">'&quot;</span>);
<a href="#2070" id="2070" class="l">2070: </a>    <span class="php-var">$thread</span> = <span class="php-var">$db</span>-&gt;fetch_array(<span class="php-var">$query</span>);
<a href="#2071" id="2071" class="l">2071: </a>    
<a href="#2072" id="2072" class="l">2072: </a>    <span class="php-keyword1">foreach</span>(<span class="php-var">$counters</span> <span class="php-keyword1">as</span> <span class="php-var">$counter</span>)
<a href="#2073" id="2073" class="l">2073: </a>    {
<a href="#2074" id="2074" class="l">2074: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">array_key_exists</span>(<span class="php-var">$counter</span>, <span class="php-var">$changes</span>))
<a href="#2075" id="2075" class="l">2075: </a>        {
<a href="#2076" id="2076" class="l">2076: </a>            <span class="php-comment">// Adding or subtracting from previous value?</span>
<a href="#2077" id="2077" class="l">2077: </a>            <span class="php-keyword1">if</span>(<span class="php-keyword2">substr</span>(<span class="php-var">$changes</span>[<span class="php-var">$counter</span>], <span class="php-num">0</span>, <span class="php-num">1</span>) == <span class="php-quote">&quot;+&quot;</span> || <span class="php-keyword2">substr</span>(<span class="php-var">$changes</span>[<span class="php-var">$counter</span>], <span class="php-num">0</span>, <span class="php-num">1</span>) == <span class="php-quote">&quot;-&quot;</span>)
<a href="#2078" id="2078" class="l">2078: </a>            {
<a href="#2079" id="2079" class="l">2079: </a>                <span class="php-var">$update_query</span>[<span class="php-var">$counter</span>] = <span class="php-var">$thread</span>[<span class="php-var">$counter</span>] + <span class="php-var">$changes</span>[<span class="php-var">$counter</span>];
<a href="#2080" id="2080" class="l">2080: </a>            }
<a href="#2081" id="2081" class="l">2081: </a>            <span class="php-keyword1">else</span>
<a href="#2082" id="2082" class="l">2082: </a>            {
<a href="#2083" id="2083" class="l">2083: </a>                <span class="php-var">$update_query</span>[<span class="php-var">$counter</span>] = <span class="php-var">$changes</span>[<span class="php-var">$counter</span>];
<a href="#2084" id="2084" class="l">2084: </a>            }
<a href="#2085" id="2085" class="l">2085: </a>            
<a href="#2086" id="2086" class="l">2086: </a>            <span class="php-comment">// Less than 0? That's bad</span>
<a href="#2087" id="2087" class="l">2087: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$update_query</span>[<span class="php-var">$counter</span>] &lt; <span class="php-num">0</span>)
<a href="#2088" id="2088" class="l">2088: </a>            {
<a href="#2089" id="2089" class="l">2089: </a>                <span class="php-var">$update_query</span>[<span class="php-var">$counter</span>] = <span class="php-num">0</span>;
<a href="#2090" id="2090" class="l">2090: </a>            }
<a href="#2091" id="2091" class="l">2091: </a>        }
<a href="#2092" id="2092" class="l">2092: </a>    }
<a href="#2093" id="2093" class="l">2093: </a>    
<a href="#2094" id="2094" class="l">2094: </a>    <span class="php-var">$db</span>-&gt;free_result(<span class="php-var">$query</span>);
<a href="#2095" id="2095" class="l">2095: </a>
<a href="#2096" id="2096" class="l">2096: </a>    <span class="php-comment">// Only update if we're actually doing something</span>
<a href="#2097" id="2097" class="l">2097: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">count</span>(<span class="php-var">$update_query</span>) &gt; <span class="php-num">0</span>)
<a href="#2098" id="2098" class="l">2098: </a>    {
<a href="#2099" id="2099" class="l">2099: </a>        <span class="php-var">$db</span>-&gt;update_query(<span class="php-quote">&quot;threads&quot;</span>, <span class="php-var">$update_query</span>, <span class="php-quote">&quot;tid='&quot;</span>.<span class="php-keyword2">intval</span>(<span class="php-var">$tid</span>).<span class="php-quote">&quot;'&quot;</span>);
<a href="#2100" id="2100" class="l">2100: </a>    }
<a href="#2101" id="2101" class="l">2101: </a>    
<a href="#2102" id="2102" class="l">2102: </a>    <span class="php-keyword1">unset</span>(<span class="php-var">$update_query</span>, <span class="php-var">$thread</span>);
<a href="#2103" id="2103" class="l">2103: </a>
<a href="#2104" id="2104" class="l">2104: </a>    update_thread_data(<span class="php-var">$tid</span>);
<a href="#2105" id="2105" class="l">2105: </a>}
<a href="#2106" id="2106" class="l">2106: </a>
<a href="#2107" id="2107" class="l">2107: </a><span class="php-comment">/**
</span><a href="#2108" id="2108" class="l">2108: </a><span class="php-comment"> * Update the first post and lastpost data for a specific thread
</span><a href="#2109" id="2109" class="l">2109: </a><span class="php-comment"> *
</span><a href="#2110" id="2110" class="l">2110: </a><span class="php-comment"> * @param int The thread ID
</span><a href="#2111" id="2111" class="l">2111: </a><span class="php-comment"> */</span>
<a href="#2112" id="2112" class="l">2112: </a><span class="php-keyword1">function</span> update_thread_data(<span class="php-var">$tid</span>)
<a href="#2113" id="2113" class="l">2113: </a>{
<a href="#2114" id="2114" class="l">2114: </a>    <span class="php-keyword1">global</span> <span class="php-var">$db</span>;
<a href="#2115" id="2115" class="l">2115: </a>
<a href="#2116" id="2116" class="l">2116: </a>    <span class="php-var">$thread</span> = get_thread(<span class="php-var">$tid</span>);
<a href="#2117" id="2117" class="l">2117: </a>
<a href="#2118" id="2118" class="l">2118: </a>    <span class="php-comment">// If this is a moved thread marker, don't update it - we need it to stay as it is</span>
<a href="#2119" id="2119" class="l">2119: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">strpos</span>(<span class="php-var">$thread</span>[<span class="php-quote">'closed'</span>], <span class="php-quote">'moved|'</span>) !== <span class="php-keyword1">false</span>)
<a href="#2120" id="2120" class="l">2120: </a>    {
<a href="#2121" id="2121" class="l">2121: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#2122" id="2122" class="l">2122: </a>    }
<a href="#2123" id="2123" class="l">2123: </a>
<a href="#2124" id="2124" class="l">2124: </a>    <span class="php-var">$query</span> = <span class="php-var">$db</span>-&gt;query(<span class="php-quote">&quot;
</span><a href="#2125" id="2125" class="l">2125: </a><span class="php-quote">        SELECT u.uid, u.username, p.username AS postusername, p.dateline
</span><a href="#2126" id="2126" class="l">2126: </a><span class="php-quote">        FROM &quot;</span>.TABLE_PREFIX.<span class="php-quote">&quot;posts p
</span><a href="#2127" id="2127" class="l">2127: </a><span class="php-quote">        LEFT JOIN &quot;</span>.TABLE_PREFIX.<span class="php-quote">&quot;users u ON (u.uid=p.uid)
</span><a href="#2128" id="2128" class="l">2128: </a><span class="php-quote">        WHERE p.tid='</span><span class="php-var">$tid</span><span class="php-quote">' AND p.visible='1'
</span><a href="#2129" id="2129" class="l">2129: </a><span class="php-quote">        ORDER BY p.dateline DESC
</span><a href="#2130" id="2130" class="l">2130: </a><span class="php-quote">        LIMIT 1&quot;</span>
<a href="#2131" id="2131" class="l">2131: </a>    );
<a href="#2132" id="2132" class="l">2132: </a>    <span class="php-var">$lastpost</span> = <span class="php-var">$db</span>-&gt;fetch_array(<span class="php-var">$query</span>);
<a href="#2133" id="2133" class="l">2133: </a>    
<a href="#2134" id="2134" class="l">2134: </a>    <span class="php-var">$db</span>-&gt;free_result(<span class="php-var">$query</span>);
<a href="#2135" id="2135" class="l">2135: </a>    
<a href="#2136" id="2136" class="l">2136: </a>    <span class="php-var">$query</span> = <span class="php-var">$db</span>-&gt;query(<span class="php-quote">&quot;
</span><a href="#2137" id="2137" class="l">2137: </a><span class="php-quote">        SELECT u.uid, u.username, p.username AS postusername, p.dateline
</span><a href="#2138" id="2138" class="l">2138: </a><span class="php-quote">        FROM &quot;</span>.TABLE_PREFIX.<span class="php-quote">&quot;posts p
</span><a href="#2139" id="2139" class="l">2139: </a><span class="php-quote">        LEFT JOIN &quot;</span>.TABLE_PREFIX.<span class="php-quote">&quot;users u ON (u.uid=p.uid)
</span><a href="#2140" id="2140" class="l">2140: </a><span class="php-quote">        WHERE p.tid='</span><span class="php-var">$tid</span><span class="php-quote">'
</span><a href="#2141" id="2141" class="l">2141: </a><span class="php-quote">        ORDER BY p.dateline ASC
</span><a href="#2142" id="2142" class="l">2142: </a><span class="php-quote">        LIMIT 1
</span><a href="#2143" id="2143" class="l">2143: </a><span class="php-quote">    &quot;</span>);
<a href="#2144" id="2144" class="l">2144: </a>    <span class="php-var">$firstpost</span> = <span class="php-var">$db</span>-&gt;fetch_array(<span class="php-var">$query</span>);
<a href="#2145" id="2145" class="l">2145: </a>    
<a href="#2146" id="2146" class="l">2146: </a>    <span class="php-var">$db</span>-&gt;free_result(<span class="php-var">$query</span>);
<a href="#2147" id="2147" class="l">2147: </a>
<a href="#2148" id="2148" class="l">2148: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$firstpost</span>[<span class="php-quote">'username'</span>])
<a href="#2149" id="2149" class="l">2149: </a>    {
<a href="#2150" id="2150" class="l">2150: </a>        <span class="php-var">$firstpost</span>[<span class="php-quote">'username'</span>] = <span class="php-var">$firstpost</span>[<span class="php-quote">'postusername'</span>];
<a href="#2151" id="2151" class="l">2151: </a>    }
<a href="#2152" id="2152" class="l">2152: </a>
<a href="#2153" id="2153" class="l">2153: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$lastpost</span>[<span class="php-quote">'username'</span>])
<a href="#2154" id="2154" class="l">2154: </a>    {
<a href="#2155" id="2155" class="l">2155: </a>        <span class="php-var">$lastpost</span>[<span class="php-quote">'username'</span>] = <span class="php-var">$lastpost</span>[<span class="php-quote">'postusername'</span>];
<a href="#2156" id="2156" class="l">2156: </a>    }
<a href="#2157" id="2157" class="l">2157: </a>
<a href="#2158" id="2158" class="l">2158: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$lastpost</span>[<span class="php-quote">'dateline'</span>])
<a href="#2159" id="2159" class="l">2159: </a>    {
<a href="#2160" id="2160" class="l">2160: </a>        <span class="php-var">$lastpost</span>[<span class="php-quote">'username'</span>] = <span class="php-var">$firstpost</span>[<span class="php-quote">'username'</span>];
<a href="#2161" id="2161" class="l">2161: </a>        <span class="php-var">$lastpost</span>[<span class="php-quote">'uid'</span>] = <span class="php-var">$firstpost</span>[<span class="php-quote">'uid'</span>];
<a href="#2162" id="2162" class="l">2162: </a>        <span class="php-var">$lastpost</span>[<span class="php-quote">'dateline'</span>] = <span class="php-var">$firstpost</span>[<span class="php-quote">'dateline'</span>];
<a href="#2163" id="2163" class="l">2163: </a>    }
<a href="#2164" id="2164" class="l">2164: </a>
<a href="#2165" id="2165" class="l">2165: </a>    <span class="php-var">$lastpost</span>[<span class="php-quote">'username'</span>] = <span class="php-var">$db</span>-&gt;escape_string(<span class="php-var">$lastpost</span>[<span class="php-quote">'username'</span>]);
<a href="#2166" id="2166" class="l">2166: </a>    <span class="php-var">$firstpost</span>[<span class="php-quote">'username'</span>] = <span class="php-var">$db</span>-&gt;escape_string(<span class="php-var">$firstpost</span>[<span class="php-quote">'username'</span>]);
<a href="#2167" id="2167" class="l">2167: </a>
<a href="#2168" id="2168" class="l">2168: </a>    <span class="php-var">$update_array</span> = <span class="php-keyword1">array</span>(
<a href="#2169" id="2169" class="l">2169: </a>        <span class="php-quote">'username'</span> =&gt; <span class="php-var">$firstpost</span>[<span class="php-quote">'username'</span>],
<a href="#2170" id="2170" class="l">2170: </a>        <span class="php-quote">'uid'</span> =&gt; <span class="php-keyword2">intval</span>(<span class="php-var">$firstpost</span>[<span class="php-quote">'uid'</span>]),
<a href="#2171" id="2171" class="l">2171: </a>        <span class="php-quote">'dateline'</span> =&gt; <span class="php-keyword2">intval</span>(<span class="php-var">$firstpost</span>[<span class="php-quote">'dateline'</span>]),
<a href="#2172" id="2172" class="l">2172: </a>        <span class="php-quote">'lastpost'</span> =&gt; <span class="php-keyword2">intval</span>(<span class="php-var">$lastpost</span>[<span class="php-quote">'dateline'</span>]),
<a href="#2173" id="2173" class="l">2173: </a>        <span class="php-quote">'lastposter'</span> =&gt; <span class="php-var">$lastpost</span>[<span class="php-quote">'username'</span>],
<a href="#2174" id="2174" class="l">2174: </a>        <span class="php-quote">'lastposteruid'</span> =&gt; <span class="php-keyword2">intval</span>(<span class="php-var">$lastpost</span>[<span class="php-quote">'uid'</span>]),
<a href="#2175" id="2175" class="l">2175: </a>    );
<a href="#2176" id="2176" class="l">2176: </a>    <span class="php-var">$db</span>-&gt;update_query(<span class="php-quote">&quot;threads&quot;</span>, <span class="php-var">$update_array</span>, <span class="php-quote">&quot;tid='</span><span class="php-var">{$tid}</span><span class="php-quote">'&quot;</span>);
<a href="#2177" id="2177" class="l">2177: </a>    
<a href="#2178" id="2178" class="l">2178: </a>    <span class="php-keyword1">unset</span>(<span class="php-var">$firstpost</span>, <span class="php-var">$lastpost</span>, <span class="php-var">$update_array</span>);
<a href="#2179" id="2179" class="l">2179: </a>}
<a href="#2180" id="2180" class="l">2180: </a>
<a href="#2181" id="2181" class="l">2181: </a><span class="php-keyword1">function</span> update_forum_count(<span class="php-var">$fid</span>)
<a href="#2182" id="2182" class="l">2182: </a>{
<a href="#2183" id="2183" class="l">2183: </a>    <span class="php-keyword1">die</span>(<span class="php-quote">&quot;Deprecated function call: update_forum_count&quot;</span>);
<a href="#2184" id="2184" class="l">2184: </a>}
<a href="#2185" id="2185" class="l">2185: </a><span class="php-keyword1">function</span> update_thread_count(<span class="php-var">$tid</span>)
<a href="#2186" id="2186" class="l">2186: </a>{
<a href="#2187" id="2187" class="l">2187: </a>    <span class="php-keyword1">die</span>(<span class="php-quote">&quot;Deprecated function call: update_thread_count&quot;</span>);
<a href="#2188" id="2188" class="l">2188: </a>}
<a href="#2189" id="2189" class="l">2189: </a><span class="php-keyword1">function</span> update_thread_attachment_count(<span class="php-var">$tid</span>)
<a href="#2190" id="2190" class="l">2190: </a>{
<a href="#2191" id="2191" class="l">2191: </a>    <span class="php-keyword1">die</span>(<span class="php-quote">&quot;Deprecated function call: update_thread_attachment_count&quot;</span>);
<a href="#2192" id="2192" class="l">2192: </a>}
<a href="#2193" id="2193" class="l">2193: </a>
<a href="#2194" id="2194" class="l">2194: </a><span class="php-comment">/**
</span><a href="#2195" id="2195" class="l">2195: </a><span class="php-comment"> * Deletes a thread from the database
</span><a href="#2196" id="2196" class="l">2196: </a><span class="php-comment"> *
</span><a href="#2197" id="2197" class="l">2197: </a><span class="php-comment"> * @param int The thread ID
</span><a href="#2198" id="2198" class="l">2198: </a><span class="php-comment"> */</span>
<a href="#2199" id="2199" class="l">2199: </a><span class="php-keyword1">function</span> delete_thread(<span class="php-var">$tid</span>)
<a href="#2200" id="2200" class="l">2200: </a>{
<a href="#2201" id="2201" class="l">2201: </a>    <span class="php-keyword1">global</span> <span class="php-var">$moderation</span>;
<a href="#2202" id="2202" class="l">2202: </a>
<a href="#2203" id="2203" class="l">2203: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_object</span>(<span class="php-var">$moderation</span>))
<a href="#2204" id="2204" class="l">2204: </a>    {
<a href="#2205" id="2205" class="l">2205: </a>        <span class="php-keyword1">require_once</span> MYBB_ROOT.<span class="php-quote">&quot;inc/class_moderation.php&quot;</span>;
<a href="#2206" id="2206" class="l">2206: </a>        <span class="php-var">$moderation</span> = <span class="php-keyword1">new</span> Moderation;
<a href="#2207" id="2207" class="l">2207: </a>    }
<a href="#2208" id="2208" class="l">2208: </a>
<a href="#2209" id="2209" class="l">2209: </a>    <span class="php-keyword1">return</span> <span class="php-var">$moderation</span>-&gt;delete_thread(<span class="php-var">$tid</span>);
<a href="#2210" id="2210" class="l">2210: </a>}
<a href="#2211" id="2211" class="l">2211: </a>
<a href="#2212" id="2212" class="l">2212: </a><span class="php-comment">/**
</span><a href="#2213" id="2213" class="l">2213: </a><span class="php-comment"> * Deletes a post from the database
</span><a href="#2214" id="2214" class="l">2214: </a><span class="php-comment"> *
</span><a href="#2215" id="2215" class="l">2215: </a><span class="php-comment"> * @param int The thread ID
</span><a href="#2216" id="2216" class="l">2216: </a><span class="php-comment"> */</span>
<a href="#2217" id="2217" class="l">2217: </a><span class="php-keyword1">function</span> delete_post(<span class="php-var">$pid</span>, <span class="php-var">$tid</span>=<span class="php-quote">&quot;&quot;</span>)
<a href="#2218" id="2218" class="l">2218: </a>{
<a href="#2219" id="2219" class="l">2219: </a>    <span class="php-keyword1">global</span> <span class="php-var">$moderation</span>;
<a href="#2220" id="2220" class="l">2220: </a>
<a href="#2221" id="2221" class="l">2221: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_object</span>(<span class="php-var">$moderation</span>))
<a href="#2222" id="2222" class="l">2222: </a>    {
<a href="#2223" id="2223" class="l">2223: </a>        <span class="php-keyword1">require_once</span> MYBB_ROOT.<span class="php-quote">&quot;inc/class_moderation.php&quot;</span>;
<a href="#2224" id="2224" class="l">2224: </a>        <span class="php-var">$moderation</span> = <span class="php-keyword1">new</span> Moderation;
<a href="#2225" id="2225" class="l">2225: </a>    }
<a href="#2226" id="2226" class="l">2226: </a>
<a href="#2227" id="2227" class="l">2227: </a>    <span class="php-keyword1">return</span> <span class="php-var">$moderation</span>-&gt;delete_post(<span class="php-var">$pid</span>);
<a href="#2228" id="2228" class="l">2228: </a>}
<a href="#2229" id="2229" class="l">2229: </a>
<a href="#2230" id="2230" class="l">2230: </a><span class="php-comment">/**
</span><a href="#2231" id="2231" class="l">2231: </a><span class="php-comment"> * Builds a forum jump menu
</span><a href="#2232" id="2232" class="l">2232: </a><span class="php-comment"> *
</span><a href="#2233" id="2233" class="l">2233: </a><span class="php-comment"> * @param int The parent forum to start with
</span><a href="#2234" id="2234" class="l">2234: </a><span class="php-comment"> * @param int The selected item ID
</span><a href="#2235" id="2235" class="l">2235: </a><span class="php-comment"> * @param int If we need to add select boxes to this cal or not
</span><a href="#2236" id="2236" class="l">2236: </a><span class="php-comment"> * @param int The current depth of forums we're at
</span><a href="#2237" id="2237" class="l">2237: </a><span class="php-comment"> * @param int Whether or not to show extra items such as User CP, Forum home
</span><a href="#2238" id="2238" class="l">2238: </a><span class="php-comment"> * @param boolean Ignore the showinjump setting and show all forums (for moderation pages)
</span><a href="#2239" id="2239" class="l">2239: </a><span class="php-comment"> * @param array Array of permissions
</span><a href="#2240" id="2240" class="l">2240: </a><span class="php-comment"> * @param string The name of the forum jump
</span><a href="#2241" id="2241" class="l">2241: </a><span class="php-comment"> * @return string Forum jump items
</span><a href="#2242" id="2242" class="l">2242: </a><span class="php-comment"> */</span>
<a href="#2243" id="2243" class="l">2243: </a><span class="php-keyword1">function</span> build_forum_jump(<span class="php-var">$pid</span>=<span class="php-quote">&quot;0&quot;</span>, <span class="php-var">$selitem</span>=<span class="php-quote">&quot;&quot;</span>, <span class="php-var">$addselect</span>=<span class="php-quote">&quot;1&quot;</span>, <span class="php-var">$depth</span>=<span class="php-quote">&quot;&quot;</span>, <span class="php-var">$showextras</span>=<span class="php-quote">&quot;1&quot;</span>, <span class="php-var">$showall</span>=<span class="php-keyword1">false</span>, <span class="php-var">$permissions</span>=<span class="php-quote">&quot;&quot;</span>, <span class="php-var">$name</span>=<span class="php-quote">&quot;fid&quot;</span>)
<a href="#2244" id="2244" class="l">2244: </a>{
<a href="#2245" id="2245" class="l">2245: </a>    <span class="php-keyword1">global</span> <span class="php-var">$forum_cache</span>, <span class="php-var">$jumpfcache</span>, <span class="php-var">$permissioncache</span>, <span class="php-var">$mybb</span>, <span class="php-var">$selecteddone</span>, <span class="php-var">$forumjump</span>, <span class="php-var">$forumjumpbits</span>, <span class="php-var">$gobutton</span>, <span class="php-var">$theme</span>, <span class="php-var">$templates</span>, <span class="php-var">$lang</span>;
<a href="#2246" id="2246" class="l">2246: </a>
<a href="#2247" id="2247" class="l">2247: </a>    <span class="php-var">$pid</span> = <span class="php-keyword2">intval</span>(<span class="php-var">$pid</span>);
<a href="#2248" id="2248" class="l">2248: </a>
<a href="#2249" id="2249" class="l">2249: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$permissions</span>)
<a href="#2250" id="2250" class="l">2250: </a>    {
<a href="#2251" id="2251" class="l">2251: </a>        <span class="php-var">$permissions</span> = <span class="php-var">$mybb</span>-&gt;usergroup;
<a href="#2252" id="2252" class="l">2252: </a>    }
<a href="#2253" id="2253" class="l">2253: </a>
<a href="#2254" id="2254" class="l">2254: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$jumpfcache</span>))
<a href="#2255" id="2255" class="l">2255: </a>    {
<a href="#2256" id="2256" class="l">2256: </a>        <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$forum_cache</span>))
<a href="#2257" id="2257" class="l">2257: </a>        {
<a href="#2258" id="2258" class="l">2258: </a>            cache_forums();
<a href="#2259" id="2259" class="l">2259: </a>        }
<a href="#2260" id="2260" class="l">2260: </a>
<a href="#2261" id="2261" class="l">2261: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$forum_cache</span> <span class="php-keyword1">as</span> <span class="php-var">$fid</span> =&gt; <span class="php-var">$forum</span>)
<a href="#2262" id="2262" class="l">2262: </a>        {
<a href="#2263" id="2263" class="l">2263: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$forum</span>[<span class="php-quote">'active'</span>] != <span class="php-num">0</span>)
<a href="#2264" id="2264" class="l">2264: </a>            {
<a href="#2265" id="2265" class="l">2265: </a>                <span class="php-var">$jumpfcache</span>[<span class="php-var">$forum</span>[<span class="php-quote">'pid'</span>]][<span class="php-var">$forum</span>[<span class="php-quote">'disporder'</span>]][<span class="php-var">$forum</span>[<span class="php-quote">'fid'</span>]] = <span class="php-var">$forum</span>;
<a href="#2266" id="2266" class="l">2266: </a>            }
<a href="#2267" id="2267" class="l">2267: </a>        }
<a href="#2268" id="2268" class="l">2268: </a>    }
<a href="#2269" id="2269" class="l">2269: </a>
<a href="#2270" id="2270" class="l">2270: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$permissioncache</span>))
<a href="#2271" id="2271" class="l">2271: </a>    {
<a href="#2272" id="2272" class="l">2272: </a>        <span class="php-var">$permissioncache</span> = forum_permissions();
<a href="#2273" id="2273" class="l">2273: </a>    }
<a href="#2274" id="2274" class="l">2274: </a>
<a href="#2275" id="2275" class="l">2275: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$jumpfcache</span>[<span class="php-var">$pid</span>]))
<a href="#2276" id="2276" class="l">2276: </a>    {
<a href="#2277" id="2277" class="l">2277: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$jumpfcache</span>[<span class="php-var">$pid</span>] <span class="php-keyword1">as</span> <span class="php-var">$main</span>)
<a href="#2278" id="2278" class="l">2278: </a>        {
<a href="#2279" id="2279" class="l">2279: </a>            <span class="php-keyword1">foreach</span>(<span class="php-var">$main</span> <span class="php-keyword1">as</span> <span class="php-var">$forum</span>)
<a href="#2280" id="2280" class="l">2280: </a>            {
<a href="#2281" id="2281" class="l">2281: </a>                <span class="php-var">$perms</span> = <span class="php-var">$permissioncache</span>[<span class="php-var">$forum</span>[<span class="php-quote">'fid'</span>]];
<a href="#2282" id="2282" class="l">2282: </a>
<a href="#2283" id="2283" class="l">2283: </a>                <span class="php-keyword1">if</span>(<span class="php-var">$forum</span>[<span class="php-quote">'fid'</span>] != <span class="php-quote">&quot;0&quot;</span> &amp;&amp; (<span class="php-var">$perms</span>[<span class="php-quote">'canview'</span>] != <span class="php-num">0</span> || <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'hideprivateforums'</span>] == <span class="php-num">0</span>) &amp;&amp; <span class="php-var">$forum</span>[<span class="php-quote">'linkto'</span>] == <span class="php-quote">''</span> &amp;&amp; (<span class="php-var">$forum</span>[<span class="php-quote">'showinjump'</span>] != <span class="php-num">0</span> || <span class="php-var">$showall</span> == <span class="php-keyword1">true</span>))
<a href="#2284" id="2284" class="l">2284: </a>                {
<a href="#2285" id="2285" class="l">2285: </a>                    <span class="php-var">$optionselected</span> = <span class="php-quote">&quot;&quot;</span>;
<a href="#2286" id="2286" class="l">2286: </a>
<a href="#2287" id="2287" class="l">2287: </a>                    <span class="php-keyword1">if</span>(<span class="php-var">$selitem</span> == <span class="php-var">$forum</span>[<span class="php-quote">'fid'</span>])
<a href="#2288" id="2288" class="l">2288: </a>                    {
<a href="#2289" id="2289" class="l">2289: </a>                        <span class="php-var">$optionselected</span> = <span class="php-quote">&quot;selected=\&quot;selected\&quot;&quot;</span>;
<a href="#2290" id="2290" class="l">2290: </a>                        <span class="php-var">$selecteddone</span> = <span class="php-num">1</span>;
<a href="#2291" id="2291" class="l">2291: </a>                    }
<a href="#2292" id="2292" class="l">2292: </a>                    
<a href="#2293" id="2293" class="l">2293: </a>                    <span class="php-var">$forum</span>[<span class="php-quote">'name'</span>] = htmlspecialchars_uni(<span class="php-keyword2">strip_tags</span>(<span class="php-var">$forum</span>[<span class="php-quote">'name'</span>]));
<a href="#2294" id="2294" class="l">2294: </a>
<a href="#2295" id="2295" class="l">2295: </a>                    <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$forumjumpbits</span><span class="php-quote"> .= \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;forumjump_bit&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#2296" id="2296" class="l">2296: </a>
<a href="#2297" id="2297" class="l">2297: </a>                    <span class="php-keyword1">if</span>(<span class="php-var">$forum_cache</span>[<span class="php-var">$forum</span>[<span class="php-quote">'fid'</span>]])
<a href="#2298" id="2298" class="l">2298: </a>                    {
<a href="#2299" id="2299" class="l">2299: </a>                        <span class="php-var">$newdepth</span> = <span class="php-var">$depth</span>.<span class="php-quote">&quot;--&quot;</span>;
<a href="#2300" id="2300" class="l">2300: </a>                        <span class="php-var">$forumjumpbits</span> .= build_forum_jump(<span class="php-var">$forum</span>[<span class="php-quote">'fid'</span>], <span class="php-var">$selitem</span>, <span class="php-num">0</span>, <span class="php-var">$newdepth</span>, <span class="php-var">$showextras</span>, <span class="php-var">$showall</span>);
<a href="#2301" id="2301" class="l">2301: </a>                    }
<a href="#2302" id="2302" class="l">2302: </a>                }
<a href="#2303" id="2303" class="l">2303: </a>            }
<a href="#2304" id="2304" class="l">2304: </a>        }
<a href="#2305" id="2305" class="l">2305: </a>    }
<a href="#2306" id="2306" class="l">2306: </a>
<a href="#2307" id="2307" class="l">2307: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$addselect</span>)
<a href="#2308" id="2308" class="l">2308: </a>    {
<a href="#2309" id="2309" class="l">2309: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$selecteddone</span>)
<a href="#2310" id="2310" class="l">2310: </a>        {
<a href="#2311" id="2311" class="l">2311: </a>            <span class="php-keyword1">if</span>(!<span class="php-var">$selitem</span>)
<a href="#2312" id="2312" class="l">2312: </a>            {
<a href="#2313" id="2313" class="l">2313: </a>                <span class="php-var">$selitem</span> = <span class="php-quote">&quot;default&quot;</span>;
<a href="#2314" id="2314" class="l">2314: </a>            }
<a href="#2315" id="2315" class="l">2315: </a>
<a href="#2316" id="2316" class="l">2316: </a>            <span class="php-var">$jumpsel</span>[<span class="php-var">$selitem</span>] = <span class="php-quote">'selected=&quot;selected&quot;'</span>;
<a href="#2317" id="2317" class="l">2317: </a>        }
<a href="#2318" id="2318" class="l">2318: </a>
<a href="#2319" id="2319" class="l">2319: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$showextras</span> == <span class="php-num">0</span>)
<a href="#2320" id="2320" class="l">2320: </a>        {
<a href="#2321" id="2321" class="l">2321: </a>            <span class="php-var">$template</span> = <span class="php-quote">&quot;special&quot;</span>;
<a href="#2322" id="2322" class="l">2322: </a>        }
<a href="#2323" id="2323" class="l">2323: </a>        <span class="php-keyword1">else</span>
<a href="#2324" id="2324" class="l">2324: </a>        {
<a href="#2325" id="2325" class="l">2325: </a>            <span class="php-var">$template</span> = <span class="php-quote">&quot;advanced&quot;</span>;
<a href="#2326" id="2326" class="l">2326: </a>
<a href="#2327" id="2327" class="l">2327: </a>            <span class="php-keyword1">if</span>(<span class="php-keyword2">strpos</span>(FORUM_URL, <span class="php-quote">'.html'</span>) !== <span class="php-keyword1">false</span>)
<a href="#2328" id="2328" class="l">2328: </a>            {
<a href="#2329" id="2329" class="l">2329: </a>                <span class="php-var">$forum_link</span> = <span class="php-quote">&quot;'&quot;</span>.<span class="php-keyword2">str_replace</span>(<span class="php-quote">'{fid}'</span>, <span class="php-quote">&quot;'+this.options[this.selectedIndex].value+'&quot;</span>, FORUM_URL).<span class="php-quote">&quot;'&quot;</span>;
<a href="#2330" id="2330" class="l">2330: </a>            }
<a href="#2331" id="2331" class="l">2331: </a>            <span class="php-keyword1">else</span>
<a href="#2332" id="2332" class="l">2332: </a>            {
<a href="#2333" id="2333" class="l">2333: </a>                <span class="php-var">$forum_link</span> = <span class="php-quote">&quot;'&quot;</span>.<span class="php-keyword2">str_replace</span>(<span class="php-quote">'{fid}'</span>, <span class="php-quote">&quot;'+this.options[this.selectedIndex].value&quot;</span>, FORUM_URL);
<a href="#2334" id="2334" class="l">2334: </a>            }
<a href="#2335" id="2335" class="l">2335: </a>        }
<a href="#2336" id="2336" class="l">2336: </a>
<a href="#2337" id="2337" class="l">2337: </a>        <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$forumjump</span><span class="php-quote"> = \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;forumjump_&quot;</span>.<span class="php-var">$template</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#2338" id="2338" class="l">2338: </a>    }
<a href="#2339" id="2339" class="l">2339: </a>
<a href="#2340" id="2340" class="l">2340: </a>    <span class="php-keyword1">return</span> <span class="php-var">$forumjump</span>;
<a href="#2341" id="2341" class="l">2341: </a>}
<a href="#2342" id="2342" class="l">2342: </a>
<a href="#2343" id="2343" class="l">2343: </a><span class="php-comment">/**
</span><a href="#2344" id="2344" class="l">2344: </a><span class="php-comment"> * Returns the extension of a file.
</span><a href="#2345" id="2345" class="l">2345: </a><span class="php-comment"> *
</span><a href="#2346" id="2346" class="l">2346: </a><span class="php-comment"> * @param string The filename.
</span><a href="#2347" id="2347" class="l">2347: </a><span class="php-comment"> * @return string The extension of the file.
</span><a href="#2348" id="2348" class="l">2348: </a><span class="php-comment"> */</span>
<a href="#2349" id="2349" class="l">2349: </a><span class="php-keyword1">function</span> get_extension(<span class="php-var">$file</span>)
<a href="#2350" id="2350" class="l">2350: </a>{
<a href="#2351" id="2351" class="l">2351: </a>    <span class="php-keyword1">return</span> my_strtolower(my_substr(<span class="php-keyword2">strrchr</span>(<span class="php-var">$file</span>, <span class="php-quote">&quot;.&quot;</span>), <span class="php-num">1</span>));
<a href="#2352" id="2352" class="l">2352: </a>}
<a href="#2353" id="2353" class="l">2353: </a>
<a href="#2354" id="2354" class="l">2354: </a><span class="php-comment">/**
</span><a href="#2355" id="2355" class="l">2355: </a><span class="php-comment"> * Generates a random string.
</span><a href="#2356" id="2356" class="l">2356: </a><span class="php-comment"> *
</span><a href="#2357" id="2357" class="l">2357: </a><span class="php-comment"> * @param int The length of the string to generate.
</span><a href="#2358" id="2358" class="l">2358: </a><span class="php-comment"> * @return string The random string.
</span><a href="#2359" id="2359" class="l">2359: </a><span class="php-comment"> */</span>
<a href="#2360" id="2360" class="l">2360: </a><span class="php-keyword1">function</span> random_str(<span class="php-var">$length</span>=<span class="php-quote">&quot;8&quot;</span>)
<a href="#2361" id="2361" class="l">2361: </a>{
<a href="#2362" id="2362" class="l">2362: </a>    <span class="php-var">$set</span> = <span class="php-keyword1">array</span>(<span class="php-quote">&quot;a&quot;</span>,<span class="php-quote">&quot;A&quot;</span>,<span class="php-quote">&quot;b&quot;</span>,<span class="php-quote">&quot;B&quot;</span>,<span class="php-quote">&quot;c&quot;</span>,<span class="php-quote">&quot;C&quot;</span>,<span class="php-quote">&quot;d&quot;</span>,<span class="php-quote">&quot;D&quot;</span>,<span class="php-quote">&quot;e&quot;</span>,<span class="php-quote">&quot;E&quot;</span>,<span class="php-quote">&quot;f&quot;</span>,<span class="php-quote">&quot;F&quot;</span>,<span class="php-quote">&quot;g&quot;</span>,<span class="php-quote">&quot;G&quot;</span>,<span class="php-quote">&quot;h&quot;</span>,<span class="php-quote">&quot;H&quot;</span>,<span class="php-quote">&quot;i&quot;</span>,<span class="php-quote">&quot;I&quot;</span>,<span class="php-quote">&quot;j&quot;</span>,<span class="php-quote">&quot;J&quot;</span>,<span class="php-quote">&quot;k&quot;</span>,<span class="php-quote">&quot;K&quot;</span>,<span class="php-quote">&quot;l&quot;</span>,<span class="php-quote">&quot;L&quot;</span>,<span class="php-quote">&quot;m&quot;</span>,<span class="php-quote">&quot;M&quot;</span>,<span class="php-quote">&quot;n&quot;</span>,<span class="php-quote">&quot;N&quot;</span>,<span class="php-quote">&quot;o&quot;</span>,<span class="php-quote">&quot;O&quot;</span>,<span class="php-quote">&quot;p&quot;</span>,<span class="php-quote">&quot;P&quot;</span>,<span class="php-quote">&quot;q&quot;</span>,<span class="php-quote">&quot;Q&quot;</span>,<span class="php-quote">&quot;r&quot;</span>,<span class="php-quote">&quot;R&quot;</span>,<span class="php-quote">&quot;s&quot;</span>,<span class="php-quote">&quot;S&quot;</span>,<span class="php-quote">&quot;t&quot;</span>,<span class="php-quote">&quot;T&quot;</span>,<span class="php-quote">&quot;u&quot;</span>,<span class="php-quote">&quot;U&quot;</span>,<span class="php-quote">&quot;v&quot;</span>,<span class="php-quote">&quot;V&quot;</span>,<span class="php-quote">&quot;w&quot;</span>,<span class="php-quote">&quot;W&quot;</span>,<span class="php-quote">&quot;x&quot;</span>,<span class="php-quote">&quot;X&quot;</span>,<span class="php-quote">&quot;y&quot;</span>,<span class="php-quote">&quot;Y&quot;</span>,<span class="php-quote">&quot;z&quot;</span>,<span class="php-quote">&quot;Z&quot;</span>,<span class="php-quote">&quot;1&quot;</span>,<span class="php-quote">&quot;2&quot;</span>,<span class="php-quote">&quot;3&quot;</span>,<span class="php-quote">&quot;4&quot;</span>,<span class="php-quote">&quot;5&quot;</span>,<span class="php-quote">&quot;6&quot;</span>,<span class="php-quote">&quot;7&quot;</span>,<span class="php-quote">&quot;8&quot;</span>,<span class="php-quote">&quot;9&quot;</span>);
<a href="#2363" id="2363" class="l">2363: </a>    <span class="php-var">$str</span> = <span class="php-quote">''</span>;
<a href="#2364" id="2364" class="l">2364: </a>
<a href="#2365" id="2365" class="l">2365: </a>    <span class="php-keyword1">for</span>(<span class="php-var">$i</span> = <span class="php-num">1</span>; <span class="php-var">$i</span> &lt;= <span class="php-var">$length</span>; ++<span class="php-var">$i</span>)
<a href="#2366" id="2366" class="l">2366: </a>    {
<a href="#2367" id="2367" class="l">2367: </a>        <span class="php-var">$ch</span> = my_rand(<span class="php-num">0</span>, <span class="php-keyword2">count</span>(<span class="php-var">$set</span>)-<span class="php-num">1</span>);
<a href="#2368" id="2368" class="l">2368: </a>        <span class="php-var">$str</span> .= <span class="php-var">$set</span>[<span class="php-var">$ch</span>];
<a href="#2369" id="2369" class="l">2369: </a>    }
<a href="#2370" id="2370" class="l">2370: </a>
<a href="#2371" id="2371" class="l">2371: </a>    <span class="php-keyword1">return</span> <span class="php-var">$str</span>;
<a href="#2372" id="2372" class="l">2372: </a>}
<a href="#2373" id="2373" class="l">2373: </a>
<a href="#2374" id="2374" class="l">2374: </a><span class="php-comment">/**
</span><a href="#2375" id="2375" class="l">2375: </a><span class="php-comment"> * Formats a username based on their display group
</span><a href="#2376" id="2376" class="l">2376: </a><span class="php-comment"> *
</span><a href="#2377" id="2377" class="l">2377: </a><span class="php-comment"> * @param string The username
</span><a href="#2378" id="2378" class="l">2378: </a><span class="php-comment"> * @param int The usergroup for the user (if not specified, will be fetched)
</span><a href="#2379" id="2379" class="l">2379: </a><span class="php-comment"> * @param int The display group for the user (if not specified, will be fetched)
</span><a href="#2380" id="2380" class="l">2380: </a><span class="php-comment"> * @return string The formatted username
</span><a href="#2381" id="2381" class="l">2381: </a><span class="php-comment"> */</span>
<a href="#2382" id="2382" class="l">2382: </a><span class="php-keyword1">function</span> format_name(<span class="php-var">$username</span>, <span class="php-var">$usergroup</span>, <span class="php-var">$displaygroup</span>=<span class="php-quote">&quot;&quot;</span>)
<a href="#2383" id="2383" class="l">2383: </a>{
<a href="#2384" id="2384" class="l">2384: </a>    <span class="php-keyword1">global</span> <span class="php-var">$groupscache</span>, <span class="php-var">$cache</span>;
<a href="#2385" id="2385" class="l">2385: </a>
<a href="#2386" id="2386" class="l">2386: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$groupscache</span>))
<a href="#2387" id="2387" class="l">2387: </a>    {
<a href="#2388" id="2388" class="l">2388: </a>        <span class="php-var">$groupscache</span> = <span class="php-var">$cache</span>-&gt;read(<span class="php-quote">&quot;usergroups&quot;</span>);
<a href="#2389" id="2389" class="l">2389: </a>    }
<a href="#2390" id="2390" class="l">2390: </a>
<a href="#2391" id="2391" class="l">2391: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$displaygroup</span> != <span class="php-num">0</span>)
<a href="#2392" id="2392" class="l">2392: </a>    {
<a href="#2393" id="2393" class="l">2393: </a>        <span class="php-var">$usergroup</span> = <span class="php-var">$displaygroup</span>;
<a href="#2394" id="2394" class="l">2394: </a>    }
<a href="#2395" id="2395" class="l">2395: </a>
<a href="#2396" id="2396" class="l">2396: </a>    <span class="php-var">$ugroup</span> = <span class="php-var">$groupscache</span>[<span class="php-var">$usergroup</span>];
<a href="#2397" id="2397" class="l">2397: </a>    <span class="php-var">$format</span> = <span class="php-var">$ugroup</span>[<span class="php-quote">'namestyle'</span>];
<a href="#2398" id="2398" class="l">2398: </a>    <span class="php-var">$userin</span> = <span class="php-keyword2">substr_count</span>(<span class="php-var">$format</span>, <span class="php-quote">&quot;{username}&quot;</span>);
<a href="#2399" id="2399" class="l">2399: </a>
<a href="#2400" id="2400" class="l">2400: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$userin</span> == <span class="php-num">0</span>)
<a href="#2401" id="2401" class="l">2401: </a>    {
<a href="#2402" id="2402" class="l">2402: </a>        <span class="php-var">$format</span> = <span class="php-quote">&quot;{username}&quot;</span>;
<a href="#2403" id="2403" class="l">2403: </a>    }
<a href="#2404" id="2404" class="l">2404: </a>
<a href="#2405" id="2405" class="l">2405: </a>    <span class="php-var">$format</span> = <span class="php-keyword2">stripslashes</span>(<span class="php-var">$format</span>);
<a href="#2406" id="2406" class="l">2406: </a>
<a href="#2407" id="2407" class="l">2407: </a>    <span class="php-keyword1">return</span> <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{username}&quot;</span>, <span class="php-var">$username</span>, <span class="php-var">$format</span>);
<a href="#2408" id="2408" class="l">2408: </a>}
<a href="#2409" id="2409" class="l">2409: </a>
<a href="#2410" id="2410" class="l">2410: </a><span class="php-comment">/**
</span><a href="#2411" id="2411" class="l">2411: </a><span class="php-comment"> * Build the javascript based MyCode inserter
</span><a href="#2412" id="2412" class="l">2412: </a><span class="php-comment"> *
</span><a href="#2413" id="2413" class="l">2413: </a><span class="php-comment"> * @return string The MyCode inserter
</span><a href="#2414" id="2414" class="l">2414: </a><span class="php-comment"> */</span>
<a href="#2415" id="2415" class="l">2415: </a><span class="php-keyword1">function</span> build_mycode_inserter(<span class="php-var">$bind</span>=<span class="php-quote">&quot;message&quot;</span>)
<a href="#2416" id="2416" class="l">2416: </a>{
<a href="#2417" id="2417" class="l">2417: </a>    <span class="php-keyword1">global</span> <span class="php-var">$db</span>, <span class="php-var">$mybb</span>, <span class="php-var">$theme</span>, <span class="php-var">$templates</span>, <span class="php-var">$lang</span>, <span class="php-var">$plugins</span>;
<a href="#2418" id="2418" class="l">2418: </a>
<a href="#2419" id="2419" class="l">2419: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'bbcodeinserter'</span>] != <span class="php-num">0</span>)
<a href="#2420" id="2420" class="l">2420: </a>    {
<a href="#2421" id="2421" class="l">2421: </a>        <span class="php-var">$editor_lang_strings</span> = <span class="php-keyword1">array</span>(
<a href="#2422" id="2422" class="l">2422: </a>            <span class="php-quote">&quot;editor_title_bold&quot;</span>,
<a href="#2423" id="2423" class="l">2423: </a>            <span class="php-quote">&quot;editor_title_italic&quot;</span>,
<a href="#2424" id="2424" class="l">2424: </a>            <span class="php-quote">&quot;editor_title_underline&quot;</span>,
<a href="#2425" id="2425" class="l">2425: </a>            <span class="php-quote">&quot;editor_title_left&quot;</span>,
<a href="#2426" id="2426" class="l">2426: </a>            <span class="php-quote">&quot;editor_title_center&quot;</span>,
<a href="#2427" id="2427" class="l">2427: </a>            <span class="php-quote">&quot;editor_title_right&quot;</span>,
<a href="#2428" id="2428" class="l">2428: </a>            <span class="php-quote">&quot;editor_title_justify&quot;</span>,
<a href="#2429" id="2429" class="l">2429: </a>            <span class="php-quote">&quot;editor_title_numlist&quot;</span>,
<a href="#2430" id="2430" class="l">2430: </a>            <span class="php-quote">&quot;editor_title_bulletlist&quot;</span>,
<a href="#2431" id="2431" class="l">2431: </a>            <span class="php-quote">&quot;editor_title_image&quot;</span>,
<a href="#2432" id="2432" class="l">2432: </a>            <span class="php-quote">&quot;editor_title_hyperlink&quot;</span>,
<a href="#2433" id="2433" class="l">2433: </a>            <span class="php-quote">&quot;editor_title_email&quot;</span>,
<a href="#2434" id="2434" class="l">2434: </a>            <span class="php-quote">&quot;editor_title_quote&quot;</span>,
<a href="#2435" id="2435" class="l">2435: </a>            <span class="php-quote">&quot;editor_title_code&quot;</span>,
<a href="#2436" id="2436" class="l">2436: </a>            <span class="php-quote">&quot;editor_title_php&quot;</span>,
<a href="#2437" id="2437" class="l">2437: </a>            <span class="php-quote">&quot;editor_title_close_tags&quot;</span>,
<a href="#2438" id="2438" class="l">2438: </a>            <span class="php-quote">&quot;editor_enter_list_item&quot;</span>,
<a href="#2439" id="2439" class="l">2439: </a>            <span class="php-quote">&quot;editor_enter_url&quot;</span>,
<a href="#2440" id="2440" class="l">2440: </a>            <span class="php-quote">&quot;editor_enter_url_title&quot;</span>,
<a href="#2441" id="2441" class="l">2441: </a>            <span class="php-quote">&quot;editor_enter_email&quot;</span>,
<a href="#2442" id="2442" class="l">2442: </a>            <span class="php-quote">&quot;editor_enter_email_title&quot;</span>,
<a href="#2443" id="2443" class="l">2443: </a>            <span class="php-quote">&quot;editor_enter_image&quot;</span>,
<a href="#2444" id="2444" class="l">2444: </a>            <span class="php-quote">&quot;editor_enter_video_url&quot;</span>,
<a href="#2445" id="2445" class="l">2445: </a>            <span class="php-quote">&quot;editor_video_dailymotion&quot;</span>,
<a href="#2446" id="2446" class="l">2446: </a>            <span class="php-quote">&quot;editor_video_metacafe&quot;</span>,
<a href="#2447" id="2447" class="l">2447: </a>            <span class="php-quote">&quot;editor_video_myspacetv&quot;</span>,
<a href="#2448" id="2448" class="l">2448: </a>            <span class="php-quote">&quot;editor_video_vimeo&quot;</span>,
<a href="#2449" id="2449" class="l">2449: </a>            <span class="php-quote">&quot;editor_video_yahoo&quot;</span>,
<a href="#2450" id="2450" class="l">2450: </a>            <span class="php-quote">&quot;editor_video_youtube&quot;</span>,
<a href="#2451" id="2451" class="l">2451: </a>            <span class="php-quote">&quot;editor_size_xx_small&quot;</span>,
<a href="#2452" id="2452" class="l">2452: </a>            <span class="php-quote">&quot;editor_size_x_small&quot;</span>,
<a href="#2453" id="2453" class="l">2453: </a>            <span class="php-quote">&quot;editor_size_small&quot;</span>,
<a href="#2454" id="2454" class="l">2454: </a>            <span class="php-quote">&quot;editor_size_medium&quot;</span>,
<a href="#2455" id="2455" class="l">2455: </a>            <span class="php-quote">&quot;editor_size_large&quot;</span>,
<a href="#2456" id="2456" class="l">2456: </a>            <span class="php-quote">&quot;editor_size_x_large&quot;</span>,
<a href="#2457" id="2457" class="l">2457: </a>            <span class="php-quote">&quot;editor_size_xx_large&quot;</span>,
<a href="#2458" id="2458" class="l">2458: </a>            <span class="php-quote">&quot;editor_font&quot;</span>,
<a href="#2459" id="2459" class="l">2459: </a>            <span class="php-quote">&quot;editor_size&quot;</span>,
<a href="#2460" id="2460" class="l">2460: </a>            <span class="php-quote">&quot;editor_color&quot;</span>
<a href="#2461" id="2461" class="l">2461: </a>        );
<a href="#2462" id="2462" class="l">2462: </a>        <span class="php-var">$editor_language</span> = <span class="php-quote">&quot;var editor_language = {\n&quot;</span>;
<a href="#2463" id="2463" class="l">2463: </a>        
<a href="#2464" id="2464" class="l">2464: </a>        <span class="php-var">$editor_lang_strings</span> = <span class="php-var">$plugins</span>-&gt;run_hooks(<span class="php-quote">&quot;mycode_add_codebuttons&quot;</span>, <span class="php-var">$editor_lang_strings</span>);
<a href="#2465" id="2465" class="l">2465: </a>
<a href="#2466" id="2466" class="l">2466: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$editor_lang_strings</span> <span class="php-keyword1">as</span> <span class="php-var">$key</span> =&gt; <span class="php-var">$lang_string</span>)
<a href="#2467" id="2467" class="l">2467: </a>        {
<a href="#2468" id="2468" class="l">2468: </a>            <span class="php-comment">// Strip initial editor_ off language string if it exists - ensure case sensitivity does not matter.</span>
<a href="#2469" id="2469" class="l">2469: </a>            <span class="php-var">$js_lang_string</span> = <span class="php-keyword2">preg_replace</span>(<span class="php-quote">&quot;#^editor_#i&quot;</span>, <span class="php-quote">&quot;&quot;</span>, <span class="php-var">$lang_string</span>);
<a href="#2470" id="2470" class="l">2470: </a>            <span class="php-var">$string</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;\&quot;&quot;</span>, <span class="php-quote">&quot;\\\&quot;&quot;</span>, <span class="php-var">$lang</span>-&gt;<span class="php-var">$lang_string</span>);
<a href="#2471" id="2471" class="l">2471: </a>            <span class="php-var">$editor_language</span> .= <span class="php-quote">&quot;\t</span><span class="php-var">{$js_lang_string}</span><span class="php-quote">: \&quot;</span><span class="php-var">{$string}</span><span class="php-quote">\&quot;&quot;</span>;
<a href="#2472" id="2472" class="l">2472: </a>
<a href="#2473" id="2473" class="l">2473: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$editor_lang_strings</span>[<span class="php-var">$key</span>+<span class="php-num">1</span>])
<a href="#2474" id="2474" class="l">2474: </a>            {
<a href="#2475" id="2475" class="l">2475: </a>                <span class="php-var">$editor_language</span> .= <span class="php-quote">&quot;,&quot;</span>;
<a href="#2476" id="2476" class="l">2476: </a>            }
<a href="#2477" id="2477" class="l">2477: </a>
<a href="#2478" id="2478" class="l">2478: </a>            <span class="php-var">$editor_language</span> .= <span class="php-quote">&quot;\n&quot;</span>;
<a href="#2479" id="2479" class="l">2479: </a>        }
<a href="#2480" id="2480" class="l">2480: </a>
<a href="#2481" id="2481" class="l">2481: </a>        <span class="php-var">$editor_language</span> .= <span class="php-quote">&quot;};&quot;</span>;
<a href="#2482" id="2482" class="l">2482: </a>
<a href="#2483" id="2483" class="l">2483: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">defined</span>(<span class="php-quote">&quot;IN_ADMINCP&quot;</span>))
<a href="#2484" id="2484" class="l">2484: </a>        {
<a href="#2485" id="2485" class="l">2485: </a>            <span class="php-keyword1">global</span> <span class="php-var">$page</span>;
<a href="#2486" id="2486" class="l">2486: </a>            <span class="php-var">$codeinsert</span> = <span class="php-var">$page</span>-&gt;build_codebuttons_editor(<span class="php-var">$bind</span>, <span class="php-var">$editor_language</span>);
<a href="#2487" id="2487" class="l">2487: </a>        }
<a href="#2488" id="2488" class="l">2488: </a>        <span class="php-keyword1">else</span>
<a href="#2489" id="2489" class="l">2489: </a>        {
<a href="#2490" id="2490" class="l">2490: </a>            <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$codeinsert</span><span class="php-quote"> = \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;codebuttons&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#2491" id="2491" class="l">2491: </a>        }
<a href="#2492" id="2492" class="l">2492: </a>    }
<a href="#2493" id="2493" class="l">2493: </a>
<a href="#2494" id="2494" class="l">2494: </a>    <span class="php-keyword1">return</span> <span class="php-var">$codeinsert</span>;
<a href="#2495" id="2495" class="l">2495: </a>}
<a href="#2496" id="2496" class="l">2496: </a>
<a href="#2497" id="2497" class="l">2497: </a><span class="php-comment">/**
</span><a href="#2498" id="2498" class="l">2498: </a><span class="php-comment"> * Build the javascript clickable smilie inserter
</span><a href="#2499" id="2499" class="l">2499: </a><span class="php-comment"> *
</span><a href="#2500" id="2500" class="l">2500: </a><span class="php-comment"> * @return string The clickable smilies list
</span><a href="#2501" id="2501" class="l">2501: </a><span class="php-comment"> */</span>
<a href="#2502" id="2502" class="l">2502: </a><span class="php-keyword1">function</span> build_clickable_smilies()
<a href="#2503" id="2503" class="l">2503: </a>{
<a href="#2504" id="2504" class="l">2504: </a>    <span class="php-keyword1">global</span> <span class="php-var">$cache</span>, <span class="php-var">$smiliecache</span>, <span class="php-var">$theme</span>, <span class="php-var">$templates</span>, <span class="php-var">$lang</span>, <span class="php-var">$mybb</span>, <span class="php-var">$smiliecount</span>;
<a href="#2505" id="2505" class="l">2505: </a>
<a href="#2506" id="2506" class="l">2506: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'smilieinserter'</span>] != <span class="php-num">0</span> &amp;&amp; <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'smilieinsertercols'</span>] &amp;&amp; <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'smilieinsertertot'</span>])
<a href="#2507" id="2507" class="l">2507: </a>    {
<a href="#2508" id="2508" class="l">2508: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$smiliecount</span>)
<a href="#2509" id="2509" class="l">2509: </a>        {
<a href="#2510" id="2510" class="l">2510: </a>            <span class="php-var">$smilie_cache</span> = <span class="php-var">$cache</span>-&gt;read(<span class="php-quote">&quot;smilies&quot;</span>);
<a href="#2511" id="2511" class="l">2511: </a>            <span class="php-var">$smiliecount</span> = <span class="php-keyword2">count</span>(<span class="php-var">$smilie_cache</span>);
<a href="#2512" id="2512" class="l">2512: </a>        }
<a href="#2513" id="2513" class="l">2513: </a>
<a href="#2514" id="2514" class="l">2514: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$smiliecache</span>)
<a href="#2515" id="2515" class="l">2515: </a>        {
<a href="#2516" id="2516" class="l">2516: </a>            <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$smilie_cache</span>))
<a href="#2517" id="2517" class="l">2517: </a>            {
<a href="#2518" id="2518" class="l">2518: </a>                <span class="php-var">$smilie_cache</span> = <span class="php-var">$cache</span>-&gt;read(<span class="php-quote">&quot;smilies&quot;</span>);
<a href="#2519" id="2519" class="l">2519: </a>            }
<a href="#2520" id="2520" class="l">2520: </a>            <span class="php-keyword1">foreach</span>(<span class="php-var">$smilie_cache</span> <span class="php-keyword1">as</span> <span class="php-var">$smilie</span>)
<a href="#2521" id="2521" class="l">2521: </a>            {
<a href="#2522" id="2522" class="l">2522: </a>                <span class="php-keyword1">if</span>(<span class="php-var">$smilie</span>[<span class="php-quote">'showclickable'</span>] != <span class="php-num">0</span>)
<a href="#2523" id="2523" class="l">2523: </a>                {
<a href="#2524" id="2524" class="l">2524: </a>                    <span class="php-var">$smiliecache</span>[<span class="php-var">$smilie</span>[<span class="php-quote">'find'</span>]] = <span class="php-var">$smilie</span>[<span class="php-quote">'image'</span>];
<a href="#2525" id="2525" class="l">2525: </a>                }
<a href="#2526" id="2526" class="l">2526: </a>            }
<a href="#2527" id="2527" class="l">2527: </a>        }
<a href="#2528" id="2528" class="l">2528: </a>
<a href="#2529" id="2529" class="l">2529: </a>        <span class="php-keyword1">unset</span>(<span class="php-var">$smilie</span>);
<a href="#2530" id="2530" class="l">2530: </a>
<a href="#2531" id="2531" class="l">2531: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$smiliecache</span>))
<a href="#2532" id="2532" class="l">2532: </a>        {
<a href="#2533" id="2533" class="l">2533: </a>            <span class="php-keyword2">reset</span>(<span class="php-var">$smiliecache</span>);
<a href="#2534" id="2534" class="l">2534: </a>
<a href="#2535" id="2535" class="l">2535: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'smilieinsertertot'</span>] &gt;= <span class="php-var">$smiliecount</span>)
<a href="#2536" id="2536" class="l">2536: </a>            {
<a href="#2537" id="2537" class="l">2537: </a>                <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'smilieinsertertot'</span>] = <span class="php-var">$smiliecount</span>;
<a href="#2538" id="2538" class="l">2538: </a>            }
<a href="#2539" id="2539" class="l">2539: </a>            <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'smilieinsertertot'</span>] &lt; <span class="php-var">$smiliecount</span>)
<a href="#2540" id="2540" class="l">2540: </a>            {
<a href="#2541" id="2541" class="l">2541: </a>                <span class="php-var">$smiliecount</span> = <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'smilieinsertertot'</span>];
<a href="#2542" id="2542" class="l">2542: </a>                <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$getmore</span><span class="php-quote"> = \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;smilieinsert_getmore&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#2543" id="2543" class="l">2543: </a>            }
<a href="#2544" id="2544" class="l">2544: </a>
<a href="#2545" id="2545" class="l">2545: </a>            <span class="php-var">$smilies</span> = <span class="php-quote">&quot;&quot;</span>;
<a href="#2546" id="2546" class="l">2546: </a>            <span class="php-var">$counter</span> = <span class="php-num">0</span>;
<a href="#2547" id="2547" class="l">2547: </a>            <span class="php-var">$i</span> = <span class="php-num">0</span>;
<a href="#2548" id="2548" class="l">2548: </a>
<a href="#2549" id="2549" class="l">2549: </a>            <span class="php-keyword1">foreach</span>(<span class="php-var">$smiliecache</span> <span class="php-keyword1">as</span> <span class="php-var">$find</span> =&gt; <span class="php-var">$image</span>)
<a href="#2550" id="2550" class="l">2550: </a>            {
<a href="#2551" id="2551" class="l">2551: </a>                <span class="php-keyword1">if</span>(<span class="php-var">$i</span> &lt; <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'smilieinsertertot'</span>])
<a href="#2552" id="2552" class="l">2552: </a>                {
<a href="#2553" id="2553" class="l">2553: </a>                    <span class="php-keyword1">if</span>(<span class="php-var">$counter</span> == <span class="php-num">0</span>)
<a href="#2554" id="2554" class="l">2554: </a>                    {
<a href="#2555" id="2555" class="l">2555: </a>                        <span class="php-var">$smilies</span> .=  <span class="php-quote">&quot;&lt;tr&gt;\n&quot;</span>;
<a href="#2556" id="2556" class="l">2556: </a>                    }
<a href="#2557" id="2557" class="l">2557: </a>
<a href="#2558" id="2558" class="l">2558: </a>                    <span class="php-var">$find</span> = htmlspecialchars_uni(<span class="php-var">$find</span>);
<a href="#2559" id="2559" class="l">2559: </a>                    <span class="php-var">$smilies</span> .= <span class="php-quote">&quot;&lt;td style=\&quot;text-align: center\&quot;&gt;&lt;img src=\&quot;</span><span class="php-var">{$image}</span><span class="php-quote">\&quot; border=\&quot;0\&quot; class=\&quot;smilie\&quot; alt=\&quot;</span><span class="php-var">{$find}</span><span class="php-quote">\&quot; /&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#2560" id="2560" class="l">2560: </a>                    ++<span class="php-var">$i</span>;
<a href="#2561" id="2561" class="l">2561: </a>                    ++<span class="php-var">$counter</span>;
<a href="#2562" id="2562" class="l">2562: </a>
<a href="#2563" id="2563" class="l">2563: </a>                    <span class="php-keyword1">if</span>(<span class="php-var">$counter</span> == <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'smilieinsertercols'</span>])
<a href="#2564" id="2564" class="l">2564: </a>                    {
<a href="#2565" id="2565" class="l">2565: </a>                        <span class="php-var">$counter</span> = <span class="php-num">0</span>;
<a href="#2566" id="2566" class="l">2566: </a>                        <span class="php-var">$smilies</span> .= <span class="php-quote">&quot;&lt;/tr&gt;\n&quot;</span>;
<a href="#2567" id="2567" class="l">2567: </a>                    }
<a href="#2568" id="2568" class="l">2568: </a>                }
<a href="#2569" id="2569" class="l">2569: </a>            }
<a href="#2570" id="2570" class="l">2570: </a>
<a href="#2571" id="2571" class="l">2571: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$counter</span> != <span class="php-num">0</span>)
<a href="#2572" id="2572" class="l">2572: </a>            {
<a href="#2573" id="2573" class="l">2573: </a>                <span class="php-var">$colspan</span> = <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'smilieinsertercols'</span>] - <span class="php-var">$counter</span>;
<a href="#2574" id="2574" class="l">2574: </a>                <span class="php-var">$smilies</span> .= <span class="php-quote">&quot;&lt;td colspan=\&quot;</span><span class="php-var">{$colspan}</span><span class="php-quote">\&quot;&gt;&amp;nbsp;&lt;/td&gt;\n&lt;/tr&gt;\n&quot;</span>;
<a href="#2575" id="2575" class="l">2575: </a>            }
<a href="#2576" id="2576" class="l">2576: </a>
<a href="#2577" id="2577" class="l">2577: </a>            <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$clickablesmilies</span><span class="php-quote"> = \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;smilieinsert&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#2578" id="2578" class="l">2578: </a>        }
<a href="#2579" id="2579" class="l">2579: </a>        <span class="php-keyword1">else</span>
<a href="#2580" id="2580" class="l">2580: </a>        {
<a href="#2581" id="2581" class="l">2581: </a>            <span class="php-var">$clickablesmilies</span> = <span class="php-quote">&quot;&quot;</span>;
<a href="#2582" id="2582" class="l">2582: </a>        }
<a href="#2583" id="2583" class="l">2583: </a>    }
<a href="#2584" id="2584" class="l">2584: </a>    <span class="php-keyword1">else</span>
<a href="#2585" id="2585" class="l">2585: </a>    {
<a href="#2586" id="2586" class="l">2586: </a>        <span class="php-var">$clickablesmilies</span> = <span class="php-quote">&quot;&quot;</span>;
<a href="#2587" id="2587" class="l">2587: </a>    }
<a href="#2588" id="2588" class="l">2588: </a>
<a href="#2589" id="2589" class="l">2589: </a>    <span class="php-keyword1">return</span> <span class="php-var">$clickablesmilies</span>;
<a href="#2590" id="2590" class="l">2590: </a>}
<a href="#2591" id="2591" class="l">2591: </a>
<a href="#2592" id="2592" class="l">2592: </a><span class="php-comment">/**
</span><a href="#2593" id="2593" class="l">2593: </a><span class="php-comment"> * Builds thread prefixes and returns a selected prefix (or all)
</span><a href="#2594" id="2594" class="l">2594: </a><span class="php-comment"> * 
</span><a href="#2595" id="2595" class="l">2595: </a><span class="php-comment"> *  @param int The prefix ID (0 to return all)
</span><a href="#2596" id="2596" class="l">2596: </a><span class="php-comment"> *  @return array The thread prefix's values (or all thread prefixes)
</span><a href="#2597" id="2597" class="l">2597: </a><span class="php-comment"> */</span>
<a href="#2598" id="2598" class="l">2598: </a><span class="php-keyword1">function</span> build_prefixes(<span class="php-var">$pid</span>=<span class="php-num">0</span>)
<a href="#2599" id="2599" class="l">2599: </a>{
<a href="#2600" id="2600" class="l">2600: </a>    <span class="php-keyword1">global</span> <span class="php-var">$cache</span>;
<a href="#2601" id="2601" class="l">2601: </a>    <span class="php-keyword1">static</span> <span class="php-var">$prefixes_cache</span>;
<a href="#2602" id="2602" class="l">2602: </a>
<a href="#2603" id="2603" class="l">2603: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$prefixes_cache</span>))
<a href="#2604" id="2604" class="l">2604: </a>    {
<a href="#2605" id="2605" class="l">2605: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$pid</span> &gt; <span class="php-num">0</span> &amp;&amp; <span class="php-keyword2">is_array</span>(<span class="php-var">$prefixes_cache</span>[<span class="php-var">$pid</span>]))
<a href="#2606" id="2606" class="l">2606: </a>        {
<a href="#2607" id="2607" class="l">2607: </a>            <span class="php-keyword1">return</span> <span class="php-var">$prefixes_cache</span>[<span class="php-var">$pid</span>];
<a href="#2608" id="2608" class="l">2608: </a>        }
<a href="#2609" id="2609" class="l">2609: </a>
<a href="#2610" id="2610" class="l">2610: </a>        <span class="php-keyword1">return</span> <span class="php-var">$prefixes_cache</span>;
<a href="#2611" id="2611" class="l">2611: </a>    }
<a href="#2612" id="2612" class="l">2612: </a>
<a href="#2613" id="2613" class="l">2613: </a>    <span class="php-var">$prefix_cache</span> = <span class="php-var">$cache</span>-&gt;read(<span class="php-quote">&quot;threadprefixes&quot;</span>);
<a href="#2614" id="2614" class="l">2614: </a>
<a href="#2615" id="2615" class="l">2615: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$prefix_cache</span>))
<a href="#2616" id="2616" class="l">2616: </a>    {
<a href="#2617" id="2617" class="l">2617: </a>        <span class="php-comment">// No cache</span>
<a href="#2618" id="2618" class="l">2618: </a>        <span class="php-var">$prefix_cache</span> = <span class="php-var">$cache</span>-&gt;read(<span class="php-quote">&quot;threadprefixes&quot;</span>, <span class="php-keyword1">true</span>);
<a href="#2619" id="2619" class="l">2619: </a>
<a href="#2620" id="2620" class="l">2620: </a>        <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$prefix_cache</span>))
<a href="#2621" id="2621" class="l">2621: </a>        {
<a href="#2622" id="2622" class="l">2622: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">array</span>();
<a href="#2623" id="2623" class="l">2623: </a>        }
<a href="#2624" id="2624" class="l">2624: </a>    }
<a href="#2625" id="2625" class="l">2625: </a>
<a href="#2626" id="2626" class="l">2626: </a>    <span class="php-var">$prefixes_cache</span> = <span class="php-keyword1">array</span>();
<a href="#2627" id="2627" class="l">2627: </a>    <span class="php-keyword1">foreach</span>(<span class="php-var">$prefix_cache</span> <span class="php-keyword1">as</span> <span class="php-var">$prefix</span>)
<a href="#2628" id="2628" class="l">2628: </a>    {
<a href="#2629" id="2629" class="l">2629: </a>        <span class="php-var">$prefixes_cache</span>[<span class="php-var">$prefix</span>[<span class="php-quote">'pid'</span>]] = <span class="php-var">$prefix</span>;
<a href="#2630" id="2630" class="l">2630: </a>    }
<a href="#2631" id="2631" class="l">2631: </a>
<a href="#2632" id="2632" class="l">2632: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$pid</span> != <span class="php-num">0</span> &amp;&amp; <span class="php-keyword2">is_array</span>(<span class="php-var">$prefixes_cache</span>[<span class="php-var">$pid</span>]))
<a href="#2633" id="2633" class="l">2633: </a>    {
<a href="#2634" id="2634" class="l">2634: </a>        <span class="php-keyword1">return</span> <span class="php-var">$prefixes_cache</span>[<span class="php-var">$pid</span>];
<a href="#2635" id="2635" class="l">2635: </a>    }
<a href="#2636" id="2636" class="l">2636: </a>    <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(!<span class="php-keyword1">empty</span>(<span class="php-var">$prefixes_cache</span>))
<a href="#2637" id="2637" class="l">2637: </a>    {
<a href="#2638" id="2638" class="l">2638: </a>        <span class="php-keyword1">return</span> <span class="php-var">$prefixes_cache</span>;
<a href="#2639" id="2639" class="l">2639: </a>    }
<a href="#2640" id="2640" class="l">2640: </a>
<a href="#2641" id="2641" class="l">2641: </a>    <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#2642" id="2642" class="l">2642: </a>}
<a href="#2643" id="2643" class="l">2643: </a>
<a href="#2644" id="2644" class="l">2644: </a><span class="php-comment">/**
</span><a href="#2645" id="2645" class="l">2645: </a><span class="php-comment"> * Build the thread prefix selection menu
</span><a href="#2646" id="2646" class="l">2646: </a><span class="php-comment"> * 
</span><a href="#2647" id="2647" class="l">2647: </a><span class="php-comment"> *  @param mixed The forum ID (integer ID or string all)
</span><a href="#2648" id="2648" class="l">2648: </a><span class="php-comment"> *  @param mixed The selected prefix ID (integer ID or string any)
</span><a href="#2649" id="2649" class="l">2649: </a><span class="php-comment"> *  @return string The thread prefix selection menu
</span><a href="#2650" id="2650" class="l">2650: </a><span class="php-comment"> */</span>
<a href="#2651" id="2651" class="l">2651: </a><span class="php-keyword1">function</span> build_prefix_select(<span class="php-var">$fid</span>, <span class="php-var">$selected_pid</span>=<span class="php-num">0</span>, <span class="php-var">$multiple</span>=<span class="php-num">0</span>)
<a href="#2652" id="2652" class="l">2652: </a>{
<a href="#2653" id="2653" class="l">2653: </a>    <span class="php-keyword1">global</span> <span class="php-var">$cache</span>, <span class="php-var">$db</span>, <span class="php-var">$lang</span>, <span class="php-var">$mybb</span>;
<a href="#2654" id="2654" class="l">2654: </a>    
<a href="#2655" id="2655" class="l">2655: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$fid</span> != <span class="php-quote">'all'</span>)
<a href="#2656" id="2656" class="l">2656: </a>    {
<a href="#2657" id="2657" class="l">2657: </a>        <span class="php-var">$fid</span> = <span class="php-keyword2">intval</span>(<span class="php-var">$fid</span>);
<a href="#2658" id="2658" class="l">2658: </a>    }
<a href="#2659" id="2659" class="l">2659: </a>
<a href="#2660" id="2660" class="l">2660: </a>    <span class="php-var">$prefix_cache</span> = build_prefixes(<span class="php-num">0</span>);
<a href="#2661" id="2661" class="l">2661: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$prefix_cache</span>)
<a href="#2662" id="2662" class="l">2662: </a>    {
<a href="#2663" id="2663" class="l">2663: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>; <span class="php-comment">// We've got no prefixes to show</span>
<a href="#2664" id="2664" class="l">2664: </a>    }
<a href="#2665" id="2665" class="l">2665: </a>
<a href="#2666" id="2666" class="l">2666: </a>    <span class="php-var">$groups</span> = <span class="php-keyword1">array</span>(<span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'usergroup'</span>]);
<a href="#2667" id="2667" class="l">2667: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'additionalgroups'</span>])
<a href="#2668" id="2668" class="l">2668: </a>    {
<a href="#2669" id="2669" class="l">2669: </a>        <span class="php-var">$exp</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">&quot;,&quot;</span>, <span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'additionalgroups'</span>]);
<a href="#2670" id="2670" class="l">2670: </a>
<a href="#2671" id="2671" class="l">2671: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$exp</span> <span class="php-keyword1">as</span> <span class="php-var">$group</span>)
<a href="#2672" id="2672" class="l">2672: </a>        {
<a href="#2673" id="2673" class="l">2673: </a>            <span class="php-var">$groups</span>[] = <span class="php-var">$group</span>;
<a href="#2674" id="2674" class="l">2674: </a>        }
<a href="#2675" id="2675" class="l">2675: </a>    }
<a href="#2676" id="2676" class="l">2676: </a>
<a href="#2677" id="2677" class="l">2677: </a>    <span class="php-comment">// Go through each of our prefixes and decide which ones we can use</span>
<a href="#2678" id="2678" class="l">2678: </a>    <span class="php-var">$prefixes</span> = <span class="php-keyword1">array</span>();
<a href="#2679" id="2679" class="l">2679: </a>    <span class="php-keyword1">foreach</span>(<span class="php-var">$prefix_cache</span> <span class="php-keyword1">as</span> <span class="php-var">$prefix</span>)
<a href="#2680" id="2680" class="l">2680: </a>    {
<a href="#2681" id="2681" class="l">2681: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$fid</span> != <span class="php-quote">&quot;all&quot;</span> &amp;&amp; <span class="php-var">$prefix</span>[<span class="php-quote">'forums'</span>] != <span class="php-quote">&quot;-1&quot;</span>)
<a href="#2682" id="2682" class="l">2682: </a>        {
<a href="#2683" id="2683" class="l">2683: </a>            <span class="php-comment">// Decide whether this prefix can be used in our forum</span>
<a href="#2684" id="2684" class="l">2684: </a>            <span class="php-var">$forums</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">&quot;,&quot;</span>, <span class="php-var">$prefix</span>[<span class="php-quote">'forums'</span>]);
<a href="#2685" id="2685" class="l">2685: </a>
<a href="#2686" id="2686" class="l">2686: </a>            <span class="php-keyword1">if</span>(!<span class="php-keyword2">in_array</span>(<span class="php-var">$fid</span>, <span class="php-var">$forums</span>))
<a href="#2687" id="2687" class="l">2687: </a>            {
<a href="#2688" id="2688" class="l">2688: </a>                <span class="php-comment">// This prefix is not in our forum list</span>
<a href="#2689" id="2689" class="l">2689: </a>                <span class="php-keyword1">continue</span>;
<a href="#2690" id="2690" class="l">2690: </a>            }
<a href="#2691" id="2691" class="l">2691: </a>        }
<a href="#2692" id="2692" class="l">2692: </a>
<a href="#2693" id="2693" class="l">2693: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$prefix</span>[<span class="php-quote">'groups'</span>] != <span class="php-quote">&quot;-1&quot;</span>)
<a href="#2694" id="2694" class="l">2694: </a>        {
<a href="#2695" id="2695" class="l">2695: </a>            <span class="php-var">$prefix_groups</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">&quot;,&quot;</span>, <span class="php-var">$prefix</span>[<span class="php-quote">'groups'</span>]);
<a href="#2696" id="2696" class="l">2696: </a>
<a href="#2697" id="2697" class="l">2697: </a>            <span class="php-keyword1">foreach</span>(<span class="php-var">$groups</span> <span class="php-keyword1">as</span> <span class="php-var">$group</span>)
<a href="#2698" id="2698" class="l">2698: </a>            {
<a href="#2699" id="2699" class="l">2699: </a>                <span class="php-keyword1">if</span>(<span class="php-keyword2">in_array</span>(<span class="php-var">$group</span>, <span class="php-var">$prefix_groups</span>) &amp;&amp; !<span class="php-keyword1">isset</span>(<span class="php-var">$prefixes</span>[<span class="php-var">$prefix</span>[<span class="php-quote">'pid'</span>]]))
<a href="#2700" id="2700" class="l">2700: </a>                {
<a href="#2701" id="2701" class="l">2701: </a>                    <span class="php-comment">// Our group can use this prefix!</span>
<a href="#2702" id="2702" class="l">2702: </a>                    <span class="php-var">$prefixes</span>[<span class="php-var">$prefix</span>[<span class="php-quote">'pid'</span>]] = <span class="php-var">$prefix</span>;
<a href="#2703" id="2703" class="l">2703: </a>                }
<a href="#2704" id="2704" class="l">2704: </a>            }
<a href="#2705" id="2705" class="l">2705: </a>        }
<a href="#2706" id="2706" class="l">2706: </a>        <span class="php-keyword1">else</span>
<a href="#2707" id="2707" class="l">2707: </a>        {
<a href="#2708" id="2708" class="l">2708: </a>            <span class="php-comment">// This prefix is for anybody to use...</span>
<a href="#2709" id="2709" class="l">2709: </a>            <span class="php-var">$prefixes</span>[<span class="php-var">$prefix</span>[<span class="php-quote">'pid'</span>]] = <span class="php-var">$prefix</span>;
<a href="#2710" id="2710" class="l">2710: </a>        }
<a href="#2711" id="2711" class="l">2711: </a>    }
<a href="#2712" id="2712" class="l">2712: </a>
<a href="#2713" id="2713" class="l">2713: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword1">empty</span>(<span class="php-var">$prefixes</span>))
<a href="#2714" id="2714" class="l">2714: </a>    {
<a href="#2715" id="2715" class="l">2715: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#2716" id="2716" class="l">2716: </a>    }
<a href="#2717" id="2717" class="l">2717: </a>
<a href="#2718" id="2718" class="l">2718: </a>    <span class="php-var">$prefixselect</span> = <span class="php-quote">&quot;&quot;</span>;
<a href="#2719" id="2719" class="l">2719: </a>    <span class="php-var">$multipleselect</span> = <span class="php-quote">&quot;&quot;</span>;
<a href="#2720" id="2720" class="l">2720: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$multiple</span> != <span class="php-num">0</span>)
<a href="#2721" id="2721" class="l">2721: </a>    {
<a href="#2722" id="2722" class="l">2722: </a>        <span class="php-var">$multipleselect</span> = <span class="php-quote">&quot; multiple=\&quot;multiple\&quot; size=\&quot;5\&quot;&quot;</span>;
<a href="#2723" id="2723" class="l">2723: </a>    }
<a href="#2724" id="2724" class="l">2724: </a>
<a href="#2725" id="2725" class="l">2725: </a>    <span class="php-var">$prefixselect</span> = <span class="php-quote">&quot;&lt;select name=\&quot;threadprefix\&quot;</span><span class="php-var">{$multipleselect}</span><span class="php-quote">&gt;\n&quot;</span>;
<a href="#2726" id="2726" class="l">2726: </a>
<a href="#2727" id="2727" class="l">2727: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$multiple</span> == <span class="php-num">1</span>)
<a href="#2728" id="2728" class="l">2728: </a>    {
<a href="#2729" id="2729" class="l">2729: </a>        <span class="php-var">$any_selected</span> = <span class="php-quote">&quot;&quot;</span>;
<a href="#2730" id="2730" class="l">2730: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$selected_pid</span> == <span class="php-quote">'any'</span>)
<a href="#2731" id="2731" class="l">2731: </a>        {
<a href="#2732" id="2732" class="l">2732: </a>            <span class="php-var">$any_selected</span> = <span class="php-quote">&quot; selected=\&quot;selected\&quot;&quot;</span>;
<a href="#2733" id="2733" class="l">2733: </a>        }
<a href="#2734" id="2734" class="l">2734: </a>
<a href="#2735" id="2735" class="l">2735: </a>        <span class="php-var">$prefixselect</span> .= <span class="php-quote">&quot;&lt;option value=\&quot;any\&quot;&quot;</span>.<span class="php-var">$any_selected</span>.<span class="php-quote">&quot;&gt;&quot;</span>.<span class="php-var">$lang</span>-&gt;any_prefix.<span class="php-quote">&quot;&lt;/option&gt;\n&quot;</span>;
<a href="#2736" id="2736" class="l">2736: </a>    }
<a href="#2737" id="2737" class="l">2737: </a>
<a href="#2738" id="2738" class="l">2738: </a>    <span class="php-var">$default_selected</span> = <span class="php-quote">&quot;&quot;</span>;
<a href="#2739" id="2739" class="l">2739: </a>    <span class="php-keyword1">if</span>((<span class="php-keyword2">intval</span>(<span class="php-var">$selected_pid</span>) == <span class="php-num">0</span>) &amp;&amp; <span class="php-var">$selected_pid</span> != <span class="php-quote">'any'</span>)
<a href="#2740" id="2740" class="l">2740: </a>    {
<a href="#2741" id="2741" class="l">2741: </a>        <span class="php-var">$default_selected</span> = <span class="php-quote">&quot; selected=\&quot;selected\&quot;&quot;</span>;
<a href="#2742" id="2742" class="l">2742: </a>    }
<a href="#2743" id="2743" class="l">2743: </a>
<a href="#2744" id="2744" class="l">2744: </a>    <span class="php-var">$prefixselect</span> .= <span class="php-quote">&quot;&lt;option value=\&quot;0\&quot;&quot;</span>.<span class="php-var">$default_selected</span>.<span class="php-quote">&quot;&gt;&quot;</span>.<span class="php-var">$lang</span>-&gt;no_prefix.<span class="php-quote">&quot;&lt;/option&gt;\n&quot;</span>;
<a href="#2745" id="2745" class="l">2745: </a>
<a href="#2746" id="2746" class="l">2746: </a>    <span class="php-keyword1">foreach</span>(<span class="php-var">$prefixes</span> <span class="php-keyword1">as</span> <span class="php-var">$prefix</span>)
<a href="#2747" id="2747" class="l">2747: </a>    {
<a href="#2748" id="2748" class="l">2748: </a>        <span class="php-var">$selected</span> = <span class="php-quote">&quot;&quot;</span>;
<a href="#2749" id="2749" class="l">2749: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$prefix</span>[<span class="php-quote">'pid'</span>] == <span class="php-var">$selected_pid</span>)
<a href="#2750" id="2750" class="l">2750: </a>        {
<a href="#2751" id="2751" class="l">2751: </a>            <span class="php-var">$selected</span> = <span class="php-quote">&quot; selected=\&quot;selected\&quot;&quot;</span>;
<a href="#2752" id="2752" class="l">2752: </a>        }
<a href="#2753" id="2753" class="l">2753: </a>
<a href="#2754" id="2754" class="l">2754: </a>        <span class="php-var">$prefixselect</span> .= <span class="php-quote">&quot;&lt;option value=\&quot;&quot;</span>.<span class="php-var">$prefix</span>[<span class="php-quote">'pid'</span>].<span class="php-quote">&quot;\&quot;&quot;</span>.<span class="php-var">$selected</span>.<span class="php-quote">&quot;&gt;&quot;</span>.htmlspecialchars_uni(<span class="php-var">$prefix</span>[<span class="php-quote">'prefix'</span>]).<span class="php-quote">&quot;&lt;/option&gt;\n&quot;</span>;
<a href="#2755" id="2755" class="l">2755: </a>    }
<a href="#2756" id="2756" class="l">2756: </a>
<a href="#2757" id="2757" class="l">2757: </a>    <span class="php-var">$prefixselect</span> .= <span class="php-quote">&quot;&lt;/select&gt;\n&amp;nbsp;&quot;</span>;
<a href="#2758" id="2758" class="l">2758: </a>
<a href="#2759" id="2759" class="l">2759: </a>    <span class="php-keyword1">return</span> <span class="php-var">$prefixselect</span>;
<a href="#2760" id="2760" class="l">2760: </a>}
<a href="#2761" id="2761" class="l">2761: </a>
<a href="#2762" id="2762" class="l">2762: </a><span class="php-comment">/**
</span><a href="#2763" id="2763" class="l">2763: </a><span class="php-comment"> * Gzip encodes text to a specified level
</span><a href="#2764" id="2764" class="l">2764: </a><span class="php-comment"> *
</span><a href="#2765" id="2765" class="l">2765: </a><span class="php-comment"> * @param string The string to encode
</span><a href="#2766" id="2766" class="l">2766: </a><span class="php-comment"> * @param int The level (1-9) to encode at
</span><a href="#2767" id="2767" class="l">2767: </a><span class="php-comment"> * @return string The encoded string
</span><a href="#2768" id="2768" class="l">2768: </a><span class="php-comment"> */</span>
<a href="#2769" id="2769" class="l">2769: </a><span class="php-keyword1">function</span> gzip_encode(<span class="php-var">$contents</span>, <span class="php-var">$level</span>=<span class="php-num">1</span>)
<a href="#2770" id="2770" class="l">2770: </a>{
<a href="#2771" id="2771" class="l">2771: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">function_exists</span>(<span class="php-quote">&quot;gzcompress&quot;</span>) &amp;&amp; <span class="php-keyword2">function_exists</span>(<span class="php-quote">&quot;crc32&quot;</span>) &amp;&amp; !<span class="php-keyword2">headers_sent</span>() &amp;&amp; !(<span class="php-keyword2">ini_get</span>(<span class="php-quote">'output_buffering'</span>) &amp;&amp; my_strpos(<span class="php-quote">' '</span>.<span class="php-keyword2">ini_get</span>(<span class="php-quote">'output_handler'</span>), <span class="php-quote">'ob_gzhandler'</span>)))
<a href="#2772" id="2772" class="l">2772: </a>    {
<a href="#2773" id="2773" class="l">2773: </a>        <span class="php-var">$httpaccept_encoding</span> = <span class="php-quote">''</span>;
<a href="#2774" id="2774" class="l">2774: </a>
<a href="#2775" id="2775" class="l">2775: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword1">isset</span>(<span class="php-var">$_SERVER</span>[<span class="php-quote">'HTTP_ACCEPT_ENCODING'</span>]))
<a href="#2776" id="2776" class="l">2776: </a>        {
<a href="#2777" id="2777" class="l">2777: </a>            <span class="php-var">$httpaccept_encoding</span> = <span class="php-var">$_SERVER</span>[<span class="php-quote">'HTTP_ACCEPT_ENCODING'</span>];
<a href="#2778" id="2778" class="l">2778: </a>        }
<a href="#2779" id="2779" class="l">2779: </a>
<a href="#2780" id="2780" class="l">2780: </a>        <span class="php-keyword1">if</span>(my_strpos(<span class="php-quote">&quot; &quot;</span>.<span class="php-var">$httpaccept_encoding</span>, <span class="php-quote">&quot;x-gzip&quot;</span>))
<a href="#2781" id="2781" class="l">2781: </a>        {
<a href="#2782" id="2782" class="l">2782: </a>            <span class="php-var">$encoding</span> = <span class="php-quote">&quot;x-gzip&quot;</span>;
<a href="#2783" id="2783" class="l">2783: </a>        }
<a href="#2784" id="2784" class="l">2784: </a>
<a href="#2785" id="2785" class="l">2785: </a>        <span class="php-keyword1">if</span>(my_strpos(<span class="php-quote">&quot; &quot;</span>.<span class="php-var">$httpaccept_encoding</span>, <span class="php-quote">&quot;gzip&quot;</span>))
<a href="#2786" id="2786" class="l">2786: </a>        {
<a href="#2787" id="2787" class="l">2787: </a>            <span class="php-var">$encoding</span> = <span class="php-quote">&quot;gzip&quot;</span>;
<a href="#2788" id="2788" class="l">2788: </a>        }
<a href="#2789" id="2789" class="l">2789: </a>
<a href="#2790" id="2790" class="l">2790: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword1">isset</span>(<span class="php-var">$encoding</span>))
<a href="#2791" id="2791" class="l">2791: </a>        {
<a href="#2792" id="2792" class="l">2792: </a>            <span class="php-keyword2">header</span>(<span class="php-quote">&quot;Content-Encoding: </span><span class="php-var">$encoding</span><span class="php-quote">&quot;</span>);
<a href="#2793" id="2793" class="l">2793: </a>
<a href="#2794" id="2794" class="l">2794: </a>            <span class="php-keyword1">if</span>(<span class="php-keyword2">function_exists</span>(<span class="php-quote">&quot;gzencode&quot;</span>))
<a href="#2795" id="2795" class="l">2795: </a>            {
<a href="#2796" id="2796" class="l">2796: </a>                <span class="php-var">$contents</span> = <span class="php-keyword2">gzencode</span>(<span class="php-var">$contents</span>, <span class="php-var">$level</span>);
<a href="#2797" id="2797" class="l">2797: </a>            }
<a href="#2798" id="2798" class="l">2798: </a>            <span class="php-keyword1">else</span>
<a href="#2799" id="2799" class="l">2799: </a>            {
<a href="#2800" id="2800" class="l">2800: </a>                <span class="php-var">$size</span> = <span class="php-keyword2">strlen</span>(<span class="php-var">$contents</span>);
<a href="#2801" id="2801" class="l">2801: </a>                <span class="php-var">$crc</span> = <span class="php-keyword2">crc32</span>(<span class="php-var">$contents</span>);
<a href="#2802" id="2802" class="l">2802: </a>                <span class="php-var">$gzdata</span> = <span class="php-quote">&quot;\x1f\x8b\x08\x00\x00\x00\x00\x00\x00\xff&quot;</span>;
<a href="#2803" id="2803" class="l">2803: </a>                <span class="php-var">$gzdata</span> .= my_substr(<span class="php-keyword2">gzcompress</span>(<span class="php-var">$contents</span>, <span class="php-var">$level</span>), <span class="php-num">2</span>, -<span class="php-num">4</span>);
<a href="#2804" id="2804" class="l">2804: </a>                <span class="php-var">$gzdata</span> .= <span class="php-keyword2">pack</span>(<span class="php-quote">&quot;V&quot;</span>, <span class="php-var">$crc</span>);
<a href="#2805" id="2805" class="l">2805: </a>                <span class="php-var">$gzdata</span> .= <span class="php-keyword2">pack</span>(<span class="php-quote">&quot;V&quot;</span>, <span class="php-var">$size</span>);
<a href="#2806" id="2806" class="l">2806: </a>                <span class="php-var">$contents</span> = <span class="php-var">$gzdata</span>;
<a href="#2807" id="2807" class="l">2807: </a>            }
<a href="#2808" id="2808" class="l">2808: </a>        }
<a href="#2809" id="2809" class="l">2809: </a>    }
<a href="#2810" id="2810" class="l">2810: </a>
<a href="#2811" id="2811" class="l">2811: </a>    <span class="php-keyword1">return</span> <span class="php-var">$contents</span>;
<a href="#2812" id="2812" class="l">2812: </a>}
<a href="#2813" id="2813" class="l">2813: </a>
<a href="#2814" id="2814" class="l">2814: </a><span class="php-comment">/**
</span><a href="#2815" id="2815" class="l">2815: </a><span class="php-comment"> * Log the actions of a moderator.
</span><a href="#2816" id="2816" class="l">2816: </a><span class="php-comment"> *
</span><a href="#2817" id="2817" class="l">2817: </a><span class="php-comment"> * @param array The data of the moderator's action.
</span><a href="#2818" id="2818" class="l">2818: </a><span class="php-comment"> * @param string The message to enter for the action the moderator performed.
</span><a href="#2819" id="2819" class="l">2819: </a><span class="php-comment"> */</span>
<a href="#2820" id="2820" class="l">2820: </a><span class="php-keyword1">function</span> log_moderator_action(<span class="php-var">$data</span>, <span class="php-var">$action</span>=<span class="php-quote">&quot;&quot;</span>)
<a href="#2821" id="2821" class="l">2821: </a>{
<a href="#2822" id="2822" class="l">2822: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>, <span class="php-var">$db</span>, <span class="php-var">$session</span>;
<a href="#2823" id="2823" class="l">2823: </a>
<a href="#2824" id="2824" class="l">2824: </a>    <span class="php-comment">// If the fid or tid is not set, set it at 0 so MySQL doesn't choke on it.</span>
<a href="#2825" id="2825" class="l">2825: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$data</span>[<span class="php-quote">'fid'</span>] == <span class="php-quote">''</span>)
<a href="#2826" id="2826" class="l">2826: </a>    {
<a href="#2827" id="2827" class="l">2827: </a>        <span class="php-var">$fid</span> = <span class="php-num">0</span>;
<a href="#2828" id="2828" class="l">2828: </a>    }
<a href="#2829" id="2829" class="l">2829: </a>    <span class="php-keyword1">else</span>
<a href="#2830" id="2830" class="l">2830: </a>    {
<a href="#2831" id="2831" class="l">2831: </a>        <span class="php-var">$fid</span> = <span class="php-var">$data</span>[<span class="php-quote">'fid'</span>];
<a href="#2832" id="2832" class="l">2832: </a>        <span class="php-keyword1">unset</span>(<span class="php-var">$data</span>[<span class="php-quote">'fid'</span>]);
<a href="#2833" id="2833" class="l">2833: </a>    }
<a href="#2834" id="2834" class="l">2834: </a>
<a href="#2835" id="2835" class="l">2835: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$data</span>[<span class="php-quote">'tid'</span>] == <span class="php-quote">''</span>)
<a href="#2836" id="2836" class="l">2836: </a>    {
<a href="#2837" id="2837" class="l">2837: </a>        <span class="php-var">$tid</span> = <span class="php-num">0</span>;
<a href="#2838" id="2838" class="l">2838: </a>    }
<a href="#2839" id="2839" class="l">2839: </a>    <span class="php-keyword1">else</span>
<a href="#2840" id="2840" class="l">2840: </a>    {
<a href="#2841" id="2841" class="l">2841: </a>        <span class="php-var">$tid</span> = <span class="php-var">$data</span>[<span class="php-quote">'tid'</span>];
<a href="#2842" id="2842" class="l">2842: </a>        <span class="php-keyword1">unset</span>(<span class="php-var">$data</span>[<span class="php-quote">'tid'</span>]);
<a href="#2843" id="2843" class="l">2843: </a>    }
<a href="#2844" id="2844" class="l">2844: </a>
<a href="#2845" id="2845" class="l">2845: </a>    <span class="php-comment">// Any remaining extra data - we serialize and insert in to its own column</span>
<a href="#2846" id="2846" class="l">2846: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$data</span>))
<a href="#2847" id="2847" class="l">2847: </a>    {
<a href="#2848" id="2848" class="l">2848: </a>        <span class="php-var">$data</span> = <span class="php-keyword2">serialize</span>(<span class="php-var">$data</span>);
<a href="#2849" id="2849" class="l">2849: </a>    }
<a href="#2850" id="2850" class="l">2850: </a>
<a href="#2851" id="2851" class="l">2851: </a>    <span class="php-var">$time</span> = TIME_NOW;
<a href="#2852" id="2852" class="l">2852: </a>
<a href="#2853" id="2853" class="l">2853: </a>    <span class="php-var">$sql_array</span> = <span class="php-keyword1">array</span>(
<a href="#2854" id="2854" class="l">2854: </a>        <span class="php-quote">&quot;uid&quot;</span> =&gt; <span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'uid'</span>],
<a href="#2855" id="2855" class="l">2855: </a>        <span class="php-quote">&quot;dateline&quot;</span> =&gt; <span class="php-var">$time</span>,
<a href="#2856" id="2856" class="l">2856: </a>        <span class="php-quote">&quot;fid&quot;</span> =&gt; <span class="php-var">$fid</span>,
<a href="#2857" id="2857" class="l">2857: </a>        <span class="php-quote">&quot;tid&quot;</span> =&gt; <span class="php-var">$tid</span>,
<a href="#2858" id="2858" class="l">2858: </a>        <span class="php-quote">&quot;action&quot;</span> =&gt; <span class="php-var">$db</span>-&gt;escape_string(<span class="php-var">$action</span>),
<a href="#2859" id="2859" class="l">2859: </a>        <span class="php-quote">&quot;data&quot;</span> =&gt; <span class="php-var">$db</span>-&gt;escape_string(<span class="php-var">$data</span>),
<a href="#2860" id="2860" class="l">2860: </a>        <span class="php-quote">&quot;ipaddress&quot;</span> =&gt; <span class="php-var">$db</span>-&gt;escape_string(<span class="php-var">$session</span>-&gt;ipaddress)
<a href="#2861" id="2861" class="l">2861: </a>    );
<a href="#2862" id="2862" class="l">2862: </a>    <span class="php-var">$db</span>-&gt;insert_query(<span class="php-quote">&quot;moderatorlog&quot;</span>, <span class="php-var">$sql_array</span>);
<a href="#2863" id="2863" class="l">2863: </a>}
<a href="#2864" id="2864" class="l">2864: </a>
<a href="#2865" id="2865" class="l">2865: </a><span class="php-comment">/**
</span><a href="#2866" id="2866" class="l">2866: </a><span class="php-comment"> * Get the formatted reputation for a user.
</span><a href="#2867" id="2867" class="l">2867: </a><span class="php-comment"> *
</span><a href="#2868" id="2868" class="l">2868: </a><span class="php-comment"> * @param int The reputation value
</span><a href="#2869" id="2869" class="l">2869: </a><span class="php-comment"> * @param int The user ID (if not specified, the generated reputation will not be a link)
</span><a href="#2870" id="2870" class="l">2870: </a><span class="php-comment"> * @return string The formatted repuation
</span><a href="#2871" id="2871" class="l">2871: </a><span class="php-comment"> */</span>
<a href="#2872" id="2872" class="l">2872: </a><span class="php-keyword1">function</span> get_reputation(<span class="php-var">$reputation</span>, <span class="php-var">$uid</span>=<span class="php-num">0</span>)
<a href="#2873" id="2873" class="l">2873: </a>{
<a href="#2874" id="2874" class="l">2874: </a>    <span class="php-keyword1">global</span> <span class="php-var">$theme</span>;
<a href="#2875" id="2875" class="l">2875: </a>
<a href="#2876" id="2876" class="l">2876: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$uid</span> != <span class="php-num">0</span>)
<a href="#2877" id="2877" class="l">2877: </a>    {
<a href="#2878" id="2878" class="l">2878: </a>        <span class="php-var">$display_reputation</span> = <span class="php-quote">&quot;&lt;a href=\&quot;reputation.php?uid=</span><span class="php-var">{$uid}</span><span class="php-quote">\&quot;&gt;&quot;</span>;
<a href="#2879" id="2879" class="l">2879: </a>    }
<a href="#2880" id="2880" class="l">2880: </a>
<a href="#2881" id="2881" class="l">2881: </a>    <span class="php-var">$display_reputation</span> .= <span class="php-quote">&quot;&lt;strong class=\&quot;&quot;</span>;
<a href="#2882" id="2882" class="l">2882: </a>
<a href="#2883" id="2883" class="l">2883: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$reputation</span> &lt; <span class="php-num">0</span>)
<a href="#2884" id="2884" class="l">2884: </a>    {
<a href="#2885" id="2885" class="l">2885: </a>        <span class="php-var">$display_reputation</span> .= <span class="php-quote">&quot;reputation_negative&quot;</span>;
<a href="#2886" id="2886" class="l">2886: </a>    }
<a href="#2887" id="2887" class="l">2887: </a>    <span class="php-keyword1">elseif</span>(<span class="php-var">$reputation</span> &gt; <span class="php-num">0</span>)
<a href="#2888" id="2888" class="l">2888: </a>    {
<a href="#2889" id="2889" class="l">2889: </a>        <span class="php-var">$display_reputation</span> .= <span class="php-quote">&quot;reputation_positive&quot;</span>;
<a href="#2890" id="2890" class="l">2890: </a>    }
<a href="#2891" id="2891" class="l">2891: </a>    <span class="php-keyword1">else</span>
<a href="#2892" id="2892" class="l">2892: </a>    {
<a href="#2893" id="2893" class="l">2893: </a>        <span class="php-var">$display_reputation</span> .= <span class="php-quote">&quot;reputation_neutral&quot;</span>;
<a href="#2894" id="2894" class="l">2894: </a>    }
<a href="#2895" id="2895" class="l">2895: </a>
<a href="#2896" id="2896" class="l">2896: </a>    <span class="php-var">$display_reputation</span> .= <span class="php-quote">&quot;\&quot;&gt;</span><span class="php-var">{$reputation}</span><span class="php-quote">&lt;/strong&gt;&quot;</span>;
<a href="#2897" id="2897" class="l">2897: </a>
<a href="#2898" id="2898" class="l">2898: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$uid</span> != <span class="php-num">0</span>)
<a href="#2899" id="2899" class="l">2899: </a>    {
<a href="#2900" id="2900" class="l">2900: </a>        <span class="php-var">$display_reputation</span> .= <span class="php-quote">&quot;&lt;/a&gt;&quot;</span>;
<a href="#2901" id="2901" class="l">2901: </a>    }
<a href="#2902" id="2902" class="l">2902: </a>
<a href="#2903" id="2903" class="l">2903: </a>    <span class="php-keyword1">return</span> <span class="php-var">$display_reputation</span>;
<a href="#2904" id="2904" class="l">2904: </a>}
<a href="#2905" id="2905" class="l">2905: </a>
<a href="#2906" id="2906" class="l">2906: </a><span class="php-comment">/**
</span><a href="#2907" id="2907" class="l">2907: </a><span class="php-comment"> * Fetch a color coded version of a warning level (based on it's percentage)
</span><a href="#2908" id="2908" class="l">2908: </a><span class="php-comment"> *
</span><a href="#2909" id="2909" class="l">2909: </a><span class="php-comment"> * @param int The warning level (percentage of 100)
</span><a href="#2910" id="2910" class="l">2910: </a><span class="php-comment"> * @return string Formatted warning level
</span><a href="#2911" id="2911" class="l">2911: </a><span class="php-comment"> */</span>
<a href="#2912" id="2912" class="l">2912: </a><span class="php-keyword1">function</span> get_colored_warning_level(<span class="php-var">$level</span>)
<a href="#2913" id="2913" class="l">2913: </a>{
<a href="#2914" id="2914" class="l">2914: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$level</span> &gt;= <span class="php-num">80</span>)
<a href="#2915" id="2915" class="l">2915: </a>    {
<a href="#2916" id="2916" class="l">2916: </a>        <span class="php-keyword1">return</span> <span class="php-quote">&quot;&lt;span class=\&quot;high_warning\&quot;&gt;</span><span class="php-var">{$level}</span><span class="php-quote">%&lt;/span&gt;&quot;</span>;
<a href="#2917" id="2917" class="l">2917: </a>    }
<a href="#2918" id="2918" class="l">2918: </a>    <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(<span class="php-var">$level</span> &gt;= <span class="php-num">50</span>)
<a href="#2919" id="2919" class="l">2919: </a>    {
<a href="#2920" id="2920" class="l">2920: </a>        <span class="php-keyword1">return</span> <span class="php-quote">&quot;&lt;span class=\&quot;moderate_warning\&quot;&gt;</span><span class="php-var">{$level}</span><span class="php-quote">%&lt;/span&gt;&quot;</span>;
<a href="#2921" id="2921" class="l">2921: </a>    }
<a href="#2922" id="2922" class="l">2922: </a>    <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(<span class="php-var">$level</span> &gt;= <span class="php-num">25</span>)
<a href="#2923" id="2923" class="l">2923: </a>    {
<a href="#2924" id="2924" class="l">2924: </a>        <span class="php-keyword1">return</span> <span class="php-quote">&quot;&lt;span class=\&quot;low_warning\&quot;&gt;</span><span class="php-var">{$level}</span><span class="php-quote">%&lt;/span&gt;&quot;</span>;
<a href="#2925" id="2925" class="l">2925: </a>    }
<a href="#2926" id="2926" class="l">2926: </a>    <span class="php-keyword1">else</span>
<a href="#2927" id="2927" class="l">2927: </a>    {
<a href="#2928" id="2928" class="l">2928: </a>        <span class="php-keyword1">return</span> <span class="php-var">$level</span>.<span class="php-quote">&quot;%&quot;</span>;
<a href="#2929" id="2929" class="l">2929: </a>    }
<a href="#2930" id="2930" class="l">2930: </a>}
<a href="#2931" id="2931" class="l">2931: </a>
<a href="#2932" id="2932" class="l">2932: </a><span class="php-comment">/**
</span><a href="#2933" id="2933" class="l">2933: </a><span class="php-comment"> * Fetch the IP address of the current user.
</span><a href="#2934" id="2934" class="l">2934: </a><span class="php-comment"> *
</span><a href="#2935" id="2935" class="l">2935: </a><span class="php-comment"> * @return string The IP address.
</span><a href="#2936" id="2936" class="l">2936: </a><span class="php-comment"> */</span>
<a href="#2937" id="2937" class="l">2937: </a><span class="php-keyword1">function</span> get_ip()
<a href="#2938" id="2938" class="l">2938: </a>{
<a href="#2939" id="2939" class="l">2939: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>, <span class="php-var">$plugins</span>;
<a href="#2940" id="2940" class="l">2940: </a>
<a href="#2941" id="2941" class="l">2941: </a>    <span class="php-var">$ip</span> = <span class="php-num">0</span>;
<a href="#2942" id="2942" class="l">2942: </a>
<a href="#2943" id="2943" class="l">2943: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">preg_match</span>(<span class="php-quote">&quot;#^(10|172\.16|192\.168)\.#&quot;</span>, <span class="php-var">$_SERVER</span>[<span class="php-quote">'REMOTE_ADDR'</span>]))
<a href="#2944" id="2944" class="l">2944: </a>    {
<a href="#2945" id="2945" class="l">2945: </a>        <span class="php-var">$ip</span> = <span class="php-var">$_SERVER</span>[<span class="php-quote">'REMOTE_ADDR'</span>];
<a href="#2946" id="2946" class="l">2946: </a>    }
<a href="#2947" id="2947" class="l">2947: </a>
<a href="#2948" id="2948" class="l">2948: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'ip_forwarded_check'</span>])
<a href="#2949" id="2949" class="l">2949: </a>    {
<a href="#2950" id="2950" class="l">2950: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword1">isset</span>(<span class="php-var">$_SERVER</span>[<span class="php-quote">'HTTP_X_FORWARDED_FOR'</span>]))
<a href="#2951" id="2951" class="l">2951: </a>        {
<a href="#2952" id="2952" class="l">2952: </a>            <span class="php-keyword2">preg_match_all</span>(<span class="php-quote">&quot;#[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}#s&quot;</span>, <span class="php-var">$_SERVER</span>[<span class="php-quote">'HTTP_X_FORWARDED_FOR'</span>], <span class="php-var">$addresses</span>);
<a href="#2953" id="2953" class="l">2953: </a>        }
<a href="#2954" id="2954" class="l">2954: </a>        <span class="php-keyword1">elseif</span>(<span class="php-keyword1">isset</span>(<span class="php-var">$_SERVER</span>[<span class="php-quote">'HTTP_X_REAL_IP'</span>]))
<a href="#2955" id="2955" class="l">2955: </a>        {
<a href="#2956" id="2956" class="l">2956: </a>            <span class="php-keyword2">preg_match_all</span>(<span class="php-quote">&quot;#[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}#s&quot;</span>, <span class="php-var">$_SERVER</span>[<span class="php-quote">'HTTP_X_REAL_IP'</span>], <span class="php-var">$addresses</span>);
<a href="#2957" id="2957" class="l">2957: </a>        }
<a href="#2958" id="2958" class="l">2958: </a>
<a href="#2959" id="2959" class="l">2959: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$addresses</span>[<span class="php-num">0</span>]))
<a href="#2960" id="2960" class="l">2960: </a>        {
<a href="#2961" id="2961" class="l">2961: </a>            <span class="php-keyword1">foreach</span>(<span class="php-var">$addresses</span>[<span class="php-num">0</span>] <span class="php-keyword1">as</span> <span class="php-var">$key</span> =&gt; <span class="php-var">$val</span>)
<a href="#2962" id="2962" class="l">2962: </a>            {
<a href="#2963" id="2963" class="l">2963: </a>                <span class="php-keyword1">if</span>(!<span class="php-keyword2">preg_match</span>(<span class="php-quote">&quot;#^(10|172\.16|192\.168)\.#&quot;</span>, <span class="php-var">$val</span>))
<a href="#2964" id="2964" class="l">2964: </a>                {
<a href="#2965" id="2965" class="l">2965: </a>                    <span class="php-var">$ip</span> = <span class="php-var">$val</span>;
<a href="#2966" id="2966" class="l">2966: </a>                    <span class="php-keyword1">break</span>;
<a href="#2967" id="2967" class="l">2967: </a>                }
<a href="#2968" id="2968" class="l">2968: </a>            }
<a href="#2969" id="2969" class="l">2969: </a>        }
<a href="#2970" id="2970" class="l">2970: </a>    }
<a href="#2971" id="2971" class="l">2971: </a>
<a href="#2972" id="2972" class="l">2972: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$ip</span>)
<a href="#2973" id="2973" class="l">2973: </a>    {
<a href="#2974" id="2974" class="l">2974: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword1">isset</span>(<span class="php-var">$_SERVER</span>[<span class="php-quote">'HTTP_CLIENT_IP'</span>]))
<a href="#2975" id="2975" class="l">2975: </a>        {
<a href="#2976" id="2976" class="l">2976: </a>            <span class="php-var">$ip</span> = <span class="php-var">$_SERVER</span>[<span class="php-quote">'HTTP_CLIENT_IP'</span>];
<a href="#2977" id="2977" class="l">2977: </a>        }
<a href="#2978" id="2978" class="l">2978: </a>    }
<a href="#2979" id="2979" class="l">2979: </a>
<a href="#2980" id="2980" class="l">2980: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$plugins</span>)
<a href="#2981" id="2981" class="l">2981: </a>    {
<a href="#2982" id="2982" class="l">2982: </a>        <span class="php-var">$ip_array</span> = <span class="php-keyword1">array</span>(<span class="php-quote">&quot;ip&quot;</span> =&gt; &amp;<span class="php-var">$ip</span>); <span class="php-comment">// Used for backwards compatibility on this hook with the updated run_hooks() function.</span>
<a href="#2983" id="2983" class="l">2983: </a>        <span class="php-var">$plugins</span>-&gt;run_hooks(<span class="php-quote">&quot;get_ip&quot;</span>, <span class="php-var">$ip_array</span>);
<a href="#2984" id="2984" class="l">2984: </a>    }
<a href="#2985" id="2985" class="l">2985: </a>
<a href="#2986" id="2986" class="l">2986: </a>    <span class="php-keyword1">return</span> <span class="php-var">$ip</span>;
<a href="#2987" id="2987" class="l">2987: </a>}
<a href="#2988" id="2988" class="l">2988: </a>
<a href="#2989" id="2989" class="l">2989: </a><span class="php-comment">/**
</span><a href="#2990" id="2990" class="l">2990: </a><span class="php-comment"> * Fetch the friendly size (GB, MB, KB, B) for a specified file size.
</span><a href="#2991" id="2991" class="l">2991: </a><span class="php-comment"> *
</span><a href="#2992" id="2992" class="l">2992: </a><span class="php-comment"> * @param int The size in bytes
</span><a href="#2993" id="2993" class="l">2993: </a><span class="php-comment"> * @return string The friendly file size
</span><a href="#2994" id="2994" class="l">2994: </a><span class="php-comment"> */</span>
<a href="#2995" id="2995" class="l">2995: </a><span class="php-keyword1">function</span> get_friendly_size(<span class="php-var">$size</span>)
<a href="#2996" id="2996" class="l">2996: </a>{
<a href="#2997" id="2997" class="l">2997: </a>    <span class="php-keyword1">global</span> <span class="php-var">$lang</span>;
<a href="#2998" id="2998" class="l">2998: </a>    
<a href="#2999" id="2999" class="l">2999: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_numeric</span>(<span class="php-var">$size</span>))
<a href="#3000" id="3000" class="l">3000: </a>    {
<a href="#3001" id="3001" class="l">3001: </a>        <span class="php-keyword1">return</span> <span class="php-var">$lang</span>-&gt;na;
<a href="#3002" id="3002" class="l">3002: </a>    }
<a href="#3003" id="3003" class="l">3003: </a>    
<a href="#3004" id="3004" class="l">3004: </a>    <span class="php-comment">// Yottabyte (1024 Zettabytes)</span>
<a href="#3005" id="3005" class="l">3005: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$size</span> &gt;= <span class="php-num">1208925819614629174706176</span>)
<a href="#3006" id="3006" class="l">3006: </a>    {
<a href="#3007" id="3007" class="l">3007: </a>        <span class="php-var">$size</span> = my_number_format(<span class="php-keyword2">round</span>((<span class="php-var">$size</span> / <span class="php-num">1208925819614629174706176</span>), <span class="php-num">2</span>)).<span class="php-quote">&quot; &quot;</span>.<span class="php-var">$lang</span>-&gt;size_yb;
<a href="#3008" id="3008" class="l">3008: </a>    }
<a href="#3009" id="3009" class="l">3009: </a>    <span class="php-comment">// Zetabyte (1024 Exabytes)</span>
<a href="#3010" id="3010" class="l">3010: </a>    <span class="php-keyword1">elseif</span>(<span class="php-var">$size</span> &gt;= <span class="php-num">1180591620717411303424</span>)
<a href="#3011" id="3011" class="l">3011: </a>    {
<a href="#3012" id="3012" class="l">3012: </a>        <span class="php-var">$size</span> = my_number_format(<span class="php-keyword2">round</span>((<span class="php-var">$size</span> / <span class="php-num">1180591620717411303424</span>), <span class="php-num">2</span>)).<span class="php-quote">&quot; &quot;</span>.<span class="php-var">$lang</span>-&gt;size_zb;
<a href="#3013" id="3013" class="l">3013: </a>    }
<a href="#3014" id="3014" class="l">3014: </a>    <span class="php-comment">// Exabyte (1024 Petabytes)</span>
<a href="#3015" id="3015" class="l">3015: </a>    <span class="php-keyword1">elseif</span>(<span class="php-var">$size</span> &gt;= <span class="php-num">1152921504606846976</span>)
<a href="#3016" id="3016" class="l">3016: </a>    {
<a href="#3017" id="3017" class="l">3017: </a>        <span class="php-var">$size</span> = my_number_format(<span class="php-keyword2">round</span>((<span class="php-var">$size</span> / <span class="php-num">1152921504606846976</span>), <span class="php-num">2</span>)).<span class="php-quote">&quot; &quot;</span>.<span class="php-var">$lang</span>-&gt;size_eb;
<a href="#3018" id="3018" class="l">3018: </a>    }
<a href="#3019" id="3019" class="l">3019: </a>    <span class="php-comment">// Petabyte (1024 Terabytes)</span>
<a href="#3020" id="3020" class="l">3020: </a>    <span class="php-keyword1">elseif</span>(<span class="php-var">$size</span> &gt;= <span class="php-num">1125899906842624</span>)
<a href="#3021" id="3021" class="l">3021: </a>    {
<a href="#3022" id="3022" class="l">3022: </a>        <span class="php-var">$size</span> = my_number_format(<span class="php-keyword2">round</span>((<span class="php-var">$size</span> / <span class="php-num">1125899906842624</span>), <span class="php-num">2</span>)).<span class="php-quote">&quot; &quot;</span>.<span class="php-var">$lang</span>-&gt;size_pb;
<a href="#3023" id="3023" class="l">3023: </a>    }
<a href="#3024" id="3024" class="l">3024: </a>    <span class="php-comment">// Terabyte (1024 Gigabytes)</span>
<a href="#3025" id="3025" class="l">3025: </a>    <span class="php-keyword1">elseif</span>(<span class="php-var">$size</span> &gt;= <span class="php-num">1099511627776</span>)
<a href="#3026" id="3026" class="l">3026: </a>    {
<a href="#3027" id="3027" class="l">3027: </a>        <span class="php-var">$size</span> = my_number_format(<span class="php-keyword2">round</span>((<span class="php-var">$size</span> / <span class="php-num">1099511627776</span>), <span class="php-num">2</span>)).<span class="php-quote">&quot; &quot;</span>.<span class="php-var">$lang</span>-&gt;size_tb;
<a href="#3028" id="3028" class="l">3028: </a>    }
<a href="#3029" id="3029" class="l">3029: </a>    <span class="php-comment">// Gigabyte (1024 Megabytes)</span>
<a href="#3030" id="3030" class="l">3030: </a>    <span class="php-keyword1">elseif</span>(<span class="php-var">$size</span> &gt;= <span class="php-num">1073741824</span>)
<a href="#3031" id="3031" class="l">3031: </a>    {
<a href="#3032" id="3032" class="l">3032: </a>        <span class="php-var">$size</span> = my_number_format(<span class="php-keyword2">round</span>((<span class="php-var">$size</span> / <span class="php-num">1073741824</span>), <span class="php-num">2</span>)).<span class="php-quote">&quot; &quot;</span>.<span class="php-var">$lang</span>-&gt;size_gb;
<a href="#3033" id="3033" class="l">3033: </a>    }
<a href="#3034" id="3034" class="l">3034: </a>    <span class="php-comment">// Megabyte (1024 Kilobytes)</span>
<a href="#3035" id="3035" class="l">3035: </a>    <span class="php-keyword1">elseif</span>(<span class="php-var">$size</span> &gt;= <span class="php-num">1048576</span>)
<a href="#3036" id="3036" class="l">3036: </a>    {
<a href="#3037" id="3037" class="l">3037: </a>        <span class="php-var">$size</span> = my_number_format(<span class="php-keyword2">round</span>((<span class="php-var">$size</span> / <span class="php-num">1048576</span>), <span class="php-num">2</span>)).<span class="php-quote">&quot; &quot;</span>.<span class="php-var">$lang</span>-&gt;size_mb;
<a href="#3038" id="3038" class="l">3038: </a>    }
<a href="#3039" id="3039" class="l">3039: </a>    <span class="php-comment">// Kilobyte (1024 bytes)</span>
<a href="#3040" id="3040" class="l">3040: </a>    <span class="php-keyword1">elseif</span>(<span class="php-var">$size</span> &gt;= <span class="php-num">1024</span>)
<a href="#3041" id="3041" class="l">3041: </a>    {
<a href="#3042" id="3042" class="l">3042: </a>        <span class="php-var">$size</span> = my_number_format(<span class="php-keyword2">round</span>((<span class="php-var">$size</span> / <span class="php-num">1024</span>), <span class="php-num">2</span>)).<span class="php-quote">&quot; &quot;</span>.<span class="php-var">$lang</span>-&gt;size_kb;
<a href="#3043" id="3043" class="l">3043: </a>    }
<a href="#3044" id="3044" class="l">3044: </a>    <span class="php-keyword1">elseif</span>(<span class="php-var">$size</span> == <span class="php-num">0</span>)
<a href="#3045" id="3045" class="l">3045: </a>    {
<a href="#3046" id="3046" class="l">3046: </a>        <span class="php-var">$size</span> = <span class="php-quote">&quot;0 &quot;</span>.<span class="php-var">$lang</span>-&gt;size_bytes;
<a href="#3047" id="3047" class="l">3047: </a>    }
<a href="#3048" id="3048" class="l">3048: </a>    <span class="php-keyword1">else</span>
<a href="#3049" id="3049" class="l">3049: </a>    {
<a href="#3050" id="3050" class="l">3050: </a>        <span class="php-var">$size</span> = my_number_format(<span class="php-var">$size</span>).<span class="php-quote">&quot; &quot;</span>.<span class="php-var">$lang</span>-&gt;size_bytes;
<a href="#3051" id="3051" class="l">3051: </a>    }
<a href="#3052" id="3052" class="l">3052: </a>
<a href="#3053" id="3053" class="l">3053: </a>    <span class="php-keyword1">return</span> <span class="php-var">$size</span>;
<a href="#3054" id="3054" class="l">3054: </a>}
<a href="#3055" id="3055" class="l">3055: </a>
<a href="#3056" id="3056" class="l">3056: </a><span class="php-comment">/**
</span><a href="#3057" id="3057" class="l">3057: </a><span class="php-comment"> * Get the attachment icon for a specific file extension
</span><a href="#3058" id="3058" class="l">3058: </a><span class="php-comment"> *
</span><a href="#3059" id="3059" class="l">3059: </a><span class="php-comment"> * @param string The file extension
</span><a href="#3060" id="3060" class="l">3060: </a><span class="php-comment"> * @return string The attachment icon
</span><a href="#3061" id="3061" class="l">3061: </a><span class="php-comment"> */</span>
<a href="#3062" id="3062" class="l">3062: </a><span class="php-keyword1">function</span> get_attachment_icon(<span class="php-var">$ext</span>)
<a href="#3063" id="3063" class="l">3063: </a>{
<a href="#3064" id="3064" class="l">3064: </a>    <span class="php-keyword1">global</span> <span class="php-var">$cache</span>, <span class="php-var">$attachtypes</span>, <span class="php-var">$theme</span>;
<a href="#3065" id="3065" class="l">3065: </a>
<a href="#3066" id="3066" class="l">3066: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$attachtypes</span>)
<a href="#3067" id="3067" class="l">3067: </a>    {
<a href="#3068" id="3068" class="l">3068: </a>        <span class="php-var">$attachtypes</span> = <span class="php-var">$cache</span>-&gt;read(<span class="php-quote">&quot;attachtypes&quot;</span>);
<a href="#3069" id="3069" class="l">3069: </a>    }
<a href="#3070" id="3070" class="l">3070: </a>
<a href="#3071" id="3071" class="l">3071: </a>    <span class="php-var">$ext</span> = my_strtolower(<span class="php-var">$ext</span>);
<a href="#3072" id="3072" class="l">3072: </a>
<a href="#3073" id="3073" class="l">3073: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$attachtypes</span>[<span class="php-var">$ext</span>][<span class="php-quote">'icon'</span>])
<a href="#3074" id="3074" class="l">3074: </a>    {
<a href="#3075" id="3075" class="l">3075: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">defined</span>(<span class="php-quote">&quot;IN_ADMINCP&quot;</span>))
<a href="#3076" id="3076" class="l">3076: </a>        {
<a href="#3077" id="3077" class="l">3077: </a>            <span class="php-var">$icon</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{theme}&quot;</span>, <span class="php-quote">&quot;&quot;</span>, <span class="php-var">$attachtypes</span>[<span class="php-var">$ext</span>][<span class="php-quote">'icon'</span>]);
<a href="#3078" id="3078" class="l">3078: </a>            <span class="php-keyword1">if</span>(my_substr(<span class="php-var">$icon</span>, <span class="php-num">0</span>, <span class="php-num">1</span>) != <span class="php-quote">&quot;/&quot;</span> &amp;&amp; my_substr(<span class="php-var">$icon</span>, <span class="php-num">0</span>, <span class="php-num">7</span>) != <span class="php-quote">&quot;http://&quot;</span>)
<a href="#3079" id="3079" class="l">3079: </a>            {
<a href="#3080" id="3080" class="l">3080: </a>                <span class="php-var">$icon</span> = <span class="php-quote">&quot;../&quot;</span>.<span class="php-var">$icon</span>;
<a href="#3081" id="3081" class="l">3081: </a>            }
<a href="#3082" id="3082" class="l">3082: </a>        }
<a href="#3083" id="3083" class="l">3083: </a>        <span class="php-keyword1">elseif</span>(<span class="php-keyword2">defined</span>(<span class="php-quote">&quot;IN_PORTAL&quot;</span>))
<a href="#3084" id="3084" class="l">3084: </a>        {
<a href="#3085" id="3085" class="l">3085: </a>            <span class="php-keyword1">global</span> <span class="php-var">$change_dir</span>;
<a href="#3086" id="3086" class="l">3086: </a>            <span class="php-var">$icon</span> = <span class="php-var">$change_dir</span>.<span class="php-quote">&quot;/&quot;</span>.<span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{theme}&quot;</span>, <span class="php-var">$theme</span>[<span class="php-quote">'imgdir'</span>], <span class="php-var">$attachtypes</span>[<span class="php-var">$ext</span>][<span class="php-quote">'icon'</span>]);
<a href="#3087" id="3087" class="l">3087: </a>        }
<a href="#3088" id="3088" class="l">3088: </a>        <span class="php-keyword1">else</span>
<a href="#3089" id="3089" class="l">3089: </a>        {
<a href="#3090" id="3090" class="l">3090: </a>            <span class="php-var">$icon</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{theme}&quot;</span>, <span class="php-var">$theme</span>[<span class="php-quote">'imgdir'</span>], <span class="php-var">$attachtypes</span>[<span class="php-var">$ext</span>][<span class="php-quote">'icon'</span>]);
<a href="#3091" id="3091" class="l">3091: </a>        }
<a href="#3092" id="3092" class="l">3092: </a>        <span class="php-keyword1">return</span> <span class="php-quote">&quot;&lt;img src=\&quot;</span><span class="php-var">{$icon}</span><span class="php-quote">\&quot; border=\&quot;0\&quot; alt=\&quot;.</span><span class="php-var">{$ext}</span><span class="php-quote">\&quot; /&gt;&quot;</span>;
<a href="#3093" id="3093" class="l">3093: </a>    }
<a href="#3094" id="3094" class="l">3094: </a>    <span class="php-keyword1">else</span>
<a href="#3095" id="3095" class="l">3095: </a>    {
<a href="#3096" id="3096" class="l">3096: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">defined</span>(<span class="php-quote">&quot;IN_ADMINCP&quot;</span>))
<a href="#3097" id="3097" class="l">3097: </a>        {
<a href="#3098" id="3098" class="l">3098: </a>            <span class="php-var">$theme</span>[<span class="php-quote">'imgdir'</span>] = <span class="php-quote">&quot;../images&quot;</span>;
<a href="#3099" id="3099" class="l">3099: </a>        }
<a href="#3100" id="3100" class="l">3100: </a>        <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(<span class="php-keyword2">defined</span>(<span class="php-quote">&quot;IN_PORTAL&quot;</span>))
<a href="#3101" id="3101" class="l">3101: </a>        {
<a href="#3102" id="3102" class="l">3102: </a>            <span class="php-keyword1">global</span> <span class="php-var">$change_dir</span>;
<a href="#3103" id="3103" class="l">3103: </a>            <span class="php-var">$theme</span>[<span class="php-quote">'imgdir'</span>] = <span class="php-quote">&quot;</span><span class="php-var">{$change_dir}</span><span class="php-quote">/images&quot;</span>;
<a href="#3104" id="3104" class="l">3104: </a>        }
<a href="#3105" id="3105" class="l">3105: </a>        
<a href="#3106" id="3106" class="l">3106: </a>        <span class="php-keyword1">return</span> <span class="php-quote">&quot;&lt;img src=\&quot;</span><span class="php-var">{$theme['imgdir']}</span><span class="php-quote">/attachtypes/unknown.gif\&quot; border=\&quot;0\&quot; alt=\&quot;.</span><span class="php-var">{$ext}</span><span class="php-quote">\&quot; /&gt;&quot;</span>;
<a href="#3107" id="3107" class="l">3107: </a>    }
<a href="#3108" id="3108" class="l">3108: </a>}
<a href="#3109" id="3109" class="l">3109: </a>
<a href="#3110" id="3110" class="l">3110: </a><span class="php-comment">/**
</span><a href="#3111" id="3111" class="l">3111: </a><span class="php-comment"> * Get a list of the unviewable forums for the current user
</span><a href="#3112" id="3112" class="l">3112: </a><span class="php-comment"> *
</span><a href="#3113" id="3113" class="l">3113: </a><span class="php-comment"> * @param boolean Set to true to only fetch those forums for which users can actually read a thread in.
</span><a href="#3114" id="3114" class="l">3114: </a><span class="php-comment"> * @return string Comma separated values list of the forum IDs which the user cannot view
</span><a href="#3115" id="3115" class="l">3115: </a><span class="php-comment"> */</span>
<a href="#3116" id="3116" class="l">3116: </a><span class="php-keyword1">function</span> get_unviewable_forums(<span class="php-var">$only_readable_threads</span>=<span class="php-keyword1">false</span>)
<a href="#3117" id="3117" class="l">3117: </a>{
<a href="#3118" id="3118" class="l">3118: </a>    <span class="php-keyword1">global</span> <span class="php-var">$forum_cache</span>, <span class="php-var">$permissioncache</span>, <span class="php-var">$mybb</span>, <span class="php-var">$unviewableforums</span>, <span class="php-var">$unviewable</span>, <span class="php-var">$templates</span>, <span class="php-var">$forumpass</span>;
<a href="#3119" id="3119" class="l">3119: </a>
<a href="#3120" id="3120" class="l">3120: </a>    <span class="php-var">$pid</span> = <span class="php-keyword2">intval</span>(<span class="php-var">$pid</span>);
<a href="#3121" id="3121" class="l">3121: </a>
<a href="#3122" id="3122" class="l">3122: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$permissions</span>)
<a href="#3123" id="3123" class="l">3123: </a>    {
<a href="#3124" id="3124" class="l">3124: </a>        <span class="php-var">$permissions</span> = <span class="php-var">$mybb</span>-&gt;usergroup;
<a href="#3125" id="3125" class="l">3125: </a>    }
<a href="#3126" id="3126" class="l">3126: </a>
<a href="#3127" id="3127" class="l">3127: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$forum_cache</span>))
<a href="#3128" id="3128" class="l">3128: </a>    {
<a href="#3129" id="3129" class="l">3129: </a>        cache_forums();
<a href="#3130" id="3130" class="l">3130: </a>    }
<a href="#3131" id="3131" class="l">3131: </a>
<a href="#3132" id="3132" class="l">3132: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$permissioncache</span>))
<a href="#3133" id="3133" class="l">3133: </a>    {
<a href="#3134" id="3134" class="l">3134: </a>        <span class="php-var">$permissioncache</span> = forum_permissions();
<a href="#3135" id="3135" class="l">3135: </a>    }
<a href="#3136" id="3136" class="l">3136: </a>
<a href="#3137" id="3137" class="l">3137: </a>    <span class="php-var">$password_forums</span> = <span class="php-keyword1">array</span>();
<a href="#3138" id="3138" class="l">3138: </a>    <span class="php-keyword1">foreach</span>(<span class="php-var">$forum_cache</span> <span class="php-keyword1">as</span> <span class="php-var">$fid</span> =&gt; <span class="php-var">$forum</span>)
<a href="#3139" id="3139" class="l">3139: </a>    {
<a href="#3140" id="3140" class="l">3140: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$permissioncache</span>[<span class="php-var">$forum</span>[<span class="php-quote">'fid'</span>]])
<a href="#3141" id="3141" class="l">3141: </a>        {
<a href="#3142" id="3142" class="l">3142: </a>            <span class="php-var">$perms</span> = <span class="php-var">$permissioncache</span>[<span class="php-var">$forum</span>[<span class="php-quote">'fid'</span>]];
<a href="#3143" id="3143" class="l">3143: </a>        }
<a href="#3144" id="3144" class="l">3144: </a>        <span class="php-keyword1">else</span>
<a href="#3145" id="3145" class="l">3145: </a>        {
<a href="#3146" id="3146" class="l">3146: </a>            <span class="php-var">$perms</span> = <span class="php-var">$mybb</span>-&gt;usergroup;
<a href="#3147" id="3147" class="l">3147: </a>        }
<a href="#3148" id="3148" class="l">3148: </a>
<a href="#3149" id="3149" class="l">3149: </a>        <span class="php-var">$pwverified</span> = <span class="php-num">1</span>;
<a href="#3150" id="3150" class="l">3150: </a>
<a href="#3151" id="3151" class="l">3151: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$forum</span>[<span class="php-quote">'password'</span>] != <span class="php-quote">&quot;&quot;</span>)
<a href="#3152" id="3152" class="l">3152: </a>        {
<a href="#3153" id="3153" class="l">3153: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;cookies[<span class="php-quote">'forumpass'</span>][<span class="php-var">$forum</span>[<span class="php-quote">'fid'</span>]] != <span class="php-keyword2">md5</span>(<span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'uid'</span>].<span class="php-var">$forum</span>[<span class="php-quote">'password'</span>]))
<a href="#3154" id="3154" class="l">3154: </a>            {
<a href="#3155" id="3155" class="l">3155: </a>                <span class="php-var">$pwverified</span> = <span class="php-num">0</span>;
<a href="#3156" id="3156" class="l">3156: </a>            }
<a href="#3157" id="3157" class="l">3157: </a>            
<a href="#3158" id="3158" class="l">3158: </a>            <span class="php-var">$password_forums</span>[<span class="php-var">$forum</span>[<span class="php-quote">'fid'</span>]] = <span class="php-var">$forum</span>[<span class="php-quote">'password'</span>];
<a href="#3159" id="3159" class="l">3159: </a>        }
<a href="#3160" id="3160" class="l">3160: </a>        <span class="php-keyword1">else</span>
<a href="#3161" id="3161" class="l">3161: </a>        {
<a href="#3162" id="3162" class="l">3162: </a>            <span class="php-comment">// Check parents for passwords</span>
<a href="#3163" id="3163" class="l">3163: </a>            <span class="php-var">$parents</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">&quot;,&quot;</span>, <span class="php-var">$forum</span>[<span class="php-quote">'parentlist'</span>]);
<a href="#3164" id="3164" class="l">3164: </a>            <span class="php-keyword1">foreach</span>(<span class="php-var">$parents</span> <span class="php-keyword1">as</span> <span class="php-var">$parent</span>)
<a href="#3165" id="3165" class="l">3165: </a>            {
<a href="#3166" id="3166" class="l">3166: </a>                <span class="php-keyword1">if</span>(<span class="php-keyword1">isset</span>(<span class="php-var">$password_forums</span>[<span class="php-var">$parent</span>]) &amp;&amp; <span class="php-var">$mybb</span>-&gt;cookies[<span class="php-quote">'forumpass'</span>][<span class="php-var">$parent</span>] != <span class="php-keyword2">md5</span>(<span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'uid'</span>].<span class="php-var">$password_forums</span>[<span class="php-var">$parent</span>]))
<a href="#3167" id="3167" class="l">3167: </a>                {
<a href="#3168" id="3168" class="l">3168: </a>                    <span class="php-var">$pwverified</span> = <span class="php-num">0</span>;
<a href="#3169" id="3169" class="l">3169: </a>                }
<a href="#3170" id="3170" class="l">3170: </a>            }
<a href="#3171" id="3171" class="l">3171: </a>        }
<a href="#3172" id="3172" class="l">3172: </a>
<a href="#3173" id="3173" class="l">3173: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$perms</span>[<span class="php-quote">'canview'</span>] == <span class="php-num">0</span> || <span class="php-var">$pwverified</span> == <span class="php-num">0</span> || (<span class="php-var">$only_readable_threads</span> == <span class="php-keyword1">true</span> &amp;&amp; <span class="php-var">$perms</span>[<span class="php-quote">'canviewthreads'</span>] == <span class="php-num">0</span>))
<a href="#3174" id="3174" class="l">3174: </a>        {
<a href="#3175" id="3175" class="l">3175: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$unviewableforums</span>)
<a href="#3176" id="3176" class="l">3176: </a>            {
<a href="#3177" id="3177" class="l">3177: </a>                <span class="php-var">$unviewableforums</span> .= <span class="php-quote">&quot;,&quot;</span>;
<a href="#3178" id="3178" class="l">3178: </a>            }
<a href="#3179" id="3179" class="l">3179: </a>
<a href="#3180" id="3180" class="l">3180: </a>            <span class="php-var">$unviewableforums</span> .= <span class="php-quote">&quot;'&quot;</span>.<span class="php-var">$forum</span>[<span class="php-quote">'fid'</span>].<span class="php-quote">&quot;'&quot;</span>;
<a href="#3181" id="3181" class="l">3181: </a>        }
<a href="#3182" id="3182" class="l">3182: </a>    }
<a href="#3183" id="3183" class="l">3183: </a>
<a href="#3184" id="3184" class="l">3184: </a>    <span class="php-keyword1">return</span> <span class="php-var">$unviewableforums</span>;
<a href="#3185" id="3185" class="l">3185: </a>}
<a href="#3186" id="3186" class="l">3186: </a>
<a href="#3187" id="3187" class="l">3187: </a><span class="php-comment">/**
</span><a href="#3188" id="3188" class="l">3188: </a><span class="php-comment"> * Fixes mktime for dates earlier than 1970
</span><a href="#3189" id="3189" class="l">3189: </a><span class="php-comment"> *
</span><a href="#3190" id="3190" class="l">3190: </a><span class="php-comment"> * @param string The date format to use
</span><a href="#3191" id="3191" class="l">3191: </a><span class="php-comment"> * @param int The year of the date
</span><a href="#3192" id="3192" class="l">3192: </a><span class="php-comment"> * @return string The correct date format
</span><a href="#3193" id="3193" class="l">3193: </a><span class="php-comment"> */</span>
<a href="#3194" id="3194" class="l">3194: </a><span class="php-keyword1">function</span> fix_mktime(<span class="php-var">$format</span>, <span class="php-var">$year</span>)
<a href="#3195" id="3195" class="l">3195: </a>{
<a href="#3196" id="3196" class="l">3196: </a>    <span class="php-comment">// Our little work around for the date &lt; 1970 thing.</span>
<a href="#3197" id="3197" class="l">3197: </a>    <span class="php-comment">// -2 idea provided by Matt Light (http://www.mephex.com)</span>
<a href="#3198" id="3198" class="l">3198: </a>    <span class="php-var">$format</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;Y&quot;</span>, <span class="php-var">$year</span>, <span class="php-var">$format</span>);
<a href="#3199" id="3199" class="l">3199: </a>    <span class="php-var">$format</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;y&quot;</span>, my_substr(<span class="php-var">$year</span>, -<span class="php-num">2</span>), <span class="php-var">$format</span>);
<a href="#3200" id="3200" class="l">3200: </a>
<a href="#3201" id="3201" class="l">3201: </a>    <span class="php-keyword1">return</span> <span class="php-var">$format</span>;
<a href="#3202" id="3202" class="l">3202: </a>}
<a href="#3203" id="3203" class="l">3203: </a>
<a href="#3204" id="3204" class="l">3204: </a><span class="php-comment">/**
</span><a href="#3205" id="3205" class="l">3205: </a><span class="php-comment"> * Build the breadcrumb navigation trail from the specified items
</span><a href="#3206" id="3206" class="l">3206: </a><span class="php-comment"> *
</span><a href="#3207" id="3207" class="l">3207: </a><span class="php-comment"> * @return The formatted breadcrumb navigation trail
</span><a href="#3208" id="3208" class="l">3208: </a><span class="php-comment"> */</span>
<a href="#3209" id="3209" class="l">3209: </a><span class="php-keyword1">function</span> build_breadcrumb()
<a href="#3210" id="3210" class="l">3210: </a>{
<a href="#3211" id="3211" class="l">3211: </a>    <span class="php-keyword1">global</span> <span class="php-var">$nav</span>, <span class="php-var">$navbits</span>, <span class="php-var">$templates</span>, <span class="php-var">$theme</span>, <span class="php-var">$lang</span>, <span class="php-var">$mybb</span>;
<a href="#3212" id="3212" class="l">3212: </a>
<a href="#3213" id="3213" class="l">3213: </a>    <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$navsep</span><span class="php-quote"> = \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;nav_sep&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#3214" id="3214" class="l">3214: </a>    
<a href="#3215" id="3215" class="l">3215: </a>    <span class="php-var">$i</span> = <span class="php-num">0</span>;
<a href="#3216" id="3216" class="l">3216: </a>    
<a href="#3217" id="3217" class="l">3217: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$navbits</span>))
<a href="#3218" id="3218" class="l">3218: </a>    {
<a href="#3219" id="3219" class="l">3219: </a>        <span class="php-keyword2">reset</span>(<span class="php-var">$navbits</span>);
<a href="#3220" id="3220" class="l">3220: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$navbits</span> <span class="php-keyword1">as</span> <span class="php-var">$key</span> =&gt; <span class="php-var">$navbit</span>)
<a href="#3221" id="3221" class="l">3221: </a>        {
<a href="#3222" id="3222" class="l">3222: </a>            <span class="php-keyword1">if</span>(<span class="php-keyword1">isset</span>(<span class="php-var">$navbits</span>[<span class="php-var">$key</span>+<span class="php-num">1</span>]))
<a href="#3223" id="3223" class="l">3223: </a>            {
<a href="#3224" id="3224" class="l">3224: </a>                <span class="php-keyword1">if</span>(<span class="php-keyword1">isset</span>(<span class="php-var">$navbits</span>[<span class="php-var">$key</span>+<span class="php-num">2</span>]))
<a href="#3225" id="3225" class="l">3225: </a>                {
<a href="#3226" id="3226" class="l">3226: </a>                    <span class="php-var">$sep</span> = <span class="php-var">$navsep</span>;
<a href="#3227" id="3227" class="l">3227: </a>                }
<a href="#3228" id="3228" class="l">3228: </a>                <span class="php-keyword1">else</span>
<a href="#3229" id="3229" class="l">3229: </a>                {
<a href="#3230" id="3230" class="l">3230: </a>                    <span class="php-var">$sep</span> = <span class="php-quote">&quot;&quot;</span>;
<a href="#3231" id="3231" class="l">3231: </a>                }
<a href="#3232" id="3232" class="l">3232: </a>                
<a href="#3233" id="3233" class="l">3233: </a>                <span class="php-var">$multipage</span> = <span class="php-keyword1">null</span>;
<a href="#3234" id="3234" class="l">3234: </a>                <span class="php-var">$multipage_dropdown</span> = <span class="php-keyword1">null</span>;
<a href="#3235" id="3235" class="l">3235: </a>                <span class="php-keyword1">if</span>(!<span class="php-keyword1">empty</span>(<span class="php-var">$navbit</span>[<span class="php-quote">'multipage'</span>]))
<a href="#3236" id="3236" class="l">3236: </a>                {
<a href="#3237" id="3237" class="l">3237: </a>                    <span class="php-var">$multipage</span> = multipage(<span class="php-var">$navbit</span>[<span class="php-quote">'multipage'</span>][<span class="php-quote">'num_threads'</span>], <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'threadsperpage'</span>], <span class="php-var">$navbit</span>[<span class="php-quote">'multipage'</span>][<span class="php-quote">'current_page'</span>], <span class="php-var">$navbit</span>[<span class="php-quote">'multipage'</span>][<span class="php-quote">'url'</span>], <span class="php-keyword1">true</span>);
<a href="#3238" id="3238" class="l">3238: </a>                    <span class="php-keyword1">if</span>(<span class="php-var">$multipage</span>)
<a href="#3239" id="3239" class="l">3239: </a>                    {
<a href="#3240" id="3240" class="l">3240: </a>                        ++<span class="php-var">$i</span>;
<a href="#3241" id="3241" class="l">3241: </a>                        <span class="php-var">$multipage_dropdown</span> = <span class="php-quote">&quot; &lt;img src=\&quot;</span><span class="php-var">{$theme['imgdir']}</span><span class="php-quote">/arrow_down.gif\&quot; alt=\&quot;v\&quot; title=\&quot;\&quot; class=\&quot;pagination_breadcrumb_link\&quot; id=\&quot;breadcrumb_multipage\&quot; /&gt;</span><span class="php-var">{$multipage}</span><span class="php-quote">&quot;</span>;
<a href="#3242" id="3242" class="l">3242: </a>                        <span class="php-var">$sep</span> = <span class="php-var">$multipage_dropdown</span>.<span class="php-var">$sep</span>;
<a href="#3243" id="3243" class="l">3243: </a>                    }
<a href="#3244" id="3244" class="l">3244: </a>                }
<a href="#3245" id="3245" class="l">3245: </a>
<a href="#3246" id="3246" class="l">3246: </a>                <span class="php-comment">// Replace page 1 URLs</span>
<a href="#3247" id="3247" class="l">3247: </a>                <span class="php-var">$navbit</span>[<span class="php-quote">'url'</span>] = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;-page-1.html&quot;</span>, <span class="php-quote">&quot;.html&quot;</span>, <span class="php-var">$navbit</span>[<span class="php-quote">'url'</span>]);
<a href="#3248" id="3248" class="l">3248: </a>                <span class="php-var">$navbit</span>[<span class="php-quote">'url'</span>] = <span class="php-keyword2">preg_replace</span>(<span class="php-quote">&quot;/&amp;amp;page=1</span><span class="php-var">$</span><span class="php-quote">/&quot;</span>, <span class="php-quote">&quot;&quot;</span>, <span class="php-var">$navbit</span>[<span class="php-quote">'url'</span>]);
<a href="#3249" id="3249" class="l">3249: </a>
<a href="#3250" id="3250" class="l">3250: </a>                <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$nav</span><span class="php-quote"> .= \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;nav_bit&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#3251" id="3251" class="l">3251: </a>            }
<a href="#3252" id="3252" class="l">3252: </a>        }
<a href="#3253" id="3253" class="l">3253: </a>    }
<a href="#3254" id="3254" class="l">3254: </a>
<a href="#3255" id="3255" class="l">3255: </a>    <span class="php-var">$navsize</span> = <span class="php-keyword2">count</span>(<span class="php-var">$navbits</span>);
<a href="#3256" id="3256" class="l">3256: </a>    <span class="php-var">$navbit</span> = <span class="php-var">$navbits</span>[<span class="php-var">$navsize</span>-<span class="php-num">1</span>];
<a href="#3257" id="3257" class="l">3257: </a>
<a href="#3258" id="3258" class="l">3258: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$nav</span>)
<a href="#3259" id="3259" class="l">3259: </a>    {
<a href="#3260" id="3260" class="l">3260: </a>        <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$activesep</span><span class="php-quote"> = \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;nav_sep_active&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#3261" id="3261" class="l">3261: </a>    }
<a href="#3262" id="3262" class="l">3262: </a>
<a href="#3263" id="3263" class="l">3263: </a>    <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$activebit</span><span class="php-quote"> = \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;nav_bit_active&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#3264" id="3264" class="l">3264: </a>    <span class="php-keyword2">eval</span>(<span class="php-quote">&quot;\</span><span class="php-var">$donenav</span><span class="php-quote"> = \&quot;&quot;</span>.<span class="php-var">$templates</span>-&gt;get(<span class="php-quote">&quot;nav&quot;</span>).<span class="php-quote">&quot;\&quot;;&quot;</span>);
<a href="#3265" id="3265" class="l">3265: </a>
<a href="#3266" id="3266" class="l">3266: </a>    <span class="php-keyword1">return</span> <span class="php-var">$donenav</span>;
<a href="#3267" id="3267" class="l">3267: </a>}
<a href="#3268" id="3268" class="l">3268: </a>
<a href="#3269" id="3269" class="l">3269: </a><span class="php-comment">/**
</span><a href="#3270" id="3270" class="l">3270: </a><span class="php-comment"> * Add a breadcrumb menu item to the list.
</span><a href="#3271" id="3271" class="l">3271: </a><span class="php-comment"> *
</span><a href="#3272" id="3272" class="l">3272: </a><span class="php-comment"> * @param string The name of the item to add
</span><a href="#3273" id="3273" class="l">3273: </a><span class="php-comment"> * @param string The URL of the item to add
</span><a href="#3274" id="3274" class="l">3274: </a><span class="php-comment"> */</span>
<a href="#3275" id="3275" class="l">3275: </a><span class="php-keyword1">function</span> add_breadcrumb(<span class="php-var">$name</span>, <span class="php-var">$url</span>=<span class="php-quote">&quot;&quot;</span>)
<a href="#3276" id="3276" class="l">3276: </a>{
<a href="#3277" id="3277" class="l">3277: </a>    <span class="php-keyword1">global</span> <span class="php-var">$navbits</span>;
<a href="#3278" id="3278" class="l">3278: </a>
<a href="#3279" id="3279" class="l">3279: </a>    <span class="php-var">$navsize</span> = <span class="php-keyword2">count</span>(<span class="php-var">$navbits</span>);
<a href="#3280" id="3280" class="l">3280: </a>    <span class="php-var">$navbits</span>[<span class="php-var">$navsize</span>][<span class="php-quote">'name'</span>] = <span class="php-var">$name</span>;
<a href="#3281" id="3281" class="l">3281: </a>    <span class="php-var">$navbits</span>[<span class="php-var">$navsize</span>][<span class="php-quote">'url'</span>] = <span class="php-var">$url</span>;
<a href="#3282" id="3282" class="l">3282: </a>}
<a href="#3283" id="3283" class="l">3283: </a>
<a href="#3284" id="3284" class="l">3284: </a><span class="php-comment">/**
</span><a href="#3285" id="3285" class="l">3285: </a><span class="php-comment"> * Build the forum breadcrumb nagiation (the navigation to a specific forum including all parent forums)
</span><a href="#3286" id="3286" class="l">3286: </a><span class="php-comment"> *
</span><a href="#3287" id="3287" class="l">3287: </a><span class="php-comment"> * @param int The forum ID to build the navigation for
</span><a href="#3288" id="3288" class="l">3288: </a><span class="php-comment"> * @param array The multipage drop down array of information
</span><a href="#3289" id="3289" class="l">3289: </a><span class="php-comment"> */</span>
<a href="#3290" id="3290" class="l">3290: </a><span class="php-keyword1">function</span> build_forum_breadcrumb(<span class="php-var">$fid</span>, <span class="php-var">$multipage</span>=<span class="php-keyword1">array</span>())
<a href="#3291" id="3291" class="l">3291: </a>{
<a href="#3292" id="3292" class="l">3292: </a>    <span class="php-keyword1">global</span> <span class="php-var">$pforumcache</span>, <span class="php-var">$currentitem</span>, <span class="php-var">$forum_cache</span>, <span class="php-var">$navbits</span>, <span class="php-var">$lang</span>, <span class="php-var">$base_url</span>, <span class="php-var">$archiveurl</span>;
<a href="#3293" id="3293" class="l">3293: </a>
<a href="#3294" id="3294" class="l">3294: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$pforumcache</span>)
<a href="#3295" id="3295" class="l">3295: </a>    {
<a href="#3296" id="3296" class="l">3296: </a>        <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$forum_cache</span>))
<a href="#3297" id="3297" class="l">3297: </a>        {
<a href="#3298" id="3298" class="l">3298: </a>            cache_forums();
<a href="#3299" id="3299" class="l">3299: </a>        }
<a href="#3300" id="3300" class="l">3300: </a>
<a href="#3301" id="3301" class="l">3301: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$forum_cache</span> <span class="php-keyword1">as</span> <span class="php-var">$key</span> =&gt; <span class="php-var">$val</span>)
<a href="#3302" id="3302" class="l">3302: </a>        {
<a href="#3303" id="3303" class="l">3303: </a>            <span class="php-var">$pforumcache</span>[<span class="php-var">$val</span>[<span class="php-quote">'fid'</span>]][<span class="php-var">$val</span>[<span class="php-quote">'pid'</span>]] = <span class="php-var">$val</span>;
<a href="#3304" id="3304" class="l">3304: </a>        }
<a href="#3305" id="3305" class="l">3305: </a>    }
<a href="#3306" id="3306" class="l">3306: </a>
<a href="#3307" id="3307" class="l">3307: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$pforumcache</span>[<span class="php-var">$fid</span>]))
<a href="#3308" id="3308" class="l">3308: </a>    {
<a href="#3309" id="3309" class="l">3309: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$pforumcache</span>[<span class="php-var">$fid</span>] <span class="php-keyword1">as</span> <span class="php-var">$key</span> =&gt; <span class="php-var">$forumnav</span>)
<a href="#3310" id="3310" class="l">3310: </a>        {
<a href="#3311" id="3311" class="l">3311: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$fid</span> == <span class="php-var">$forumnav</span>[<span class="php-quote">'fid'</span>])
<a href="#3312" id="3312" class="l">3312: </a>            {
<a href="#3313" id="3313" class="l">3313: </a>                <span class="php-keyword1">if</span>(<span class="php-var">$pforumcache</span>[<span class="php-var">$forumnav</span>[<span class="php-quote">'pid'</span>]])
<a href="#3314" id="3314" class="l">3314: </a>                {
<a href="#3315" id="3315" class="l">3315: </a>                    build_forum_breadcrumb(<span class="php-var">$forumnav</span>[<span class="php-quote">'pid'</span>]);
<a href="#3316" id="3316" class="l">3316: </a>                }
<a href="#3317" id="3317" class="l">3317: </a>
<a href="#3318" id="3318" class="l">3318: </a>                <span class="php-var">$navsize</span> = <span class="php-keyword2">count</span>(<span class="php-var">$navbits</span>);
<a href="#3319" id="3319" class="l">3319: </a>                <span class="php-comment">// Convert &amp; to &amp;amp;</span>
<a href="#3320" id="3320" class="l">3320: </a>                <span class="php-var">$navbits</span>[<span class="php-var">$navsize</span>][<span class="php-quote">'name'</span>] = <span class="php-keyword2">preg_replace</span>(<span class="php-quote">&quot;#&amp;(?!\#[0-9]+;)#si&quot;</span>, <span class="php-quote">&quot;&amp;amp;&quot;</span>, <span class="php-var">$forumnav</span>[<span class="php-quote">'name'</span>]);
<a href="#3321" id="3321" class="l">3321: </a>
<a href="#3322" id="3322" class="l">3322: </a>                <span class="php-keyword1">if</span>(IN_ARCHIVE == <span class="php-num">1</span>)
<a href="#3323" id="3323" class="l">3323: </a>                {
<a href="#3324" id="3324" class="l">3324: </a>                    <span class="php-comment">// Set up link to forum in breadcrumb.</span>
<a href="#3325" id="3325" class="l">3325: </a>                    <span class="php-keyword1">if</span>(<span class="php-var">$pforumcache</span>[<span class="php-var">$fid</span>][<span class="php-var">$forumnav</span>[<span class="php-quote">'pid'</span>]][<span class="php-quote">'type'</span>] == <span class="php-quote">'f'</span> || <span class="php-var">$pforumcache</span>[<span class="php-var">$fid</span>][<span class="php-var">$forumnav</span>[<span class="php-quote">'pid'</span>]][<span class="php-quote">'type'</span>] == <span class="php-quote">'c'</span>)
<a href="#3326" id="3326" class="l">3326: </a>                    {
<a href="#3327" id="3327" class="l">3327: </a>                        <span class="php-var">$navbits</span>[<span class="php-var">$navsize</span>][<span class="php-quote">'url'</span>] = <span class="php-quote">&quot;</span><span class="php-var">{$base_url}</span><span class="php-quote">forum-&quot;</span>.<span class="php-var">$forumnav</span>[<span class="php-quote">'fid'</span>].<span class="php-quote">&quot;.html&quot;</span>;
<a href="#3328" id="3328" class="l">3328: </a>                    }
<a href="#3329" id="3329" class="l">3329: </a>                    <span class="php-keyword1">else</span>
<a href="#3330" id="3330" class="l">3330: </a>                    {
<a href="#3331" id="3331" class="l">3331: </a>                        <span class="php-var">$navbits</span>[<span class="php-var">$navsize</span>][<span class="php-quote">'url'</span>] = <span class="php-var">$archiveurl</span>.<span class="php-quote">&quot;/index.php&quot;</span>;
<a href="#3332" id="3332" class="l">3332: </a>                    }
<a href="#3333" id="3333" class="l">3333: </a>                }
<a href="#3334" id="3334" class="l">3334: </a>                <span class="php-keyword1">elseif</span>(!<span class="php-keyword1">empty</span>(<span class="php-var">$multipage</span>))
<a href="#3335" id="3335" class="l">3335: </a>                {
<a href="#3336" id="3336" class="l">3336: </a>                    <span class="php-var">$navbits</span>[<span class="php-var">$navsize</span>][<span class="php-quote">'url'</span>] = get_forum_link(<span class="php-var">$forumnav</span>[<span class="php-quote">'fid'</span>], <span class="php-var">$multipage</span>[<span class="php-quote">'current_page'</span>]);
<a href="#3337" id="3337" class="l">3337: </a>                    
<a href="#3338" id="3338" class="l">3338: </a>                    <span class="php-var">$navbits</span>[<span class="php-var">$navsize</span>][<span class="php-quote">'multipage'</span>] = <span class="php-var">$multipage</span>;
<a href="#3339" id="3339" class="l">3339: </a>                    <span class="php-var">$navbits</span>[<span class="php-var">$navsize</span>][<span class="php-quote">'multipage'</span>][<span class="php-quote">'url'</span>] = <span class="php-keyword2">str_replace</span>(<span class="php-quote">'{fid}'</span>, <span class="php-var">$forumnav</span>[<span class="php-quote">'fid'</span>], FORUM_URL_PAGED);
<a href="#3340" id="3340" class="l">3340: </a>                }
<a href="#3341" id="3341" class="l">3341: </a>                <span class="php-keyword1">else</span>
<a href="#3342" id="3342" class="l">3342: </a>                {
<a href="#3343" id="3343" class="l">3343: </a>                    <span class="php-var">$navbits</span>[<span class="php-var">$navsize</span>][<span class="php-quote">'url'</span>] = get_forum_link(<span class="php-var">$forumnav</span>[<span class="php-quote">'fid'</span>]);
<a href="#3344" id="3344" class="l">3344: </a>                }
<a href="#3345" id="3345" class="l">3345: </a>            }
<a href="#3346" id="3346" class="l">3346: </a>        }
<a href="#3347" id="3347" class="l">3347: </a>    }
<a href="#3348" id="3348" class="l">3348: </a>
<a href="#3349" id="3349" class="l">3349: </a>    <span class="php-keyword1">return</span> <span class="php-num">1</span>;
<a href="#3350" id="3350" class="l">3350: </a>}
<a href="#3351" id="3351" class="l">3351: </a>
<a href="#3352" id="3352" class="l">3352: </a><span class="php-comment">/**
</span><a href="#3353" id="3353" class="l">3353: </a><span class="php-comment"> * Resets the breadcrumb navigation to the first item, and clears the rest
</span><a href="#3354" id="3354" class="l">3354: </a><span class="php-comment"> */</span>
<a href="#3355" id="3355" class="l">3355: </a><span class="php-keyword1">function</span> reset_breadcrumb()
<a href="#3356" id="3356" class="l">3356: </a>{
<a href="#3357" id="3357" class="l">3357: </a>    <span class="php-keyword1">global</span> <span class="php-var">$navbits</span>;
<a href="#3358" id="3358" class="l">3358: </a>
<a href="#3359" id="3359" class="l">3359: </a>    <span class="php-var">$newnav</span>[<span class="php-num">0</span>][<span class="php-quote">'name'</span>] = <span class="php-var">$navbits</span>[<span class="php-num">0</span>][<span class="php-quote">'name'</span>];
<a href="#3360" id="3360" class="l">3360: </a>    <span class="php-var">$newnav</span>[<span class="php-num">0</span>][<span class="php-quote">'url'</span>] = <span class="php-var">$navbits</span>[<span class="php-num">0</span>][<span class="php-quote">'url'</span>];
<a href="#3361" id="3361" class="l">3361: </a>    <span class="php-var">$newnav</span>[<span class="php-num">0</span>][<span class="php-quote">'options'</span>] = <span class="php-var">$navbits</span>[<span class="php-num">0</span>][<span class="php-quote">'options'</span>];
<a href="#3362" id="3362" class="l">3362: </a>
<a href="#3363" id="3363" class="l">3363: </a>    <span class="php-keyword1">unset</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'navbits'</span>]);
<a href="#3364" id="3364" class="l">3364: </a>    <span class="php-var">$GLOBALS</span>[<span class="php-quote">'navbits'</span>] = <span class="php-var">$newnav</span>;
<a href="#3365" id="3365" class="l">3365: </a>}
<a href="#3366" id="3366" class="l">3366: </a>
<a href="#3367" id="3367" class="l">3367: </a><span class="php-comment">/**
</span><a href="#3368" id="3368" class="l">3368: </a><span class="php-comment"> * Builds a URL to an archive mode page
</span><a href="#3369" id="3369" class="l">3369: </a><span class="php-comment"> *
</span><a href="#3370" id="3370" class="l">3370: </a><span class="php-comment"> * @param string The type of page (thread|announcement|forum)
</span><a href="#3371" id="3371" class="l">3371: </a><span class="php-comment"> * @param int The ID of the item
</span><a href="#3372" id="3372" class="l">3372: </a><span class="php-comment"> * @return string The URL
</span><a href="#3373" id="3373" class="l">3373: </a><span class="php-comment"> */</span>
<a href="#3374" id="3374" class="l">3374: </a><span class="php-keyword1">function</span> build_archive_link(<span class="php-var">$type</span>, <span class="php-var">$id</span>=<span class="php-quote">&quot;&quot;</span>)
<a href="#3375" id="3375" class="l">3375: </a>{
<a href="#3376" id="3376" class="l">3376: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>;
<a href="#3377" id="3377" class="l">3377: </a>    
<a href="#3378" id="3378" class="l">3378: </a>    <span class="php-comment">// If the server OS is not Windows and not Apache or the PHP is running as a CGI or we have defined ARCHIVE_QUERY_STRINGS, use query strings - DIRECTORY_SEPARATOR checks if running windows</span>
<a href="#3379" id="3379" class="l">3379: </a>    <span class="php-keyword1">if</span>((DIRECTORY_SEPARATOR == <span class="php-quote">'\\'</span> &amp;&amp; <span class="php-keyword2">is_numeric</span>(<span class="php-keyword2">stripos</span>(<span class="php-var">$_SERVER</span>[<span class="php-quote">'SERVER_SOFTWARE'</span>], <span class="php-quote">&quot;apache&quot;</span>)) == <span class="php-keyword1">false</span>) || <span class="php-keyword2">is_numeric</span>(<span class="php-keyword2">stripos</span>(SAPI_NAME, <span class="php-quote">&quot;cgi&quot;</span>)) !== <span class="php-keyword1">false</span> || <span class="php-keyword2">defined</span>(<span class="php-quote">&quot;ARCHIVE_QUERY_STRINGS&quot;</span>))
<a href="#3380" id="3380" class="l">3380: </a>    {
<a href="#3381" id="3381" class="l">3381: </a>        <span class="php-var">$base_url</span> = <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'bburl'</span>].<span class="php-quote">&quot;/archive/index.php?&quot;</span>;
<a href="#3382" id="3382" class="l">3382: </a>    }
<a href="#3383" id="3383" class="l">3383: </a>    <span class="php-keyword1">else</span>
<a href="#3384" id="3384" class="l">3384: </a>    {
<a href="#3385" id="3385" class="l">3385: </a>        <span class="php-var">$base_url</span> = <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'bburl'</span>].<span class="php-quote">&quot;/archive/index.php/&quot;</span>;
<a href="#3386" id="3386" class="l">3386: </a>    }
<a href="#3387" id="3387" class="l">3387: </a>
<a href="#3388" id="3388" class="l">3388: </a>    <span class="php-keyword1">switch</span>(<span class="php-var">$type</span>)
<a href="#3389" id="3389" class="l">3389: </a>    {
<a href="#3390" id="3390" class="l">3390: </a>        <span class="php-keyword1">case</span> <span class="php-quote">&quot;thread&quot;</span>:
<a href="#3391" id="3391" class="l">3391: </a>            <span class="php-var">$url</span> = <span class="php-quote">&quot;</span><span class="php-var">{$base_url}</span><span class="php-quote">thread-</span><span class="php-var">{$id}</span><span class="php-quote">.html&quot;</span>;
<a href="#3392" id="3392" class="l">3392: </a>            <span class="php-keyword1">break</span>;
<a href="#3393" id="3393" class="l">3393: </a>        <span class="php-keyword1">case</span> <span class="php-quote">&quot;announcement&quot;</span>:
<a href="#3394" id="3394" class="l">3394: </a>            <span class="php-var">$url</span> = <span class="php-quote">&quot;</span><span class="php-var">{$base_url}</span><span class="php-quote">announcement-</span><span class="php-var">{$id}</span><span class="php-quote">.html&quot;</span>;
<a href="#3395" id="3395" class="l">3395: </a>            <span class="php-keyword1">break</span>;
<a href="#3396" id="3396" class="l">3396: </a>        <span class="php-keyword1">case</span> <span class="php-quote">&quot;forum&quot;</span>:
<a href="#3397" id="3397" class="l">3397: </a>            <span class="php-var">$url</span> = <span class="php-quote">&quot;</span><span class="php-var">{$base_url}</span><span class="php-quote">forum-</span><span class="php-var">{$id}</span><span class="php-quote">.html&quot;</span>;
<a href="#3398" id="3398" class="l">3398: </a>            <span class="php-keyword1">break</span>;
<a href="#3399" id="3399" class="l">3399: </a>        <span class="php-keyword1">default</span>:
<a href="#3400" id="3400" class="l">3400: </a>            <span class="php-var">$url</span> = <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'bburl'</span>].<span class="php-quote">&quot;/archive/index.php&quot;</span>;
<a href="#3401" id="3401" class="l">3401: </a>    }
<a href="#3402" id="3402" class="l">3402: </a>
<a href="#3403" id="3403" class="l">3403: </a>    <span class="php-keyword1">return</span> <span class="php-var">$url</span>;
<a href="#3404" id="3404" class="l">3404: </a>}
<a href="#3405" id="3405" class="l">3405: </a>
<a href="#3406" id="3406" class="l">3406: </a><span class="php-comment">/**
</span><a href="#3407" id="3407" class="l">3407: </a><span class="php-comment"> * Prints a debug information page
</span><a href="#3408" id="3408" class="l">3408: </a><span class="php-comment"> */</span>
<a href="#3409" id="3409" class="l">3409: </a><span class="php-keyword1">function</span> debug_page()
<a href="#3410" id="3410" class="l">3410: </a>{
<a href="#3411" id="3411" class="l">3411: </a>    <span class="php-keyword1">global</span> <span class="php-var">$db</span>, <span class="php-var">$debug</span>, <span class="php-var">$templates</span>, <span class="php-var">$templatelist</span>, <span class="php-var">$mybb</span>, <span class="php-var">$maintimer</span>, <span class="php-var">$globaltime</span>, <span class="php-var">$ptimer</span>, <span class="php-var">$parsetime</span>;
<a href="#3412" id="3412" class="l">3412: </a>
<a href="#3413" id="3413" class="l">3413: </a>    <span class="php-var">$totaltime</span> = <span class="php-var">$maintimer</span>-&gt;totaltime;
<a href="#3414" id="3414" class="l">3414: </a>    <span class="php-var">$phptime</span> = <span class="php-var">$maintimer</span>-&gt;format(<span class="php-var">$maintimer</span>-&gt;totaltime - <span class="php-var">$db</span>-&gt;query_time);
<a href="#3415" id="3415" class="l">3415: </a>    <span class="php-var">$query_time</span> = <span class="php-var">$maintimer</span>-&gt;format(<span class="php-var">$db</span>-&gt;query_time);
<a href="#3416" id="3416" class="l">3416: </a>
<a href="#3417" id="3417" class="l">3417: </a>    <span class="php-var">$percentphp</span> = <span class="php-keyword2">number_format</span>(((<span class="php-var">$phptime</span>/<span class="php-var">$maintimer</span>-&gt;totaltime)*<span class="php-num">100</span>), <span class="php-num">2</span>);
<a href="#3418" id="3418" class="l">3418: </a>    <span class="php-var">$percentsql</span> = <span class="php-keyword2">number_format</span>(((<span class="php-var">$query_time</span>/<span class="php-var">$maintimer</span>-&gt;totaltime)*<span class="php-num">100</span>), <span class="php-num">2</span>);
<a href="#3419" id="3419" class="l">3419: </a>
<a href="#3420" id="3420" class="l">3420: </a>    <span class="php-var">$phpversion</span> = PHP_VERSION;
<a href="#3421" id="3421" class="l">3421: </a>
<a href="#3422" id="3422" class="l">3422: </a>    <span class="php-var">$serverload</span> = get_server_load();
<a href="#3423" id="3423" class="l">3423: </a>
<a href="#3424" id="3424" class="l">3424: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'gzipoutput'</span>] != <span class="php-num">0</span>)
<a href="#3425" id="3425" class="l">3425: </a>    {
<a href="#3426" id="3426" class="l">3426: </a>        <span class="php-var">$gzipen</span> = <span class="php-quote">&quot;Enabled&quot;</span>;
<a href="#3427" id="3427" class="l">3427: </a>    }
<a href="#3428" id="3428" class="l">3428: </a>    <span class="php-keyword1">else</span>
<a href="#3429" id="3429" class="l">3429: </a>    {
<a href="#3430" id="3430" class="l">3430: </a>        <span class="php-var">$gzipen</span> = <span class="php-quote">&quot;Disabled&quot;</span>;
<a href="#3431" id="3431" class="l">3431: </a>    }
<a href="#3432" id="3432" class="l">3432: </a>
<a href="#3433" id="3433" class="l">3433: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;!DOCTYPE html PUBLIC \&quot;-//W3C//DTD XHTML 1.0 Transitional//EN\&quot; \&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\&quot;&gt;\n&quot;</span>;
<a href="#3434" id="3434" class="l">3434: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;html xmlns=\&quot;http://www.w3.org/1999/xhtml\&quot; xml:lang=\&quot;en\&quot; lang=\&quot;en\&quot;&gt;&quot;</span>;
<a href="#3435" id="3435" class="l">3435: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;head&gt;&quot;</span>;
<a href="#3436" id="3436" class="l">3436: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;title&gt;MyBB Debug Information&lt;/title&gt;&quot;</span>;
<a href="#3437" id="3437" class="l">3437: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;/head&gt;&quot;</span>;
<a href="#3438" id="3438" class="l">3438: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;body&gt;&quot;</span>;
<a href="#3439" id="3439" class="l">3439: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;h1&gt;MyBB Debug Information&lt;/h1&gt;\n&quot;</span>;
<a href="#3440" id="3440" class="l">3440: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;h2&gt;Page Generation&lt;/h2&gt;\n&quot;</span>;
<a href="#3441" id="3441" class="l">3441: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;table bgcolor=\&quot;#666666\&quot; width=\&quot;95%\&quot; cellpadding=\&quot;4\&quot; cellspacing=\&quot;1\&quot; align=\&quot;center\&quot;&gt;\n&quot;</span>;
<a href="#3442" id="3442" class="l">3442: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;tr&gt;\n&quot;</span>;
<a href="#3443" id="3443" class="l">3443: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td bgcolor=\&quot;#CCCCCC\&quot; colspan=\&quot;4\&quot;&gt;&lt;b&gt;&lt;span style=\&quot;size:2;\&quot;&gt;Page Generation Statistics&lt;/span&gt;&lt;/b&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3444" id="3444" class="l">3444: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;/tr&gt;\n&quot;</span>;
<a href="#3445" id="3445" class="l">3445: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;tr&gt;\n&quot;</span>;
<a href="#3446" id="3446" class="l">3446: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td bgcolor=\&quot;#EFEFEF\&quot; width=\&quot;25%\&quot;&gt;&lt;b&gt;&lt;font face=\&quot;Tahoma\&quot; size=\&quot;2\&quot;&gt;Page Generation Time:&lt;/font&gt;&lt;/b&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3447" id="3447" class="l">3447: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td bgcolor=\&quot;#FEFEFE\&quot; width=\&quot;25%\&quot;&gt;&lt;font face=\&quot;Tahoma\&quot; size=\&quot;2\&quot;&gt;</span><span class="php-var">$totaltime</span><span class="php-quote"> seconds&lt;/font&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3448" id="3448" class="l">3448: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td bgcolor=\&quot;#EFEFEF\&quot; width=\&quot;25%\&quot;&gt;&lt;b&gt;&lt;font face=\&quot;Tahoma\&quot; size=\&quot;2\&quot;&gt;No. DB Queries:&lt;/font&gt;&lt;/b&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3449" id="3449" class="l">3449: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td bgcolor=\&quot;#FEFEFE\&quot; width=\&quot;25%\&quot;&gt;&lt;font face=\&quot;Tahoma\&quot; size=\&quot;2\&quot;&gt;</span><span class="php-var">$db</span><span class="php-quote">-&gt;query_count&lt;/font&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3450" id="3450" class="l">3450: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;/tr&gt;\n&quot;</span>;
<a href="#3451" id="3451" class="l">3451: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;tr&gt;\n&quot;</span>;
<a href="#3452" id="3452" class="l">3452: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td bgcolor=\&quot;#EFEFEF\&quot; width=\&quot;25%\&quot;&gt;&lt;b&gt;&lt;font face=\&quot;Tahoma\&quot; size=\&quot;2\&quot;&gt;PHP Processing Time:&lt;/font&gt;&lt;/b&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3453" id="3453" class="l">3453: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td bgcolor=\&quot;#FEFEFE\&quot; width=\&quot;25%\&quot;&gt;&lt;font face=\&quot;Tahoma\&quot; size=\&quot;2\&quot;&gt;</span><span class="php-var">$phptime</span><span class="php-quote"> seconds (</span><span class="php-var">$percentphp</span><span class="php-quote">%)&lt;/font&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3454" id="3454" class="l">3454: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td bgcolor=\&quot;#EFEFEF\&quot; width=\&quot;25%\&quot;&gt;&lt;b&gt;&lt;font face=\&quot;Tahoma\&quot; size=\&quot;2\&quot;&gt;DB Processing Time:&lt;/font&gt;&lt;/b&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3455" id="3455" class="l">3455: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td bgcolor=\&quot;#FEFEFE\&quot; width=\&quot;25%\&quot;&gt;&lt;font face=\&quot;Tahoma\&quot; size=\&quot;2\&quot;&gt;</span><span class="php-var">$query_time</span><span class="php-quote"> seconds (</span><span class="php-var">$percentsql</span><span class="php-quote">%)&lt;/font&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3456" id="3456" class="l">3456: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;/tr&gt;\n&quot;</span>;
<a href="#3457" id="3457" class="l">3457: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;tr&gt;\n&quot;</span>;
<a href="#3458" id="3458" class="l">3458: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td bgcolor=\&quot;#EFEFEF\&quot; width=\&quot;25%\&quot;&gt;&lt;b&gt;&lt;font face=\&quot;Tahoma\&quot; size=\&quot;2\&quot;&gt;Extensions Used:&lt;/font&gt;&lt;/b&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3459" id="3459" class="l">3459: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td bgcolor=\&quot;#FEFEFE\&quot; width=\&quot;25%\&quot;&gt;&lt;font face=\&quot;Tahoma\&quot; size=\&quot;2\&quot;&gt;</span><span class="php-var">{$mybb-&gt;config['database']['type']}</span><span class="php-quote">, xml&lt;/font&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3460" id="3460" class="l">3460: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td bgcolor=\&quot;#EFEFEF\&quot; width=\&quot;25%\&quot;&gt;&lt;b&gt;&lt;font face=\&quot;Tahoma\&quot; size=\&quot;2\&quot;&gt;Global.php Processing Time:&lt;/font&gt;&lt;/b&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3461" id="3461" class="l">3461: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td bgcolor=\&quot;#FEFEFE\&quot; width=\&quot;25%\&quot;&gt;&lt;font face=\&quot;Tahoma\&quot; size=\&quot;2\&quot;&gt;</span><span class="php-var">$globaltime</span><span class="php-quote"> seconds&lt;/font&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3462" id="3462" class="l">3462: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;/tr&gt;\n&quot;</span>;
<a href="#3463" id="3463" class="l">3463: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;tr&gt;\n&quot;</span>;
<a href="#3464" id="3464" class="l">3464: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td bgcolor=\&quot;#EFEFEF\&quot; width=\&quot;25%\&quot;&gt;&lt;b&gt;&lt;font face=\&quot;Tahoma\&quot; size=\&quot;2\&quot;&gt;PHP Version:&lt;/font&gt;&lt;/b&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3465" id="3465" class="l">3465: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td bgcolor=\&quot;#FEFEFE\&quot; width=\&quot;25%\&quot;&gt;&lt;font face=\&quot;Tahoma\&quot; size=\&quot;2\&quot;&gt;</span><span class="php-var">$phpversion</span><span class="php-quote">&lt;/font&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3466" id="3466" class="l">3466: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td bgcolor=\&quot;#EFEFEF\&quot; width=\&quot;25%\&quot;&gt;&lt;b&gt;&lt;font face=\&quot;Tahoma\&quot; size=\&quot;2\&quot;&gt;Server Load:&lt;/font&gt;&lt;/b&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3467" id="3467" class="l">3467: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td bgcolor=\&quot;#FEFEFE\&quot; width=\&quot;25%\&quot;&gt;&lt;font face=\&quot;Tahoma\&quot; size=\&quot;2\&quot;&gt;</span><span class="php-var">$serverload</span><span class="php-quote">&lt;/font&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3468" id="3468" class="l">3468: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;/tr&gt;\n&quot;</span>;
<a href="#3469" id="3469" class="l">3469: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;tr&gt;\n&quot;</span>;
<a href="#3470" id="3470" class="l">3470: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td bgcolor=\&quot;#EFEFEF\&quot; width=\&quot;25%\&quot;&gt;&lt;b&gt;&lt;font face=\&quot;Tahoma\&quot; size=\&quot;2\&quot;&gt;GZip Encoding Status:&lt;/font&gt;&lt;/b&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3471" id="3471" class="l">3471: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td bgcolor=\&quot;#FEFEFE\&quot; width=\&quot;25%\&quot;&gt;&lt;font face=\&quot;Tahoma\&quot; size=\&quot;2\&quot;&gt;</span><span class="php-var">$gzipen</span><span class="php-quote">&lt;/font&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3472" id="3472" class="l">3472: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td bgcolor=\&quot;#EFEFEF\&quot; width=\&quot;25%\&quot;&gt;&lt;b&gt;&lt;font face=\&quot;Tahoma\&quot; size=\&quot;2\&quot;&gt;No. Templates Used:&lt;/font&gt;&lt;/b&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3473" id="3473" class="l">3473: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td bgcolor=\&quot;#FEFEFE\&quot; width=\&quot;25%\&quot;&gt;&lt;font face=\&quot;Tahoma\&quot; size=\&quot;2\&quot;&gt;&quot;</span>.<span class="php-keyword2">count</span>(<span class="php-var">$templates</span>-&gt;cache).<span class="php-quote">&quot; (&quot;</span>.<span class="php-keyword2">intval</span>(<span class="php-keyword2">count</span>(<span class="php-keyword2">explode</span>(<span class="php-quote">&quot;,&quot;</span>, <span class="php-var">$templatelist</span>))).<span class="php-quote">&quot; Cached / &quot;</span>.<span class="php-keyword2">intval</span>(<span class="php-keyword2">count</span>(<span class="php-var">$templates</span>-&gt;uncached_templates)).<span class="php-quote">&quot; Manually Loaded)&lt;/font&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3474" id="3474" class="l">3474: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;/tr&gt;\n&quot;</span>;
<a href="#3475" id="3475" class="l">3475: </a>
<a href="#3476" id="3476" class="l">3476: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">function_exists</span>(<span class="php-quote">&quot;memory_get_usage&quot;</span>))
<a href="#3477" id="3477" class="l">3477: </a>    {
<a href="#3478" id="3478" class="l">3478: </a>        <span class="php-var">$memory_usage</span> = <span class="php-keyword2">memory_get_peak_usage</span>(<span class="php-keyword1">true</span>);
<a href="#3479" id="3479" class="l">3479: </a>        <span class="php-var">$memory_limit</span> = @<span class="php-keyword2">ini_get</span>(<span class="php-quote">&quot;memory_limit&quot;</span>);
<a href="#3480" id="3480" class="l">3480: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;tr&gt;\n&quot;</span>;
<a href="#3481" id="3481" class="l">3481: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td bgcolor=\&quot;#EFEFEF\&quot; width=\&quot;25%\&quot;&gt;&lt;b&gt;&lt;font face=\&quot;Tahoma\&quot; size=\&quot;2\&quot;&gt;Memory Usage:&lt;/font&gt;&lt;/b&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3482" id="3482" class="l">3482: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td bgcolor=\&quot;#FEFEFE\&quot; width=\&quot;25%\&quot;&gt;&lt;font face=\&quot;Tahoma\&quot; size=\&quot;2\&quot;&gt;&quot;</span>.get_friendly_size(<span class="php-var">$memory_usage</span>).<span class="php-quote">&quot; (</span><span class="php-var">{$memory_usage}</span><span class="php-quote"> bytes)&lt;/font&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3483" id="3483" class="l">3483: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td bgcolor=\&quot;#EFEFEF\&quot; width=\&quot;25%\&quot;&gt;&lt;b&gt;&lt;font face=\&quot;Tahoma\&quot; size=\&quot;2\&quot;&gt;Memory Limit:&lt;/font&gt;&lt;/b&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3484" id="3484" class="l">3484: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td bgcolor=\&quot;#FEFEFE\&quot; width=\&quot;25%\&quot;&gt;&lt;font face=\&quot;Tahoma\&quot; size=\&quot;2\&quot;&gt;</span><span class="php-var">{$memory_limit}</span><span class="php-quote">&lt;/font&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3485" id="3485" class="l">3485: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;/tr&gt;\n&quot;</span>;
<a href="#3486" id="3486" class="l">3486: </a>    }
<a href="#3487" id="3487" class="l">3487: </a>
<a href="#3488" id="3488" class="l">3488: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;/table&gt;\n&quot;</span>;
<a href="#3489" id="3489" class="l">3489: </a>
<a href="#3490" id="3490" class="l">3490: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;h2&gt;Database Connections (&quot;</span>.<span class="php-keyword2">count</span>(<span class="php-var">$db</span>-&gt;connections).<span class="php-quote">&quot; Total) &lt;/h2&gt;\n&quot;</span>;
<a href="#3491" id="3491" class="l">3491: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;table style=\&quot;background-color: #666;\&quot; width=\&quot;95%\&quot; cellpadding=\&quot;4\&quot; cellspacing=\&quot;1\&quot; align=\&quot;center\&quot;&gt;\n&quot;</span>;
<a href="#3492" id="3492" class="l">3492: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;tr&gt;\n&quot;</span>;
<a href="#3493" id="3493" class="l">3493: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td style=\&quot;background: #fff;\&quot;&gt;&quot;</span>.<span class="php-keyword2">implode</span>(<span class="php-quote">&quot;&lt;br /&gt;&quot;</span>, <span class="php-var">$db</span>-&gt;connections).<span class="php-quote">&quot;&lt;/td&gt;\n&quot;</span>;
<a href="#3494" id="3494" class="l">3494: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;/tr&gt;\n&quot;</span>;
<a href="#3495" id="3495" class="l">3495: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;/table&gt;\n&quot;</span>;
<a href="#3496" id="3496" class="l">3496: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;br /&gt;\n&quot;</span>;
<a href="#3497" id="3497" class="l">3497: </a>
<a href="#3498" id="3498" class="l">3498: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;h2&gt;Database Queries (&quot;</span>.<span class="php-var">$db</span>-&gt;query_count.<span class="php-quote">&quot; Total) &lt;/h2&gt;\n&quot;</span>;
<a href="#3499" id="3499" class="l">3499: </a>    <span class="php-keyword1">echo</span> <span class="php-var">$db</span>-&gt;explain;
<a href="#3500" id="3500" class="l">3500: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;h2&gt;Template Statistics&lt;/h2&gt;\n&quot;</span>;
<a href="#3501" id="3501" class="l">3501: </a>
<a href="#3502" id="3502" class="l">3502: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">count</span>(<span class="php-var">$templates</span>-&gt;cache) &gt; <span class="php-num">0</span>)
<a href="#3503" id="3503" class="l">3503: </a>    {
<a href="#3504" id="3504" class="l">3504: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;table style=\&quot;background-color: #666;\&quot; width=\&quot;95%\&quot; cellpadding=\&quot;4\&quot; cellspacing=\&quot;1\&quot; align=\&quot;center\&quot;&gt;\n&quot;</span>;
<a href="#3505" id="3505" class="l">3505: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;tr&gt;\n&quot;</span>;
<a href="#3506" id="3506" class="l">3506: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td style=\&quot;background-color: #ccc;\&quot;&gt;&lt;strong&gt;Templates Used (Loaded for this Page) - &quot;</span>.<span class="php-keyword2">count</span>(<span class="php-var">$templates</span>-&gt;cache).<span class="php-quote">&quot; Total&lt;/strong&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3507" id="3507" class="l">3507: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;/tr&gt;\n&quot;</span>;
<a href="#3508" id="3508" class="l">3508: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;tr&gt;\n&quot;</span>;
<a href="#3509" id="3509" class="l">3509: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td style=\&quot;background: #fff;\&quot;&gt;&quot;</span>.<span class="php-keyword2">implode</span>(<span class="php-quote">&quot;, &quot;</span>, <span class="php-keyword2">array_keys</span>(<span class="php-var">$templates</span>-&gt;cache)).<span class="php-quote">&quot;&lt;/td&gt;\n&quot;</span>;
<a href="#3510" id="3510" class="l">3510: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;/tr&gt;\n&quot;</span>;
<a href="#3511" id="3511" class="l">3511: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;/table&gt;\n&quot;</span>;
<a href="#3512" id="3512" class="l">3512: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;br /&gt;\n&quot;</span>;
<a href="#3513" id="3513" class="l">3513: </a>    }
<a href="#3514" id="3514" class="l">3514: </a>
<a href="#3515" id="3515" class="l">3515: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">count</span>(<span class="php-var">$templates</span>-&gt;uncached_templates &gt; <span class="php-num">0</span>))
<a href="#3516" id="3516" class="l">3516: </a>    {
<a href="#3517" id="3517" class="l">3517: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;table style=\&quot;background-color: #666;\&quot; width=\&quot;95%\&quot; cellpadding=\&quot;4\&quot; cellspacing=\&quot;1\&quot; align=\&quot;center\&quot;&gt;\n&quot;</span>;
<a href="#3518" id="3518" class="l">3518: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;tr&gt;\n&quot;</span>;
<a href="#3519" id="3519" class="l">3519: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td style=\&quot;background-color: #ccc;\&quot;&gt;&lt;strong&gt;Templates Requiring Additional Calls (Not Cached at Startup) - &quot;</span>.<span class="php-keyword2">count</span>(<span class="php-var">$templates</span>-&gt;uncached_templates).<span class="php-quote">&quot; Total&lt;/strong&gt;&lt;/td&gt;\n&quot;</span>;
<a href="#3520" id="3520" class="l">3520: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;/tr&gt;\n&quot;</span>;
<a href="#3521" id="3521" class="l">3521: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;tr&gt;\n&quot;</span>;
<a href="#3522" id="3522" class="l">3522: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;td style=\&quot;background: #fff;\&quot;&gt;&quot;</span>.<span class="php-keyword2">implode</span>(<span class="php-quote">&quot;, &quot;</span>, <span class="php-var">$templates</span>-&gt;uncached_templates).<span class="php-quote">&quot;&lt;/td&gt;\n&quot;</span>;
<a href="#3523" id="3523" class="l">3523: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;/tr&gt;\n&quot;</span>;
<a href="#3524" id="3524" class="l">3524: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;/table&gt;\n&quot;</span>;
<a href="#3525" id="3525" class="l">3525: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;br /&gt;\n&quot;</span>;
<a href="#3526" id="3526" class="l">3526: </a>    }
<a href="#3527" id="3527" class="l">3527: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;/body&gt;&quot;</span>;
<a href="#3528" id="3528" class="l">3528: </a>    <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;/html&gt;&quot;</span>;
<a href="#3529" id="3529" class="l">3529: </a>    <span class="php-keyword1">exit</span>;
<a href="#3530" id="3530" class="l">3530: </a>}
<a href="#3531" id="3531" class="l">3531: </a>
<a href="#3532" id="3532" class="l">3532: </a><span class="php-comment">/**
</span><a href="#3533" id="3533" class="l">3533: </a><span class="php-comment"> * Outputs the correct page headers.
</span><a href="#3534" id="3534" class="l">3534: </a><span class="php-comment"> */</span>
<a href="#3535" id="3535" class="l">3535: </a><span class="php-keyword1">function</span> send_page_headers()
<a href="#3536" id="3536" class="l">3536: </a>{
<a href="#3537" id="3537" class="l">3537: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>;
<a href="#3538" id="3538" class="l">3538: </a>
<a href="#3539" id="3539" class="l">3539: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'nocacheheaders'</span>] == <span class="php-num">1</span>)
<a href="#3540" id="3540" class="l">3540: </a>    {
<a href="#3541" id="3541" class="l">3541: </a>        <span class="php-keyword2">header</span>(<span class="php-quote">&quot;Expires: Sat, 1 Jan 2000 01:00:00 GMT&quot;</span>);
<a href="#3542" id="3542" class="l">3542: </a>        <span class="php-keyword2">header</span>(<span class="php-quote">&quot;Last-Modified: &quot;</span>.<span class="php-keyword2">gmdate</span>(<span class="php-quote">&quot;D, d M Y H:i:s&quot;</span>).<span class="php-quote">&quot; GMT&quot;</span>);
<a href="#3543" id="3543" class="l">3543: </a>        <span class="php-keyword2">header</span>(<span class="php-quote">&quot;Cache-Control: no-cache, must-revalidate&quot;</span>);
<a href="#3544" id="3544" class="l">3544: </a>        <span class="php-keyword2">header</span>(<span class="php-quote">&quot;Pragma: no-cache&quot;</span>);
<a href="#3545" id="3545" class="l">3545: </a>    }
<a href="#3546" id="3546" class="l">3546: </a>}
<a href="#3547" id="3547" class="l">3547: </a>
<a href="#3548" id="3548" class="l">3548: </a><span class="php-comment">/**
</span><a href="#3549" id="3549" class="l">3549: </a><span class="php-comment"> * Mark specific reported posts of a certain type as dealt with
</span><a href="#3550" id="3550" class="l">3550: </a><span class="php-comment"> *
</span><a href="#3551" id="3551" class="l">3551: </a><span class="php-comment"> * @param mixed An array or int of the ID numbers you're marking as dealt with
</span><a href="#3552" id="3552" class="l">3552: </a><span class="php-comment"> * @param string The type of item the above IDs are for - post, posts, thread, threads, forum, all
</span><a href="#3553" id="3553" class="l">3553: </a><span class="php-comment"> */</span>
<a href="#3554" id="3554" class="l">3554: </a><span class="php-keyword1">function</span> mark_reports(<span class="php-var">$id</span>, <span class="php-var">$type</span>=<span class="php-quote">&quot;post&quot;</span>)
<a href="#3555" id="3555" class="l">3555: </a>{
<a href="#3556" id="3556" class="l">3556: </a>    <span class="php-keyword1">global</span> <span class="php-var">$db</span>, <span class="php-var">$cache</span>, <span class="php-var">$plugins</span>;
<a href="#3557" id="3557" class="l">3557: </a>
<a href="#3558" id="3558" class="l">3558: </a>    <span class="php-keyword1">switch</span>(<span class="php-var">$type</span>)
<a href="#3559" id="3559" class="l">3559: </a>    {
<a href="#3560" id="3560" class="l">3560: </a>        <span class="php-keyword1">case</span> <span class="php-quote">&quot;posts&quot;</span>:
<a href="#3561" id="3561" class="l">3561: </a>            <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$id</span>))
<a href="#3562" id="3562" class="l">3562: </a>            {
<a href="#3563" id="3563" class="l">3563: </a>                <span class="php-var">$rids</span> = <span class="php-keyword2">implode</span>(<span class="php-var">$id</span>, <span class="php-quote">&quot;','&quot;</span>);
<a href="#3564" id="3564" class="l">3564: </a>                <span class="php-var">$rids</span> = <span class="php-quote">&quot;'0','</span><span class="php-var">$rids</span><span class="php-quote">'&quot;</span>;
<a href="#3565" id="3565" class="l">3565: </a>                <span class="php-var">$db</span>-&gt;update_query(<span class="php-quote">&quot;reportedposts&quot;</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'reportstatus'</span> =&gt; <span class="php-num">1</span>), <span class="php-quote">&quot;pid IN(</span><span class="php-var">$rids</span><span class="php-quote">) AND reportstatus='0'&quot;</span>);
<a href="#3566" id="3566" class="l">3566: </a>            }
<a href="#3567" id="3567" class="l">3567: </a>            <span class="php-keyword1">break</span>;
<a href="#3568" id="3568" class="l">3568: </a>        <span class="php-keyword1">case</span> <span class="php-quote">&quot;post&quot;</span>:
<a href="#3569" id="3569" class="l">3569: </a>            <span class="php-var">$db</span>-&gt;update_query(<span class="php-quote">&quot;reportedposts&quot;</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'reportstatus'</span> =&gt; <span class="php-num">1</span>), <span class="php-quote">&quot;pid='</span><span class="php-var">$id</span><span class="php-quote">' AND reportstatus='0'&quot;</span>);
<a href="#3570" id="3570" class="l">3570: </a>            <span class="php-keyword1">break</span>;
<a href="#3571" id="3571" class="l">3571: </a>        <span class="php-keyword1">case</span> <span class="php-quote">&quot;threads&quot;</span>:
<a href="#3572" id="3572" class="l">3572: </a>            <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$id</span>))
<a href="#3573" id="3573" class="l">3573: </a>            {
<a href="#3574" id="3574" class="l">3574: </a>                <span class="php-var">$rids</span> = <span class="php-keyword2">implode</span>(<span class="php-var">$id</span>, <span class="php-quote">&quot;','&quot;</span>);
<a href="#3575" id="3575" class="l">3575: </a>                <span class="php-var">$rids</span> = <span class="php-quote">&quot;'0','</span><span class="php-var">$rids</span><span class="php-quote">'&quot;</span>;
<a href="#3576" id="3576" class="l">3576: </a>                <span class="php-var">$db</span>-&gt;update_query(<span class="php-quote">&quot;reportedposts&quot;</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'reportstatus'</span> =&gt; <span class="php-num">1</span>), <span class="php-quote">&quot;tid IN(</span><span class="php-var">$rids</span><span class="php-quote">) AND reportstatus='0'&quot;</span>);
<a href="#3577" id="3577" class="l">3577: </a>            }
<a href="#3578" id="3578" class="l">3578: </a>            <span class="php-keyword1">break</span>;
<a href="#3579" id="3579" class="l">3579: </a>        <span class="php-keyword1">case</span> <span class="php-quote">&quot;thread&quot;</span>:
<a href="#3580" id="3580" class="l">3580: </a>            <span class="php-var">$db</span>-&gt;update_query(<span class="php-quote">&quot;reportedposts&quot;</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'reportstatus'</span> =&gt; <span class="php-num">1</span>), <span class="php-quote">&quot;tid='</span><span class="php-var">$id</span><span class="php-quote">' AND reportstatus='0'&quot;</span>);
<a href="#3581" id="3581" class="l">3581: </a>            <span class="php-keyword1">break</span>;
<a href="#3582" id="3582" class="l">3582: </a>        <span class="php-keyword1">case</span> <span class="php-quote">&quot;forum&quot;</span>:
<a href="#3583" id="3583" class="l">3583: </a>            <span class="php-var">$db</span>-&gt;update_query(<span class="php-quote">&quot;reportedposts&quot;</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'reportstatus'</span> =&gt; <span class="php-num">1</span>), <span class="php-quote">&quot;fid='</span><span class="php-var">$id</span><span class="php-quote">' AND reportstatus='0'&quot;</span>);
<a href="#3584" id="3584" class="l">3584: </a>            <span class="php-keyword1">break</span>;
<a href="#3585" id="3585" class="l">3585: </a>        <span class="php-keyword1">case</span> <span class="php-quote">&quot;all&quot;</span>:
<a href="#3586" id="3586" class="l">3586: </a>            <span class="php-var">$db</span>-&gt;update_query(<span class="php-quote">&quot;reportedposts&quot;</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'reportstatus'</span> =&gt; <span class="php-num">1</span>), <span class="php-quote">&quot;reportstatus='0'&quot;</span>);
<a href="#3587" id="3587" class="l">3587: </a>            <span class="php-keyword1">break</span>;
<a href="#3588" id="3588" class="l">3588: </a>    }
<a href="#3589" id="3589" class="l">3589: </a>
<a href="#3590" id="3590" class="l">3590: </a>    <span class="php-var">$arguments</span> = <span class="php-keyword1">array</span>(<span class="php-quote">'id'</span> =&gt; <span class="php-var">$id</span>, <span class="php-quote">'type'</span> =&gt; <span class="php-var">$type</span>);
<a href="#3591" id="3591" class="l">3591: </a>    <span class="php-var">$plugins</span>-&gt;run_hooks(<span class="php-quote">&quot;mark_reports&quot;</span>, <span class="php-var">$arguments</span>);
<a href="#3592" id="3592" class="l">3592: </a>    <span class="php-var">$cache</span>-&gt;update_reportedposts();
<a href="#3593" id="3593" class="l">3593: </a>}
<a href="#3594" id="3594" class="l">3594: </a>
<a href="#3595" id="3595" class="l">3595: </a><span class="php-comment">/**
</span><a href="#3596" id="3596" class="l">3596: </a><span class="php-comment"> * Fetch a friendly x days, y months etc date stamp from a timestamp
</span><a href="#3597" id="3597" class="l">3597: </a><span class="php-comment"> *
</span><a href="#3598" id="3598" class="l">3598: </a><span class="php-comment"> * @param int The timestamp
</span><a href="#3599" id="3599" class="l">3599: </a><span class="php-comment"> * @param array Array of options
</span><a href="#3600" id="3600" class="l">3600: </a><span class="php-comment"> * @return string The friendly formatted timestamp
</span><a href="#3601" id="3601" class="l">3601: </a><span class="php-comment"> */</span>
<a href="#3602" id="3602" class="l">3602: </a><span class="php-keyword1">function</span> nice_time(<span class="php-var">$stamp</span>, <span class="php-var">$options</span>=<span class="php-keyword1">array</span>())
<a href="#3603" id="3603" class="l">3603: </a>{
<a href="#3604" id="3604" class="l">3604: </a>    <span class="php-keyword1">global</span> <span class="php-var">$lang</span>;
<a href="#3605" id="3605" class="l">3605: </a>
<a href="#3606" id="3606" class="l">3606: </a>    <span class="php-var">$ysecs</span> = <span class="php-num">365</span>*<span class="php-num">24</span>*<span class="php-num">60</span>*<span class="php-num">60</span>;
<a href="#3607" id="3607" class="l">3607: </a>    <span class="php-var">$mosecs</span> = <span class="php-num">31</span>*<span class="php-num">24</span>*<span class="php-num">60</span>*<span class="php-num">60</span>;
<a href="#3608" id="3608" class="l">3608: </a>    <span class="php-var">$wsecs</span> = <span class="php-num">7</span>*<span class="php-num">24</span>*<span class="php-num">60</span>*<span class="php-num">60</span>;
<a href="#3609" id="3609" class="l">3609: </a>    <span class="php-var">$dsecs</span> = <span class="php-num">24</span>*<span class="php-num">60</span>*<span class="php-num">60</span>;
<a href="#3610" id="3610" class="l">3610: </a>    <span class="php-var">$hsecs</span> = <span class="php-num">60</span>*<span class="php-num">60</span>;
<a href="#3611" id="3611" class="l">3611: </a>    <span class="php-var">$msecs</span> = <span class="php-num">60</span>;
<a href="#3612" id="3612" class="l">3612: </a>
<a href="#3613" id="3613" class="l">3613: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$options</span>[<span class="php-quote">'short'</span>] == <span class="php-keyword1">true</span>)
<a href="#3614" id="3614" class="l">3614: </a>    {
<a href="#3615" id="3615" class="l">3615: </a>        <span class="php-var">$lang_year</span> = <span class="php-var">$lang</span>-&gt;year_short;
<a href="#3616" id="3616" class="l">3616: </a>        <span class="php-var">$lang_years</span> = <span class="php-var">$lang</span>-&gt;years_short;
<a href="#3617" id="3617" class="l">3617: </a>        <span class="php-var">$lang_month</span> = <span class="php-var">$lang</span>-&gt;month_short;
<a href="#3618" id="3618" class="l">3618: </a>        <span class="php-var">$lang_months</span> = <span class="php-var">$lang</span>-&gt;months_short;
<a href="#3619" id="3619" class="l">3619: </a>        <span class="php-var">$lang_week</span> = <span class="php-var">$lang</span>-&gt;week_short;
<a href="#3620" id="3620" class="l">3620: </a>        <span class="php-var">$lang_weeks</span> = <span class="php-var">$lang</span>-&gt;weeks_short;
<a href="#3621" id="3621" class="l">3621: </a>        <span class="php-var">$lang_day</span> = <span class="php-var">$lang</span>-&gt;day_short;
<a href="#3622" id="3622" class="l">3622: </a>        <span class="php-var">$lang_days</span> = <span class="php-var">$lang</span>-&gt;days_short;
<a href="#3623" id="3623" class="l">3623: </a>        <span class="php-var">$lang_hour</span> = <span class="php-var">$lang</span>-&gt;hour_short;
<a href="#3624" id="3624" class="l">3624: </a>        <span class="php-var">$lang_hours</span> = <span class="php-var">$lang</span>-&gt;hours_short;
<a href="#3625" id="3625" class="l">3625: </a>        <span class="php-var">$lang_minute</span> = <span class="php-var">$lang</span>-&gt;minute_short;
<a href="#3626" id="3626" class="l">3626: </a>        <span class="php-var">$lang_minutes</span> = <span class="php-var">$lang</span>-&gt;minutes_short;
<a href="#3627" id="3627" class="l">3627: </a>        <span class="php-var">$lang_second</span> = <span class="php-var">$lang</span>-&gt;second_short;
<a href="#3628" id="3628" class="l">3628: </a>        <span class="php-var">$lang_seconds</span> = <span class="php-var">$lang</span>-&gt;seconds_short;
<a href="#3629" id="3629" class="l">3629: </a>    }
<a href="#3630" id="3630" class="l">3630: </a>    <span class="php-keyword1">else</span>
<a href="#3631" id="3631" class="l">3631: </a>    {
<a href="#3632" id="3632" class="l">3632: </a>        <span class="php-var">$lang_year</span> = <span class="php-quote">&quot; &quot;</span>.<span class="php-var">$lang</span>-&gt;year;
<a href="#3633" id="3633" class="l">3633: </a>        <span class="php-var">$lang_years</span> = <span class="php-quote">&quot; &quot;</span>.<span class="php-var">$lang</span>-&gt;years;
<a href="#3634" id="3634" class="l">3634: </a>        <span class="php-var">$lang_month</span> = <span class="php-quote">&quot; &quot;</span>.<span class="php-var">$lang</span>-&gt;month;
<a href="#3635" id="3635" class="l">3635: </a>        <span class="php-var">$lang_months</span> = <span class="php-quote">&quot; &quot;</span>.<span class="php-var">$lang</span>-&gt;months;
<a href="#3636" id="3636" class="l">3636: </a>        <span class="php-var">$lang_week</span> = <span class="php-quote">&quot; &quot;</span>.<span class="php-var">$lang</span>-&gt;week;
<a href="#3637" id="3637" class="l">3637: </a>        <span class="php-var">$lang_weeks</span> = <span class="php-quote">&quot; &quot;</span>.<span class="php-var">$lang</span>-&gt;weeks;
<a href="#3638" id="3638" class="l">3638: </a>        <span class="php-var">$lang_day</span> = <span class="php-quote">&quot; &quot;</span>.<span class="php-var">$lang</span>-&gt;day;
<a href="#3639" id="3639" class="l">3639: </a>        <span class="php-var">$lang_days</span> = <span class="php-quote">&quot; &quot;</span>.<span class="php-var">$lang</span>-&gt;days;
<a href="#3640" id="3640" class="l">3640: </a>        <span class="php-var">$lang_hour</span> = <span class="php-quote">&quot; &quot;</span>.<span class="php-var">$lang</span>-&gt;hour;
<a href="#3641" id="3641" class="l">3641: </a>        <span class="php-var">$lang_hours</span> = <span class="php-quote">&quot; &quot;</span>.<span class="php-var">$lang</span>-&gt;hours;
<a href="#3642" id="3642" class="l">3642: </a>        <span class="php-var">$lang_minute</span> = <span class="php-quote">&quot; &quot;</span>.<span class="php-var">$lang</span>-&gt;minute;
<a href="#3643" id="3643" class="l">3643: </a>        <span class="php-var">$lang_minutes</span> = <span class="php-quote">&quot; &quot;</span>.<span class="php-var">$lang</span>-&gt;minutes;
<a href="#3644" id="3644" class="l">3644: </a>        <span class="php-var">$lang_second</span> = <span class="php-quote">&quot; &quot;</span>.<span class="php-var">$lang</span>-&gt;second;
<a href="#3645" id="3645" class="l">3645: </a>        <span class="php-var">$lang_seconds</span> = <span class="php-quote">&quot; &quot;</span>.<span class="php-var">$lang</span>-&gt;seconds;
<a href="#3646" id="3646" class="l">3646: </a>    }
<a href="#3647" id="3647" class="l">3647: </a>
<a href="#3648" id="3648" class="l">3648: </a>    <span class="php-var">$years</span> = <span class="php-keyword2">floor</span>(<span class="php-var">$stamp</span>/<span class="php-var">$ysecs</span>);
<a href="#3649" id="3649" class="l">3649: </a>    <span class="php-var">$stamp</span> %= <span class="php-var">$ysecs</span>;
<a href="#3650" id="3650" class="l">3650: </a>    <span class="php-var">$months</span> = <span class="php-keyword2">floor</span>(<span class="php-var">$stamp</span>/<span class="php-var">$mosecs</span>);
<a href="#3651" id="3651" class="l">3651: </a>    <span class="php-var">$stamp</span> %= <span class="php-var">$mosecs</span>;
<a href="#3652" id="3652" class="l">3652: </a>    <span class="php-var">$weeks</span> = <span class="php-keyword2">floor</span>(<span class="php-var">$stamp</span>/<span class="php-var">$wsecs</span>);
<a href="#3653" id="3653" class="l">3653: </a>    <span class="php-var">$stamp</span> %= <span class="php-var">$wsecs</span>;
<a href="#3654" id="3654" class="l">3654: </a>    <span class="php-var">$days</span> = <span class="php-keyword2">floor</span>(<span class="php-var">$stamp</span>/<span class="php-var">$dsecs</span>);
<a href="#3655" id="3655" class="l">3655: </a>    <span class="php-var">$stamp</span> %= <span class="php-var">$dsecs</span>;
<a href="#3656" id="3656" class="l">3656: </a>    <span class="php-var">$hours</span> = <span class="php-keyword2">floor</span>(<span class="php-var">$stamp</span>/<span class="php-var">$hsecs</span>);
<a href="#3657" id="3657" class="l">3657: </a>    <span class="php-var">$stamp</span> %= <span class="php-var">$hsecs</span>;
<a href="#3658" id="3658" class="l">3658: </a>    <span class="php-var">$minutes</span> = <span class="php-keyword2">floor</span>(<span class="php-var">$stamp</span>/<span class="php-var">$msecs</span>);
<a href="#3659" id="3659" class="l">3659: </a>    <span class="php-var">$stamp</span> %= <span class="php-var">$msecs</span>;
<a href="#3660" id="3660" class="l">3660: </a>    <span class="php-var">$seconds</span> = <span class="php-var">$stamp</span>;
<a href="#3661" id="3661" class="l">3661: </a>
<a href="#3662" id="3662" class="l">3662: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$years</span> == <span class="php-num">1</span>)
<a href="#3663" id="3663" class="l">3663: </a>    {
<a href="#3664" id="3664" class="l">3664: </a>        <span class="php-var">$nicetime</span>[<span class="php-quote">'years'</span>] = <span class="php-quote">&quot;1&quot;</span>.<span class="php-var">$lang_year</span>;
<a href="#3665" id="3665" class="l">3665: </a>    }
<a href="#3666" id="3666" class="l">3666: </a>    <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(<span class="php-var">$years</span> &gt; <span class="php-num">1</span>)
<a href="#3667" id="3667" class="l">3667: </a>    {
<a href="#3668" id="3668" class="l">3668: </a>        <span class="php-var">$nicetime</span>[<span class="php-quote">'years'</span>] = <span class="php-var">$years</span>.<span class="php-var">$lang_years</span>;
<a href="#3669" id="3669" class="l">3669: </a>    }
<a href="#3670" id="3670" class="l">3670: </a>
<a href="#3671" id="3671" class="l">3671: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$months</span> == <span class="php-num">1</span>)
<a href="#3672" id="3672" class="l">3672: </a>    {
<a href="#3673" id="3673" class="l">3673: </a>        <span class="php-var">$nicetime</span>[<span class="php-quote">'months'</span>] = <span class="php-quote">&quot;1&quot;</span>.<span class="php-var">$lang_month</span>;
<a href="#3674" id="3674" class="l">3674: </a>    }
<a href="#3675" id="3675" class="l">3675: </a>    <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(<span class="php-var">$months</span> &gt; <span class="php-num">1</span>)
<a href="#3676" id="3676" class="l">3676: </a>    {
<a href="#3677" id="3677" class="l">3677: </a>        <span class="php-var">$nicetime</span>[<span class="php-quote">'months'</span>] = <span class="php-var">$months</span>.<span class="php-var">$lang_months</span>;
<a href="#3678" id="3678" class="l">3678: </a>    }
<a href="#3679" id="3679" class="l">3679: </a>
<a href="#3680" id="3680" class="l">3680: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$weeks</span> == <span class="php-num">1</span>)
<a href="#3681" id="3681" class="l">3681: </a>    {
<a href="#3682" id="3682" class="l">3682: </a>        <span class="php-var">$nicetime</span>[<span class="php-quote">'weeks'</span>] = <span class="php-quote">&quot;1&quot;</span>.<span class="php-var">$lang_week</span>;
<a href="#3683" id="3683" class="l">3683: </a>    }
<a href="#3684" id="3684" class="l">3684: </a>    <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(<span class="php-var">$weeks</span> &gt; <span class="php-num">1</span>)
<a href="#3685" id="3685" class="l">3685: </a>    {
<a href="#3686" id="3686" class="l">3686: </a>        <span class="php-var">$nicetime</span>[<span class="php-quote">'weeks'</span>] = <span class="php-var">$weeks</span>.<span class="php-var">$lang_weeks</span>;
<a href="#3687" id="3687" class="l">3687: </a>    }
<a href="#3688" id="3688" class="l">3688: </a>
<a href="#3689" id="3689" class="l">3689: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$days</span> == <span class="php-num">1</span>)
<a href="#3690" id="3690" class="l">3690: </a>    {
<a href="#3691" id="3691" class="l">3691: </a>        <span class="php-var">$nicetime</span>[<span class="php-quote">'days'</span>] = <span class="php-quote">&quot;1&quot;</span>.<span class="php-var">$lang_day</span>;
<a href="#3692" id="3692" class="l">3692: </a>    }
<a href="#3693" id="3693" class="l">3693: </a>    <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(<span class="php-var">$days</span> &gt; <span class="php-num">1</span>)
<a href="#3694" id="3694" class="l">3694: </a>    {
<a href="#3695" id="3695" class="l">3695: </a>        <span class="php-var">$nicetime</span>[<span class="php-quote">'days'</span>] = <span class="php-var">$days</span>.<span class="php-var">$lang_days</span>;
<a href="#3696" id="3696" class="l">3696: </a>    }
<a href="#3697" id="3697" class="l">3697: </a>
<a href="#3698" id="3698" class="l">3698: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$options</span>[<span class="php-quote">'hours'</span>] !== <span class="php-keyword1">false</span>)
<a href="#3699" id="3699" class="l">3699: </a>    {
<a href="#3700" id="3700" class="l">3700: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$hours</span> == <span class="php-num">1</span>)
<a href="#3701" id="3701" class="l">3701: </a>        {
<a href="#3702" id="3702" class="l">3702: </a>            <span class="php-var">$nicetime</span>[<span class="php-quote">'hours'</span>] = <span class="php-quote">&quot;1&quot;</span>.<span class="php-var">$lang_hour</span>;
<a href="#3703" id="3703" class="l">3703: </a>        }
<a href="#3704" id="3704" class="l">3704: </a>        <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(<span class="php-var">$hours</span> &gt; <span class="php-num">1</span>)
<a href="#3705" id="3705" class="l">3705: </a>        {
<a href="#3706" id="3706" class="l">3706: </a>            <span class="php-var">$nicetime</span>[<span class="php-quote">'hours'</span>] = <span class="php-var">$hours</span>.<span class="php-var">$lang_hours</span>;
<a href="#3707" id="3707" class="l">3707: </a>        }
<a href="#3708" id="3708" class="l">3708: </a>    }
<a href="#3709" id="3709" class="l">3709: </a>
<a href="#3710" id="3710" class="l">3710: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$options</span>[<span class="php-quote">'minutes'</span>] !== <span class="php-keyword1">false</span>)
<a href="#3711" id="3711" class="l">3711: </a>    {
<a href="#3712" id="3712" class="l">3712: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$minutes</span> == <span class="php-num">1</span>)
<a href="#3713" id="3713" class="l">3713: </a>        {
<a href="#3714" id="3714" class="l">3714: </a>            <span class="php-var">$nicetime</span>[<span class="php-quote">'minutes'</span>] = <span class="php-quote">&quot;1&quot;</span>.<span class="php-var">$lang_minute</span>;
<a href="#3715" id="3715" class="l">3715: </a>        }
<a href="#3716" id="3716" class="l">3716: </a>        <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(<span class="php-var">$minutes</span> &gt; <span class="php-num">1</span>)
<a href="#3717" id="3717" class="l">3717: </a>        {
<a href="#3718" id="3718" class="l">3718: </a>            <span class="php-var">$nicetime</span>[<span class="php-quote">'minutes'</span>] = <span class="php-var">$minutes</span>.<span class="php-var">$lang_minutes</span>;
<a href="#3719" id="3719" class="l">3719: </a>        }
<a href="#3720" id="3720" class="l">3720: </a>    }
<a href="#3721" id="3721" class="l">3721: </a>
<a href="#3722" id="3722" class="l">3722: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$options</span>[<span class="php-quote">'seconds'</span>] !== <span class="php-keyword1">false</span>)
<a href="#3723" id="3723" class="l">3723: </a>    {
<a href="#3724" id="3724" class="l">3724: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$seconds</span> == <span class="php-num">1</span>)
<a href="#3725" id="3725" class="l">3725: </a>        {
<a href="#3726" id="3726" class="l">3726: </a>            <span class="php-var">$nicetime</span>[<span class="php-quote">'seconds'</span>] = <span class="php-quote">&quot;1&quot;</span>.<span class="php-var">$lang_second</span>;
<a href="#3727" id="3727" class="l">3727: </a>        }
<a href="#3728" id="3728" class="l">3728: </a>        <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(<span class="php-var">$seconds</span> &gt; <span class="php-num">1</span>)
<a href="#3729" id="3729" class="l">3729: </a>        {
<a href="#3730" id="3730" class="l">3730: </a>            <span class="php-var">$nicetime</span>[<span class="php-quote">'seconds'</span>] = <span class="php-var">$seconds</span>.<span class="php-var">$lang_seconds</span>;
<a href="#3731" id="3731" class="l">3731: </a>        }
<a href="#3732" id="3732" class="l">3732: </a>    }
<a href="#3733" id="3733" class="l">3733: </a>
<a href="#3734" id="3734" class="l">3734: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$nicetime</span>))
<a href="#3735" id="3735" class="l">3735: </a>    {
<a href="#3736" id="3736" class="l">3736: </a>        <span class="php-keyword1">return</span> <span class="php-keyword2">implode</span>(<span class="php-quote">&quot;, &quot;</span>, <span class="php-var">$nicetime</span>);
<a href="#3737" id="3737" class="l">3737: </a>    }
<a href="#3738" id="3738" class="l">3738: </a>}
<a href="#3739" id="3739" class="l">3739: </a>
<a href="#3740" id="3740" class="l">3740: </a><span class="php-comment">/**
</span><a href="#3741" id="3741" class="l">3741: </a><span class="php-comment"> * Select an alternating row colour based on the previous call to this function
</span><a href="#3742" id="3742" class="l">3742: </a><span class="php-comment"> *
</span><a href="#3743" id="3743" class="l">3743: </a><span class="php-comment"> * @param int 1 to reset the row to trow1.
</span><a href="#3744" id="3744" class="l">3744: </a><span class="php-comment"> * @return string trow1 or trow2 depending on the previous call
</span><a href="#3745" id="3745" class="l">3745: </a><span class="php-comment"> */</span>
<a href="#3746" id="3746" class="l">3746: </a><span class="php-keyword1">function</span> alt_trow(<span class="php-var">$reset</span>=<span class="php-num">0</span>)
<a href="#3747" id="3747" class="l">3747: </a>{
<a href="#3748" id="3748" class="l">3748: </a>    <span class="php-keyword1">global</span> <span class="php-var">$alttrow</span>;
<a href="#3749" id="3749" class="l">3749: </a>
<a href="#3750" id="3750" class="l">3750: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$alttrow</span> == <span class="php-quote">&quot;trow1&quot;</span> &amp;&amp; !<span class="php-var">$reset</span>)
<a href="#3751" id="3751" class="l">3751: </a>    {
<a href="#3752" id="3752" class="l">3752: </a>        <span class="php-var">$trow</span> = <span class="php-quote">&quot;trow2&quot;</span>;
<a href="#3753" id="3753" class="l">3753: </a>    }
<a href="#3754" id="3754" class="l">3754: </a>    <span class="php-keyword1">else</span>
<a href="#3755" id="3755" class="l">3755: </a>    {
<a href="#3756" id="3756" class="l">3756: </a>        <span class="php-var">$trow</span> = <span class="php-quote">&quot;trow1&quot;</span>;
<a href="#3757" id="3757" class="l">3757: </a>    }
<a href="#3758" id="3758" class="l">3758: </a>
<a href="#3759" id="3759" class="l">3759: </a>    <span class="php-var">$alttrow</span> = <span class="php-var">$trow</span>;
<a href="#3760" id="3760" class="l">3760: </a>
<a href="#3761" id="3761" class="l">3761: </a>    <span class="php-keyword1">return</span> <span class="php-var">$trow</span>;
<a href="#3762" id="3762" class="l">3762: </a>}
<a href="#3763" id="3763" class="l">3763: </a>
<a href="#3764" id="3764" class="l">3764: </a><span class="php-comment">/**
</span><a href="#3765" id="3765" class="l">3765: </a><span class="php-comment"> * Add a user to a specific additional user group.
</span><a href="#3766" id="3766" class="l">3766: </a><span class="php-comment"> *
</span><a href="#3767" id="3767" class="l">3767: </a><span class="php-comment"> * @param int The user ID
</span><a href="#3768" id="3768" class="l">3768: </a><span class="php-comment"> * @param int The user group ID to join
</span><a href="#3769" id="3769" class="l">3769: </a><span class="php-comment"> */</span>
<a href="#3770" id="3770" class="l">3770: </a><span class="php-keyword1">function</span> join_usergroup(<span class="php-var">$uid</span>, <span class="php-var">$joingroup</span>)
<a href="#3771" id="3771" class="l">3771: </a>{
<a href="#3772" id="3772" class="l">3772: </a>    <span class="php-keyword1">global</span> <span class="php-var">$db</span>, <span class="php-var">$mybb</span>;
<a href="#3773" id="3773" class="l">3773: </a>
<a href="#3774" id="3774" class="l">3774: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$uid</span> == <span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'uid'</span>])
<a href="#3775" id="3775" class="l">3775: </a>    {
<a href="#3776" id="3776" class="l">3776: </a>        <span class="php-var">$user</span> = <span class="php-var">$mybb</span>-&gt;user;
<a href="#3777" id="3777" class="l">3777: </a>    }
<a href="#3778" id="3778" class="l">3778: </a>    <span class="php-keyword1">else</span>
<a href="#3779" id="3779" class="l">3779: </a>    {
<a href="#3780" id="3780" class="l">3780: </a>        <span class="php-var">$query</span> = <span class="php-var">$db</span>-&gt;simple_select(<span class="php-quote">&quot;users&quot;</span>, <span class="php-quote">&quot;additionalgroups, usergroup&quot;</span>, <span class="php-quote">&quot;uid='&quot;</span>.<span class="php-keyword2">intval</span>(<span class="php-var">$uid</span>).<span class="php-quote">&quot;'&quot;</span>);
<a href="#3781" id="3781" class="l">3781: </a>        <span class="php-var">$user</span> = <span class="php-var">$db</span>-&gt;fetch_array(<span class="php-var">$query</span>);
<a href="#3782" id="3782" class="l">3782: </a>    }
<a href="#3783" id="3783" class="l">3783: </a>
<a href="#3784" id="3784" class="l">3784: </a>    <span class="php-comment">// Build the new list of additional groups for this user and make sure they're in the right format</span>
<a href="#3785" id="3785" class="l">3785: </a>    <span class="php-var">$usergroups</span> = <span class="php-quote">&quot;&quot;</span>;
<a href="#3786" id="3786" class="l">3786: </a>    <span class="php-var">$usergroups</span> = <span class="php-var">$user</span>[<span class="php-quote">'additionalgroups'</span>].<span class="php-quote">&quot;,&quot;</span>.<span class="php-var">$joingroup</span>;
<a href="#3787" id="3787" class="l">3787: </a>    <span class="php-var">$groupslist</span> = <span class="php-quote">&quot;&quot;</span>;
<a href="#3788" id="3788" class="l">3788: </a>    <span class="php-var">$groups</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">&quot;,&quot;</span>, <span class="php-var">$usergroups</span>);
<a href="#3789" id="3789" class="l">3789: </a>
<a href="#3790" id="3790" class="l">3790: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$groups</span>))
<a href="#3791" id="3791" class="l">3791: </a>    {
<a href="#3792" id="3792" class="l">3792: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$groups</span> <span class="php-keyword1">as</span> <span class="php-var">$gid</span>)
<a href="#3793" id="3793" class="l">3793: </a>        {
<a href="#3794" id="3794" class="l">3794: </a>            <span class="php-keyword1">if</span>(<span class="php-keyword2">trim</span>(<span class="php-var">$gid</span>) != <span class="php-quote">&quot;&quot;</span> &amp;&amp; <span class="php-var">$gid</span> != <span class="php-var">$user</span>[<span class="php-quote">'usergroup'</span>] &amp;&amp; !<span class="php-var">$donegroup</span>[<span class="php-var">$gid</span>])
<a href="#3795" id="3795" class="l">3795: </a>            {
<a href="#3796" id="3796" class="l">3796: </a>                <span class="php-var">$groupslist</span> .= <span class="php-var">$comma</span>.<span class="php-var">$gid</span>;
<a href="#3797" id="3797" class="l">3797: </a>                <span class="php-var">$comma</span> = <span class="php-quote">&quot;,&quot;</span>;
<a href="#3798" id="3798" class="l">3798: </a>                <span class="php-var">$donegroup</span>[<span class="php-var">$gid</span>] = <span class="php-num">1</span>;
<a href="#3799" id="3799" class="l">3799: </a>            }
<a href="#3800" id="3800" class="l">3800: </a>        }
<a href="#3801" id="3801" class="l">3801: </a>    }
<a href="#3802" id="3802" class="l">3802: </a>
<a href="#3803" id="3803" class="l">3803: </a>    <span class="php-comment">// What's the point in updating if they're the same?</span>
<a href="#3804" id="3804" class="l">3804: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$groupslist</span> != <span class="php-var">$user</span>[<span class="php-quote">'additionalgroups'</span>])
<a href="#3805" id="3805" class="l">3805: </a>    {
<a href="#3806" id="3806" class="l">3806: </a>        <span class="php-var">$db</span>-&gt;update_query(<span class="php-quote">&quot;users&quot;</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'additionalgroups'</span> =&gt; <span class="php-var">$groupslist</span>), <span class="php-quote">&quot;uid='&quot;</span>.<span class="php-keyword2">intval</span>(<span class="php-var">$uid</span>).<span class="php-quote">&quot;'&quot;</span>);
<a href="#3807" id="3807" class="l">3807: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
<a href="#3808" id="3808" class="l">3808: </a>    }
<a href="#3809" id="3809" class="l">3809: </a>    <span class="php-keyword1">else</span>
<a href="#3810" id="3810" class="l">3810: </a>    {
<a href="#3811" id="3811" class="l">3811: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#3812" id="3812" class="l">3812: </a>    }
<a href="#3813" id="3813" class="l">3813: </a>}
<a href="#3814" id="3814" class="l">3814: </a>
<a href="#3815" id="3815" class="l">3815: </a><span class="php-comment">/**
</span><a href="#3816" id="3816" class="l">3816: </a><span class="php-comment"> * Remove a user from a specific additional user group
</span><a href="#3817" id="3817" class="l">3817: </a><span class="php-comment"> *
</span><a href="#3818" id="3818" class="l">3818: </a><span class="php-comment"> * @param int The user ID
</span><a href="#3819" id="3819" class="l">3819: </a><span class="php-comment"> * @param int The user group ID
</span><a href="#3820" id="3820" class="l">3820: </a><span class="php-comment"> */</span>
<a href="#3821" id="3821" class="l">3821: </a><span class="php-keyword1">function</span> leave_usergroup(<span class="php-var">$uid</span>, <span class="php-var">$leavegroup</span>)
<a href="#3822" id="3822" class="l">3822: </a>{
<a href="#3823" id="3823" class="l">3823: </a>    <span class="php-keyword1">global</span> <span class="php-var">$db</span>, <span class="php-var">$mybb</span>, <span class="php-var">$cache</span>;
<a href="#3824" id="3824" class="l">3824: </a>
<a href="#3825" id="3825" class="l">3825: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$uid</span> == <span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'uid'</span>])
<a href="#3826" id="3826" class="l">3826: </a>    {
<a href="#3827" id="3827" class="l">3827: </a>        <span class="php-var">$user</span> = <span class="php-var">$mybb</span>-&gt;user;
<a href="#3828" id="3828" class="l">3828: </a>    }
<a href="#3829" id="3829" class="l">3829: </a>    <span class="php-keyword1">else</span>
<a href="#3830" id="3830" class="l">3830: </a>    {
<a href="#3831" id="3831" class="l">3831: </a>        <span class="php-var">$query</span> = <span class="php-var">$db</span>-&gt;simple_select(<span class="php-quote">&quot;users&quot;</span>, <span class="php-quote">&quot;*&quot;</span>, <span class="php-quote">&quot;uid='&quot;</span>.<span class="php-keyword2">intval</span>(<span class="php-var">$uid</span>).<span class="php-quote">&quot;'&quot;</span>);
<a href="#3832" id="3832" class="l">3832: </a>        <span class="php-var">$user</span> = <span class="php-var">$db</span>-&gt;fetch_array(<span class="php-var">$query</span>);
<a href="#3833" id="3833" class="l">3833: </a>    }
<a href="#3834" id="3834" class="l">3834: </a>
<a href="#3835" id="3835" class="l">3835: </a>    <span class="php-var">$groupslist</span> = <span class="php-quote">&quot;&quot;</span>;
<a href="#3836" id="3836" class="l">3836: </a>    <span class="php-var">$usergroups</span> = <span class="php-quote">&quot;&quot;</span>;
<a href="#3837" id="3837" class="l">3837: </a>    <span class="php-var">$usergroups</span> = <span class="php-var">$user</span>[<span class="php-quote">'additionalgroups'</span>].<span class="php-quote">&quot;,&quot;</span>;
<a href="#3838" id="3838" class="l">3838: </a>
<a href="#3839" id="3839" class="l">3839: </a>    <span class="php-var">$groups</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">&quot;,&quot;</span>, <span class="php-var">$user</span>[<span class="php-quote">'additionalgroups'</span>]);
<a href="#3840" id="3840" class="l">3840: </a>
<a href="#3841" id="3841" class="l">3841: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$groups</span>))
<a href="#3842" id="3842" class="l">3842: </a>    {
<a href="#3843" id="3843" class="l">3843: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$groups</span> <span class="php-keyword1">as</span> <span class="php-var">$gid</span>)
<a href="#3844" id="3844" class="l">3844: </a>        {
<a href="#3845" id="3845" class="l">3845: </a>            <span class="php-keyword1">if</span>(<span class="php-keyword2">trim</span>(<span class="php-var">$gid</span>) != <span class="php-quote">&quot;&quot;</span> &amp;&amp; <span class="php-var">$leavegroup</span> != <span class="php-var">$gid</span> &amp;&amp; !<span class="php-var">$donegroup</span>[<span class="php-var">$gid</span>])
<a href="#3846" id="3846" class="l">3846: </a>            {
<a href="#3847" id="3847" class="l">3847: </a>                <span class="php-var">$groupslist</span> .= <span class="php-var">$comma</span>.<span class="php-var">$gid</span>;
<a href="#3848" id="3848" class="l">3848: </a>                <span class="php-var">$comma</span> = <span class="php-quote">&quot;,&quot;</span>;
<a href="#3849" id="3849" class="l">3849: </a>                <span class="php-var">$donegroup</span>[<span class="php-var">$gid</span>] = <span class="php-num">1</span>;
<a href="#3850" id="3850" class="l">3850: </a>            }
<a href="#3851" id="3851" class="l">3851: </a>        }
<a href="#3852" id="3852" class="l">3852: </a>    }
<a href="#3853" id="3853" class="l">3853: </a>    
<a href="#3854" id="3854" class="l">3854: </a>    <span class="php-var">$dispupdate</span> = <span class="php-quote">&quot;&quot;</span>;
<a href="#3855" id="3855" class="l">3855: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$leavegroup</span> == <span class="php-var">$user</span>[<span class="php-quote">'displaygroup'</span>])
<a href="#3856" id="3856" class="l">3856: </a>    {
<a href="#3857" id="3857" class="l">3857: </a>        <span class="php-var">$dispupdate</span> = <span class="php-quote">&quot;, displaygroup=usergroup&quot;</span>;
<a href="#3858" id="3858" class="l">3858: </a>    }
<a href="#3859" id="3859" class="l">3859: </a>
<a href="#3860" id="3860" class="l">3860: </a>    <span class="php-var">$db</span>-&gt;write_query(<span class="php-quote">&quot;
</span><a href="#3861" id="3861" class="l">3861: </a><span class="php-quote">        UPDATE &quot;</span>.TABLE_PREFIX.<span class="php-quote">&quot;users
</span><a href="#3862" id="3862" class="l">3862: </a><span class="php-quote">        SET additionalgroups='</span><span class="php-var">$groupslist</span><span class="php-quote">' </span><span class="php-var">$dispupdate</span><span class="php-quote">
</span><a href="#3863" id="3863" class="l">3863: </a><span class="php-quote">        WHERE uid='&quot;</span>.<span class="php-keyword2">intval</span>(<span class="php-var">$uid</span>).<span class="php-quote">&quot;'
</span><a href="#3864" id="3864" class="l">3864: </a><span class="php-quote">    &quot;</span>);
<a href="#3865" id="3865" class="l">3865: </a>    
<a href="#3866" id="3866" class="l">3866: </a>    <span class="php-var">$cache</span>-&gt;update_moderators();
<a href="#3867" id="3867" class="l">3867: </a>}
<a href="#3868" id="3868" class="l">3868: </a>
<a href="#3869" id="3869" class="l">3869: </a><span class="php-comment">/**
</span><a href="#3870" id="3870" class="l">3870: </a><span class="php-comment"> * Get the current location taking in to account different web serves and systems
</span><a href="#3871" id="3871" class="l">3871: </a><span class="php-comment"> *
</span><a href="#3872" id="3872" class="l">3872: </a><span class="php-comment"> * @param boolean True to return as &quot;hidden&quot; fields
</span><a href="#3873" id="3873" class="l">3873: </a><span class="php-comment"> * @param array Array of fields to ignore if first argument is true
</span><a href="#3874" id="3874" class="l">3874: </a><span class="php-comment"> * @return string The current URL being accessed
</span><a href="#3875" id="3875" class="l">3875: </a><span class="php-comment"> */</span>
<a href="#3876" id="3876" class="l">3876: </a><span class="php-keyword1">function</span> get_current_location(<span class="php-var">$fields</span>=<span class="php-keyword1">false</span>, <span class="php-var">$ignore</span>=<span class="php-keyword1">array</span>())
<a href="#3877" id="3877" class="l">3877: </a>{
<a href="#3878" id="3878" class="l">3878: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">defined</span>(<span class="php-quote">&quot;MYBB_LOCATION&quot;</span>))
<a href="#3879" id="3879" class="l">3879: </a>    {
<a href="#3880" id="3880" class="l">3880: </a>        <span class="php-keyword1">return</span> MYBB_LOCATION;
<a href="#3881" id="3881" class="l">3881: </a>    }
<a href="#3882" id="3882" class="l">3882: </a>
<a href="#3883" id="3883" class="l">3883: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword1">empty</span>(<span class="php-var">$_SERVER</span>[<span class="php-quote">'PATH_INFO'</span>]))
<a href="#3884" id="3884" class="l">3884: </a>    {
<a href="#3885" id="3885" class="l">3885: </a>        <span class="php-var">$location</span> = htmlspecialchars_uni(<span class="php-var">$_SERVER</span>[<span class="php-quote">'PATH_INFO'</span>]);
<a href="#3886" id="3886" class="l">3886: </a>    }
<a href="#3887" id="3887" class="l">3887: </a>    <span class="php-keyword1">elseif</span>(!<span class="php-keyword1">empty</span>(<span class="php-var">$_ENV</span>[<span class="php-quote">'PATH_INFO'</span>]))
<a href="#3888" id="3888" class="l">3888: </a>    {
<a href="#3889" id="3889" class="l">3889: </a>        <span class="php-var">$location</span> = htmlspecialchars_uni(<span class="php-var">$_ENV</span>[<span class="php-quote">'PATH_INFO'</span>]);
<a href="#3890" id="3890" class="l">3890: </a>    }
<a href="#3891" id="3891" class="l">3891: </a>    <span class="php-keyword1">elseif</span>(!<span class="php-keyword1">empty</span>(<span class="php-var">$_ENV</span>[<span class="php-quote">'PHP_SELF'</span>]))
<a href="#3892" id="3892" class="l">3892: </a>    {
<a href="#3893" id="3893" class="l">3893: </a>        <span class="php-var">$location</span> = htmlspecialchars_uni(<span class="php-var">$_ENV</span>[<span class="php-quote">'PHP_SELF'</span>]);
<a href="#3894" id="3894" class="l">3894: </a>    }
<a href="#3895" id="3895" class="l">3895: </a>    <span class="php-keyword1">else</span>
<a href="#3896" id="3896" class="l">3896: </a>    {
<a href="#3897" id="3897" class="l">3897: </a>        <span class="php-var">$location</span> = htmlspecialchars_uni(<span class="php-var">$_SERVER</span>[<span class="php-quote">'PHP_SELF'</span>]);
<a href="#3898" id="3898" class="l">3898: </a>    }
<a href="#3899" id="3899" class="l">3899: </a>
<a href="#3900" id="3900" class="l">3900: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$fields</span> == <span class="php-keyword1">true</span>)
<a href="#3901" id="3901" class="l">3901: </a>    {
<a href="#3902" id="3902" class="l">3902: </a>        <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>;
<a href="#3903" id="3903" class="l">3903: </a>        
<a href="#3904" id="3904" class="l">3904: </a>        <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$ignore</span>))
<a href="#3905" id="3905" class="l">3905: </a>        {
<a href="#3906" id="3906" class="l">3906: </a>            <span class="php-var">$ignore</span> = <span class="php-keyword1">array</span>(<span class="php-var">$ignore</span>);
<a href="#3907" id="3907" class="l">3907: </a>        }
<a href="#3908" id="3908" class="l">3908: </a>        
<a href="#3909" id="3909" class="l">3909: </a>        <span class="php-var">$form_html</span> = <span class="php-quote">&quot;&quot;</span>;
<a href="#3910" id="3910" class="l">3910: </a>        <span class="php-var">$field_parts</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">'&amp;'</span>, <span class="php-var">$field_parts</span>);
<a href="#3911" id="3911" class="l">3911: </a>        
<a href="#3912" id="3912" class="l">3912: </a>        <span class="php-keyword1">if</span>(!<span class="php-keyword1">empty</span>(<span class="php-var">$mybb</span>-&gt;input))
<a href="#3913" id="3913" class="l">3913: </a>        {
<a href="#3914" id="3914" class="l">3914: </a>            <span class="php-keyword1">foreach</span>(<span class="php-var">$mybb</span>-&gt;input <span class="php-keyword1">as</span> <span class="php-var">$name</span> =&gt; <span class="php-var">$value</span>)
<a href="#3915" id="3915" class="l">3915: </a>            {
<a href="#3916" id="3916" class="l">3916: </a>                <span class="php-keyword1">if</span>(<span class="php-keyword2">in_array</span>(<span class="php-var">$name</span>, <span class="php-var">$ignore</span>))
<a href="#3917" id="3917" class="l">3917: </a>                {
<a href="#3918" id="3918" class="l">3918: </a>                    <span class="php-keyword1">continue</span>;
<a href="#3919" id="3919" class="l">3919: </a>                }
<a href="#3920" id="3920" class="l">3920: </a>                
<a href="#3921" id="3921" class="l">3921: </a>                <span class="php-var">$form_html</span> .= <span class="php-quote">&quot;&lt;input type=\&quot;hidden\&quot; name=\&quot;&quot;</span>.<span class="php-keyword2">htmlspecialchars</span>((string)<span class="php-var">$name</span>).<span class="php-quote">&quot;\&quot; value=\&quot;&quot;</span>.<span class="php-keyword2">htmlspecialchars</span>((string)<span class="php-var">$value</span>).<span class="php-quote">&quot;\&quot; /&gt;\n&quot;</span>;
<a href="#3922" id="3922" class="l">3922: </a>            }
<a href="#3923" id="3923" class="l">3923: </a>        }
<a href="#3924" id="3924" class="l">3924: </a>        
<a href="#3925" id="3925" class="l">3925: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">array</span>(<span class="php-quote">'location'</span> =&gt; <span class="php-var">$location</span>, <span class="php-quote">'form_html'</span> =&gt; <span class="php-var">$form_html</span>, <span class="php-quote">'form_method'</span> =&gt; <span class="php-var">$mybb</span>-&gt;request_method);
<a href="#3926" id="3926" class="l">3926: </a>    }
<a href="#3927" id="3927" class="l">3927: </a>    <span class="php-keyword1">else</span>
<a href="#3928" id="3928" class="l">3928: </a>    {
<a href="#3929" id="3929" class="l">3929: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword1">isset</span>(<span class="php-var">$_SERVER</span>[<span class="php-quote">'QUERY_STRING'</span>]))
<a href="#3930" id="3930" class="l">3930: </a>        {
<a href="#3931" id="3931" class="l">3931: </a>            <span class="php-var">$location</span> .= <span class="php-quote">&quot;?&quot;</span>.htmlspecialchars_uni(<span class="php-var">$_SERVER</span>[<span class="php-quote">'QUERY_STRING'</span>]);
<a href="#3932" id="3932" class="l">3932: </a>        }
<a href="#3933" id="3933" class="l">3933: </a>        <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(<span class="php-keyword1">isset</span>(<span class="php-var">$_ENV</span>[<span class="php-quote">'QUERY_STRING'</span>]))
<a href="#3934" id="3934" class="l">3934: </a>        {
<a href="#3935" id="3935" class="l">3935: </a>            <span class="php-var">$location</span> .= <span class="php-quote">&quot;?&quot;</span>.htmlspecialchars_uni(<span class="php-var">$_ENV</span>[<span class="php-quote">'QUERY_STRING'</span>]);
<a href="#3936" id="3936" class="l">3936: </a>        }
<a href="#3937" id="3937" class="l">3937: </a>        
<a href="#3938" id="3938" class="l">3938: </a>        <span class="php-keyword1">if</span>((<span class="php-keyword1">isset</span>(<span class="php-var">$_SERVER</span>[<span class="php-quote">'REQUEST_METHOD'</span>]) &amp;&amp; <span class="php-var">$_SERVER</span>[<span class="php-quote">'REQUEST_METHOD'</span>] == <span class="php-quote">&quot;POST&quot;</span>) || (<span class="php-keyword1">isset</span>(<span class="php-var">$_ENV</span>[<span class="php-quote">'REQUEST_METHOD'</span>]) &amp;&amp; <span class="php-var">$_ENV</span>[<span class="php-quote">'REQUEST_METHOD'</span>] == <span class="php-quote">&quot;POST&quot;</span>))
<a href="#3939" id="3939" class="l">3939: </a>        {
<a href="#3940" id="3940" class="l">3940: </a>            <span class="php-var">$post_array</span> = <span class="php-keyword1">array</span>(<span class="php-quote">'action'</span>, <span class="php-quote">'fid'</span>, <span class="php-quote">'pid'</span>, <span class="php-quote">'tid'</span>, <span class="php-quote">'uid'</span>, <span class="php-quote">'eid'</span>);
<a href="#3941" id="3941" class="l">3941: </a>    
<a href="#3942" id="3942" class="l">3942: </a>            <span class="php-keyword1">foreach</span>(<span class="php-var">$post_array</span> <span class="php-keyword1">as</span> <span class="php-var">$var</span>)
<a href="#3943" id="3943" class="l">3943: </a>            {
<a href="#3944" id="3944" class="l">3944: </a>                <span class="php-keyword1">if</span>(<span class="php-keyword1">isset</span>(<span class="php-var">$_POST</span>[<span class="php-var">$var</span>]))
<a href="#3945" id="3945" class="l">3945: </a>                {
<a href="#3946" id="3946" class="l">3946: </a>                    <span class="php-var">$addloc</span>[] = <span class="php-keyword2">urlencode</span>(<span class="php-var">$var</span>).<span class="php-quote">'='</span>.<span class="php-keyword2">urlencode</span>(<span class="php-var">$_POST</span>[<span class="php-var">$var</span>]);
<a href="#3947" id="3947" class="l">3947: </a>                }
<a href="#3948" id="3948" class="l">3948: </a>            }
<a href="#3949" id="3949" class="l">3949: </a>    
<a href="#3950" id="3950" class="l">3950: </a>            <span class="php-keyword1">if</span>(<span class="php-keyword1">isset</span>(<span class="php-var">$addloc</span>) &amp;&amp; <span class="php-keyword2">is_array</span>(<span class="php-var">$addloc</span>))
<a href="#3951" id="3951" class="l">3951: </a>            {
<a href="#3952" id="3952" class="l">3952: </a>                <span class="php-keyword1">if</span>(<span class="php-keyword2">strpos</span>(<span class="php-var">$location</span>, <span class="php-quote">&quot;?&quot;</span>) === <span class="php-keyword1">false</span>)
<a href="#3953" id="3953" class="l">3953: </a>                {
<a href="#3954" id="3954" class="l">3954: </a>                    <span class="php-var">$location</span> .= <span class="php-quote">&quot;?&quot;</span>;
<a href="#3955" id="3955" class="l">3955: </a>                }
<a href="#3956" id="3956" class="l">3956: </a>                <span class="php-keyword1">else</span>
<a href="#3957" id="3957" class="l">3957: </a>                {
<a href="#3958" id="3958" class="l">3958: </a>                    <span class="php-var">$location</span> .= <span class="php-quote">&quot;&amp;amp;&quot;</span>;
<a href="#3959" id="3959" class="l">3959: </a>                }
<a href="#3960" id="3960" class="l">3960: </a>                <span class="php-var">$location</span> .= <span class="php-keyword2">implode</span>(<span class="php-quote">&quot;&amp;amp;&quot;</span>, <span class="php-var">$addloc</span>);
<a href="#3961" id="3961" class="l">3961: </a>            }
<a href="#3962" id="3962" class="l">3962: </a>        }
<a href="#3963" id="3963" class="l">3963: </a>
<a href="#3964" id="3964" class="l">3964: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">strlen</span>(<span class="php-var">$location</span>) &gt; <span class="php-num">150</span>)
<a href="#3965" id="3965" class="l">3965: </a>        {
<a href="#3966" id="3966" class="l">3966: </a>            <span class="php-var">$location</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$location</span>, <span class="php-num">0</span>, <span class="php-num">150</span>);
<a href="#3967" id="3967" class="l">3967: </a>        }
<a href="#3968" id="3968" class="l">3968: </a>
<a href="#3969" id="3969" class="l">3969: </a>        <span class="php-keyword1">return</span> <span class="php-var">$location</span>;
<a href="#3970" id="3970" class="l">3970: </a>    }
<a href="#3971" id="3971" class="l">3971: </a>}
<a href="#3972" id="3972" class="l">3972: </a>
<a href="#3973" id="3973" class="l">3973: </a><span class="php-comment">/**
</span><a href="#3974" id="3974" class="l">3974: </a><span class="php-comment"> * Build a theme selection menu
</span><a href="#3975" id="3975" class="l">3975: </a><span class="php-comment"> *
</span><a href="#3976" id="3976" class="l">3976: </a><span class="php-comment"> * @param string The name of the menu
</span><a href="#3977" id="3977" class="l">3977: </a><span class="php-comment"> * @param int The ID of the selected theme
</span><a href="#3978" id="3978" class="l">3978: </a><span class="php-comment"> * @param int The ID of the parent theme to select from
</span><a href="#3979" id="3979" class="l">3979: </a><span class="php-comment"> * @param int The current selection depth
</span><a href="#3980" id="3980" class="l">3980: </a><span class="php-comment"> * @param boolean Whether or not to override usergroup permissions (true to override)
</span><a href="#3981" id="3981" class="l">3981: </a><span class="php-comment"> * @return string The theme selection list
</span><a href="#3982" id="3982" class="l">3982: </a><span class="php-comment"> */</span>
<a href="#3983" id="3983" class="l">3983: </a><span class="php-keyword1">function</span> build_theme_select(<span class="php-var">$name</span>, <span class="php-var">$selected</span>=<span class="php-quote">&quot;&quot;</span>, <span class="php-var">$tid</span>=<span class="php-num">0</span>, <span class="php-var">$depth</span>=<span class="php-quote">&quot;&quot;</span>, <span class="php-var">$usergroup_override</span>=<span class="php-keyword1">false</span>)
<a href="#3984" id="3984" class="l">3984: </a>{
<a href="#3985" id="3985" class="l">3985: </a>    <span class="php-keyword1">global</span> <span class="php-var">$db</span>, <span class="php-var">$themeselect</span>, <span class="php-var">$tcache</span>, <span class="php-var">$lang</span>, <span class="php-var">$mybb</span>, <span class="php-var">$limit</span>;
<a href="#3986" id="3986" class="l">3986: </a>
<a href="#3987" id="3987" class="l">3987: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$tid</span> == <span class="php-num">0</span>)
<a href="#3988" id="3988" class="l">3988: </a>    {
<a href="#3989" id="3989" class="l">3989: </a>        <span class="php-var">$themeselect</span> = <span class="php-quote">&quot;&lt;select name=\&quot;</span><span class="php-var">$name</span><span class="php-quote">\&quot;&gt;&quot;</span>;
<a href="#3990" id="3990" class="l">3990: </a>        <span class="php-var">$themeselect</span> .= <span class="php-quote">&quot;&lt;option value=\&quot;0\&quot;&gt;&quot;</span>.<span class="php-var">$lang</span>-&gt;use_default.<span class="php-quote">&quot;&lt;/option&gt;\n&quot;</span>;
<a href="#3991" id="3991" class="l">3991: </a>        <span class="php-var">$themeselect</span> .= <span class="php-quote">&quot;&lt;option value=\&quot;0\&quot;&gt;-----------&lt;/option&gt;\n&quot;</span>;
<a href="#3992" id="3992" class="l">3992: </a>        <span class="php-var">$tid</span> = <span class="php-num">1</span>;
<a href="#3993" id="3993" class="l">3993: </a>    }
<a href="#3994" id="3994" class="l">3994: </a>
<a href="#3995" id="3995" class="l">3995: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$tcache</span>))
<a href="#3996" id="3996" class="l">3996: </a>    {
<a href="#3997" id="3997" class="l">3997: </a>        <span class="php-var">$query</span> = <span class="php-var">$db</span>-&gt;simple_select(<span class="php-quote">&quot;themes&quot;</span>, <span class="php-quote">&quot;name, pid, tid, allowedgroups&quot;</span>, <span class="php-quote">&quot;pid != '0'&quot;</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'order_by'</span> =&gt; <span class="php-quote">'pid, name'</span>));
<a href="#3998" id="3998" class="l">3998: </a>
<a href="#3999" id="3999" class="l">3999: </a>        <span class="php-keyword1">while</span>(<span class="php-var">$theme</span> = <span class="php-var">$db</span>-&gt;fetch_array(<span class="php-var">$query</span>))
<a href="#4000" id="4000" class="l">4000: </a>        {
<a href="#4001" id="4001" class="l">4001: </a>            <span class="php-var">$tcache</span>[<span class="php-var">$theme</span>[<span class="php-quote">'pid'</span>]][<span class="php-var">$theme</span>[<span class="php-quote">'tid'</span>]] = <span class="php-var">$theme</span>;
<a href="#4002" id="4002" class="l">4002: </a>        }
<a href="#4003" id="4003" class="l">4003: </a>    }
<a href="#4004" id="4004" class="l">4004: </a>
<a href="#4005" id="4005" class="l">4005: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$tcache</span>[<span class="php-var">$tid</span>]))
<a href="#4006" id="4006" class="l">4006: </a>    {
<a href="#4007" id="4007" class="l">4007: </a>        <span class="php-comment">// Figure out what groups this user is in</span>
<a href="#4008" id="4008" class="l">4008: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'additionalgroups'</span>])
<a href="#4009" id="4009" class="l">4009: </a>        {
<a href="#4010" id="4010" class="l">4010: </a>            <span class="php-var">$in_groups</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">&quot;,&quot;</span>, <span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'additionalgroups'</span>]);
<a href="#4011" id="4011" class="l">4011: </a>        }
<a href="#4012" id="4012" class="l">4012: </a>        <span class="php-var">$in_groups</span>[] = <span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'usergroup'</span>];
<a href="#4013" id="4013" class="l">4013: </a>
<a href="#4014" id="4014" class="l">4014: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$tcache</span>[<span class="php-var">$tid</span>] <span class="php-keyword1">as</span> <span class="php-var">$theme</span>)
<a href="#4015" id="4015" class="l">4015: </a>        {
<a href="#4016" id="4016" class="l">4016: </a>            <span class="php-var">$sel</span> = <span class="php-quote">&quot;&quot;</span>;
<a href="#4017" id="4017" class="l">4017: </a>            <span class="php-comment">// Make theme allowed groups into array</span>
<a href="#4018" id="4018" class="l">4018: </a>            <span class="php-var">$is_allowed</span> = <span class="php-keyword1">false</span>;
<a href="#4019" id="4019" class="l">4019: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$theme</span>[<span class="php-quote">'allowedgroups'</span>] != <span class="php-quote">&quot;all&quot;</span>)
<a href="#4020" id="4020" class="l">4020: </a>            {
<a href="#4021" id="4021" class="l">4021: </a>                <span class="php-var">$allowed_groups</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">&quot;,&quot;</span>, <span class="php-var">$theme</span>[<span class="php-quote">'allowedgroups'</span>]);
<a href="#4022" id="4022" class="l">4022: </a>                <span class="php-comment">// See if groups user is in is allowed</span>
<a href="#4023" id="4023" class="l">4023: </a>                <span class="php-keyword1">foreach</span>(<span class="php-var">$allowed_groups</span> <span class="php-keyword1">as</span> <span class="php-var">$agid</span>)
<a href="#4024" id="4024" class="l">4024: </a>                {
<a href="#4025" id="4025" class="l">4025: </a>                    <span class="php-keyword1">if</span>(<span class="php-keyword2">in_array</span>(<span class="php-var">$agid</span>, <span class="php-var">$in_groups</span>))
<a href="#4026" id="4026" class="l">4026: </a>                    {
<a href="#4027" id="4027" class="l">4027: </a>                        <span class="php-var">$is_allowed</span> = <span class="php-keyword1">true</span>;
<a href="#4028" id="4028" class="l">4028: </a>                        <span class="php-keyword1">break</span>;
<a href="#4029" id="4029" class="l">4029: </a>                    }
<a href="#4030" id="4030" class="l">4030: </a>                }
<a href="#4031" id="4031" class="l">4031: </a>            }
<a href="#4032" id="4032" class="l">4032: </a>
<a href="#4033" id="4033" class="l">4033: </a>            <span class="php-comment">// Show theme if allowed, or if override is on</span>
<a href="#4034" id="4034" class="l">4034: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$is_allowed</span> || <span class="php-var">$theme</span>[<span class="php-quote">'allowedgroups'</span>] == <span class="php-quote">&quot;all&quot;</span> || <span class="php-var">$usergroup_override</span> == <span class="php-keyword1">true</span>)
<a href="#4035" id="4035" class="l">4035: </a>            {
<a href="#4036" id="4036" class="l">4036: </a>                <span class="php-keyword1">if</span>(<span class="php-var">$theme</span>[<span class="php-quote">'tid'</span>] == <span class="php-var">$selected</span>)
<a href="#4037" id="4037" class="l">4037: </a>                {
<a href="#4038" id="4038" class="l">4038: </a>                    <span class="php-var">$sel</span> = <span class="php-quote">&quot; selected=\&quot;selected\&quot;&quot;</span>;
<a href="#4039" id="4039" class="l">4039: </a>                }
<a href="#4040" id="4040" class="l">4040: </a>
<a href="#4041" id="4041" class="l">4041: </a>                <span class="php-keyword1">if</span>(<span class="php-var">$theme</span>[<span class="php-quote">'pid'</span>] != <span class="php-num">0</span>)
<a href="#4042" id="4042" class="l">4042: </a>                {
<a href="#4043" id="4043" class="l">4043: </a>                    <span class="php-var">$themeselect</span> .= <span class="php-quote">&quot;&lt;option value=\&quot;&quot;</span>.<span class="php-var">$theme</span>[<span class="php-quote">'tid'</span>].<span class="php-quote">&quot;\&quot;</span><span class="php-var">$sel</span><span class="php-quote">&gt;&quot;</span>.<span class="php-var">$depth</span>.<span class="php-var">$theme</span>[<span class="php-quote">'name'</span>].<span class="php-quote">&quot;&lt;/option&gt;&quot;</span>;
<a href="#4044" id="4044" class="l">4044: </a>                    <span class="php-var">$depthit</span> = <span class="php-var">$depth</span>.<span class="php-quote">&quot;--&quot;</span>;
<a href="#4045" id="4045" class="l">4045: </a>                }
<a href="#4046" id="4046" class="l">4046: </a>
<a href="#4047" id="4047" class="l">4047: </a>                <span class="php-keyword1">if</span>(<span class="php-keyword2">array_key_exists</span>(<span class="php-var">$theme</span>[<span class="php-quote">'tid'</span>], <span class="php-var">$tcache</span>))
<a href="#4048" id="4048" class="l">4048: </a>                {
<a href="#4049" id="4049" class="l">4049: </a>                    build_theme_select(<span class="php-var">$name</span>, <span class="php-var">$selected</span>, <span class="php-var">$theme</span>[<span class="php-quote">'tid'</span>], <span class="php-var">$depthit</span>, <span class="php-var">$usergroup_override</span>);
<a href="#4050" id="4050" class="l">4050: </a>                }
<a href="#4051" id="4051" class="l">4051: </a>            }
<a href="#4052" id="4052" class="l">4052: </a>        }
<a href="#4053" id="4053" class="l">4053: </a>    }
<a href="#4054" id="4054" class="l">4054: </a>
<a href="#4055" id="4055" class="l">4055: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$tid</span> == <span class="php-num">1</span>)
<a href="#4056" id="4056" class="l">4056: </a>    {
<a href="#4057" id="4057" class="l">4057: </a>        <span class="php-var">$themeselect</span> .= <span class="php-quote">&quot;&lt;/select&gt;&quot;</span>;
<a href="#4058" id="4058" class="l">4058: </a>    }
<a href="#4059" id="4059" class="l">4059: </a>
<a href="#4060" id="4060" class="l">4060: </a>    <span class="php-keyword1">return</span> <span class="php-var">$themeselect</span>;
<a href="#4061" id="4061" class="l">4061: </a>}
<a href="#4062" id="4062" class="l">4062: </a>
<a href="#4063" id="4063" class="l">4063: </a><span class="php-comment">/**
</span><a href="#4064" id="4064" class="l">4064: </a><span class="php-comment"> * Custom function for htmlspecialchars which takes in to account unicode
</span><a href="#4065" id="4065" class="l">4065: </a><span class="php-comment"> *
</span><a href="#4066" id="4066" class="l">4066: </a><span class="php-comment"> * @param string The string to format
</span><a href="#4067" id="4067" class="l">4067: </a><span class="php-comment"> * @return string The string with htmlspecialchars applied
</span><a href="#4068" id="4068" class="l">4068: </a><span class="php-comment"> */</span>
<a href="#4069" id="4069" class="l">4069: </a><span class="php-keyword1">function</span> htmlspecialchars_uni(<span class="php-var">$message</span>)
<a href="#4070" id="4070" class="l">4070: </a>{
<a href="#4071" id="4071" class="l">4071: </a>    <span class="php-var">$message</span> = <span class="php-keyword2">preg_replace</span>(<span class="php-quote">&quot;#&amp;(?!\#[0-9]+;)#si&quot;</span>, <span class="php-quote">&quot;&amp;amp;&quot;</span>, <span class="php-var">$message</span>); <span class="php-comment">// Fix &amp; but allow unicode</span>
<a href="#4072" id="4072" class="l">4072: </a>    <span class="php-var">$message</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;&lt;&quot;</span>, <span class="php-quote">&quot;&amp;lt;&quot;</span>, <span class="php-var">$message</span>);
<a href="#4073" id="4073" class="l">4073: </a>    <span class="php-var">$message</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;&gt;&quot;</span>, <span class="php-quote">&quot;&amp;gt;&quot;</span>, <span class="php-var">$message</span>);
<a href="#4074" id="4074" class="l">4074: </a>    <span class="php-var">$message</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;\&quot;&quot;</span>, <span class="php-quote">&quot;&amp;quot;&quot;</span>, <span class="php-var">$message</span>);
<a href="#4075" id="4075" class="l">4075: </a>    <span class="php-keyword1">return</span> <span class="php-var">$message</span>;
<a href="#4076" id="4076" class="l">4076: </a>}
<a href="#4077" id="4077" class="l">4077: </a>
<a href="#4078" id="4078" class="l">4078: </a><span class="php-comment">/**
</span><a href="#4079" id="4079" class="l">4079: </a><span class="php-comment"> * Custom function for formatting numbers.
</span><a href="#4080" id="4080" class="l">4080: </a><span class="php-comment"> *
</span><a href="#4081" id="4081" class="l">4081: </a><span class="php-comment"> * @param int The number to format.
</span><a href="#4082" id="4082" class="l">4082: </a><span class="php-comment"> * @return int The formatted number.
</span><a href="#4083" id="4083" class="l">4083: </a><span class="php-comment"> */</span>
<a href="#4084" id="4084" class="l">4084: </a><span class="php-keyword1">function</span> my_number_format(<span class="php-var">$number</span>)
<a href="#4085" id="4085" class="l">4085: </a>{
<a href="#4086" id="4086" class="l">4086: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>;
<a href="#4087" id="4087" class="l">4087: </a>
<a href="#4088" id="4088" class="l">4088: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$number</span> == <span class="php-quote">&quot;-&quot;</span>)
<a href="#4089" id="4089" class="l">4089: </a>    {
<a href="#4090" id="4090" class="l">4090: </a>        <span class="php-keyword1">return</span> <span class="php-var">$number</span>;
<a href="#4091" id="4091" class="l">4091: </a>    }
<a href="#4092" id="4092" class="l">4092: </a>
<a href="#4093" id="4093" class="l">4093: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">is_int</span>(<span class="php-var">$number</span>))
<a href="#4094" id="4094" class="l">4094: </a>    {
<a href="#4095" id="4095" class="l">4095: </a>        <span class="php-keyword1">return</span> <span class="php-keyword2">number_format</span>(<span class="php-var">$number</span>, <span class="php-num">0</span>, <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'decpoint'</span>], <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'thousandssep'</span>]);
<a href="#4096" id="4096" class="l">4096: </a>    }
<a href="#4097" id="4097" class="l">4097: </a>    <span class="php-keyword1">else</span>
<a href="#4098" id="4098" class="l">4098: </a>    {
<a href="#4099" id="4099" class="l">4099: </a>        <span class="php-var">$parts</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">'.'</span>, <span class="php-var">$number</span>);
<a href="#4100" id="4100" class="l">4100: </a>
<a href="#4101" id="4101" class="l">4101: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword1">isset</span>(<span class="php-var">$parts</span>[<span class="php-num">1</span>]))
<a href="#4102" id="4102" class="l">4102: </a>        {
<a href="#4103" id="4103" class="l">4103: </a>            <span class="php-var">$decimals</span> = my_strlen(<span class="php-var">$parts</span>[<span class="php-num">1</span>]);
<a href="#4104" id="4104" class="l">4104: </a>        }
<a href="#4105" id="4105" class="l">4105: </a>        <span class="php-keyword1">else</span>
<a href="#4106" id="4106" class="l">4106: </a>        {
<a href="#4107" id="4107" class="l">4107: </a>            <span class="php-var">$decimals</span> = <span class="php-num">0</span>;
<a href="#4108" id="4108" class="l">4108: </a>        }
<a href="#4109" id="4109" class="l">4109: </a>
<a href="#4110" id="4110" class="l">4110: </a>        <span class="php-keyword1">return</span> <span class="php-keyword2">number_format</span>((double)<span class="php-var">$number</span>, <span class="php-var">$decimals</span>, <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'decpoint'</span>], <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'thousandssep'</span>]);
<a href="#4111" id="4111" class="l">4111: </a>    }
<a href="#4112" id="4112" class="l">4112: </a>}
<a href="#4113" id="4113" class="l">4113: </a>
<a href="#4114" id="4114" class="l">4114: </a><span class="php-keyword1">function</span> convert_through_utf8(<span class="php-var">$str</span>, <span class="php-var">$to</span>=<span class="php-keyword1">true</span>)
<a href="#4115" id="4115" class="l">4115: </a>{
<a href="#4116" id="4116" class="l">4116: </a>    <span class="php-keyword1">global</span> <span class="php-var">$lang</span>;
<a href="#4117" id="4117" class="l">4117: </a>    <span class="php-keyword1">static</span> <span class="php-var">$charset</span>;
<a href="#4118" id="4118" class="l">4118: </a>    <span class="php-keyword1">static</span> <span class="php-var">$use_mb</span>;
<a href="#4119" id="4119" class="l">4119: </a>    <span class="php-keyword1">static</span> <span class="php-var">$use_iconv</span>;
<a href="#4120" id="4120" class="l">4120: </a>    
<a href="#4121" id="4121" class="l">4121: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword1">isset</span>(<span class="php-var">$charset</span>))
<a href="#4122" id="4122" class="l">4122: </a>    {
<a href="#4123" id="4123" class="l">4123: </a>        <span class="php-var">$charset</span> = my_strtolower(<span class="php-var">$lang</span>-&gt;settings[<span class="php-quote">'charset'</span>]);
<a href="#4124" id="4124" class="l">4124: </a>    }
<a href="#4125" id="4125" class="l">4125: </a>    
<a href="#4126" id="4126" class="l">4126: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$charset</span> == <span class="php-quote">&quot;utf-8&quot;</span>)
<a href="#4127" id="4127" class="l">4127: </a>    {
<a href="#4128" id="4128" class="l">4128: </a>        <span class="php-keyword1">return</span> <span class="php-var">$str</span>;
<a href="#4129" id="4129" class="l">4129: </a>    }
<a href="#4130" id="4130" class="l">4130: </a>    
<a href="#4131" id="4131" class="l">4131: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword1">isset</span>(<span class="php-var">$use_iconv</span>))
<a href="#4132" id="4132" class="l">4132: </a>    {
<a href="#4133" id="4133" class="l">4133: </a>        <span class="php-var">$use_iconv</span> = <span class="php-keyword2">function_exists</span>(<span class="php-quote">&quot;iconv&quot;</span>);
<a href="#4134" id="4134" class="l">4134: </a>    }
<a href="#4135" id="4135" class="l">4135: </a>    
<a href="#4136" id="4136" class="l">4136: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword1">isset</span>(<span class="php-var">$use_mb</span>))
<a href="#4137" id="4137" class="l">4137: </a>    {
<a href="#4138" id="4138" class="l">4138: </a>        <span class="php-var">$use_mb</span> = <span class="php-keyword2">function_exists</span>(<span class="php-quote">&quot;mb_convert_encoding&quot;</span>);
<a href="#4139" id="4139" class="l">4139: </a>    }
<a href="#4140" id="4140" class="l">4140: </a>    
<a href="#4141" id="4141" class="l">4141: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$use_iconv</span> || <span class="php-var">$use_mb</span>)
<a href="#4142" id="4142" class="l">4142: </a>    {
<a href="#4143" id="4143" class="l">4143: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$to</span>)
<a href="#4144" id="4144" class="l">4144: </a>        {
<a href="#4145" id="4145" class="l">4145: </a>            <span class="php-var">$from_charset</span> = <span class="php-var">$lang</span>-&gt;settings[<span class="php-quote">'charset'</span>];
<a href="#4146" id="4146" class="l">4146: </a>            <span class="php-var">$to_charset</span> = <span class="php-quote">&quot;UTF-8&quot;</span>;
<a href="#4147" id="4147" class="l">4147: </a>        }
<a href="#4148" id="4148" class="l">4148: </a>        <span class="php-keyword1">else</span>
<a href="#4149" id="4149" class="l">4149: </a>        {
<a href="#4150" id="4150" class="l">4150: </a>            <span class="php-var">$from_charset</span> = <span class="php-quote">&quot;UTF-8&quot;</span>;
<a href="#4151" id="4151" class="l">4151: </a>            <span class="php-var">$to_charset</span> = <span class="php-var">$lang</span>-&gt;settings[<span class="php-quote">'charset'</span>];
<a href="#4152" id="4152" class="l">4152: </a>        }
<a href="#4153" id="4153" class="l">4153: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$use_iconv</span>)
<a href="#4154" id="4154" class="l">4154: </a>        {
<a href="#4155" id="4155" class="l">4155: </a>            <span class="php-keyword1">return</span> <span class="php-keyword2">iconv</span>(<span class="php-var">$from_charset</span>, <span class="php-var">$to_charset</span>.<span class="php-quote">&quot;//IGNORE&quot;</span>, <span class="php-var">$str</span>);
<a href="#4156" id="4156" class="l">4156: </a>        }
<a href="#4157" id="4157" class="l">4157: </a>        <span class="php-keyword1">else</span>
<a href="#4158" id="4158" class="l">4158: </a>        {
<a href="#4159" id="4159" class="l">4159: </a>            <span class="php-keyword1">return</span> @<span class="php-keyword2">mb_convert_encoding</span>(<span class="php-var">$str</span>, <span class="php-var">$to_charset</span>, <span class="php-var">$from_charset</span>);
<a href="#4160" id="4160" class="l">4160: </a>        }
<a href="#4161" id="4161" class="l">4161: </a>    }
<a href="#4162" id="4162" class="l">4162: </a>    <span class="php-keyword1">elseif</span>(<span class="php-var">$charset</span> == <span class="php-quote">&quot;iso-8859-1&quot;</span> &amp;&amp; <span class="php-keyword2">function_exists</span>(<span class="php-quote">&quot;utf8_encode&quot;</span>))
<a href="#4163" id="4163" class="l">4163: </a>    {
<a href="#4164" id="4164" class="l">4164: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$to</span>)
<a href="#4165" id="4165" class="l">4165: </a>        {
<a href="#4166" id="4166" class="l">4166: </a>            <span class="php-keyword1">return</span> <span class="php-keyword2">utf8_encode</span>(<span class="php-var">$str</span>);
<a href="#4167" id="4167" class="l">4167: </a>        }
<a href="#4168" id="4168" class="l">4168: </a>        <span class="php-keyword1">else</span>
<a href="#4169" id="4169" class="l">4169: </a>        {
<a href="#4170" id="4170" class="l">4170: </a>            <span class="php-keyword1">return</span> <span class="php-keyword2">utf8_decode</span>(<span class="php-var">$str</span>);
<a href="#4171" id="4171" class="l">4171: </a>        }
<a href="#4172" id="4172" class="l">4172: </a>    }
<a href="#4173" id="4173" class="l">4173: </a>    <span class="php-keyword1">else</span>
<a href="#4174" id="4174" class="l">4174: </a>    {
<a href="#4175" id="4175" class="l">4175: </a>        <span class="php-keyword1">return</span> <span class="php-var">$str</span>;
<a href="#4176" id="4176" class="l">4176: </a>    }
<a href="#4177" id="4177" class="l">4177: </a>}
<a href="#4178" id="4178" class="l">4178: </a>
<a href="#4179" id="4179" class="l">4179: </a><span class="php-comment">/**
</span><a href="#4180" id="4180" class="l">4180: </a><span class="php-comment"> * Replacement function for PHP's wordwrap(). This version does not break up HTML tags, URLs or unicode references.
</span><a href="#4181" id="4181" class="l">4181: </a><span class="php-comment"> *
</span><a href="#4182" id="4182" class="l">4182: </a><span class="php-comment"> * @param string The string to be word wrapped
</span><a href="#4183" id="4183" class="l">4183: </a><span class="php-comment"> * @return string The word wraped string
</span><a href="#4184" id="4184" class="l">4184: </a><span class="php-comment"> */</span>
<a href="#4185" id="4185" class="l">4185: </a><span class="php-keyword1">function</span> my_wordwrap(<span class="php-var">$message</span>)
<a href="#4186" id="4186" class="l">4186: </a>{
<a href="#4187" id="4187" class="l">4187: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>;
<a href="#4188" id="4188" class="l">4188: </a>
<a href="#4189" id="4189" class="l">4189: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'wordwrap'</span>] &gt; <span class="php-num">0</span>)
<a href="#4190" id="4190" class="l">4190: </a>    {
<a href="#4191" id="4191" class="l">4191: </a>        <span class="php-var">$message</span> = convert_through_utf8(<span class="php-var">$message</span>);
<a href="#4192" id="4192" class="l">4192: </a>        
<a href="#4193" id="4193" class="l">4193: </a>        <span class="php-keyword1">if</span>(!(<span class="php-var">$new_message</span> = @<span class="php-keyword2">preg_replace</span>(<span class="php-quote">&quot;#(((?&gt;[^\s&amp;/&lt;&gt;\&quot;\\-\[\]])|(&amp;\#[a-z0-9]{1,10};)){</span><span class="php-var">{$mybb-&gt;settings['wordwrap']}</span><span class="php-quote">})#u&quot;</span>, <span class="php-quote">&quot;</span><span class="php-var">$0</span><span class="php-quote">&amp;#8203;&quot;</span>, <span class="php-var">$message</span>)))
<a href="#4194" id="4194" class="l">4194: </a>        {
<a href="#4195" id="4195" class="l">4195: </a>            <span class="php-var">$new_message</span> = <span class="php-keyword2">preg_replace</span>(<span class="php-quote">&quot;#(((?&gt;[^\s&amp;/&lt;&gt;\&quot;\\-\[\]])|(&amp;\#[a-z0-9]{1,10};)){</span><span class="php-var">{$mybb-&gt;settings['wordwrap']}</span><span class="php-quote">})#&quot;</span>, <span class="php-quote">&quot;</span><span class="php-var">$0</span><span class="php-quote">&amp;#8203;&quot;</span>, <span class="php-var">$message</span>); 
<a href="#4196" id="4196" class="l">4196: </a>        }
<a href="#4197" id="4197" class="l">4197: </a>        
<a href="#4198" id="4198" class="l">4198: </a>        <span class="php-var">$new_message</span> = convert_through_utf8(<span class="php-var">$new_message</span>, <span class="php-keyword1">false</span>);
<a href="#4199" id="4199" class="l">4199: </a>        
<a href="#4200" id="4200" class="l">4200: </a>        <span class="php-keyword1">return</span> <span class="php-var">$new_message</span>;
<a href="#4201" id="4201" class="l">4201: </a>    }
<a href="#4202" id="4202" class="l">4202: </a>
<a href="#4203" id="4203" class="l">4203: </a>    <span class="php-keyword1">return</span> <span class="php-var">$message</span>;
<a href="#4204" id="4204" class="l">4204: </a>}
<a href="#4205" id="4205" class="l">4205: </a>
<a href="#4206" id="4206" class="l">4206: </a><span class="php-comment">/**
</span><a href="#4207" id="4207" class="l">4207: </a><span class="php-comment"> * Workaround for date limitation in PHP to establish the day of a birthday (Provided by meme)
</span><a href="#4208" id="4208" class="l">4208: </a><span class="php-comment"> *
</span><a href="#4209" id="4209" class="l">4209: </a><span class="php-comment"> * @param int The month of the birthday
</span><a href="#4210" id="4210" class="l">4210: </a><span class="php-comment"> * @param int The day of the birthday
</span><a href="#4211" id="4211" class="l">4211: </a><span class="php-comment"> * @param int The year of the bithday
</span><a href="#4212" id="4212" class="l">4212: </a><span class="php-comment"> * @return int The numeric day of the week for the birthday
</span><a href="#4213" id="4213" class="l">4213: </a><span class="php-comment"> */</span>
<a href="#4214" id="4214" class="l">4214: </a><span class="php-keyword1">function</span> get_weekday(<span class="php-var">$month</span>, <span class="php-var">$day</span>, <span class="php-var">$year</span>)
<a href="#4215" id="4215" class="l">4215: </a>{
<a href="#4216" id="4216" class="l">4216: </a>    <span class="php-var">$h</span> = <span class="php-num">4</span>;
<a href="#4217" id="4217" class="l">4217: </a>
<a href="#4218" id="4218" class="l">4218: </a>    <span class="php-keyword1">for</span>(<span class="php-var">$i</span> = <span class="php-num">1969</span>; <span class="php-var">$i</span> &gt;= <span class="php-var">$year</span>; <span class="php-var">$i</span>--)
<a href="#4219" id="4219" class="l">4219: </a>    {
<a href="#4220" id="4220" class="l">4220: </a>        <span class="php-var">$j</span> = get_bdays(<span class="php-var">$i</span>);
<a href="#4221" id="4221" class="l">4221: </a>
<a href="#4222" id="4222" class="l">4222: </a>        <span class="php-keyword1">for</span>(<span class="php-var">$k</span> = <span class="php-num">11</span>; <span class="php-var">$k</span> &gt;= <span class="php-num">0</span>; <span class="php-var">$k</span>--)
<a href="#4223" id="4223" class="l">4223: </a>        {
<a href="#4224" id="4224" class="l">4224: </a>            <span class="php-var">$l</span> = (<span class="php-var">$k</span> + <span class="php-num">1</span>);
<a href="#4225" id="4225" class="l">4225: </a>
<a href="#4226" id="4226" class="l">4226: </a>            <span class="php-keyword1">for</span>(<span class="php-var">$m</span> = <span class="php-var">$j</span>[<span class="php-var">$k</span>]; <span class="php-var">$m</span> &gt;= <span class="php-num">1</span>; <span class="php-var">$m</span>--)
<a href="#4227" id="4227" class="l">4227: </a>            {
<a href="#4228" id="4228" class="l">4228: </a>                <span class="php-var">$h</span>--;
<a href="#4229" id="4229" class="l">4229: </a>
<a href="#4230" id="4230" class="l">4230: </a>                <span class="php-keyword1">if</span>(<span class="php-var">$i</span> == <span class="php-var">$year</span> &amp;&amp; <span class="php-var">$l</span> == <span class="php-var">$month</span> &amp;&amp; <span class="php-var">$m</span> == <span class="php-var">$day</span>)
<a href="#4231" id="4231" class="l">4231: </a>                {
<a href="#4232" id="4232" class="l">4232: </a>                    <span class="php-keyword1">return</span> <span class="php-var">$h</span>;
<a href="#4233" id="4233" class="l">4233: </a>                }
<a href="#4234" id="4234" class="l">4234: </a>
<a href="#4235" id="4235" class="l">4235: </a>                <span class="php-keyword1">if</span>(<span class="php-var">$h</span> == <span class="php-num">0</span>)
<a href="#4236" id="4236" class="l">4236: </a>                {
<a href="#4237" id="4237" class="l">4237: </a>                    <span class="php-var">$h</span> = <span class="php-num">7</span>;
<a href="#4238" id="4238" class="l">4238: </a>                }
<a href="#4239" id="4239" class="l">4239: </a>            }
<a href="#4240" id="4240" class="l">4240: </a>        }
<a href="#4241" id="4241" class="l">4241: </a>    }
<a href="#4242" id="4242" class="l">4242: </a>}
<a href="#4243" id="4243" class="l">4243: </a>
<a href="#4244" id="4244" class="l">4244: </a><span class="php-comment">/**
</span><a href="#4245" id="4245" class="l">4245: </a><span class="php-comment"> * Workaround for date limitation in PHP to establish the day of a birthday (Provided by meme)
</span><a href="#4246" id="4246" class="l">4246: </a><span class="php-comment"> *
</span><a href="#4247" id="4247" class="l">4247: </a><span class="php-comment"> * @param int The year.
</span><a href="#4248" id="4248" class="l">4248: </a><span class="php-comment"> * @return array The number of days in each month of that year
</span><a href="#4249" id="4249" class="l">4249: </a><span class="php-comment"> */</span>
<a href="#4250" id="4250" class="l">4250: </a><span class="php-keyword1">function</span> get_bdays(<span class="php-var">$in</span>)
<a href="#4251" id="4251" class="l">4251: </a>{
<a href="#4252" id="4252" class="l">4252: </a>    <span class="php-keyword1">return</span> <span class="php-keyword1">array</span>(
<a href="#4253" id="4253" class="l">4253: </a>        <span class="php-num">31</span>,
<a href="#4254" id="4254" class="l">4254: </a>        (<span class="php-var">$in</span> % <span class="php-num">4</span> == <span class="php-num">0</span> &amp;&amp; (<span class="php-var">$in</span> % <span class="php-num">100</span> &gt; <span class="php-num">0</span> || <span class="php-var">$in</span> % <span class="php-num">400</span> == <span class="php-num">0</span>) ? <span class="php-num">29</span> : <span class="php-num">28</span>),
<a href="#4255" id="4255" class="l">4255: </a>        <span class="php-num">31</span>,
<a href="#4256" id="4256" class="l">4256: </a>        <span class="php-num">30</span>,
<a href="#4257" id="4257" class="l">4257: </a>        <span class="php-num">31</span>,
<a href="#4258" id="4258" class="l">4258: </a>        <span class="php-num">30</span>,
<a href="#4259" id="4259" class="l">4259: </a>        <span class="php-num">31</span>,
<a href="#4260" id="4260" class="l">4260: </a>        <span class="php-num">31</span>,
<a href="#4261" id="4261" class="l">4261: </a>        <span class="php-num">30</span>,
<a href="#4262" id="4262" class="l">4262: </a>        <span class="php-num">31</span>,
<a href="#4263" id="4263" class="l">4263: </a>        <span class="php-num">30</span>,
<a href="#4264" id="4264" class="l">4264: </a>        <span class="php-num">31</span>
<a href="#4265" id="4265" class="l">4265: </a>    );
<a href="#4266" id="4266" class="l">4266: </a>}
<a href="#4267" id="4267" class="l">4267: </a>
<a href="#4268" id="4268" class="l">4268: </a><span class="php-comment">/**
</span><a href="#4269" id="4269" class="l">4269: </a><span class="php-comment"> * Formats a birthday appropriately
</span><a href="#4270" id="4270" class="l">4270: </a><span class="php-comment"> *
</span><a href="#4271" id="4271" class="l">4271: </a><span class="php-comment"> * @param string The PHP date format string
</span><a href="#4272" id="4272" class="l">4272: </a><span class="php-comment"> * @param int The month of the birthday
</span><a href="#4273" id="4273" class="l">4273: </a><span class="php-comment"> * @param int The day of the birthday
</span><a href="#4274" id="4274" class="l">4274: </a><span class="php-comment"> * @param int The year of the birthday
</span><a href="#4275" id="4275" class="l">4275: </a><span class="php-comment"> * @param int The weekday of the birthday
</span><a href="#4276" id="4276" class="l">4276: </a><span class="php-comment"> * @return string The formatted birthday
</span><a href="#4277" id="4277" class="l">4277: </a><span class="php-comment"> */</span>
<a href="#4278" id="4278" class="l">4278: </a><span class="php-keyword1">function</span> format_bdays(<span class="php-var">$display</span>, <span class="php-var">$bm</span>, <span class="php-var">$bd</span>, <span class="php-var">$by</span>, <span class="php-var">$wd</span>)
<a href="#4279" id="4279" class="l">4279: </a>{
<a href="#4280" id="4280" class="l">4280: </a>    <span class="php-keyword1">global</span> <span class="php-var">$lang</span>;
<a href="#4281" id="4281" class="l">4281: </a>
<a href="#4282" id="4282" class="l">4282: </a>    <span class="php-var">$bdays</span> = <span class="php-keyword1">array</span>(
<a href="#4283" id="4283" class="l">4283: </a>        <span class="php-var">$lang</span>-&gt;sunday,
<a href="#4284" id="4284" class="l">4284: </a>        <span class="php-var">$lang</span>-&gt;monday,
<a href="#4285" id="4285" class="l">4285: </a>        <span class="php-var">$lang</span>-&gt;tuesday,
<a href="#4286" id="4286" class="l">4286: </a>        <span class="php-var">$lang</span>-&gt;wednesday,
<a href="#4287" id="4287" class="l">4287: </a>        <span class="php-var">$lang</span>-&gt;thursday,
<a href="#4288" id="4288" class="l">4288: </a>        <span class="php-var">$lang</span>-&gt;friday,
<a href="#4289" id="4289" class="l">4289: </a>        <span class="php-var">$lang</span>-&gt;saturday
<a href="#4290" id="4290" class="l">4290: </a>    );
<a href="#4291" id="4291" class="l">4291: </a>
<a href="#4292" id="4292" class="l">4292: </a>    <span class="php-var">$bmonth</span> = <span class="php-keyword1">array</span>(
<a href="#4293" id="4293" class="l">4293: </a>        <span class="php-var">$lang</span>-&gt;month_1,
<a href="#4294" id="4294" class="l">4294: </a>        <span class="php-var">$lang</span>-&gt;month_2,
<a href="#4295" id="4295" class="l">4295: </a>        <span class="php-var">$lang</span>-&gt;month_3,
<a href="#4296" id="4296" class="l">4296: </a>        <span class="php-var">$lang</span>-&gt;month_4,
<a href="#4297" id="4297" class="l">4297: </a>        <span class="php-var">$lang</span>-&gt;month_5,
<a href="#4298" id="4298" class="l">4298: </a>        <span class="php-var">$lang</span>-&gt;month_6,
<a href="#4299" id="4299" class="l">4299: </a>        <span class="php-var">$lang</span>-&gt;month_7,
<a href="#4300" id="4300" class="l">4300: </a>        <span class="php-var">$lang</span>-&gt;month_8,
<a href="#4301" id="4301" class="l">4301: </a>        <span class="php-var">$lang</span>-&gt;month_9,
<a href="#4302" id="4302" class="l">4302: </a>        <span class="php-var">$lang</span>-&gt;month_10,
<a href="#4303" id="4303" class="l">4303: </a>        <span class="php-var">$lang</span>-&gt;month_11,
<a href="#4304" id="4304" class="l">4304: </a>        <span class="php-var">$lang</span>-&gt;month_12
<a href="#4305" id="4305" class="l">4305: </a>    );
<a href="#4306" id="4306" class="l">4306: </a>    
<a href="#4307" id="4307" class="l">4307: </a>
<a href="#4308" id="4308" class="l">4308: </a>    <span class="php-comment">// This needs to be in this specific order</span>
<a href="#4309" id="4309" class="l">4309: </a>    <span class="php-var">$find</span> = <span class="php-keyword1">array</span>(
<a href="#4310" id="4310" class="l">4310: </a>        <span class="php-quote">'m'</span>,
<a href="#4311" id="4311" class="l">4311: </a>        <span class="php-quote">'d'</span>,
<a href="#4312" id="4312" class="l">4312: </a>        <span class="php-quote">'D'</span>,
<a href="#4313" id="4313" class="l">4313: </a>        <span class="php-quote">'y'</span>,
<a href="#4314" id="4314" class="l">4314: </a>        <span class="php-quote">'Y'</span>,
<a href="#4315" id="4315" class="l">4315: </a>        <span class="php-quote">'j'</span>,
<a href="#4316" id="4316" class="l">4316: </a>        <span class="php-quote">'S'</span>,
<a href="#4317" id="4317" class="l">4317: </a>        <span class="php-quote">'F'</span>,
<a href="#4318" id="4318" class="l">4318: </a>        <span class="php-quote">'l'</span>,
<a href="#4319" id="4319" class="l">4319: </a>        <span class="php-quote">'M'</span>,
<a href="#4320" id="4320" class="l">4320: </a>    );
<a href="#4321" id="4321" class="l">4321: </a>
<a href="#4322" id="4322" class="l">4322: </a>    <span class="php-var">$html</span> = <span class="php-keyword1">array</span>(
<a href="#4323" id="4323" class="l">4323: </a>        <span class="php-quote">'&amp;#109;'</span>,
<a href="#4324" id="4324" class="l">4324: </a>        <span class="php-quote">'&amp;#99;'</span>,
<a href="#4325" id="4325" class="l">4325: </a>        <span class="php-quote">'&amp;#68;'</span>,
<a href="#4326" id="4326" class="l">4326: </a>        <span class="php-quote">'&amp;#121;'</span>,
<a href="#4327" id="4327" class="l">4327: </a>        <span class="php-quote">'&amp;#89;'</span>,
<a href="#4328" id="4328" class="l">4328: </a>        <span class="php-quote">'&amp;#106;'</span>,
<a href="#4329" id="4329" class="l">4329: </a>        <span class="php-quote">'&amp;#83;'</span>,
<a href="#4330" id="4330" class="l">4330: </a>        <span class="php-quote">'&amp;#70;'</span>,
<a href="#4331" id="4331" class="l">4331: </a>        <span class="php-quote">'&amp;#108;'</span>,
<a href="#4332" id="4332" class="l">4332: </a>        <span class="php-quote">'&amp;#77;'</span>,
<a href="#4333" id="4333" class="l">4333: </a>    );
<a href="#4334" id="4334" class="l">4334: </a>
<a href="#4335" id="4335" class="l">4335: </a>    <span class="php-var">$bdays</span> = <span class="php-keyword2">str_replace</span>(<span class="php-var">$find</span>, <span class="php-var">$html</span>, <span class="php-var">$bdays</span>);
<a href="#4336" id="4336" class="l">4336: </a>    <span class="php-var">$bmonth</span> = <span class="php-keyword2">str_replace</span>(<span class="php-var">$find</span>, <span class="php-var">$html</span>, <span class="php-var">$bmonth</span>);
<a href="#4337" id="4337" class="l">4337: </a>    
<a href="#4338" id="4338" class="l">4338: </a>    <span class="php-var">$replace</span> = <span class="php-keyword1">array</span>(
<a href="#4339" id="4339" class="l">4339: </a>        <span class="php-keyword2">sprintf</span>(<span class="php-quote">'%02s'</span>, <span class="php-var">$bm</span>),
<a href="#4340" id="4340" class="l">4340: </a>        <span class="php-keyword2">sprintf</span>(<span class="php-quote">'%02s'</span>, <span class="php-var">$bd</span>),
<a href="#4341" id="4341" class="l">4341: </a>        (<span class="php-var">$wd</span> == <span class="php-num">2</span> ? my_substr(<span class="php-var">$bdays</span>[<span class="php-var">$wd</span>], <span class="php-num">0</span>, <span class="php-num">4</span>) : (<span class="php-var">$wd</span> == <span class="php-num">4</span> ? my_substr(<span class="php-var">$bdays</span>[<span class="php-var">$wd</span>], <span class="php-num">0</span>, <span class="php-num">5</span>) : my_substr(<span class="php-var">$bdays</span>[<span class="php-var">$wd</span>], <span class="php-num">0</span>, <span class="php-num">3</span>))),
<a href="#4342" id="4342" class="l">4342: </a>        my_substr(<span class="php-var">$by</span>, <span class="php-num">2</span>),
<a href="#4343" id="4343" class="l">4343: </a>        <span class="php-var">$by</span>,
<a href="#4344" id="4344" class="l">4344: </a>        (<span class="php-var">$bd</span>[<span class="php-num">0</span>] == <span class="php-num">0</span> ? my_substr(<span class="php-var">$bd</span>, <span class="php-num">1</span>) : <span class="php-var">$bd</span>),
<a href="#4345" id="4345" class="l">4345: </a>        (<span class="php-var">$bd</span> == <span class="php-num">1</span> || <span class="php-var">$bd</span> == <span class="php-num">21</span> || <span class="php-var">$bd</span> == <span class="php-num">31</span> ? <span class="php-quote">'st'</span> : (<span class="php-var">$bd</span> == <span class="php-num">2</span> || <span class="php-var">$bd</span> == <span class="php-num">22</span> ? <span class="php-quote">'nd'</span> : (<span class="php-var">$bd</span> == <span class="php-num">3</span> || <span class="php-var">$bd</span> == <span class="php-num">23</span> ? <span class="php-quote">'rd'</span> : <span class="php-quote">'th'</span>))),
<a href="#4346" id="4346" class="l">4346: </a>        <span class="php-var">$bmonth</span>[<span class="php-var">$bm</span>-<span class="php-num">1</span>],
<a href="#4347" id="4347" class="l">4347: </a>        <span class="php-var">$wd</span>,
<a href="#4348" id="4348" class="l">4348: </a>        (<span class="php-var">$bm</span> == <span class="php-num">9</span> ? my_substr(<span class="php-var">$bmonth</span>[<span class="php-var">$bm</span>-<span class="php-num">1</span>], <span class="php-num">0</span>, <span class="php-num">4</span>) :  my_substr(<span class="php-var">$bmonth</span>[<span class="php-var">$bm</span>-<span class="php-num">1</span>], <span class="php-num">0</span>, <span class="php-num">3</span>)),
<a href="#4349" id="4349" class="l">4349: </a>    );
<a href="#4350" id="4350" class="l">4350: </a>    
<a href="#4351" id="4351" class="l">4351: </a>    <span class="php-comment">// Do we have the full month in our output?</span>
<a href="#4352" id="4352" class="l">4352: </a>    <span class="php-comment">// If so there's no need for the short month</span>
<a href="#4353" id="4353" class="l">4353: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">strpos</span>(<span class="php-var">$display</span>, <span class="php-quote">'F'</span>) !== <span class="php-keyword1">false</span>)
<a href="#4354" id="4354" class="l">4354: </a>    {
<a href="#4355" id="4355" class="l">4355: </a>        <span class="php-keyword2">array_pop</span>(<span class="php-var">$find</span>);
<a href="#4356" id="4356" class="l">4356: </a>        <span class="php-keyword2">array_pop</span>(<span class="php-var">$replace</span>);
<a href="#4357" id="4357" class="l">4357: </a>    }
<a href="#4358" id="4358" class="l">4358: </a>    
<a href="#4359" id="4359" class="l">4359: </a>    <span class="php-keyword1">return</span> <span class="php-keyword2">str_replace</span>(<span class="php-var">$find</span>, <span class="php-var">$replace</span>, <span class="php-var">$display</span>);
<a href="#4360" id="4360" class="l">4360: </a>}
<a href="#4361" id="4361" class="l">4361: </a>
<a href="#4362" id="4362" class="l">4362: </a><span class="php-comment">/**
</span><a href="#4363" id="4363" class="l">4363: </a><span class="php-comment"> * Returns the age of a user with specified birthday.
</span><a href="#4364" id="4364" class="l">4364: </a><span class="php-comment"> *
</span><a href="#4365" id="4365" class="l">4365: </a><span class="php-comment"> * @param string The birthday of a user.
</span><a href="#4366" id="4366" class="l">4366: </a><span class="php-comment"> * @return float The age of a user with that birthday.
</span><a href="#4367" id="4367" class="l">4367: </a><span class="php-comment"> */</span>
<a href="#4368" id="4368" class="l">4368: </a><span class="php-keyword1">function</span> get_age(<span class="php-var">$birthday</span>)
<a href="#4369" id="4369" class="l">4369: </a>{
<a href="#4370" id="4370" class="l">4370: </a>    <span class="php-var">$bday</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">&quot;-&quot;</span>, <span class="php-var">$birthday</span>);
<a href="#4371" id="4371" class="l">4371: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$bday</span>[<span class="php-num">2</span>])
<a href="#4372" id="4372" class="l">4372: </a>    {
<a href="#4373" id="4373" class="l">4373: </a>        <span class="php-keyword1">return</span>;
<a href="#4374" id="4374" class="l">4374: </a>    }
<a href="#4375" id="4375" class="l">4375: </a>
<a href="#4376" id="4376" class="l">4376: </a>    <span class="php-keyword1">list</span>(<span class="php-var">$day</span>, <span class="php-var">$month</span>, <span class="php-var">$year</span>) = <span class="php-keyword2">explode</span>(<span class="php-quote">&quot;-&quot;</span>, my_date(<span class="php-quote">&quot;j-n-Y&quot;</span>, TIME_NOW, <span class="php-num">0</span>, <span class="php-num">0</span>));
<a href="#4377" id="4377" class="l">4377: </a>
<a href="#4378" id="4378" class="l">4378: </a>    <span class="php-var">$age</span> = <span class="php-var">$year</span>-<span class="php-var">$bday</span>[<span class="php-num">2</span>];
<a href="#4379" id="4379" class="l">4379: </a>
<a href="#4380" id="4380" class="l">4380: </a>    <span class="php-keyword1">if</span>((<span class="php-var">$month</span> == <span class="php-var">$bday</span>[<span class="php-num">1</span>] &amp;&amp; <span class="php-var">$day</span> &lt; <span class="php-var">$bday</span>[<span class="php-num">0</span>]) || <span class="php-var">$month</span> &lt; <span class="php-var">$bday</span>[<span class="php-num">1</span>])
<a href="#4381" id="4381" class="l">4381: </a>    {
<a href="#4382" id="4382" class="l">4382: </a>        --<span class="php-var">$age</span>;
<a href="#4383" id="4383" class="l">4383: </a>    }
<a href="#4384" id="4384" class="l">4384: </a>    <span class="php-keyword1">return</span> <span class="php-var">$age</span>;
<a href="#4385" id="4385" class="l">4385: </a>}
<a href="#4386" id="4386" class="l">4386: </a>
<a href="#4387" id="4387" class="l">4387: </a><span class="php-comment">/**
</span><a href="#4388" id="4388" class="l">4388: </a><span class="php-comment"> * Updates the first posts in a thread.
</span><a href="#4389" id="4389" class="l">4389: </a><span class="php-comment"> *
</span><a href="#4390" id="4390" class="l">4390: </a><span class="php-comment"> * @param int The thread id for which to update the first post id.
</span><a href="#4391" id="4391" class="l">4391: </a><span class="php-comment"> */</span>
<a href="#4392" id="4392" class="l">4392: </a><span class="php-keyword1">function</span> update_first_post(<span class="php-var">$tid</span>)
<a href="#4393" id="4393" class="l">4393: </a>{
<a href="#4394" id="4394" class="l">4394: </a>    <span class="php-keyword1">global</span> <span class="php-var">$db</span>;
<a href="#4395" id="4395" class="l">4395: </a>
<a href="#4396" id="4396" class="l">4396: </a>    <span class="php-var">$query</span> = <span class="php-var">$db</span>-&gt;simple_select(<span class="php-quote">&quot;posts&quot;</span>, <span class="php-quote">&quot;pid,replyto&quot;</span>, <span class="php-quote">&quot;tid='</span><span class="php-var">{$tid}</span><span class="php-quote">'&quot;</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'order_by'</span> =&gt; <span class="php-quote">'dateline'</span>, <span class="php-quote">'limit'</span> =&gt; <span class="php-num">1</span>));
<a href="#4397" id="4397" class="l">4397: </a>    <span class="php-var">$post</span> = <span class="php-var">$db</span>-&gt;fetch_array(<span class="php-var">$query</span>);
<a href="#4398" id="4398" class="l">4398: </a>
<a href="#4399" id="4399" class="l">4399: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$post</span>[<span class="php-quote">'replyto'</span>] != <span class="php-num">0</span>)
<a href="#4400" id="4400" class="l">4400: </a>    {
<a href="#4401" id="4401" class="l">4401: </a>        <span class="php-var">$replyto_update</span> = <span class="php-keyword1">array</span>(
<a href="#4402" id="4402" class="l">4402: </a>            <span class="php-quote">&quot;replyto&quot;</span> =&gt; <span class="php-num">0</span>
<a href="#4403" id="4403" class="l">4403: </a>        );
<a href="#4404" id="4404" class="l">4404: </a>        <span class="php-var">$db</span>-&gt;update_query(<span class="php-quote">&quot;posts&quot;</span>, <span class="php-var">$replyto_update</span>, <span class="php-quote">&quot;pid='</span><span class="php-var">{$post['pid']}</span><span class="php-quote">'&quot;</span>);
<a href="#4405" id="4405" class="l">4405: </a>    }
<a href="#4406" id="4406" class="l">4406: </a>
<a href="#4407" id="4407" class="l">4407: </a>    <span class="php-var">$firstpostup</span> = <span class="php-keyword1">array</span>(
<a href="#4408" id="4408" class="l">4408: </a>        <span class="php-quote">&quot;firstpost&quot;</span> =&gt; <span class="php-var">$post</span>[<span class="php-quote">'pid'</span>]
<a href="#4409" id="4409" class="l">4409: </a>    );
<a href="#4410" id="4410" class="l">4410: </a>    <span class="php-var">$db</span>-&gt;update_query(<span class="php-quote">&quot;threads&quot;</span>, <span class="php-var">$firstpostup</span>, <span class="php-quote">&quot;tid='</span><span class="php-var">$tid</span><span class="php-quote">'&quot;</span>);
<a href="#4411" id="4411" class="l">4411: </a>}
<a href="#4412" id="4412" class="l">4412: </a>
<a href="#4413" id="4413" class="l">4413: </a><span class="php-comment">/**
</span><a href="#4414" id="4414" class="l">4414: </a><span class="php-comment"> * Checks for the length of a string, mb strings accounted for
</span><a href="#4415" id="4415" class="l">4415: </a><span class="php-comment"> *
</span><a href="#4416" id="4416" class="l">4416: </a><span class="php-comment"> * @param string The string to check the length of.
</span><a href="#4417" id="4417" class="l">4417: </a><span class="php-comment"> * @return int The length of the string.
</span><a href="#4418" id="4418" class="l">4418: </a><span class="php-comment"> */</span>
<a href="#4419" id="4419" class="l">4419: </a><span class="php-keyword1">function</span> my_strlen(<span class="php-var">$string</span>)
<a href="#4420" id="4420" class="l">4420: </a>{
<a href="#4421" id="4421" class="l">4421: </a>    <span class="php-keyword1">global</span> <span class="php-var">$lang</span>;
<a href="#4422" id="4422" class="l">4422: </a>
<a href="#4423" id="4423" class="l">4423: </a>    <span class="php-var">$string</span> = <span class="php-keyword2">preg_replace</span>(<span class="php-quote">&quot;#&amp;\#([0-9]+);#&quot;</span>, <span class="php-quote">&quot;-&quot;</span>, <span class="php-var">$string</span>);
<a href="#4424" id="4424" class="l">4424: </a>
<a href="#4425" id="4425" class="l">4425: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">strtolower</span>(<span class="php-var">$lang</span>-&gt;settings[<span class="php-quote">'charset'</span>]) == <span class="php-quote">&quot;utf-8&quot;</span>)
<a href="#4426" id="4426" class="l">4426: </a>    {
<a href="#4427" id="4427" class="l">4427: </a>        <span class="php-comment">// Get rid of any excess RTL and LTR override for they are the workings of the devil</span>
<a href="#4428" id="4428" class="l">4428: </a>        <span class="php-var">$string</span> = <span class="php-keyword2">str_replace</span>(dec_to_utf8(<span class="php-num">8238</span>), <span class="php-quote">&quot;&quot;</span>, <span class="php-var">$string</span>);
<a href="#4429" id="4429" class="l">4429: </a>        <span class="php-var">$string</span> = <span class="php-keyword2">str_replace</span>(dec_to_utf8(<span class="php-num">8237</span>), <span class="php-quote">&quot;&quot;</span>, <span class="php-var">$string</span>);
<a href="#4430" id="4430" class="l">4430: </a>
<a href="#4431" id="4431" class="l">4431: </a>        <span class="php-comment">// Remove dodgy whitespaces</span>
<a href="#4432" id="4432" class="l">4432: </a>        <span class="php-var">$string</span> = <span class="php-keyword2">str_replace</span>(<span class="php-keyword2">chr</span>(<span class="php-num">0xCA</span>), <span class="php-quote">&quot;&quot;</span>, <span class="php-var">$string</span>);
<a href="#4433" id="4433" class="l">4433: </a>    }
<a href="#4434" id="4434" class="l">4434: </a>    <span class="php-var">$string</span> = <span class="php-keyword2">trim</span>(<span class="php-var">$string</span>);
<a href="#4435" id="4435" class="l">4435: </a>
<a href="#4436" id="4436" class="l">4436: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">function_exists</span>(<span class="php-quote">&quot;mb_strlen&quot;</span>))
<a href="#4437" id="4437" class="l">4437: </a>    {
<a href="#4438" id="4438" class="l">4438: </a>        <span class="php-var">$string_length</span> = <span class="php-keyword2">mb_strlen</span>(<span class="php-var">$string</span>);
<a href="#4439" id="4439" class="l">4439: </a>    }
<a href="#4440" id="4440" class="l">4440: </a>    <span class="php-keyword1">else</span>
<a href="#4441" id="4441" class="l">4441: </a>    {
<a href="#4442" id="4442" class="l">4442: </a>        <span class="php-var">$string_length</span> = <span class="php-keyword2">strlen</span>(<span class="php-var">$string</span>);
<a href="#4443" id="4443" class="l">4443: </a>    }
<a href="#4444" id="4444" class="l">4444: </a>
<a href="#4445" id="4445" class="l">4445: </a>    <span class="php-keyword1">return</span> <span class="php-var">$string_length</span>;
<a href="#4446" id="4446" class="l">4446: </a>}
<a href="#4447" id="4447" class="l">4447: </a>
<a href="#4448" id="4448" class="l">4448: </a><span class="php-comment">/**
</span><a href="#4449" id="4449" class="l">4449: </a><span class="php-comment"> * Cuts a string at a specified point, mb strings accounted for
</span><a href="#4450" id="4450" class="l">4450: </a><span class="php-comment"> *
</span><a href="#4451" id="4451" class="l">4451: </a><span class="php-comment"> * @param string The string to cut.
</span><a href="#4452" id="4452" class="l">4452: </a><span class="php-comment"> * @param int Where to cut
</span><a href="#4453" id="4453" class="l">4453: </a><span class="php-comment"> * @param int (optional) How much to cut
</span><a href="#4454" id="4454" class="l">4454: </a><span class="php-comment"> * @param bool (optional) Properly handle HTML entities?
</span><a href="#4455" id="4455" class="l">4455: </a><span class="php-comment"> * @return int The cut part of the string.
</span><a href="#4456" id="4456" class="l">4456: </a><span class="php-comment"> */</span>
<a href="#4457" id="4457" class="l">4457: </a><span class="php-keyword1">function</span> my_substr(<span class="php-var">$string</span>, <span class="php-var">$start</span>, <span class="php-var">$length</span>=<span class="php-quote">&quot;&quot;</span>, <span class="php-var">$handle_entities</span> = <span class="php-keyword1">false</span>)
<a href="#4458" id="4458" class="l">4458: </a>{
<a href="#4459" id="4459" class="l">4459: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$handle_entities</span>)
<a href="#4460" id="4460" class="l">4460: </a>    {
<a href="#4461" id="4461" class="l">4461: </a>        <span class="php-var">$string</span> = unhtmlentities(<span class="php-var">$string</span>);
<a href="#4462" id="4462" class="l">4462: </a>    }
<a href="#4463" id="4463" class="l">4463: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">function_exists</span>(<span class="php-quote">&quot;mb_substr&quot;</span>))
<a href="#4464" id="4464" class="l">4464: </a>    {
<a href="#4465" id="4465" class="l">4465: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$length</span> != <span class="php-quote">&quot;&quot;</span>)
<a href="#4466" id="4466" class="l">4466: </a>        {
<a href="#4467" id="4467" class="l">4467: </a>            <span class="php-var">$cut_string</span> = <span class="php-keyword2">mb_substr</span>(<span class="php-var">$string</span>, <span class="php-var">$start</span>, <span class="php-var">$length</span>);
<a href="#4468" id="4468" class="l">4468: </a>        }
<a href="#4469" id="4469" class="l">4469: </a>        <span class="php-keyword1">else</span>
<a href="#4470" id="4470" class="l">4470: </a>        {
<a href="#4471" id="4471" class="l">4471: </a>            <span class="php-var">$cut_string</span> = <span class="php-keyword2">mb_substr</span>(<span class="php-var">$string</span>, <span class="php-var">$start</span>);
<a href="#4472" id="4472" class="l">4472: </a>        }
<a href="#4473" id="4473" class="l">4473: </a>    }
<a href="#4474" id="4474" class="l">4474: </a>    <span class="php-keyword1">else</span>
<a href="#4475" id="4475" class="l">4475: </a>    {
<a href="#4476" id="4476" class="l">4476: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$length</span> != <span class="php-quote">&quot;&quot;</span>)
<a href="#4477" id="4477" class="l">4477: </a>        {
<a href="#4478" id="4478" class="l">4478: </a>            <span class="php-var">$cut_string</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$string</span>, <span class="php-var">$start</span>, <span class="php-var">$length</span>);
<a href="#4479" id="4479" class="l">4479: </a>        }
<a href="#4480" id="4480" class="l">4480: </a>        <span class="php-keyword1">else</span>
<a href="#4481" id="4481" class="l">4481: </a>        {
<a href="#4482" id="4482" class="l">4482: </a>            <span class="php-var">$cut_string</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$string</span>, <span class="php-var">$start</span>);
<a href="#4483" id="4483" class="l">4483: </a>        }
<a href="#4484" id="4484" class="l">4484: </a>    }
<a href="#4485" id="4485" class="l">4485: </a>
<a href="#4486" id="4486" class="l">4486: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$handle_entities</span>)
<a href="#4487" id="4487" class="l">4487: </a>    {
<a href="#4488" id="4488" class="l">4488: </a>        <span class="php-var">$cut_string</span> = htmlspecialchars_uni(<span class="php-var">$cut_string</span>);
<a href="#4489" id="4489" class="l">4489: </a>    }
<a href="#4490" id="4490" class="l">4490: </a>    <span class="php-keyword1">return</span> <span class="php-var">$cut_string</span>;
<a href="#4491" id="4491" class="l">4491: </a>}
<a href="#4492" id="4492" class="l">4492: </a>
<a href="#4493" id="4493" class="l">4493: </a><span class="php-comment">/**
</span><a href="#4494" id="4494" class="l">4494: </a><span class="php-comment"> * lowers the case of a string, mb strings accounted for
</span><a href="#4495" id="4495" class="l">4495: </a><span class="php-comment"> *
</span><a href="#4496" id="4496" class="l">4496: </a><span class="php-comment"> * @param string The string to lower.
</span><a href="#4497" id="4497" class="l">4497: </a><span class="php-comment"> * @return int The lowered string.
</span><a href="#4498" id="4498" class="l">4498: </a><span class="php-comment"> */</span>
<a href="#4499" id="4499" class="l">4499: </a><span class="php-keyword1">function</span> my_strtolower(<span class="php-var">$string</span>)
<a href="#4500" id="4500" class="l">4500: </a>{
<a href="#4501" id="4501" class="l">4501: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">function_exists</span>(<span class="php-quote">&quot;mb_strtolower&quot;</span>))
<a href="#4502" id="4502" class="l">4502: </a>    {
<a href="#4503" id="4503" class="l">4503: </a>        <span class="php-var">$string</span> = <span class="php-keyword2">mb_strtolower</span>(<span class="php-var">$string</span>);
<a href="#4504" id="4504" class="l">4504: </a>    }
<a href="#4505" id="4505" class="l">4505: </a>    <span class="php-keyword1">else</span>
<a href="#4506" id="4506" class="l">4506: </a>    {
<a href="#4507" id="4507" class="l">4507: </a>        <span class="php-var">$string</span> = <span class="php-keyword2">strtolower</span>(<span class="php-var">$string</span>);
<a href="#4508" id="4508" class="l">4508: </a>    }
<a href="#4509" id="4509" class="l">4509: </a>
<a href="#4510" id="4510" class="l">4510: </a>    <span class="php-keyword1">return</span> <span class="php-var">$string</span>;
<a href="#4511" id="4511" class="l">4511: </a>}
<a href="#4512" id="4512" class="l">4512: </a>
<a href="#4513" id="4513" class="l">4513: </a><span class="php-comment">/**
</span><a href="#4514" id="4514" class="l">4514: </a><span class="php-comment"> * Finds a needle in a haystack and returns it position, mb strings accounted for
</span><a href="#4515" id="4515" class="l">4515: </a><span class="php-comment"> *
</span><a href="#4516" id="4516" class="l">4516: </a><span class="php-comment"> * @param string String to look in (haystack)
</span><a href="#4517" id="4517" class="l">4517: </a><span class="php-comment"> * @param string What to look for (needle)
</span><a href="#4518" id="4518" class="l">4518: </a><span class="php-comment"> * @param int (optional) How much to offset
</span><a href="#4519" id="4519" class="l">4519: </a><span class="php-comment"> * @return int false on needle not found, integer position if found
</span><a href="#4520" id="4520" class="l">4520: </a><span class="php-comment"> */</span>
<a href="#4521" id="4521" class="l">4521: </a><span class="php-keyword1">function</span> my_strpos(<span class="php-var">$haystack</span>, <span class="php-var">$needle</span>, <span class="php-var">$offset</span>=<span class="php-num">0</span>)
<a href="#4522" id="4522" class="l">4522: </a>{
<a href="#4523" id="4523" class="l">4523: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$needle</span> == <span class="php-quote">''</span>)
<a href="#4524" id="4524" class="l">4524: </a>    {
<a href="#4525" id="4525" class="l">4525: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#4526" id="4526" class="l">4526: </a>    }
<a href="#4527" id="4527" class="l">4527: </a>
<a href="#4528" id="4528" class="l">4528: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">function_exists</span>(<span class="php-quote">&quot;mb_strpos&quot;</span>))
<a href="#4529" id="4529" class="l">4529: </a>    {
<a href="#4530" id="4530" class="l">4530: </a>        <span class="php-var">$position</span> = <span class="php-keyword2">mb_strpos</span>(<span class="php-var">$haystack</span>, <span class="php-var">$needle</span>, <span class="php-var">$offset</span>);
<a href="#4531" id="4531" class="l">4531: </a>    }
<a href="#4532" id="4532" class="l">4532: </a>    <span class="php-keyword1">else</span>
<a href="#4533" id="4533" class="l">4533: </a>    {
<a href="#4534" id="4534" class="l">4534: </a>        <span class="php-var">$position</span> = <span class="php-keyword2">strpos</span>(<span class="php-var">$haystack</span>, <span class="php-var">$needle</span>, <span class="php-var">$offset</span>);
<a href="#4535" id="4535" class="l">4535: </a>    }
<a href="#4536" id="4536" class="l">4536: </a>
<a href="#4537" id="4537" class="l">4537: </a>    <span class="php-keyword1">return</span> <span class="php-var">$position</span>;
<a href="#4538" id="4538" class="l">4538: </a>}
<a href="#4539" id="4539" class="l">4539: </a>
<a href="#4540" id="4540" class="l">4540: </a><span class="php-comment">/**
</span><a href="#4541" id="4541" class="l">4541: </a><span class="php-comment"> * ups the case of a string, mb strings accounted for
</span><a href="#4542" id="4542" class="l">4542: </a><span class="php-comment"> *
</span><a href="#4543" id="4543" class="l">4543: </a><span class="php-comment"> * @param string The string to up.
</span><a href="#4544" id="4544" class="l">4544: </a><span class="php-comment"> * @return int The uped string.
</span><a href="#4545" id="4545" class="l">4545: </a><span class="php-comment"> */</span>
<a href="#4546" id="4546" class="l">4546: </a><span class="php-keyword1">function</span> my_strtoupper(<span class="php-var">$string</span>)
<a href="#4547" id="4547" class="l">4547: </a>{
<a href="#4548" id="4548" class="l">4548: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">function_exists</span>(<span class="php-quote">&quot;mb_strtoupper&quot;</span>))
<a href="#4549" id="4549" class="l">4549: </a>    {
<a href="#4550" id="4550" class="l">4550: </a>        <span class="php-var">$string</span> = <span class="php-keyword2">mb_strtoupper</span>(<span class="php-var">$string</span>);
<a href="#4551" id="4551" class="l">4551: </a>    }
<a href="#4552" id="4552" class="l">4552: </a>    <span class="php-keyword1">else</span>
<a href="#4553" id="4553" class="l">4553: </a>    {
<a href="#4554" id="4554" class="l">4554: </a>        <span class="php-var">$string</span> = <span class="php-keyword2">strtoupper</span>(<span class="php-var">$string</span>);
<a href="#4555" id="4555" class="l">4555: </a>    }
<a href="#4556" id="4556" class="l">4556: </a>
<a href="#4557" id="4557" class="l">4557: </a>    <span class="php-keyword1">return</span> <span class="php-var">$string</span>;
<a href="#4558" id="4558" class="l">4558: </a>}
<a href="#4559" id="4559" class="l">4559: </a>
<a href="#4560" id="4560" class="l">4560: </a><span class="php-comment">/**
</span><a href="#4561" id="4561" class="l">4561: </a><span class="php-comment"> * Returns any html entities to their original character
</span><a href="#4562" id="4562" class="l">4562: </a><span class="php-comment"> *
</span><a href="#4563" id="4563" class="l">4563: </a><span class="php-comment"> * @param string The string to un-htmlentitize.
</span><a href="#4564" id="4564" class="l">4564: </a><span class="php-comment"> * @return int The un-htmlentitied' string.
</span><a href="#4565" id="4565" class="l">4565: </a><span class="php-comment"> */</span>
<a href="#4566" id="4566" class="l">4566: </a><span class="php-keyword1">function</span> unhtmlentities(<span class="php-var">$string</span>)
<a href="#4567" id="4567" class="l">4567: </a>{   
<a href="#4568" id="4568" class="l">4568: </a>    <span class="php-comment">// Replace numeric entities</span>
<a href="#4569" id="4569" class="l">4569: </a>    <span class="php-var">$string</span> = <span class="php-keyword2">preg_replace</span>(<span class="php-quote">'~&amp;#x([0-9a-f]+);~ei'</span>, <span class="php-quote">'unichr(hexdec(&quot;\\1&quot;))'</span>, <span class="php-var">$string</span>);
<a href="#4570" id="4570" class="l">4570: </a>    <span class="php-var">$string</span> = <span class="php-keyword2">preg_replace</span>(<span class="php-quote">'~&amp;#([0-9]+);~e'</span>, <span class="php-quote">'unichr(&quot;\\1&quot;)'</span>, <span class="php-var">$string</span>);
<a href="#4571" id="4571" class="l">4571: </a>    
<a href="#4572" id="4572" class="l">4572: </a>    <span class="php-comment">// Replace literal entities</span>
<a href="#4573" id="4573" class="l">4573: </a>    <span class="php-var">$trans_tbl</span> = <span class="php-keyword2">get_html_translation_table</span>(HTML_ENTITIES);
<a href="#4574" id="4574" class="l">4574: </a>    <span class="php-var">$trans_tbl</span> = <span class="php-keyword2">array_flip</span>(<span class="php-var">$trans_tbl</span>);
<a href="#4575" id="4575" class="l">4575: </a>    
<a href="#4576" id="4576" class="l">4576: </a>    <span class="php-keyword1">return</span> <span class="php-keyword2">strtr</span>(<span class="php-var">$string</span>, <span class="php-var">$trans_tbl</span>);
<a href="#4577" id="4577" class="l">4577: </a>}
<a href="#4578" id="4578" class="l">4578: </a>
<a href="#4579" id="4579" class="l">4579: </a><span class="php-comment">/**
</span><a href="#4580" id="4580" class="l">4580: </a><span class="php-comment"> * Returns any ascii to it's character (utf-8 safe).
</span><a href="#4581" id="4581" class="l">4581: </a><span class="php-comment"> *
</span><a href="#4582" id="4582" class="l">4582: </a><span class="php-comment"> * @param string The ascii to characterize.
</span><a href="#4583" id="4583" class="l">4583: </a><span class="php-comment"> * @return int The characterized ascii.
</span><a href="#4584" id="4584" class="l">4584: </a><span class="php-comment"> */</span>
<a href="#4585" id="4585" class="l">4585: </a><span class="php-keyword1">function</span> unichr(<span class="php-var">$c</span>)
<a href="#4586" id="4586" class="l">4586: </a>{
<a href="#4587" id="4587" class="l">4587: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$c</span> &lt;= <span class="php-num">0x7F</span>)
<a href="#4588" id="4588" class="l">4588: </a>    {
<a href="#4589" id="4589" class="l">4589: </a>        <span class="php-keyword1">return</span> <span class="php-keyword2">chr</span>(<span class="php-var">$c</span>);
<a href="#4590" id="4590" class="l">4590: </a>    }
<a href="#4591" id="4591" class="l">4591: </a>    <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(<span class="php-var">$c</span> &lt;= <span class="php-num">0x7FF</span>)
<a href="#4592" id="4592" class="l">4592: </a>    {
<a href="#4593" id="4593" class="l">4593: </a>        <span class="php-keyword1">return</span> <span class="php-keyword2">chr</span>(<span class="php-num">0xC0</span> | <span class="php-var">$c</span> &gt;&gt; <span class="php-num">6</span>) . <span class="php-keyword2">chr</span>(<span class="php-num">0x80</span> | <span class="php-var">$c</span> &amp; <span class="php-num">0x3F</span>);
<a href="#4594" id="4594" class="l">4594: </a>    }
<a href="#4595" id="4595" class="l">4595: </a>    <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(<span class="php-var">$c</span> &lt;= <span class="php-num">0xFFFF</span>)
<a href="#4596" id="4596" class="l">4596: </a>    {
<a href="#4597" id="4597" class="l">4597: </a>        <span class="php-keyword1">return</span> <span class="php-keyword2">chr</span>(<span class="php-num">0xE0</span> | <span class="php-var">$c</span> &gt;&gt; <span class="php-num">12</span>) . <span class="php-keyword2">chr</span>(<span class="php-num">0x80</span> | <span class="php-var">$c</span> &gt;&gt; <span class="php-num">6</span> &amp; <span class="php-num">0x3F</span>)
<a href="#4598" id="4598" class="l">4598: </a>                                    . <span class="php-keyword2">chr</span>(<span class="php-num">0x80</span> | <span class="php-var">$c</span> &amp; <span class="php-num">0x3F</span>);
<a href="#4599" id="4599" class="l">4599: </a>    }
<a href="#4600" id="4600" class="l">4600: </a>    <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(<span class="php-var">$c</span> &lt;= <span class="php-num">0x10FFFF</span>)
<a href="#4601" id="4601" class="l">4601: </a>    {
<a href="#4602" id="4602" class="l">4602: </a>        <span class="php-keyword1">return</span> <span class="php-keyword2">chr</span>(<span class="php-num">0xF0</span> | <span class="php-var">$c</span> &gt;&gt; <span class="php-num">18</span>) . <span class="php-keyword2">chr</span>(<span class="php-num">0x80</span> | <span class="php-var">$c</span> &gt;&gt; <span class="php-num">12</span> &amp; <span class="php-num">0x3F</span>)
<a href="#4603" id="4603" class="l">4603: </a>                                    . <span class="php-keyword2">chr</span>(<span class="php-num">0x80</span> | <span class="php-var">$c</span> &gt;&gt; <span class="php-num">6</span> &amp; <span class="php-num">0x3F</span>)
<a href="#4604" id="4604" class="l">4604: </a>                                    . <span class="php-keyword2">chr</span>(<span class="php-num">0x80</span> | <span class="php-var">$c</span> &amp; <span class="php-num">0x3F</span>);
<a href="#4605" id="4605" class="l">4605: </a>    }
<a href="#4606" id="4606" class="l">4606: </a>    <span class="php-keyword1">else</span>
<a href="#4607" id="4607" class="l">4607: </a>    {
<a href="#4608" id="4608" class="l">4608: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#4609" id="4609" class="l">4609: </a>    }
<a href="#4610" id="4610" class="l">4610: </a>}
<a href="#4611" id="4611" class="l">4611: </a>
<a href="#4612" id="4612" class="l">4612: </a><span class="php-comment">/**
</span><a href="#4613" id="4613" class="l">4613: </a><span class="php-comment"> * Get the event poster.
</span><a href="#4614" id="4614" class="l">4614: </a><span class="php-comment"> *
</span><a href="#4615" id="4615" class="l">4615: </a><span class="php-comment"> * @param array The event data array.
</span><a href="#4616" id="4616" class="l">4616: </a><span class="php-comment"> * @return string The link to the event poster.
</span><a href="#4617" id="4617" class="l">4617: </a><span class="php-comment"> */</span>
<a href="#4618" id="4618" class="l">4618: </a><span class="php-keyword1">function</span> get_event_poster(<span class="php-var">$event</span>)
<a href="#4619" id="4619" class="l">4619: </a>{
<a href="#4620" id="4620" class="l">4620: </a>    <span class="php-var">$event</span>[<span class="php-quote">'username'</span>] = format_name(<span class="php-var">$event</span>[<span class="php-quote">'username'</span>], <span class="php-var">$event</span>[<span class="php-quote">'usergroup'</span>], <span class="php-var">$event</span>[<span class="php-quote">'displaygroup'</span>]);
<a href="#4621" id="4621" class="l">4621: </a>    <span class="php-var">$event_poster</span> = build_profile_link(<span class="php-var">$event</span>[<span class="php-quote">'username'</span>], <span class="php-var">$event</span>[<span class="php-quote">'author'</span>]);
<a href="#4622" id="4622" class="l">4622: </a>    <span class="php-keyword1">return</span> <span class="php-var">$event_poster</span>;
<a href="#4623" id="4623" class="l">4623: </a>}
<a href="#4624" id="4624" class="l">4624: </a>
<a href="#4625" id="4625" class="l">4625: </a><span class="php-comment">/**
</span><a href="#4626" id="4626" class="l">4626: </a><span class="php-comment"> * Get the event date.
</span><a href="#4627" id="4627" class="l">4627: </a><span class="php-comment"> *
</span><a href="#4628" id="4628" class="l">4628: </a><span class="php-comment"> * @param array The event data array.
</span><a href="#4629" id="4629" class="l">4629: </a><span class="php-comment"> * @return string The event date.
</span><a href="#4630" id="4630" class="l">4630: </a><span class="php-comment"> */</span>
<a href="#4631" id="4631" class="l">4631: </a><span class="php-keyword1">function</span> get_event_date(<span class="php-var">$event</span>)
<a href="#4632" id="4632" class="l">4632: </a>{
<a href="#4633" id="4633" class="l">4633: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>;
<a href="#4634" id="4634" class="l">4634: </a>    
<a href="#4635" id="4635" class="l">4635: </a>    <span class="php-var">$event_date</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">&quot;-&quot;</span>, <span class="php-var">$event</span>[<span class="php-quote">'date'</span>]);
<a href="#4636" id="4636" class="l">4636: </a>    <span class="php-var">$event_date</span> = <span class="php-keyword2">mktime</span>(<span class="php-num">0</span>, <span class="php-num">0</span>, <span class="php-num">0</span>, <span class="php-var">$event_date</span>[<span class="php-num">1</span>], <span class="php-var">$event_date</span>[<span class="php-num">0</span>], <span class="php-var">$event_date</span>[<span class="php-num">2</span>]);
<a href="#4637" id="4637" class="l">4637: </a>    <span class="php-var">$event_date</span> = my_date(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'dateformat'</span>], <span class="php-var">$event_date</span>);
<a href="#4638" id="4638" class="l">4638: </a>
<a href="#4639" id="4639" class="l">4639: </a>    <span class="php-keyword1">return</span> <span class="php-var">$event_date</span>;
<a href="#4640" id="4640" class="l">4640: </a>}
<a href="#4641" id="4641" class="l">4641: </a>
<a href="#4642" id="4642" class="l">4642: </a><span class="php-comment">/**
</span><a href="#4643" id="4643" class="l">4643: </a><span class="php-comment"> * Get the profile link.
</span><a href="#4644" id="4644" class="l">4644: </a><span class="php-comment"> *
</span><a href="#4645" id="4645" class="l">4645: </a><span class="php-comment"> * @param int The user id of the profile.
</span><a href="#4646" id="4646" class="l">4646: </a><span class="php-comment"> * @return string The url to the profile.
</span><a href="#4647" id="4647" class="l">4647: </a><span class="php-comment"> */</span>
<a href="#4648" id="4648" class="l">4648: </a><span class="php-keyword1">function</span> get_profile_link(<span class="php-var">$uid</span>=<span class="php-num">0</span>)
<a href="#4649" id="4649" class="l">4649: </a>{
<a href="#4650" id="4650" class="l">4650: </a>    <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{uid}&quot;</span>, <span class="php-var">$uid</span>, PROFILE_URL);
<a href="#4651" id="4651" class="l">4651: </a>    <span class="php-keyword1">return</span> htmlspecialchars_uni(<span class="php-var">$link</span>);
<a href="#4652" id="4652" class="l">4652: </a>}
<a href="#4653" id="4653" class="l">4653: </a>
<a href="#4654" id="4654" class="l">4654: </a><span class="php-comment">/**
</span><a href="#4655" id="4655" class="l">4655: </a><span class="php-comment"> * Get the announcement link.
</span><a href="#4656" id="4656" class="l">4656: </a><span class="php-comment"> *
</span><a href="#4657" id="4657" class="l">4657: </a><span class="php-comment"> * @param int The announement id of the announcement.
</span><a href="#4658" id="4658" class="l">4658: </a><span class="php-comment"> * @return string The url to the announcement.
</span><a href="#4659" id="4659" class="l">4659: </a><span class="php-comment"> */</span>
<a href="#4660" id="4660" class="l">4660: </a><span class="php-keyword1">function</span> get_announcement_link(<span class="php-var">$aid</span>=<span class="php-num">0</span>)
<a href="#4661" id="4661" class="l">4661: </a>{
<a href="#4662" id="4662" class="l">4662: </a>    <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{aid}&quot;</span>, <span class="php-var">$aid</span>, ANNOUNCEMENT_URL);
<a href="#4663" id="4663" class="l">4663: </a>    <span class="php-keyword1">return</span> htmlspecialchars_uni(<span class="php-var">$link</span>);
<a href="#4664" id="4664" class="l">4664: </a>}
<a href="#4665" id="4665" class="l">4665: </a>
<a href="#4666" id="4666" class="l">4666: </a><span class="php-comment">/**
</span><a href="#4667" id="4667" class="l">4667: </a><span class="php-comment"> * Build the profile link.
</span><a href="#4668" id="4668" class="l">4668: </a><span class="php-comment"> *
</span><a href="#4669" id="4669" class="l">4669: </a><span class="php-comment"> * @param string The Username of the profile.
</span><a href="#4670" id="4670" class="l">4670: </a><span class="php-comment"> * @param int The user id of the profile.
</span><a href="#4671" id="4671" class="l">4671: </a><span class="php-comment"> * @param string The target frame
</span><a href="#4672" id="4672" class="l">4672: </a><span class="php-comment"> * @param string Any onclick javascript.
</span><a href="#4673" id="4673" class="l">4673: </a><span class="php-comment"> * @return string The complete profile link.
</span><a href="#4674" id="4674" class="l">4674: </a><span class="php-comment"> */</span>
<a href="#4675" id="4675" class="l">4675: </a><span class="php-keyword1">function</span> build_profile_link(<span class="php-var">$username</span>=<span class="php-quote">&quot;&quot;</span>, <span class="php-var">$uid</span>=<span class="php-num">0</span>, <span class="php-var">$target</span>=<span class="php-quote">&quot;&quot;</span>, <span class="php-var">$onclick</span>=<span class="php-quote">&quot;&quot;</span>)
<a href="#4676" id="4676" class="l">4676: </a>{
<a href="#4677" id="4677" class="l">4677: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>, <span class="php-var">$lang</span>;
<a href="#4678" id="4678" class="l">4678: </a>
<a href="#4679" id="4679" class="l">4679: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$username</span> &amp;&amp; <span class="php-var">$uid</span> == <span class="php-num">0</span>)
<a href="#4680" id="4680" class="l">4680: </a>    {
<a href="#4681" id="4681" class="l">4681: </a>        <span class="php-comment">// Return Guest phrase for no UID, no guest nickname</span>
<a href="#4682" id="4682" class="l">4682: </a>        <span class="php-keyword1">return</span> <span class="php-var">$lang</span>-&gt;guest;
<a href="#4683" id="4683" class="l">4683: </a>    }
<a href="#4684" id="4684" class="l">4684: </a>    <span class="php-keyword1">elseif</span>(<span class="php-var">$uid</span> == <span class="php-num">0</span>)
<a href="#4685" id="4685" class="l">4685: </a>    {
<a href="#4686" id="4686" class="l">4686: </a>        <span class="php-comment">// Return the guest's nickname if user is a guest but has a nickname</span>
<a href="#4687" id="4687" class="l">4687: </a>        <span class="php-keyword1">return</span> <span class="php-var">$username</span>;
<a href="#4688" id="4688" class="l">4688: </a>    }
<a href="#4689" id="4689" class="l">4689: </a>    <span class="php-keyword1">else</span>
<a href="#4690" id="4690" class="l">4690: </a>    {
<a href="#4691" id="4691" class="l">4691: </a>        <span class="php-comment">// Build the profile link for the registered user</span>
<a href="#4692" id="4692" class="l">4692: </a>        <span class="php-keyword1">if</span>(!<span class="php-keyword1">empty</span>(<span class="php-var">$target</span>))
<a href="#4693" id="4693" class="l">4693: </a>        {
<a href="#4694" id="4694" class="l">4694: </a>            <span class="php-var">$target</span> = <span class="php-quote">&quot; target=\&quot;</span><span class="php-var">{$target}</span><span class="php-quote">\&quot;&quot;</span>;
<a href="#4695" id="4695" class="l">4695: </a>        }
<a href="#4696" id="4696" class="l">4696: </a>
<a href="#4697" id="4697" class="l">4697: </a>        <span class="php-keyword1">if</span>(!<span class="php-keyword1">empty</span>(<span class="php-var">$onclick</span>))
<a href="#4698" id="4698" class="l">4698: </a>        {
<a href="#4699" id="4699" class="l">4699: </a>            <span class="php-var">$onclick</span> = <span class="php-quote">&quot; onclick=\&quot;</span><span class="php-var">{$onclick}</span><span class="php-quote">\&quot;&quot;</span>;
<a href="#4700" id="4700" class="l">4700: </a>        }
<a href="#4701" id="4701" class="l">4701: </a>        
<a href="#4702" id="4702" class="l">4702: </a>        <span class="php-keyword1">return</span> <span class="php-quote">&quot;&lt;a href=\&quot;</span><span class="php-var">{$mybb-&gt;settings['bburl']}</span><span class="php-quote">/&quot;</span>.get_profile_link(<span class="php-var">$uid</span>).<span class="php-quote">&quot;\&quot;</span><span class="php-var">{$target}{$onclick}</span><span class="php-quote">&gt;</span><span class="php-var">{$username}</span><span class="php-quote">&lt;/a&gt;&quot;</span>;
<a href="#4703" id="4703" class="l">4703: </a>    }
<a href="#4704" id="4704" class="l">4704: </a>}
<a href="#4705" id="4705" class="l">4705: </a>
<a href="#4706" id="4706" class="l">4706: </a><span class="php-comment">/**
</span><a href="#4707" id="4707" class="l">4707: </a><span class="php-comment"> * Build the forum link.
</span><a href="#4708" id="4708" class="l">4708: </a><span class="php-comment"> *
</span><a href="#4709" id="4709" class="l">4709: </a><span class="php-comment"> * @param int The forum id of the forum.
</span><a href="#4710" id="4710" class="l">4710: </a><span class="php-comment"> * @param int (Optional) The page number of the forum.
</span><a href="#4711" id="4711" class="l">4711: </a><span class="php-comment"> * @return string The url to the forum.
</span><a href="#4712" id="4712" class="l">4712: </a><span class="php-comment"> */</span>
<a href="#4713" id="4713" class="l">4713: </a><span class="php-keyword1">function</span> get_forum_link(<span class="php-var">$fid</span>, <span class="php-var">$page</span>=<span class="php-num">0</span>)
<a href="#4714" id="4714" class="l">4714: </a>{
<a href="#4715" id="4715" class="l">4715: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$page</span> &gt; <span class="php-num">0</span>)
<a href="#4716" id="4716" class="l">4716: </a>    {
<a href="#4717" id="4717" class="l">4717: </a>        <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{fid}&quot;</span>, <span class="php-var">$fid</span>, FORUM_URL_PAGED);
<a href="#4718" id="4718" class="l">4718: </a>        <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{page}&quot;</span>, <span class="php-var">$page</span>, <span class="php-var">$link</span>);
<a href="#4719" id="4719" class="l">4719: </a>        <span class="php-keyword1">return</span> htmlspecialchars_uni(<span class="php-var">$link</span>);
<a href="#4720" id="4720" class="l">4720: </a>    }
<a href="#4721" id="4721" class="l">4721: </a>    <span class="php-keyword1">else</span>
<a href="#4722" id="4722" class="l">4722: </a>    {
<a href="#4723" id="4723" class="l">4723: </a>        <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{fid}&quot;</span>, <span class="php-var">$fid</span>, FORUM_URL);
<a href="#4724" id="4724" class="l">4724: </a>        <span class="php-keyword1">return</span> htmlspecialchars_uni(<span class="php-var">$link</span>);
<a href="#4725" id="4725" class="l">4725: </a>    }
<a href="#4726" id="4726" class="l">4726: </a>}
<a href="#4727" id="4727" class="l">4727: </a>
<a href="#4728" id="4728" class="l">4728: </a><span class="php-comment">/**
</span><a href="#4729" id="4729" class="l">4729: </a><span class="php-comment"> * Build the thread link.
</span><a href="#4730" id="4730" class="l">4730: </a><span class="php-comment"> *
</span><a href="#4731" id="4731" class="l">4731: </a><span class="php-comment"> * @param int The thread id of the thread.
</span><a href="#4732" id="4732" class="l">4732: </a><span class="php-comment"> * @param int (Optional) The page number of the thread.
</span><a href="#4733" id="4733" class="l">4733: </a><span class="php-comment"> * @param string (Optional) The action we're performing (ex, lastpost, newpost, etc)
</span><a href="#4734" id="4734" class="l">4734: </a><span class="php-comment"> * @return string The url to the thread.
</span><a href="#4735" id="4735" class="l">4735: </a><span class="php-comment"> */</span>
<a href="#4736" id="4736" class="l">4736: </a><span class="php-keyword1">function</span> get_thread_link(<span class="php-var">$tid</span>, <span class="php-var">$page</span>=<span class="php-num">0</span>, <span class="php-var">$action</span>=<span class="php-quote">''</span>)
<a href="#4737" id="4737" class="l">4737: </a>{
<a href="#4738" id="4738" class="l">4738: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$page</span> &gt; <span class="php-num">1</span>)
<a href="#4739" id="4739" class="l">4739: </a>    {
<a href="#4740" id="4740" class="l">4740: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$action</span>)
<a href="#4741" id="4741" class="l">4741: </a>        {
<a href="#4742" id="4742" class="l">4742: </a>            <span class="php-var">$link</span> = THREAD_URL_ACTION;
<a href="#4743" id="4743" class="l">4743: </a>            <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{action}&quot;</span>, <span class="php-var">$action</span>, <span class="php-var">$link</span>);
<a href="#4744" id="4744" class="l">4744: </a>        }
<a href="#4745" id="4745" class="l">4745: </a>        <span class="php-keyword1">else</span>
<a href="#4746" id="4746" class="l">4746: </a>        {
<a href="#4747" id="4747" class="l">4747: </a>            <span class="php-var">$link</span> = THREAD_URL_PAGED;
<a href="#4748" id="4748" class="l">4748: </a>        }
<a href="#4749" id="4749" class="l">4749: </a>        <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{tid}&quot;</span>, <span class="php-var">$tid</span>, <span class="php-var">$link</span>);      
<a href="#4750" id="4750" class="l">4750: </a>        <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{page}&quot;</span>, <span class="php-var">$page</span>, <span class="php-var">$link</span>);
<a href="#4751" id="4751" class="l">4751: </a>        <span class="php-keyword1">return</span> htmlspecialchars_uni(<span class="php-var">$link</span>);
<a href="#4752" id="4752" class="l">4752: </a>    }
<a href="#4753" id="4753" class="l">4753: </a>    <span class="php-keyword1">else</span>
<a href="#4754" id="4754" class="l">4754: </a>    {
<a href="#4755" id="4755" class="l">4755: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$action</span>)
<a href="#4756" id="4756" class="l">4756: </a>        {
<a href="#4757" id="4757" class="l">4757: </a>            <span class="php-var">$link</span> = THREAD_URL_ACTION;
<a href="#4758" id="4758" class="l">4758: </a>            <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{action}&quot;</span>, <span class="php-var">$action</span>, <span class="php-var">$link</span>);
<a href="#4759" id="4759" class="l">4759: </a>        }
<a href="#4760" id="4760" class="l">4760: </a>        <span class="php-keyword1">else</span>
<a href="#4761" id="4761" class="l">4761: </a>        {
<a href="#4762" id="4762" class="l">4762: </a>            <span class="php-var">$link</span> = THREAD_URL;
<a href="#4763" id="4763" class="l">4763: </a>        }
<a href="#4764" id="4764" class="l">4764: </a>        <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{tid}&quot;</span>, <span class="php-var">$tid</span>, <span class="php-var">$link</span>);
<a href="#4765" id="4765" class="l">4765: </a>        <span class="php-keyword1">return</span> htmlspecialchars_uni(<span class="php-var">$link</span>);
<a href="#4766" id="4766" class="l">4766: </a>    }
<a href="#4767" id="4767" class="l">4767: </a>}
<a href="#4768" id="4768" class="l">4768: </a>
<a href="#4769" id="4769" class="l">4769: </a><span class="php-comment">/**
</span><a href="#4770" id="4770" class="l">4770: </a><span class="php-comment"> * Build the post link.
</span><a href="#4771" id="4771" class="l">4771: </a><span class="php-comment"> *
</span><a href="#4772" id="4772" class="l">4772: </a><span class="php-comment"> * @param int The post ID of the post
</span><a href="#4773" id="4773" class="l">4773: </a><span class="php-comment"> * @param int The thread id of the post.
</span><a href="#4774" id="4774" class="l">4774: </a><span class="php-comment"> */</span>
<a href="#4775" id="4775" class="l">4775: </a><span class="php-keyword1">function</span> get_post_link(<span class="php-var">$pid</span>, <span class="php-var">$tid</span>=<span class="php-num">0</span>)
<a href="#4776" id="4776" class="l">4776: </a>{
<a href="#4777" id="4777" class="l">4777: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$tid</span> &gt; <span class="php-num">0</span>)
<a href="#4778" id="4778" class="l">4778: </a>    {
<a href="#4779" id="4779" class="l">4779: </a>        <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{tid}&quot;</span>, <span class="php-var">$tid</span>, THREAD_URL_POST);
<a href="#4780" id="4780" class="l">4780: </a>        <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{pid}&quot;</span>, <span class="php-var">$pid</span>, <span class="php-var">$link</span>);
<a href="#4781" id="4781" class="l">4781: </a>        <span class="php-keyword1">return</span> htmlspecialchars_uni(<span class="php-var">$link</span>);
<a href="#4782" id="4782" class="l">4782: </a>    }
<a href="#4783" id="4783" class="l">4783: </a>    <span class="php-keyword1">else</span>
<a href="#4784" id="4784" class="l">4784: </a>    {
<a href="#4785" id="4785" class="l">4785: </a>        <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{pid}&quot;</span>, <span class="php-var">$pid</span>, POST_URL);
<a href="#4786" id="4786" class="l">4786: </a>        <span class="php-keyword1">return</span> htmlspecialchars_uni(<span class="php-var">$link</span>);
<a href="#4787" id="4787" class="l">4787: </a>    }
<a href="#4788" id="4788" class="l">4788: </a>}
<a href="#4789" id="4789" class="l">4789: </a>
<a href="#4790" id="4790" class="l">4790: </a><span class="php-comment">/**
</span><a href="#4791" id="4791" class="l">4791: </a><span class="php-comment"> * Build the event link.
</span><a href="#4792" id="4792" class="l">4792: </a><span class="php-comment"> *
</span><a href="#4793" id="4793" class="l">4793: </a><span class="php-comment"> * @param int The event ID of the event
</span><a href="#4794" id="4794" class="l">4794: </a><span class="php-comment"> * @return string The URL of the event
</span><a href="#4795" id="4795" class="l">4795: </a><span class="php-comment"> */</span>
<a href="#4796" id="4796" class="l">4796: </a><span class="php-keyword1">function</span> get_event_link(<span class="php-var">$eid</span>)
<a href="#4797" id="4797" class="l">4797: </a>{
<a href="#4798" id="4798" class="l">4798: </a>    <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{eid}&quot;</span>, <span class="php-var">$eid</span>, EVENT_URL);
<a href="#4799" id="4799" class="l">4799: </a>    <span class="php-keyword1">return</span> htmlspecialchars_uni(<span class="php-var">$link</span>);
<a href="#4800" id="4800" class="l">4800: </a>}
<a href="#4801" id="4801" class="l">4801: </a>
<a href="#4802" id="4802" class="l">4802: </a><span class="php-comment">/**
</span><a href="#4803" id="4803" class="l">4803: </a><span class="php-comment"> * Build the link to a specified date on the calendar
</span><a href="#4804" id="4804" class="l">4804: </a><span class="php-comment"> *
</span><a href="#4805" id="4805" class="l">4805: </a><span class="php-comment"> * @param int The ID of the calendar
</span><a href="#4806" id="4806" class="l">4806: </a><span class="php-comment"> * @param int The year
</span><a href="#4807" id="4807" class="l">4807: </a><span class="php-comment"> * @param int The month
</span><a href="#4808" id="4808" class="l">4808: </a><span class="php-comment"> * @param int The day (optional)
</span><a href="#4809" id="4809" class="l">4809: </a><span class="php-comment"> * @return string The URL of the calendar
</span><a href="#4810" id="4810" class="l">4810: </a><span class="php-comment"> */</span>
<a href="#4811" id="4811" class="l">4811: </a><span class="php-keyword1">function</span> get_calendar_link(<span class="php-var">$calendar</span>, <span class="php-var">$year</span>=<span class="php-num">0</span>, <span class="php-var">$month</span>=<span class="php-num">0</span>, <span class="php-var">$day</span>=<span class="php-num">0</span>)
<a href="#4812" id="4812" class="l">4812: </a>{
<a href="#4813" id="4813" class="l">4813: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$day</span> &gt; <span class="php-num">0</span>)
<a href="#4814" id="4814" class="l">4814: </a>    {
<a href="#4815" id="4815" class="l">4815: </a>        <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{month}&quot;</span>, <span class="php-var">$month</span>, CALENDAR_URL_DAY);
<a href="#4816" id="4816" class="l">4816: </a>        <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{year}&quot;</span>, <span class="php-var">$year</span>, <span class="php-var">$link</span>);
<a href="#4817" id="4817" class="l">4817: </a>        <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{day}&quot;</span>, <span class="php-var">$day</span>, <span class="php-var">$link</span>);
<a href="#4818" id="4818" class="l">4818: </a>        <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{calendar}&quot;</span>, <span class="php-var">$calendar</span>, <span class="php-var">$link</span>);
<a href="#4819" id="4819" class="l">4819: </a>        <span class="php-keyword1">return</span> htmlspecialchars_uni(<span class="php-var">$link</span>);
<a href="#4820" id="4820" class="l">4820: </a>    }
<a href="#4821" id="4821" class="l">4821: </a>    <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(<span class="php-var">$month</span> &gt; <span class="php-num">0</span>)
<a href="#4822" id="4822" class="l">4822: </a>    {
<a href="#4823" id="4823" class="l">4823: </a>        <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{month}&quot;</span>, <span class="php-var">$month</span>, CALENDAR_URL_MONTH);
<a href="#4824" id="4824" class="l">4824: </a>        <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{year}&quot;</span>, <span class="php-var">$year</span>, <span class="php-var">$link</span>);
<a href="#4825" id="4825" class="l">4825: </a>        <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{calendar}&quot;</span>, <span class="php-var">$calendar</span>, <span class="php-var">$link</span>);
<a href="#4826" id="4826" class="l">4826: </a>        <span class="php-keyword1">return</span> htmlspecialchars_uni(<span class="php-var">$link</span>);
<a href="#4827" id="4827" class="l">4827: </a>    }
<a href="#4828" id="4828" class="l">4828: </a>    <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(<span class="php-var">$year</span> &gt; <span class="php-num">0</span>)
<a href="#4829" id="4829" class="l">4829: </a>    {
<a href="#4830" id="4830" class="l">4830: </a>        <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{year}&quot;</span>, <span class="php-var">$year</span>, CALENDAR_URL_YEAR);
<a href="#4831" id="4831" class="l">4831: </a>        <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{calendar}&quot;</span>, <span class="php-var">$calendar</span>, <span class="php-var">$link</span>);
<a href="#4832" id="4832" class="l">4832: </a>        <span class="php-keyword1">return</span> htmlspecialchars_uni(<span class="php-var">$link</span>);
<a href="#4833" id="4833" class="l">4833: </a>    }
<a href="#4834" id="4834" class="l">4834: </a>    <span class="php-keyword1">else</span>
<a href="#4835" id="4835" class="l">4835: </a>    {
<a href="#4836" id="4836" class="l">4836: </a>        <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{calendar}&quot;</span>, <span class="php-var">$calendar</span>, CALENDAR_URL);
<a href="#4837" id="4837" class="l">4837: </a>        <span class="php-keyword1">return</span> htmlspecialchars_uni(<span class="php-var">$link</span>);
<a href="#4838" id="4838" class="l">4838: </a>    }
<a href="#4839" id="4839" class="l">4839: </a>}
<a href="#4840" id="4840" class="l">4840: </a>
<a href="#4841" id="4841" class="l">4841: </a><span class="php-comment">/**
</span><a href="#4842" id="4842" class="l">4842: </a><span class="php-comment"> * Build the link to a specified week on the calendar
</span><a href="#4843" id="4843" class="l">4843: </a><span class="php-comment"> *
</span><a href="#4844" id="4844" class="l">4844: </a><span class="php-comment"> * @param int The ID of the calendar
</span><a href="#4845" id="4845" class="l">4845: </a><span class="php-comment"> * @param int The year
</span><a href="#4846" id="4846" class="l">4846: </a><span class="php-comment"> * @param int The week
</span><a href="#4847" id="4847" class="l">4847: </a><span class="php-comment"> * @return string The URL of the calendar
</span><a href="#4848" id="4848" class="l">4848: </a><span class="php-comment"> */</span>
<a href="#4849" id="4849" class="l">4849: </a><span class="php-keyword1">function</span> get_calendar_week_link(<span class="php-var">$calendar</span>, <span class="php-var">$week</span>)
<a href="#4850" id="4850" class="l">4850: </a>{
<a href="#4851" id="4851" class="l">4851: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$week</span> &lt; <span class="php-num">0</span>)
<a href="#4852" id="4852" class="l">4852: </a>    {
<a href="#4853" id="4853" class="l">4853: </a>        <span class="php-var">$week</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">'-'</span>, <span class="php-quote">&quot;n&quot;</span>, <span class="php-var">$week</span>);
<a href="#4854" id="4854" class="l">4854: </a>    }
<a href="#4855" id="4855" class="l">4855: </a>    <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{week}&quot;</span>, <span class="php-var">$week</span>, CALENDAR_URL_WEEK);
<a href="#4856" id="4856" class="l">4856: </a>    <span class="php-var">$link</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;{calendar}&quot;</span>, <span class="php-var">$calendar</span>, <span class="php-var">$link</span>);
<a href="#4857" id="4857" class="l">4857: </a>    <span class="php-keyword1">return</span> htmlspecialchars_uni(<span class="php-var">$link</span>);
<a href="#4858" id="4858" class="l">4858: </a>}
<a href="#4859" id="4859" class="l">4859: </a>
<a href="#4860" id="4860" class="l">4860: </a><span class="php-comment">/**
</span><a href="#4861" id="4861" class="l">4861: </a><span class="php-comment"> * Get the user data of a user id.
</span><a href="#4862" id="4862" class="l">4862: </a><span class="php-comment"> *
</span><a href="#4863" id="4863" class="l">4863: </a><span class="php-comment"> * @param int The user id of the user.
</span><a href="#4864" id="4864" class="l">4864: </a><span class="php-comment"> * @return array The users data
</span><a href="#4865" id="4865" class="l">4865: </a><span class="php-comment"> */</span>
<a href="#4866" id="4866" class="l">4866: </a><span class="php-keyword1">function</span> get_user(<span class="php-var">$uid</span>)
<a href="#4867" id="4867" class="l">4867: </a>{
<a href="#4868" id="4868" class="l">4868: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>, <span class="php-var">$db</span>;
<a href="#4869" id="4869" class="l">4869: </a>    <span class="php-keyword1">static</span> <span class="php-var">$user_cache</span>;
<a href="#4870" id="4870" class="l">4870: </a>
<a href="#4871" id="4871" class="l">4871: </a>    <span class="php-var">$uid</span> = <span class="php-keyword2">intval</span>(<span class="php-var">$uid</span>);
<a href="#4872" id="4872" class="l">4872: </a>
<a href="#4873" id="4873" class="l">4873: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$uid</span> == <span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'uid'</span>])
<a href="#4874" id="4874" class="l">4874: </a>    {
<a href="#4875" id="4875" class="l">4875: </a>        <span class="php-keyword1">return</span> <span class="php-var">$mybb</span>-&gt;user;
<a href="#4876" id="4876" class="l">4876: </a>    }
<a href="#4877" id="4877" class="l">4877: </a>    <span class="php-keyword1">elseif</span>(<span class="php-keyword1">isset</span>(<span class="php-var">$user_cache</span>[<span class="php-var">$uid</span>]))
<a href="#4878" id="4878" class="l">4878: </a>    {
<a href="#4879" id="4879" class="l">4879: </a>        <span class="php-keyword1">return</span> <span class="php-var">$user_cache</span>[<span class="php-var">$uid</span>];
<a href="#4880" id="4880" class="l">4880: </a>    }
<a href="#4881" id="4881" class="l">4881: </a>    <span class="php-keyword1">else</span>
<a href="#4882" id="4882" class="l">4882: </a>    {
<a href="#4883" id="4883" class="l">4883: </a>        <span class="php-var">$query</span> = <span class="php-var">$db</span>-&gt;simple_select(<span class="php-quote">&quot;users&quot;</span>, <span class="php-quote">&quot;*&quot;</span>, <span class="php-quote">&quot;uid='</span><span class="php-var">{$uid}</span><span class="php-quote">'&quot;</span>);
<a href="#4884" id="4884" class="l">4884: </a>        <span class="php-var">$user_cache</span>[<span class="php-var">$uid</span>] = <span class="php-var">$db</span>-&gt;fetch_array(<span class="php-var">$query</span>);
<a href="#4885" id="4885" class="l">4885: </a>
<a href="#4886" id="4886" class="l">4886: </a>        <span class="php-keyword1">return</span> <span class="php-var">$user_cache</span>[<span class="php-var">$uid</span>];
<a href="#4887" id="4887" class="l">4887: </a>    }
<a href="#4888" id="4888" class="l">4888: </a>}
<a href="#4889" id="4889" class="l">4889: </a>
<a href="#4890" id="4890" class="l">4890: </a><span class="php-comment">/**
</span><a href="#4891" id="4891" class="l">4891: </a><span class="php-comment"> * Get the forum of a specific forum id.
</span><a href="#4892" id="4892" class="l">4892: </a><span class="php-comment"> *
</span><a href="#4893" id="4893" class="l">4893: </a><span class="php-comment"> * @param int The forum id of the forum.
</span><a href="#4894" id="4894" class="l">4894: </a><span class="php-comment"> * @param int (Optional) If set to 1, will override the active forum status
</span><a href="#4895" id="4895" class="l">4895: </a><span class="php-comment"> * @return array The database row of a forum.
</span><a href="#4896" id="4896" class="l">4896: </a><span class="php-comment"> */</span>
<a href="#4897" id="4897" class="l">4897: </a><span class="php-keyword1">function</span> get_forum(<span class="php-var">$fid</span>, <span class="php-var">$active_override</span>=<span class="php-num">0</span>)
<a href="#4898" id="4898" class="l">4898: </a>{
<a href="#4899" id="4899" class="l">4899: </a>    <span class="php-keyword1">global</span> <span class="php-var">$cache</span>;
<a href="#4900" id="4900" class="l">4900: </a>    <span class="php-keyword1">static</span> <span class="php-var">$forum_cache</span>;
<a href="#4901" id="4901" class="l">4901: </a>
<a href="#4902" id="4902" class="l">4902: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword1">isset</span>(<span class="php-var">$forum_cache</span>) || <span class="php-keyword2">is_array</span>(<span class="php-var">$forum_cache</span>))
<a href="#4903" id="4903" class="l">4903: </a>    {
<a href="#4904" id="4904" class="l">4904: </a>        <span class="php-var">$forum_cache</span> = <span class="php-var">$cache</span>-&gt;read(<span class="php-quote">&quot;forums&quot;</span>);
<a href="#4905" id="4905" class="l">4905: </a>    }
<a href="#4906" id="4906" class="l">4906: </a>
<a href="#4907" id="4907" class="l">4907: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$forum_cache</span>[<span class="php-var">$fid</span>])
<a href="#4908" id="4908" class="l">4908: </a>    {
<a href="#4909" id="4909" class="l">4909: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#4910" id="4910" class="l">4910: </a>    }
<a href="#4911" id="4911" class="l">4911: </a>
<a href="#4912" id="4912" class="l">4912: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$active_override</span> != <span class="php-num">1</span>)
<a href="#4913" id="4913" class="l">4913: </a>    {
<a href="#4914" id="4914" class="l">4914: </a>        <span class="php-var">$parents</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">&quot;,&quot;</span>, <span class="php-var">$forum_cache</span>[<span class="php-var">$fid</span>][<span class="php-quote">'parentlist'</span>]);
<a href="#4915" id="4915" class="l">4915: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$parents</span>))
<a href="#4916" id="4916" class="l">4916: </a>        {
<a href="#4917" id="4917" class="l">4917: </a>            <span class="php-keyword1">foreach</span>(<span class="php-var">$parents</span> <span class="php-keyword1">as</span> <span class="php-var">$parent</span>)
<a href="#4918" id="4918" class="l">4918: </a>            {
<a href="#4919" id="4919" class="l">4919: </a>                <span class="php-keyword1">if</span>(<span class="php-var">$forum_cache</span>[<span class="php-var">$parent</span>][<span class="php-quote">'active'</span>] == <span class="php-num">0</span>)
<a href="#4920" id="4920" class="l">4920: </a>                {
<a href="#4921" id="4921" class="l">4921: </a>                    <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#4922" id="4922" class="l">4922: </a>                }
<a href="#4923" id="4923" class="l">4923: </a>            }
<a href="#4924" id="4924" class="l">4924: </a>        }
<a href="#4925" id="4925" class="l">4925: </a>    }
<a href="#4926" id="4926" class="l">4926: </a>
<a href="#4927" id="4927" class="l">4927: </a>    <span class="php-keyword1">return</span> <span class="php-var">$forum_cache</span>[<span class="php-var">$fid</span>];
<a href="#4928" id="4928" class="l">4928: </a>}
<a href="#4929" id="4929" class="l">4929: </a>
<a href="#4930" id="4930" class="l">4930: </a><span class="php-comment">/**
</span><a href="#4931" id="4931" class="l">4931: </a><span class="php-comment"> * Get the thread of a thread id.
</span><a href="#4932" id="4932" class="l">4932: </a><span class="php-comment"> *
</span><a href="#4933" id="4933" class="l">4933: </a><span class="php-comment"> * @param int The thread id of the thread.
</span><a href="#4934" id="4934" class="l">4934: </a><span class="php-comment"> * @param boolean Whether or not to recache the thread.
</span><a href="#4935" id="4935" class="l">4935: </a><span class="php-comment"> * @return string The database row of the thread.
</span><a href="#4936" id="4936" class="l">4936: </a><span class="php-comment"> */</span>
<a href="#4937" id="4937" class="l">4937: </a><span class="php-keyword1">function</span> get_thread(<span class="php-var">$tid</span>, <span class="php-var">$recache</span> = <span class="php-keyword1">false</span>)
<a href="#4938" id="4938" class="l">4938: </a>{
<a href="#4939" id="4939" class="l">4939: </a>    <span class="php-keyword1">global</span> <span class="php-var">$db</span>;
<a href="#4940" id="4940" class="l">4940: </a>    <span class="php-keyword1">static</span> <span class="php-var">$thread_cache</span>;
<a href="#4941" id="4941" class="l">4941: </a>
<a href="#4942" id="4942" class="l">4942: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword1">isset</span>(<span class="php-var">$thread_cache</span>[<span class="php-var">$tid</span>]) &amp;&amp; !<span class="php-var">$recache</span>)
<a href="#4943" id="4943" class="l">4943: </a>    {
<a href="#4944" id="4944" class="l">4944: </a>        <span class="php-keyword1">return</span> <span class="php-var">$thread_cache</span>[<span class="php-var">$tid</span>];
<a href="#4945" id="4945" class="l">4945: </a>    }
<a href="#4946" id="4946" class="l">4946: </a>    <span class="php-keyword1">else</span>
<a href="#4947" id="4947" class="l">4947: </a>    {
<a href="#4948" id="4948" class="l">4948: </a>        <span class="php-var">$query</span> = <span class="php-var">$db</span>-&gt;simple_select(<span class="php-quote">&quot;threads&quot;</span>, <span class="php-quote">&quot;*&quot;</span>, <span class="php-quote">&quot;tid='&quot;</span>.<span class="php-keyword2">intval</span>(<span class="php-var">$tid</span>).<span class="php-quote">&quot;'&quot;</span>);
<a href="#4949" id="4949" class="l">4949: </a>        <span class="php-var">$thread</span> = <span class="php-var">$db</span>-&gt;fetch_array(<span class="php-var">$query</span>);
<a href="#4950" id="4950" class="l">4950: </a>
<a href="#4951" id="4951" class="l">4951: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$thread</span>)
<a href="#4952" id="4952" class="l">4952: </a>        {
<a href="#4953" id="4953" class="l">4953: </a>            <span class="php-var">$thread_cache</span>[<span class="php-var">$tid</span>] = <span class="php-var">$thread</span>;
<a href="#4954" id="4954" class="l">4954: </a>            <span class="php-keyword1">return</span> <span class="php-var">$thread</span>;
<a href="#4955" id="4955" class="l">4955: </a>        }
<a href="#4956" id="4956" class="l">4956: </a>        <span class="php-keyword1">else</span>
<a href="#4957" id="4957" class="l">4957: </a>        {
<a href="#4958" id="4958" class="l">4958: </a>            <span class="php-var">$thread_cache</span>[<span class="php-var">$tid</span>] = <span class="php-keyword1">false</span>;
<a href="#4959" id="4959" class="l">4959: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#4960" id="4960" class="l">4960: </a>        }
<a href="#4961" id="4961" class="l">4961: </a>    }
<a href="#4962" id="4962" class="l">4962: </a>}
<a href="#4963" id="4963" class="l">4963: </a>
<a href="#4964" id="4964" class="l">4964: </a><span class="php-comment">/**
</span><a href="#4965" id="4965" class="l">4965: </a><span class="php-comment"> * Get the post of a post id.
</span><a href="#4966" id="4966" class="l">4966: </a><span class="php-comment"> *
</span><a href="#4967" id="4967" class="l">4967: </a><span class="php-comment"> * @param int The post id of the post.
</span><a href="#4968" id="4968" class="l">4968: </a><span class="php-comment"> * @return string The database row of the post.
</span><a href="#4969" id="4969" class="l">4969: </a><span class="php-comment"> */</span>
<a href="#4970" id="4970" class="l">4970: </a><span class="php-keyword1">function</span> get_post(<span class="php-var">$pid</span>)
<a href="#4971" id="4971" class="l">4971: </a>{
<a href="#4972" id="4972" class="l">4972: </a>    <span class="php-keyword1">global</span> <span class="php-var">$db</span>;
<a href="#4973" id="4973" class="l">4973: </a>    <span class="php-keyword1">static</span> <span class="php-var">$post_cache</span>;
<a href="#4974" id="4974" class="l">4974: </a>
<a href="#4975" id="4975" class="l">4975: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword1">isset</span>(<span class="php-var">$post_cache</span>[<span class="php-var">$pid</span>]))
<a href="#4976" id="4976" class="l">4976: </a>    {
<a href="#4977" id="4977" class="l">4977: </a>        <span class="php-keyword1">return</span> <span class="php-var">$post_cache</span>[<span class="php-var">$pid</span>];
<a href="#4978" id="4978" class="l">4978: </a>    }
<a href="#4979" id="4979" class="l">4979: </a>    <span class="php-keyword1">else</span>
<a href="#4980" id="4980" class="l">4980: </a>    {
<a href="#4981" id="4981" class="l">4981: </a>        <span class="php-var">$query</span> = <span class="php-var">$db</span>-&gt;simple_select(<span class="php-quote">&quot;posts&quot;</span>, <span class="php-quote">&quot;*&quot;</span>, <span class="php-quote">&quot;pid='&quot;</span>.<span class="php-keyword2">intval</span>(<span class="php-var">$pid</span>).<span class="php-quote">&quot;'&quot;</span>);
<a href="#4982" id="4982" class="l">4982: </a>        <span class="php-var">$post</span> = <span class="php-var">$db</span>-&gt;fetch_array(<span class="php-var">$query</span>);
<a href="#4983" id="4983" class="l">4983: </a>
<a href="#4984" id="4984" class="l">4984: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$post</span>)
<a href="#4985" id="4985" class="l">4985: </a>        {
<a href="#4986" id="4986" class="l">4986: </a>            <span class="php-var">$post_cache</span>[<span class="php-var">$pid</span>] = <span class="php-var">$post</span>;
<a href="#4987" id="4987" class="l">4987: </a>            <span class="php-keyword1">return</span> <span class="php-var">$post</span>;
<a href="#4988" id="4988" class="l">4988: </a>        }
<a href="#4989" id="4989" class="l">4989: </a>        <span class="php-keyword1">else</span>
<a href="#4990" id="4990" class="l">4990: </a>        {
<a href="#4991" id="4991" class="l">4991: </a>            <span class="php-var">$post_cache</span>[<span class="php-var">$pid</span>] = <span class="php-keyword1">false</span>;
<a href="#4992" id="4992" class="l">4992: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#4993" id="4993" class="l">4993: </a>        }
<a href="#4994" id="4994" class="l">4994: </a>    }
<a href="#4995" id="4995" class="l">4995: </a>}
<a href="#4996" id="4996" class="l">4996: </a>
<a href="#4997" id="4997" class="l">4997: </a><span class="php-comment">/**
</span><a href="#4998" id="4998" class="l">4998: </a><span class="php-comment"> * Get inactivate forums.
</span><a href="#4999" id="4999" class="l">4999: </a><span class="php-comment"> *
</span><a href="#5000" id="5000" class="l">5000: </a><span class="php-comment"> * @return string The comma separated values of the inactivate forum.
</span><a href="#5001" id="5001" class="l">5001: </a><span class="php-comment"> */</span>
<a href="#5002" id="5002" class="l">5002: </a><span class="php-keyword1">function</span> get_inactive_forums()
<a href="#5003" id="5003" class="l">5003: </a>{
<a href="#5004" id="5004" class="l">5004: </a>    <span class="php-keyword1">global</span> <span class="php-var">$forum_cache</span>, <span class="php-var">$cache</span>, <span class="php-var">$inactiveforums</span>;
<a href="#5005" id="5005" class="l">5005: </a>
<a href="#5006" id="5006" class="l">5006: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$forum_cache</span>)
<a href="#5007" id="5007" class="l">5007: </a>    {
<a href="#5008" id="5008" class="l">5008: </a>        cache_forums();
<a href="#5009" id="5009" class="l">5009: </a>    }
<a href="#5010" id="5010" class="l">5010: </a>
<a href="#5011" id="5011" class="l">5011: </a>    <span class="php-var">$inactive</span> = <span class="php-keyword1">array</span>();
<a href="#5012" id="5012" class="l">5012: </a>
<a href="#5013" id="5013" class="l">5013: </a>    <span class="php-keyword1">foreach</span>(<span class="php-var">$forum_cache</span> <span class="php-keyword1">as</span> <span class="php-var">$fid</span> =&gt; <span class="php-var">$forum</span>)
<a href="#5014" id="5014" class="l">5014: </a>    {
<a href="#5015" id="5015" class="l">5015: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$forum</span>[<span class="php-quote">'active'</span>] == <span class="php-num">0</span>)
<a href="#5016" id="5016" class="l">5016: </a>        {
<a href="#5017" id="5017" class="l">5017: </a>            <span class="php-var">$inactive</span>[] = <span class="php-var">$fid</span>;
<a href="#5018" id="5018" class="l">5018: </a>            <span class="php-keyword1">foreach</span>(<span class="php-var">$forum_cache</span> <span class="php-keyword1">as</span> <span class="php-var">$fid1</span> =&gt; <span class="php-var">$forum1</span>)
<a href="#5019" id="5019" class="l">5019: </a>            {
<a href="#5020" id="5020" class="l">5020: </a>                <span class="php-keyword1">if</span>(my_strpos(<span class="php-quote">&quot;,&quot;</span>.<span class="php-var">$forum1</span>[<span class="php-quote">'parentlist'</span>].<span class="php-quote">&quot;,&quot;</span>, <span class="php-quote">&quot;,&quot;</span>.<span class="php-var">$fid</span>.<span class="php-quote">&quot;,&quot;</span>) !== <span class="php-keyword1">false</span> &amp;&amp; !<span class="php-keyword2">in_array</span>(<span class="php-var">$fid1</span>, <span class="php-var">$inactive</span>))
<a href="#5021" id="5021" class="l">5021: </a>                {
<a href="#5022" id="5022" class="l">5022: </a>                    <span class="php-var">$inactive</span>[] = <span class="php-var">$fid1</span>;
<a href="#5023" id="5023" class="l">5023: </a>                }
<a href="#5024" id="5024" class="l">5024: </a>            }
<a href="#5025" id="5025" class="l">5025: </a>        }
<a href="#5026" id="5026" class="l">5026: </a>    }
<a href="#5027" id="5027" class="l">5027: </a>    <span class="php-var">$inactiveforums</span> = <span class="php-keyword2">implode</span>(<span class="php-quote">&quot;,&quot;</span>, <span class="php-var">$inactive</span>);
<a href="#5028" id="5028" class="l">5028: </a>
<a href="#5029" id="5029" class="l">5029: </a>    <span class="php-keyword1">return</span> <span class="php-var">$inactiveforums</span>;
<a href="#5030" id="5030" class="l">5030: </a>}
<a href="#5031" id="5031" class="l">5031: </a>
<a href="#5032" id="5032" class="l">5032: </a><span class="php-comment">/**
</span><a href="#5033" id="5033" class="l">5033: </a><span class="php-comment"> * Checks to make sure a user has not tried to login more times than permitted
</span><a href="#5034" id="5034" class="l">5034: </a><span class="php-comment"> * Will stop execution with call to error() unless
</span><a href="#5035" id="5035" class="l">5035: </a><span class="php-comment"> *
</span><a href="#5036" id="5036" class="l">5036: </a><span class="php-comment"> * @param bool (Optional) The function will stop execution if it finds an error with the login. Default is True
</span><a href="#5037" id="5037" class="l">5037: </a><span class="php-comment"> * @return bool Number of logins when success, false if failed.
</span><a href="#5038" id="5038" class="l">5038: </a><span class="php-comment"> */</span>
<a href="#5039" id="5039" class="l">5039: </a><span class="php-keyword1">function</span> login_attempt_check(<span class="php-var">$fatal</span> = <span class="php-keyword1">true</span>)
<a href="#5040" id="5040" class="l">5040: </a>{
<a href="#5041" id="5041" class="l">5041: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>, <span class="php-var">$lang</span>, <span class="php-var">$session</span>, <span class="php-var">$db</span>;
<a href="#5042" id="5042" class="l">5042: </a>
<a href="#5043" id="5043" class="l">5043: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'failedlogincount'</span>] == <span class="php-num">0</span>)
<a href="#5044" id="5044" class="l">5044: </a>    {
<a href="#5045" id="5045" class="l">5045: </a>        <span class="php-keyword1">return</span> <span class="php-num">1</span>;
<a href="#5046" id="5046" class="l">5046: </a>    }
<a href="#5047" id="5047" class="l">5047: </a>    <span class="php-comment">// Note: Number of logins is defaulted to 1, because using 0 seems to clear cookie data. Not really a problem as long as we account for 1 being default.</span>
<a href="#5048" id="5048" class="l">5048: </a>
<a href="#5049" id="5049" class="l">5049: </a>    <span class="php-comment">// Use cookie if possible, otherwise use session</span>
<a href="#5050" id="5050" class="l">5050: </a>    <span class="php-comment">// Session stops user clearing cookies to bypass the login</span>
<a href="#5051" id="5051" class="l">5051: </a>    <span class="php-comment">// Also use the greater of the two numbers present, stops people using scripts with altered cookie data to stay the same</span>
<a href="#5052" id="5052" class="l">5052: </a>    <span class="php-var">$cookielogins</span> = <span class="php-keyword2">intval</span>(<span class="php-var">$mybb</span>-&gt;cookies[<span class="php-quote">'loginattempts'</span>]);
<a href="#5053" id="5053" class="l">5053: </a>    <span class="php-var">$cookietime</span> = <span class="php-var">$mybb</span>-&gt;cookies[<span class="php-quote">'failedlogin'</span>];
<a href="#5054" id="5054" class="l">5054: </a>
<a href="#5055" id="5055" class="l">5055: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword1">empty</span>(<span class="php-var">$cookielogins</span>) || <span class="php-var">$cookielogins</span> &lt; <span class="php-var">$session</span>-&gt;logins)
<a href="#5056" id="5056" class="l">5056: </a>    {
<a href="#5057" id="5057" class="l">5057: </a>        <span class="php-var">$loginattempts</span> = <span class="php-var">$session</span>-&gt;logins;
<a href="#5058" id="5058" class="l">5058: </a>    }
<a href="#5059" id="5059" class="l">5059: </a>    <span class="php-keyword1">else</span>
<a href="#5060" id="5060" class="l">5060: </a>    {
<a href="#5061" id="5061" class="l">5061: </a>        <span class="php-var">$loginattempts</span> = <span class="php-var">$cookielogins</span>;
<a href="#5062" id="5062" class="l">5062: </a>    }
<a href="#5063" id="5063" class="l">5063: </a>
<a href="#5064" id="5064" class="l">5064: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword1">empty</span>(<span class="php-var">$cookietime</span>) || <span class="php-var">$cookietime</span> &lt; <span class="php-var">$session</span>-&gt;failedlogin)
<a href="#5065" id="5065" class="l">5065: </a>    {
<a href="#5066" id="5066" class="l">5066: </a>        <span class="php-var">$failedlogin</span> = <span class="php-var">$session</span>-&gt;failedlogin;
<a href="#5067" id="5067" class="l">5067: </a>    }
<a href="#5068" id="5068" class="l">5068: </a>    <span class="php-keyword1">else</span>
<a href="#5069" id="5069" class="l">5069: </a>    {
<a href="#5070" id="5070" class="l">5070: </a>        <span class="php-var">$failedlogin</span> = <span class="php-var">$cookietime</span>;
<a href="#5071" id="5071" class="l">5071: </a>    }
<a href="#5072" id="5072" class="l">5072: </a>
<a href="#5073" id="5073" class="l">5073: </a>    <span class="php-comment">// Work out if the user has had more than the allowed number of login attempts</span>
<a href="#5074" id="5074" class="l">5074: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$loginattempts</span> &gt; <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'failedlogincount'</span>])
<a href="#5075" id="5075" class="l">5075: </a>    {
<a href="#5076" id="5076" class="l">5076: </a>        <span class="php-comment">// If so, then we need to work out if they can try to login again</span>
<a href="#5077" id="5077" class="l">5077: </a>        <span class="php-comment">// Some maths to work out how long they have left and display it to them</span>
<a href="#5078" id="5078" class="l">5078: </a>        <span class="php-var">$now</span> = TIME_NOW;
<a href="#5079" id="5079" class="l">5079: </a>
<a href="#5080" id="5080" class="l">5080: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword1">empty</span>(<span class="php-var">$mybb</span>-&gt;cookies[<span class="php-quote">'failedlogin'</span>]))
<a href="#5081" id="5081" class="l">5081: </a>        {
<a href="#5082" id="5082" class="l">5082: </a>            <span class="php-var">$failedtime</span> = <span class="php-var">$now</span>;
<a href="#5083" id="5083" class="l">5083: </a>        }
<a href="#5084" id="5084" class="l">5084: </a>        <span class="php-keyword1">else</span>
<a href="#5085" id="5085" class="l">5085: </a>        {
<a href="#5086" id="5086" class="l">5086: </a>            <span class="php-var">$failedtime</span> = <span class="php-var">$mybb</span>-&gt;cookies[<span class="php-quote">'failedlogin'</span>];
<a href="#5087" id="5087" class="l">5087: </a>        }
<a href="#5088" id="5088" class="l">5088: </a>
<a href="#5089" id="5089" class="l">5089: </a>        <span class="php-var">$secondsleft</span> = <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'failedlogintime'</span>] * <span class="php-num">60</span> + <span class="php-var">$failedtime</span> - <span class="php-var">$now</span>;
<a href="#5090" id="5090" class="l">5090: </a>        <span class="php-var">$hoursleft</span> = <span class="php-keyword2">floor</span>(<span class="php-var">$secondsleft</span> / <span class="php-num">3600</span>);
<a href="#5091" id="5091" class="l">5091: </a>        <span class="php-var">$minsleft</span> = <span class="php-keyword2">floor</span>((<span class="php-var">$secondsleft</span> / <span class="php-num">60</span>) % <span class="php-num">60</span>);
<a href="#5092" id="5092" class="l">5092: </a>        <span class="php-var">$secsleft</span> = <span class="php-keyword2">floor</span>(<span class="php-var">$secondsleft</span> % <span class="php-num">60</span>);
<a href="#5093" id="5093" class="l">5093: </a>
<a href="#5094" id="5094" class="l">5094: </a>        <span class="php-comment">// This value will be empty the first time the user doesn't login in, set it</span>
<a href="#5095" id="5095" class="l">5095: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword1">empty</span>(<span class="php-var">$failedlogin</span>))
<a href="#5096" id="5096" class="l">5096: </a>        {
<a href="#5097" id="5097" class="l">5097: </a>            my_setcookie(<span class="php-quote">'failedlogin'</span>, <span class="php-var">$now</span>);
<a href="#5098" id="5098" class="l">5098: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$fatal</span>)
<a href="#5099" id="5099" class="l">5099: </a>            {
<a href="#5100" id="5100" class="l">5100: </a>                error(<span class="php-var">$lang</span>-&gt;<span class="php-keyword2">sprintf</span>(<span class="php-var">$lang</span>-&gt;failed_login_wait, <span class="php-var">$hoursleft</span>, <span class="php-var">$minsleft</span>, <span class="php-var">$secsleft</span>));
<a href="#5101" id="5101" class="l">5101: </a>            }
<a href="#5102" id="5102" class="l">5102: </a>
<a href="#5103" id="5103" class="l">5103: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#5104" id="5104" class="l">5104: </a>        }
<a href="#5105" id="5105" class="l">5105: </a>
<a href="#5106" id="5106" class="l">5106: </a>        <span class="php-comment">// Work out if the user has waited long enough before letting them login again</span>
<a href="#5107" id="5107" class="l">5107: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;cookies[<span class="php-quote">'failedlogin'</span>] &lt; (<span class="php-var">$now</span> - <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'failedlogintime'</span>] * <span class="php-num">60</span>))
<a href="#5108" id="5108" class="l">5108: </a>        {
<a href="#5109" id="5109" class="l">5109: </a>            my_setcookie(<span class="php-quote">'loginattempts'</span>, <span class="php-num">1</span>);
<a href="#5110" id="5110" class="l">5110: </a>            my_unsetcookie(<span class="php-quote">'failedlogin'</span>);
<a href="#5111" id="5111" class="l">5111: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;user[<span class="php-quote">'uid'</span>] != <span class="php-num">0</span>)
<a href="#5112" id="5112" class="l">5112: </a>            {
<a href="#5113" id="5113" class="l">5113: </a>                <span class="php-var">$update_array</span> = <span class="php-keyword1">array</span>(
<a href="#5114" id="5114" class="l">5114: </a>                    <span class="php-quote">'loginattempts'</span> =&gt; <span class="php-num">1</span>
<a href="#5115" id="5115" class="l">5115: </a>                );
<a href="#5116" id="5116" class="l">5116: </a>                <span class="php-var">$db</span>-&gt;update_query(<span class="php-quote">&quot;users&quot;</span>, <span class="php-var">$update_array</span>, <span class="php-quote">&quot;uid = '</span><span class="php-var">{$mybb-&gt;user['uid']}</span><span class="php-quote">'&quot;</span>);
<a href="#5117" id="5117" class="l">5117: </a>            }
<a href="#5118" id="5118" class="l">5118: </a>            <span class="php-keyword1">return</span> <span class="php-num">1</span>;
<a href="#5119" id="5119" class="l">5119: </a>        }
<a href="#5120" id="5120" class="l">5120: </a>        <span class="php-comment">// Not waited long enough</span>
<a href="#5121" id="5121" class="l">5121: </a>        <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;cookies[<span class="php-quote">'failedlogin'</span>] &gt; (<span class="php-var">$now</span> - <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'failedlogintime'</span>] * <span class="php-num">60</span>))
<a href="#5122" id="5122" class="l">5122: </a>        {
<a href="#5123" id="5123" class="l">5123: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$fatal</span>)
<a href="#5124" id="5124" class="l">5124: </a>            {
<a href="#5125" id="5125" class="l">5125: </a>                error(<span class="php-var">$lang</span>-&gt;<span class="php-keyword2">sprintf</span>(<span class="php-var">$lang</span>-&gt;failed_login_wait, <span class="php-var">$hoursleft</span>, <span class="php-var">$minsleft</span>, <span class="php-var">$secsleft</span>));
<a href="#5126" id="5126" class="l">5126: </a>            }
<a href="#5127" id="5127" class="l">5127: </a>
<a href="#5128" id="5128" class="l">5128: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#5129" id="5129" class="l">5129: </a>        }
<a href="#5130" id="5130" class="l">5130: </a>    }
<a href="#5131" id="5131" class="l">5131: </a>
<a href="#5132" id="5132" class="l">5132: </a>    <span class="php-comment">// User can attempt another login</span>
<a href="#5133" id="5133" class="l">5133: </a>    <span class="php-keyword1">return</span> <span class="php-var">$loginattempts</span>;
<a href="#5134" id="5134" class="l">5134: </a>}
<a href="#5135" id="5135" class="l">5135: </a>
<a href="#5136" id="5136" class="l">5136: </a><span class="php-comment">/**
</span><a href="#5137" id="5137" class="l">5137: </a><span class="php-comment"> * Validates the format of an email address.
</span><a href="#5138" id="5138" class="l">5138: </a><span class="php-comment"> *
</span><a href="#5139" id="5139" class="l">5139: </a><span class="php-comment"> * @param string The string to check.
</span><a href="#5140" id="5140" class="l">5140: </a><span class="php-comment"> * @return boolean True when valid, false when invalid.
</span><a href="#5141" id="5141" class="l">5141: </a><span class="php-comment"> */</span>
<a href="#5142" id="5142" class="l">5142: </a><span class="php-keyword1">function</span> validate_email_format(<span class="php-var">$email</span>)
<a href="#5143" id="5143" class="l">5143: </a>{
<a href="#5144" id="5144" class="l">5144: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">strpos</span>(<span class="php-var">$email</span>, <span class="php-quote">' '</span>) !== <span class="php-keyword1">false</span>)
<a href="#5145" id="5145" class="l">5145: </a>    {
<a href="#5146" id="5146" class="l">5146: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#5147" id="5147" class="l">5147: </a>    }
<a href="#5148" id="5148" class="l">5148: </a>    <span class="php-comment">// Valid local characters for email addresses: http://www.remote.org/jochen/mail/info/chars.html</span>
<a href="#5149" id="5149" class="l">5149: </a>    <span class="php-keyword1">return</span> <span class="php-keyword2">preg_match</span>(<span class="php-quote">&quot;/^[a-zA-Z0-9&amp;*+\-_.{}~^\?=\/]+@[a-zA-Z0-9-]+\.([a-zA-Z0-9-]+\.)*[a-zA-Z0-9-]{2,}</span><span class="php-var">$</span><span class="php-quote">/si&quot;</span>, <span class="php-var">$email</span>);
<a href="#5150" id="5150" class="l">5150: </a>}
<a href="#5151" id="5151" class="l">5151: </a>
<a href="#5152" id="5152" class="l">5152: </a><span class="php-comment">/**
</span><a href="#5153" id="5153" class="l">5153: </a><span class="php-comment"> * Checks to see if the email is already in use by another
</span><a href="#5154" id="5154" class="l">5154: </a><span class="php-comment"> *
</span><a href="#5155" id="5155" class="l">5155: </a><span class="php-comment"> * @param string The email to check.
</span><a href="#5156" id="5156" class="l">5156: </a><span class="php-comment"> * @param string User ID of the user (updating only)
</span><a href="#5157" id="5157" class="l">5157: </a><span class="php-comment"> * @return boolean True when in use, false when not.
</span><a href="#5158" id="5158" class="l">5158: </a><span class="php-comment"> */</span>
<a href="#5159" id="5159" class="l">5159: </a><span class="php-keyword1">function</span> email_already_in_use(<span class="php-var">$email</span>, <span class="php-var">$uid</span>=<span class="php-quote">&quot;&quot;</span>)
<a href="#5160" id="5160" class="l">5160: </a>{
<a href="#5161" id="5161" class="l">5161: </a>    <span class="php-keyword1">global</span> <span class="php-var">$db</span>;
<a href="#5162" id="5162" class="l">5162: </a>    
<a href="#5163" id="5163" class="l">5163: </a>    <span class="php-var">$uid_string</span> = <span class="php-quote">&quot;&quot;</span>;
<a href="#5164" id="5164" class="l">5164: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$uid</span>)
<a href="#5165" id="5165" class="l">5165: </a>    {
<a href="#5166" id="5166" class="l">5166: </a>        <span class="php-var">$uid_string</span> = <span class="php-quote">&quot; AND uid != '&quot;</span>.<span class="php-keyword2">intval</span>(<span class="php-var">$uid</span>).<span class="php-quote">&quot;'&quot;</span>;
<a href="#5167" id="5167" class="l">5167: </a>    }
<a href="#5168" id="5168" class="l">5168: </a>    <span class="php-var">$query</span> = <span class="php-var">$db</span>-&gt;simple_select(<span class="php-quote">&quot;users&quot;</span>, <span class="php-quote">&quot;COUNT(email) as emails&quot;</span>, <span class="php-quote">&quot;email = '&quot;</span>.<span class="php-var">$db</span>-&gt;escape_string(<span class="php-var">$email</span>).<span class="php-quote">&quot;'</span><span class="php-var">{$uid_string}</span><span class="php-quote">&quot;</span>);
<a href="#5169" id="5169" class="l">5169: </a>    
<a href="#5170" id="5170" class="l">5170: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$db</span>-&gt;fetch_field(<span class="php-var">$query</span>, <span class="php-quote">&quot;emails&quot;</span>) &gt; <span class="php-num">0</span>)
<a href="#5171" id="5171" class="l">5171: </a>    {
<a href="#5172" id="5172" class="l">5172: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
<a href="#5173" id="5173" class="l">5173: </a>    }
<a href="#5174" id="5174" class="l">5174: </a>    
<a href="#5175" id="5175" class="l">5175: </a>    <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#5176" id="5176" class="l">5176: </a>}
<a href="#5177" id="5177" class="l">5177: </a>
<a href="#5178" id="5178" class="l">5178: </a><span class="php-comment">/*
</span><a href="#5179" id="5179" class="l">5179: </a><span class="php-comment"> * DEPRECATED! ONLY INCLUDED FOR COMPATIBILITY PURPOSES.
</span><a href="#5180" id="5180" class="l">5180: </a><span class="php-comment"> */</span>
<a href="#5181" id="5181" class="l">5181: </a><span class="php-keyword1">function</span> rebuildsettings()
<a href="#5182" id="5182" class="l">5182: </a>{
<a href="#5183" id="5183" class="l">5183: </a>    rebuild_settings();
<a href="#5184" id="5184" class="l">5184: </a>}
<a href="#5185" id="5185" class="l">5185: </a>
<a href="#5186" id="5186" class="l">5186: </a><span class="php-comment">/**
</span><a href="#5187" id="5187" class="l">5187: </a><span class="php-comment"> * Rebuilds settings.php
</span><a href="#5188" id="5188" class="l">5188: </a><span class="php-comment"> *
</span><a href="#5189" id="5189" class="l">5189: </a><span class="php-comment"> */</span>
<a href="#5190" id="5190" class="l">5190: </a><span class="php-keyword1">function</span> rebuild_settings()
<a href="#5191" id="5191" class="l">5191: </a>{
<a href="#5192" id="5192" class="l">5192: </a>    <span class="php-keyword1">global</span> <span class="php-var">$db</span>, <span class="php-var">$mybb</span>;
<a href="#5193" id="5193" class="l">5193: </a>
<a href="#5194" id="5194" class="l">5194: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">file_exists</span>(MYBB_ROOT.<span class="php-quote">&quot;inc/settings.php&quot;</span>))
<a href="#5195" id="5195" class="l">5195: </a>    {
<a href="#5196" id="5196" class="l">5196: </a>        <span class="php-var">$mode</span> = <span class="php-quote">&quot;x&quot;</span>;
<a href="#5197" id="5197" class="l">5197: </a>    }
<a href="#5198" id="5198" class="l">5198: </a>    <span class="php-keyword1">else</span>
<a href="#5199" id="5199" class="l">5199: </a>    {
<a href="#5200" id="5200" class="l">5200: </a>        <span class="php-var">$mode</span> = <span class="php-quote">&quot;w&quot;</span>;
<a href="#5201" id="5201" class="l">5201: </a>    }
<a href="#5202" id="5202" class="l">5202: </a>
<a href="#5203" id="5203" class="l">5203: </a>    <span class="php-var">$options</span> = <span class="php-keyword1">array</span>(
<a href="#5204" id="5204" class="l">5204: </a>        <span class="php-quote">&quot;order_by&quot;</span> =&gt; <span class="php-quote">&quot;title&quot;</span>,
<a href="#5205" id="5205" class="l">5205: </a>        <span class="php-quote">&quot;order_dir&quot;</span> =&gt; <span class="php-quote">&quot;ASC&quot;</span>
<a href="#5206" id="5206" class="l">5206: </a>    );
<a href="#5207" id="5207" class="l">5207: </a>    <span class="php-var">$query</span> = <span class="php-var">$db</span>-&gt;simple_select(<span class="php-quote">&quot;settings&quot;</span>, <span class="php-quote">&quot;value, name&quot;</span>, <span class="php-quote">&quot;&quot;</span>, <span class="php-var">$options</span>);
<a href="#5208" id="5208" class="l">5208: </a>
<a href="#5209" id="5209" class="l">5209: </a>    <span class="php-keyword1">while</span>(<span class="php-var">$setting</span> = <span class="php-var">$db</span>-&gt;fetch_array(<span class="php-var">$query</span>))
<a href="#5210" id="5210" class="l">5210: </a>    {
<a href="#5211" id="5211" class="l">5211: </a>        <span class="php-var">$mybb</span>-&gt;settings[<span class="php-var">$setting</span>[<span class="php-quote">'name'</span>]] = <span class="php-var">$setting</span>[<span class="php-quote">'value'</span>];
<a href="#5212" id="5212" class="l">5212: </a>        <span class="php-var">$setting</span>[<span class="php-quote">'value'</span>] = <span class="php-keyword2">addcslashes</span>(<span class="php-var">$setting</span>[<span class="php-quote">'value'</span>], <span class="php-quote">'\\&quot;$'</span>);
<a href="#5213" id="5213" class="l">5213: </a>        <span class="php-var">$settings</span> .= <span class="php-quote">&quot;\</span><span class="php-var">$settings</span><span class="php-quote">['</span><span class="php-var">{$setting['name']}</span><span class="php-quote">'] = \&quot;</span><span class="php-var">{$setting['value']}</span><span class="php-quote">\&quot;;\n&quot;</span>;
<a href="#5214" id="5214" class="l">5214: </a>    }
<a href="#5215" id="5215" class="l">5215: </a>    
<a href="#5216" id="5216" class="l">5216: </a>    <span class="php-var">$settings</span> = <span class="php-quote">&quot;&lt;&quot;</span>.<span class="php-quote">&quot;?php\n/*********************************\ \n  DO NOT EDIT THIS FILE, PLEASE USE\n  THE SETTINGS EDITOR\n\*********************************/\n\n</span><span class="php-var">$settings</span><span class="php-quote">\n?&quot;</span>.<span class="php-quote">&quot;&gt;&quot;</span>;
<a href="#5217" id="5217" class="l">5217: </a>    <span class="php-var">$file</span> = @<span class="php-keyword2">fopen</span>(MYBB_ROOT.<span class="php-quote">&quot;inc/settings.php&quot;</span>, <span class="php-var">$mode</span>);
<a href="#5218" id="5218" class="l">5218: </a>    @<span class="php-keyword2">fwrite</span>(<span class="php-var">$file</span>, <span class="php-var">$settings</span>);
<a href="#5219" id="5219" class="l">5219: </a>    @<span class="php-keyword2">fclose</span>(<span class="php-var">$file</span>);
<a href="#5220" id="5220" class="l">5220: </a>
<a href="#5221" id="5221" class="l">5221: </a>    <span class="php-var">$GLOBALS</span>[<span class="php-quote">'settings'</span>] = &amp;<span class="php-var">$mybb</span>-&gt;settings;
<a href="#5222" id="5222" class="l">5222: </a>}
<a href="#5223" id="5223" class="l">5223: </a>
<a href="#5224" id="5224" class="l">5224: </a><span class="php-comment">/**
</span><a href="#5225" id="5225" class="l">5225: </a><span class="php-comment"> * Build a PREG compatible array of search highlight terms to replace in posts.
</span><a href="#5226" id="5226" class="l">5226: </a><span class="php-comment"> *
</span><a href="#5227" id="5227" class="l">5227: </a><span class="php-comment"> * @param string Incoming terms to highlight
</span><a href="#5228" id="5228" class="l">5228: </a><span class="php-comment"> * @return array PREG compatible array of terms
</span><a href="#5229" id="5229" class="l">5229: </a><span class="php-comment"> */</span>
<a href="#5230" id="5230" class="l">5230: </a><span class="php-keyword1">function</span> build_highlight_array(<span class="php-var">$terms</span>)
<a href="#5231" id="5231" class="l">5231: </a>{
<a href="#5232" id="5232" class="l">5232: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>;
<a href="#5233" id="5233" class="l">5233: </a>
<a href="#5234" id="5234" class="l">5234: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'minsearchword'</span>] &lt; <span class="php-num">1</span>)
<a href="#5235" id="5235" class="l">5235: </a>    {
<a href="#5236" id="5236" class="l">5236: </a>        <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'minsearchword'</span>] = <span class="php-num">3</span>;
<a href="#5237" id="5237" class="l">5237: </a>    } 
<a href="#5238" id="5238" class="l">5238: </a>
<a href="#5239" id="5239" class="l">5239: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$terms</span>))
<a href="#5240" id="5240" class="l">5240: </a>    {
<a href="#5241" id="5241" class="l">5241: </a>        <span class="php-var">$terms</span> = <span class="php-keyword2">implode</span>(<span class="php-quote">' '</span>, <span class="php-var">$terms</span>);
<a href="#5242" id="5242" class="l">5242: </a>    }
<a href="#5243" id="5243" class="l">5243: </a>
<a href="#5244" id="5244" class="l">5244: </a>    <span class="php-comment">// Strip out any characters that shouldn't be included</span>
<a href="#5245" id="5245" class="l">5245: </a>    <span class="php-var">$bad_characters</span> = <span class="php-keyword1">array</span>(
<a href="#5246" id="5246" class="l">5246: </a>        <span class="php-quote">&quot;(&quot;</span>,
<a href="#5247" id="5247" class="l">5247: </a>        <span class="php-quote">&quot;)&quot;</span>,
<a href="#5248" id="5248" class="l">5248: </a>        <span class="php-quote">&quot;+&quot;</span>,
<a href="#5249" id="5249" class="l">5249: </a>        <span class="php-quote">&quot;-&quot;</span>,
<a href="#5250" id="5250" class="l">5250: </a>        <span class="php-quote">&quot;~&quot;</span>
<a href="#5251" id="5251" class="l">5251: </a>    );
<a href="#5252" id="5252" class="l">5252: </a>    <span class="php-var">$terms</span> = <span class="php-keyword2">str_replace</span>(<span class="php-var">$bad_characters</span>, <span class="php-quote">''</span>, <span class="php-var">$terms</span>);
<a href="#5253" id="5253" class="l">5253: </a>
<a href="#5254" id="5254" class="l">5254: </a>    <span class="php-comment">// Check if this is a &quot;series of words&quot; - should be treated as an EXACT match</span>
<a href="#5255" id="5255" class="l">5255: </a>    <span class="php-keyword1">if</span>(my_strpos(<span class="php-var">$terms</span>, <span class="php-quote">&quot;\&quot;&quot;</span>) !== <span class="php-keyword1">false</span>)
<a href="#5256" id="5256" class="l">5256: </a>    {
<a href="#5257" id="5257" class="l">5257: </a>        <span class="php-var">$inquote</span> = <span class="php-keyword1">false</span>;
<a href="#5258" id="5258" class="l">5258: </a>        <span class="php-var">$terms</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">&quot;\&quot;&quot;</span>, <span class="php-var">$terms</span>);
<a href="#5259" id="5259" class="l">5259: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$terms</span> <span class="php-keyword1">as</span> <span class="php-var">$phrase</span>)
<a href="#5260" id="5260" class="l">5260: </a>        {
<a href="#5261" id="5261" class="l">5261: </a>            <span class="php-var">$phrase</span> = htmlspecialchars_uni(<span class="php-var">$phrase</span>);
<a href="#5262" id="5262" class="l">5262: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$phrase</span> != <span class="php-quote">&quot;&quot;</span>)
<a href="#5263" id="5263" class="l">5263: </a>            {
<a href="#5264" id="5264" class="l">5264: </a>                <span class="php-keyword1">if</span>(<span class="php-var">$inquote</span>)
<a href="#5265" id="5265" class="l">5265: </a>                {
<a href="#5266" id="5266" class="l">5266: </a>                    <span class="php-var">$words</span>[] = <span class="php-keyword2">trim</span>(<span class="php-var">$phrase</span>);
<a href="#5267" id="5267" class="l">5267: </a>                }
<a href="#5268" id="5268" class="l">5268: </a>                <span class="php-keyword1">else</span>
<a href="#5269" id="5269" class="l">5269: </a>                {
<a href="#5270" id="5270" class="l">5270: </a>                    <span class="php-var">$split_words</span> = <span class="php-keyword2">preg_split</span>(<span class="php-quote">&quot;#\s{1,}#&quot;</span>, <span class="php-var">$phrase</span>, -<span class="php-num">1</span>);
<a href="#5271" id="5271" class="l">5271: </a>                    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$split_words</span>))
<a href="#5272" id="5272" class="l">5272: </a>                    {
<a href="#5273" id="5273" class="l">5273: </a>                        <span class="php-keyword1">continue</span>;
<a href="#5274" id="5274" class="l">5274: </a>                    }
<a href="#5275" id="5275" class="l">5275: </a>                    <span class="php-keyword1">foreach</span>(<span class="php-var">$split_words</span> <span class="php-keyword1">as</span> <span class="php-var">$word</span>)
<a href="#5276" id="5276" class="l">5276: </a>                    {
<a href="#5277" id="5277" class="l">5277: </a>                        <span class="php-keyword1">if</span>(!<span class="php-var">$word</span> || <span class="php-keyword2">strlen</span>(<span class="php-var">$word</span>) &lt; <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'minsearchword'</span>])
<a href="#5278" id="5278" class="l">5278: </a>                        {
<a href="#5279" id="5279" class="l">5279: </a>                            <span class="php-keyword1">continue</span>;
<a href="#5280" id="5280" class="l">5280: </a>                        }
<a href="#5281" id="5281" class="l">5281: </a>                        <span class="php-var">$words</span>[] = <span class="php-keyword2">trim</span>(<span class="php-var">$word</span>);
<a href="#5282" id="5282" class="l">5282: </a>                    }
<a href="#5283" id="5283" class="l">5283: </a>                }
<a href="#5284" id="5284" class="l">5284: </a>            }
<a href="#5285" id="5285" class="l">5285: </a>            <span class="php-var">$inquote</span> = !<span class="php-var">$inquote</span>;
<a href="#5286" id="5286" class="l">5286: </a>        }
<a href="#5287" id="5287" class="l">5287: </a>    }
<a href="#5288" id="5288" class="l">5288: </a>    <span class="php-comment">// Otherwise just a simple search query with no phrases</span>
<a href="#5289" id="5289" class="l">5289: </a>    <span class="php-keyword1">else</span>
<a href="#5290" id="5290" class="l">5290: </a>    {
<a href="#5291" id="5291" class="l">5291: </a>        <span class="php-var">$terms</span> = htmlspecialchars_uni(<span class="php-var">$terms</span>);
<a href="#5292" id="5292" class="l">5292: </a>        <span class="php-var">$split_words</span> = <span class="php-keyword2">preg_split</span>(<span class="php-quote">&quot;#\s{1,}#&quot;</span>, <span class="php-var">$terms</span>, -<span class="php-num">1</span>);
<a href="#5293" id="5293" class="l">5293: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$split_words</span>))
<a href="#5294" id="5294" class="l">5294: </a>        {
<a href="#5295" id="5295" class="l">5295: </a>            <span class="php-keyword1">foreach</span>(<span class="php-var">$split_words</span> <span class="php-keyword1">as</span> <span class="php-var">$word</span>)
<a href="#5296" id="5296" class="l">5296: </a>            {
<a href="#5297" id="5297" class="l">5297: </a>                <span class="php-keyword1">if</span>(!<span class="php-var">$word</span> || <span class="php-keyword2">strlen</span>(<span class="php-var">$word</span>) &lt; <span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'minsearchword'</span>])
<a href="#5298" id="5298" class="l">5298: </a>                {
<a href="#5299" id="5299" class="l">5299: </a>                    <span class="php-keyword1">continue</span>;
<a href="#5300" id="5300" class="l">5300: </a>                }
<a href="#5301" id="5301" class="l">5301: </a>                <span class="php-var">$words</span>[] = <span class="php-keyword2">trim</span>(<span class="php-var">$word</span>);
<a href="#5302" id="5302" class="l">5302: </a>            }
<a href="#5303" id="5303" class="l">5303: </a>        }
<a href="#5304" id="5304" class="l">5304: </a>    }
<a href="#5305" id="5305" class="l">5305: </a>
<a href="#5306" id="5306" class="l">5306: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$words</span>))
<a href="#5307" id="5307" class="l">5307: </a>    {
<a href="#5308" id="5308" class="l">5308: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#5309" id="5309" class="l">5309: </a>    }
<a href="#5310" id="5310" class="l">5310: </a>    
<a href="#5311" id="5311" class="l">5311: </a>    <span class="php-comment">// Sort the word array by length. Largest terms go first and work their way down to the smallest term.</span>
<a href="#5312" id="5312" class="l">5312: </a>    <span class="php-comment">// This resolves problems like &quot;test tes&quot; where &quot;tes&quot; will be highlighted first, then &quot;test&quot; can't be highlighted because of the changed html</span>
<a href="#5313" id="5313" class="l">5313: </a>    <span class="php-keyword2">usort</span>(<span class="php-var">$words</span>, <span class="php-keyword2">create_function</span>(<span class="php-quote">'$a,$b'</span>, <span class="php-quote">'return strlen($b) - strlen($a);'</span>));
<a href="#5314" id="5314" class="l">5314: </a>
<a href="#5315" id="5315" class="l">5315: </a>    <span class="php-comment">// Loop through our words to build the PREG compatible strings</span>
<a href="#5316" id="5316" class="l">5316: </a>    <span class="php-keyword1">foreach</span>(<span class="php-var">$words</span> <span class="php-keyword1">as</span> <span class="php-var">$word</span>)
<a href="#5317" id="5317" class="l">5317: </a>    {
<a href="#5318" id="5318" class="l">5318: </a>        <span class="php-var">$word</span> = <span class="php-keyword2">trim</span>(<span class="php-var">$word</span>);
<a href="#5319" id="5319" class="l">5319: </a>
<a href="#5320" id="5320" class="l">5320: </a>        <span class="php-var">$word</span> = my_strtolower(<span class="php-var">$word</span>);
<a href="#5321" id="5321" class="l">5321: </a>    
<a href="#5322" id="5322" class="l">5322: </a>        <span class="php-comment">// Special boolean operators should be stripped</span>
<a href="#5323" id="5323" class="l">5323: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$word</span> == <span class="php-quote">&quot;&quot;</span> || <span class="php-var">$word</span> == <span class="php-quote">&quot;or&quot;</span> || <span class="php-var">$word</span> == <span class="php-quote">&quot;not&quot;</span> || <span class="php-var">$word</span> == <span class="php-quote">&quot;and&quot;</span>)
<a href="#5324" id="5324" class="l">5324: </a>        {
<a href="#5325" id="5325" class="l">5325: </a>            <span class="php-keyword1">continue</span>;
<a href="#5326" id="5326" class="l">5326: </a>        }
<a href="#5327" id="5327" class="l">5327: </a>
<a href="#5328" id="5328" class="l">5328: </a>        <span class="php-comment">// Now make PREG compatible</span>
<a href="#5329" id="5329" class="l">5329: </a>        <span class="php-var">$find</span> = <span class="php-quote">&quot;#(?!&lt;.*?)(&quot;</span>.<span class="php-keyword2">preg_quote</span>(<span class="php-var">$word</span>, <span class="php-quote">&quot;#&quot;</span>).<span class="php-quote">&quot;)(?![^&lt;&gt;]*?&gt;)#ui&quot;</span>;
<a href="#5330" id="5330" class="l">5330: </a>        <span class="php-var">$replacement</span> = <span class="php-quote">&quot;&lt;span class=\&quot;highlight\&quot; style=\&quot;padding-left: 0px; padding-right: 0px;\&quot;&gt;</span><span class="php-var">$1</span><span class="php-quote">&lt;/span&gt;&quot;</span>;
<a href="#5331" id="5331" class="l">5331: </a>        <span class="php-var">$highlight_cache</span>[<span class="php-var">$find</span>] = <span class="php-var">$replacement</span>;
<a href="#5332" id="5332" class="l">5332: </a>    }
<a href="#5333" id="5333" class="l">5333: </a>
<a href="#5334" id="5334" class="l">5334: </a>    <span class="php-keyword1">return</span> <span class="php-var">$highlight_cache</span>;
<a href="#5335" id="5335" class="l">5335: </a>}
<a href="#5336" id="5336" class="l">5336: </a>
<a href="#5337" id="5337" class="l">5337: </a><span class="php-comment">/**
</span><a href="#5338" id="5338" class="l">5338: </a><span class="php-comment"> * Converts a decimal reference of a character to its UTF-8 equivalent
</span><a href="#5339" id="5339" class="l">5339: </a><span class="php-comment"> * (Code by Anne van Kesteren, http://annevankesteren.nl/2005/05/character-references)
</span><a href="#5340" id="5340" class="l">5340: </a><span class="php-comment"> *
</span><a href="#5341" id="5341" class="l">5341: </a><span class="php-comment"> * @param string Decimal value of a character reference
</span><a href="#5342" id="5342" class="l">5342: </a><span class="php-comment"> */</span>
<a href="#5343" id="5343" class="l">5343: </a><span class="php-keyword1">function</span> dec_to_utf8(<span class="php-var">$src</span>)
<a href="#5344" id="5344" class="l">5344: </a>{
<a href="#5345" id="5345" class="l">5345: </a>    <span class="php-var">$dest</span> = <span class="php-quote">''</span>;
<a href="#5346" id="5346" class="l">5346: </a>
<a href="#5347" id="5347" class="l">5347: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$src</span> &lt; <span class="php-num">0</span>)
<a href="#5348" id="5348" class="l">5348: </a>    {
<a href="#5349" id="5349" class="l">5349: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#5350" id="5350" class="l">5350: </a>    }
<a href="#5351" id="5351" class="l">5351: </a>    <span class="php-keyword1">elseif</span>(<span class="php-var">$src</span> &lt;= <span class="php-num">0x007f</span>)
<a href="#5352" id="5352" class="l">5352: </a>    {
<a href="#5353" id="5353" class="l">5353: </a>        <span class="php-var">$dest</span> .= <span class="php-keyword2">chr</span>(<span class="php-var">$src</span>);
<a href="#5354" id="5354" class="l">5354: </a>    }
<a href="#5355" id="5355" class="l">5355: </a>    <span class="php-keyword1">elseif</span>(<span class="php-var">$src</span> &lt;= <span class="php-num">0x07ff</span>)
<a href="#5356" id="5356" class="l">5356: </a>    {
<a href="#5357" id="5357" class="l">5357: </a>        <span class="php-var">$dest</span> .= <span class="php-keyword2">chr</span>(<span class="php-num">0xc0</span> | (<span class="php-var">$src</span> &gt;&gt; <span class="php-num">6</span>));
<a href="#5358" id="5358" class="l">5358: </a>        <span class="php-var">$dest</span> .= <span class="php-keyword2">chr</span>(<span class="php-num">0x80</span> | (<span class="php-var">$src</span> &amp; <span class="php-num">0x003f</span>));
<a href="#5359" id="5359" class="l">5359: </a>    }
<a href="#5360" id="5360" class="l">5360: </a>    <span class="php-keyword1">elseif</span>(<span class="php-var">$src</span> &lt;= <span class="php-num">0xffff</span>)
<a href="#5361" id="5361" class="l">5361: </a>    {
<a href="#5362" id="5362" class="l">5362: </a>        <span class="php-var">$dest</span> .= <span class="php-keyword2">chr</span>(<span class="php-num">0xe0</span> | (<span class="php-var">$src</span> &gt;&gt; <span class="php-num">12</span>));
<a href="#5363" id="5363" class="l">5363: </a>        <span class="php-var">$dest</span> .= <span class="php-keyword2">chr</span>(<span class="php-num">0x80</span> | ((<span class="php-var">$src</span> &gt;&gt; <span class="php-num">6</span>) &amp; <span class="php-num">0x003f</span>));
<a href="#5364" id="5364" class="l">5364: </a>        <span class="php-var">$dest</span> .= <span class="php-keyword2">chr</span>(<span class="php-num">0x80</span> | (<span class="php-var">$src</span> &amp; <span class="php-num">0x003f</span>));
<a href="#5365" id="5365" class="l">5365: </a>    }
<a href="#5366" id="5366" class="l">5366: </a>    <span class="php-keyword1">elseif</span>(<span class="php-var">$src</span> &lt;= <span class="php-num">0x10ffff</span>)
<a href="#5367" id="5367" class="l">5367: </a>    {
<a href="#5368" id="5368" class="l">5368: </a>        <span class="php-var">$dest</span> .= <span class="php-keyword2">chr</span>(<span class="php-num">0xf0</span> | (<span class="php-var">$src</span> &gt;&gt; <span class="php-num">18</span>));
<a href="#5369" id="5369" class="l">5369: </a>        <span class="php-var">$dest</span> .= <span class="php-keyword2">chr</span>(<span class="php-num">0x80</span> | ((<span class="php-var">$src</span> &gt;&gt; <span class="php-num">12</span>) &amp; <span class="php-num">0x3f</span>));
<a href="#5370" id="5370" class="l">5370: </a>        <span class="php-var">$dest</span> .= <span class="php-keyword2">chr</span>(<span class="php-num">0x80</span> | ((<span class="php-var">$src</span> &gt;&gt; <span class="php-num">6</span>) &amp; <span class="php-num">0x3f</span>));
<a href="#5371" id="5371" class="l">5371: </a>        <span class="php-var">$dest</span> .= <span class="php-keyword2">chr</span>(<span class="php-num">0x80</span> | (<span class="php-var">$src</span> &amp; <span class="php-num">0x3f</span>));
<a href="#5372" id="5372" class="l">5372: </a>    }
<a href="#5373" id="5373" class="l">5373: </a>    <span class="php-keyword1">else</span>
<a href="#5374" id="5374" class="l">5374: </a>    {
<a href="#5375" id="5375" class="l">5375: </a>        <span class="php-comment">// Out of range</span>
<a href="#5376" id="5376" class="l">5376: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#5377" id="5377" class="l">5377: </a>    }
<a href="#5378" id="5378" class="l">5378: </a>
<a href="#5379" id="5379" class="l">5379: </a>    <span class="php-keyword1">return</span> <span class="php-var">$dest</span>;
<a href="#5380" id="5380" class="l">5380: </a>}
<a href="#5381" id="5381" class="l">5381: </a>
<a href="#5382" id="5382" class="l">5382: </a><span class="php-comment">/**
</span><a href="#5383" id="5383" class="l">5383: </a><span class="php-comment"> * Checks if a username has been disallowed for registration/use.
</span><a href="#5384" id="5384" class="l">5384: </a><span class="php-comment"> *
</span><a href="#5385" id="5385" class="l">5385: </a><span class="php-comment"> * @param string The username
</span><a href="#5386" id="5386" class="l">5386: </a><span class="php-comment"> * @param boolean True if the 'last used' dateline should be updated if a match is found.
</span><a href="#5387" id="5387" class="l">5387: </a><span class="php-comment"> * @return boolean True if banned, false if not banned
</span><a href="#5388" id="5388" class="l">5388: </a><span class="php-comment"> */</span>
<a href="#5389" id="5389" class="l">5389: </a><span class="php-keyword1">function</span> is_banned_username(<span class="php-var">$username</span>, <span class="php-var">$update_lastuse</span>=<span class="php-keyword1">false</span>)
<a href="#5390" id="5390" class="l">5390: </a>{
<a href="#5391" id="5391" class="l">5391: </a>    <span class="php-keyword1">global</span> <span class="php-var">$db</span>;
<a href="#5392" id="5392" class="l">5392: </a>    <span class="php-var">$query</span> = <span class="php-var">$db</span>-&gt;simple_select(<span class="php-quote">'banfilters'</span>, <span class="php-quote">'filter, fid'</span>, <span class="php-quote">&quot;type='2'&quot;</span>);
<a href="#5393" id="5393" class="l">5393: </a>    <span class="php-keyword1">while</span>(<span class="php-var">$banned_username</span> = <span class="php-var">$db</span>-&gt;fetch_array(<span class="php-var">$query</span>))
<a href="#5394" id="5394" class="l">5394: </a>    {
<a href="#5395" id="5395" class="l">5395: </a>        <span class="php-comment">// Make regular expression * match</span>
<a href="#5396" id="5396" class="l">5396: </a>        <span class="php-var">$banned_username</span>[<span class="php-quote">'filter'</span>] = <span class="php-keyword2">str_replace</span>(<span class="php-quote">'\*'</span>, <span class="php-quote">'(.*)'</span>, <span class="php-keyword2">preg_quote</span>(<span class="php-var">$banned_username</span>[<span class="php-quote">'filter'</span>], <span class="php-quote">'#'</span>));
<a href="#5397" id="5397" class="l">5397: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">preg_match</span>(<span class="php-quote">&quot;#(^|\b)</span><span class="php-var">{$banned_username['filter']}</span><span class="php-quote">(</span><span class="php-var">$</span><span class="php-quote">|\b)#i&quot;</span>, <span class="php-var">$username</span>))
<a href="#5398" id="5398" class="l">5398: </a>        {
<a href="#5399" id="5399" class="l">5399: </a>            <span class="php-comment">// Updating last use</span>
<a href="#5400" id="5400" class="l">5400: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$update_lastuse</span> == <span class="php-keyword1">true</span>)
<a href="#5401" id="5401" class="l">5401: </a>            {
<a href="#5402" id="5402" class="l">5402: </a>                <span class="php-var">$db</span>-&gt;update_query(<span class="php-quote">&quot;banfilters&quot;</span>, <span class="php-keyword1">array</span>(<span class="php-quote">&quot;lastuse&quot;</span> =&gt; TIME_NOW), <span class="php-quote">&quot;fid='</span><span class="php-var">{$banned_username['fid']}</span><span class="php-quote">'&quot;</span>);
<a href="#5403" id="5403" class="l">5403: </a>            }
<a href="#5404" id="5404" class="l">5404: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
<a href="#5405" id="5405" class="l">5405: </a>        }
<a href="#5406" id="5406" class="l">5406: </a>    }
<a href="#5407" id="5407" class="l">5407: </a>    <span class="php-comment">// Still here - good username</span>
<a href="#5408" id="5408" class="l">5408: </a>    <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#5409" id="5409" class="l">5409: </a>}
<a href="#5410" id="5410" class="l">5410: </a>
<a href="#5411" id="5411" class="l">5411: </a><span class="php-comment">/**
</span><a href="#5412" id="5412" class="l">5412: </a><span class="php-comment"> * Check if a specific email address has been banned.
</span><a href="#5413" id="5413" class="l">5413: </a><span class="php-comment"> *
</span><a href="#5414" id="5414" class="l">5414: </a><span class="php-comment"> * @param string The email address.
</span><a href="#5415" id="5415" class="l">5415: </a><span class="php-comment"> * @param boolean True if the 'last used' dateline should be updated if a match is found.
</span><a href="#5416" id="5416" class="l">5416: </a><span class="php-comment"> * @return boolean True if banned, false if not banned
</span><a href="#5417" id="5417" class="l">5417: </a><span class="php-comment"> */</span>
<a href="#5418" id="5418" class="l">5418: </a><span class="php-keyword1">function</span> is_banned_email(<span class="php-var">$email</span>, <span class="php-var">$update_lastuse</span>=<span class="php-keyword1">false</span>)
<a href="#5419" id="5419" class="l">5419: </a>{
<a href="#5420" id="5420" class="l">5420: </a>    <span class="php-keyword1">global</span> <span class="php-var">$cache</span>, <span class="php-var">$db</span>;
<a href="#5421" id="5421" class="l">5421: </a>
<a href="#5422" id="5422" class="l">5422: </a>    <span class="php-var">$banned_cache</span> = <span class="php-var">$cache</span>-&gt;read(<span class="php-quote">&quot;bannedemails&quot;</span>);
<a href="#5423" id="5423" class="l">5423: </a>    
<a href="#5424" id="5424" class="l">5424: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$banned_cache</span> === <span class="php-keyword1">false</span>)
<a href="#5425" id="5425" class="l">5425: </a>    {
<a href="#5426" id="5426" class="l">5426: </a>        <span class="php-comment">// Failed to read cache, see if we can rebuild it</span>
<a href="#5427" id="5427" class="l">5427: </a>        <span class="php-var">$cache</span>-&gt;update_bannedemails();
<a href="#5428" id="5428" class="l">5428: </a>        <span class="php-var">$banned_cache</span> = <span class="php-var">$cache</span>-&gt;read(<span class="php-quote">&quot;bannedemails&quot;</span>);
<a href="#5429" id="5429" class="l">5429: </a>    }
<a href="#5430" id="5430" class="l">5430: </a>
<a href="#5431" id="5431" class="l">5431: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$banned_cache</span>) &amp;&amp; !<span class="php-keyword1">empty</span>(<span class="php-var">$banned_cache</span>))
<a href="#5432" id="5432" class="l">5432: </a>    {
<a href="#5433" id="5433" class="l">5433: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$banned_cache</span> <span class="php-keyword1">as</span> <span class="php-var">$banned_email</span>)
<a href="#5434" id="5434" class="l">5434: </a>        {
<a href="#5435" id="5435" class="l">5435: </a>            <span class="php-comment">// Make regular expression * match</span>
<a href="#5436" id="5436" class="l">5436: </a>            <span class="php-var">$banned_email</span>[<span class="php-quote">'filter'</span>] = <span class="php-keyword2">str_replace</span>(<span class="php-quote">'\*'</span>, <span class="php-quote">'(.*)'</span>, <span class="php-keyword2">preg_quote</span>(<span class="php-var">$banned_email</span>[<span class="php-quote">'filter'</span>], <span class="php-quote">'#'</span>));
<a href="#5437" id="5437" class="l">5437: </a>
<a href="#5438" id="5438" class="l">5438: </a>            <span class="php-keyword1">if</span>(<span class="php-keyword2">preg_match</span>(<span class="php-quote">&quot;#</span><span class="php-var">{$banned_email['filter']}</span><span class="php-quote">#i&quot;</span>, <span class="php-var">$email</span>))
<a href="#5439" id="5439" class="l">5439: </a>            {
<a href="#5440" id="5440" class="l">5440: </a>                <span class="php-comment">// Updating last use</span>
<a href="#5441" id="5441" class="l">5441: </a>                <span class="php-keyword1">if</span>(<span class="php-var">$update_lastuse</span> == <span class="php-keyword1">true</span>)
<a href="#5442" id="5442" class="l">5442: </a>                {
<a href="#5443" id="5443" class="l">5443: </a>                    <span class="php-var">$db</span>-&gt;update_query(<span class="php-quote">&quot;banfilters&quot;</span>, <span class="php-keyword1">array</span>(<span class="php-quote">&quot;lastuse&quot;</span> =&gt; TIME_NOW), <span class="php-quote">&quot;fid='</span><span class="php-var">{$banned_email['fid']}</span><span class="php-quote">'&quot;</span>);
<a href="#5444" id="5444" class="l">5444: </a>                }
<a href="#5445" id="5445" class="l">5445: </a>                <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
<a href="#5446" id="5446" class="l">5446: </a>            }
<a href="#5447" id="5447" class="l">5447: </a>        }
<a href="#5448" id="5448" class="l">5448: </a>    }
<a href="#5449" id="5449" class="l">5449: </a>
<a href="#5450" id="5450" class="l">5450: </a>    <span class="php-comment">// Still here - good email</span>
<a href="#5451" id="5451" class="l">5451: </a>    <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#5452" id="5452" class="l">5452: </a>}
<a href="#5453" id="5453" class="l">5453: </a>
<a href="#5454" id="5454" class="l">5454: </a><span class="php-comment">/**
</span><a href="#5455" id="5455" class="l">5455: </a><span class="php-comment"> * Checks if a specific IP address has been banned.
</span><a href="#5456" id="5456" class="l">5456: </a><span class="php-comment"> *
</span><a href="#5457" id="5457" class="l">5457: </a><span class="php-comment"> * @param string The IP address.
</span><a href="#5458" id="5458" class="l">5458: </a><span class="php-comment"> * @param boolean True if the 'last used' dateline should be updated if a match is found.
</span><a href="#5459" id="5459" class="l">5459: </a><span class="php-comment"> * @return boolean True if banned, false if not banned.
</span><a href="#5460" id="5460" class="l">5460: </a><span class="php-comment"> */</span>
<a href="#5461" id="5461" class="l">5461: </a><span class="php-keyword1">function</span> is_banned_ip(<span class="php-var">$ip_address</span>, <span class="php-var">$update_lastuse</span>=<span class="php-keyword1">false</span>)
<a href="#5462" id="5462" class="l">5462: </a>{
<a href="#5463" id="5463" class="l">5463: </a>    <span class="php-keyword1">global</span> <span class="php-var">$db</span>, <span class="php-var">$cache</span>;
<a href="#5464" id="5464" class="l">5464: </a>    
<a href="#5465" id="5465" class="l">5465: </a>    <span class="php-var">$banned_ips</span> = <span class="php-var">$cache</span>-&gt;read(<span class="php-quote">&quot;bannedips&quot;</span>);
<a href="#5466" id="5466" class="l">5466: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$banned_ips</span>))
<a href="#5467" id="5467" class="l">5467: </a>    {
<a href="#5468" id="5468" class="l">5468: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#5469" id="5469" class="l">5469: </a>    }
<a href="#5470" id="5470" class="l">5470: </a>    
<a href="#5471" id="5471" class="l">5471: </a>    <span class="php-keyword1">foreach</span>(<span class="php-var">$banned_ips</span> <span class="php-keyword1">as</span> <span class="php-var">$banned_ip</span>)
<a href="#5472" id="5472" class="l">5472: </a>    {
<a href="#5473" id="5473" class="l">5473: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$banned_ip</span>[<span class="php-quote">'filter'</span>])
<a href="#5474" id="5474" class="l">5474: </a>        {
<a href="#5475" id="5475" class="l">5475: </a>            <span class="php-keyword1">continue</span>;
<a href="#5476" id="5476" class="l">5476: </a>        }
<a href="#5477" id="5477" class="l">5477: </a>        
<a href="#5478" id="5478" class="l">5478: </a>        <span class="php-comment">// Make regular expression * match</span>
<a href="#5479" id="5479" class="l">5479: </a>        <span class="php-var">$banned_ip</span>[<span class="php-quote">'filter'</span>] = <span class="php-keyword2">str_replace</span>(<span class="php-quote">'\*'</span>, <span class="php-quote">'(.*)'</span>, <span class="php-keyword2">preg_quote</span>(<span class="php-var">$banned_ip</span>[<span class="php-quote">'filter'</span>], <span class="php-quote">'#'</span>));
<a href="#5480" id="5480" class="l">5480: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">preg_match</span>(<span class="php-quote">&quot;#^</span><span class="php-var">{$banned_ip['filter']}$</span><span class="php-quote">#i&quot;</span>, <span class="php-var">$ip_address</span>))
<a href="#5481" id="5481" class="l">5481: </a>        {
<a href="#5482" id="5482" class="l">5482: </a>            <span class="php-comment">// Updating last use</span>
<a href="#5483" id="5483" class="l">5483: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$update_lastuse</span> == <span class="php-keyword1">true</span>)
<a href="#5484" id="5484" class="l">5484: </a>            {
<a href="#5485" id="5485" class="l">5485: </a>                <span class="php-var">$db</span>-&gt;update_query(<span class="php-quote">&quot;banfilters&quot;</span>, <span class="php-keyword1">array</span>(<span class="php-quote">&quot;lastuse&quot;</span> =&gt; TIME_NOW), <span class="php-quote">&quot;fid='</span><span class="php-var">{$banned_ip['fid']}</span><span class="php-quote">'&quot;</span>);
<a href="#5486" id="5486" class="l">5486: </a>            }
<a href="#5487" id="5487" class="l">5487: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
<a href="#5488" id="5488" class="l">5488: </a>        }
<a href="#5489" id="5489" class="l">5489: </a>    }
<a href="#5490" id="5490" class="l">5490: </a>
<a href="#5491" id="5491" class="l">5491: </a>    <span class="php-comment">// Still here - good ip</span>
<a href="#5492" id="5492" class="l">5492: </a>    <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#5493" id="5493" class="l">5493: </a>}
<a href="#5494" id="5494" class="l">5494: </a>
<a href="#5495" id="5495" class="l">5495: </a><span class="php-comment">/**
</span><a href="#5496" id="5496" class="l">5496: </a><span class="php-comment"> * Build a time zone selection list.
</span><a href="#5497" id="5497" class="l">5497: </a><span class="php-comment"> *
</span><a href="#5498" id="5498" class="l">5498: </a><span class="php-comment"> * @param string The name of the select
</span><a href="#5499" id="5499" class="l">5499: </a><span class="php-comment"> * @param int The selected time zone (defaults to GMT)
</span><a href="#5500" id="5500" class="l">5500: </a><span class="php-comment"> * @param boolean True to generate a &quot;short&quot; list with just timezone and current time
</span><a href="#5501" id="5501" class="l">5501: </a><span class="php-comment"> */</span>
<a href="#5502" id="5502" class="l">5502: </a><span class="php-keyword1">function</span> build_timezone_select(<span class="php-var">$name</span>, <span class="php-var">$selected</span>=<span class="php-num">0</span>, <span class="php-var">$short</span>=<span class="php-keyword1">false</span>)
<a href="#5503" id="5503" class="l">5503: </a>{
<a href="#5504" id="5504" class="l">5504: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>, <span class="php-var">$lang</span>;
<a href="#5505" id="5505" class="l">5505: </a>
<a href="#5506" id="5506" class="l">5506: </a>    <span class="php-var">$timezones</span> = <span class="php-keyword1">array</span>(
<a href="#5507" id="5507" class="l">5507: </a>        <span class="php-quote">&quot;-12&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_minus_1200,
<a href="#5508" id="5508" class="l">5508: </a>        <span class="php-quote">&quot;-11&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_minus_1100,
<a href="#5509" id="5509" class="l">5509: </a>        <span class="php-quote">&quot;-10&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_minus_1000,
<a href="#5510" id="5510" class="l">5510: </a>        <span class="php-quote">&quot;-9&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_minus_900,
<a href="#5511" id="5511" class="l">5511: </a>        <span class="php-quote">&quot;-8&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_minus_800,
<a href="#5512" id="5512" class="l">5512: </a>        <span class="php-quote">&quot;-7&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_minus_700,
<a href="#5513" id="5513" class="l">5513: </a>        <span class="php-quote">&quot;-6&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_minus_600,
<a href="#5514" id="5514" class="l">5514: </a>        <span class="php-quote">&quot;-5&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_minus_500,
<a href="#5515" id="5515" class="l">5515: </a>        <span class="php-quote">&quot;-4.5&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_minus_450,
<a href="#5516" id="5516" class="l">5516: </a>        <span class="php-quote">&quot;-4&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_minus_400,
<a href="#5517" id="5517" class="l">5517: </a>        <span class="php-quote">&quot;-3.5&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_minus_350,
<a href="#5518" id="5518" class="l">5518: </a>        <span class="php-quote">&quot;-3&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_minus_300,
<a href="#5519" id="5519" class="l">5519: </a>        <span class="php-quote">&quot;-2&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_minus_200,
<a href="#5520" id="5520" class="l">5520: </a>        <span class="php-quote">&quot;-1&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_minus_100,
<a href="#5521" id="5521" class="l">5521: </a>        <span class="php-quote">&quot;0&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt,
<a href="#5522" id="5522" class="l">5522: </a>        <span class="php-quote">&quot;1&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_100,
<a href="#5523" id="5523" class="l">5523: </a>        <span class="php-quote">&quot;2&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_200,
<a href="#5524" id="5524" class="l">5524: </a>        <span class="php-quote">&quot;3&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_300,
<a href="#5525" id="5525" class="l">5525: </a>        <span class="php-quote">&quot;3.5&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_350,
<a href="#5526" id="5526" class="l">5526: </a>        <span class="php-quote">&quot;4&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_400,
<a href="#5527" id="5527" class="l">5527: </a>        <span class="php-quote">&quot;4.5&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_450,
<a href="#5528" id="5528" class="l">5528: </a>        <span class="php-quote">&quot;5&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_500,
<a href="#5529" id="5529" class="l">5529: </a>        <span class="php-quote">&quot;5.5&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_550,
<a href="#5530" id="5530" class="l">5530: </a>        <span class="php-quote">&quot;6&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_600,
<a href="#5531" id="5531" class="l">5531: </a>        <span class="php-quote">&quot;7&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_700,
<a href="#5532" id="5532" class="l">5532: </a>        <span class="php-quote">&quot;8&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_800,
<a href="#5533" id="5533" class="l">5533: </a>        <span class="php-quote">&quot;9&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_900,
<a href="#5534" id="5534" class="l">5534: </a>        <span class="php-quote">&quot;9.5&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_950,
<a href="#5535" id="5535" class="l">5535: </a>        <span class="php-quote">&quot;10&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_1000,
<a href="#5536" id="5536" class="l">5536: </a>        <span class="php-quote">&quot;11&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_1100,
<a href="#5537" id="5537" class="l">5537: </a>        <span class="php-quote">&quot;12&quot;</span> =&gt; <span class="php-var">$lang</span>-&gt;timezone_gmt_1200
<a href="#5538" id="5538" class="l">5538: </a>    );
<a href="#5539" id="5539" class="l">5539: </a>
<a href="#5540" id="5540" class="l">5540: </a>    <span class="php-var">$selected</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;+&quot;</span>, <span class="php-quote">&quot;&quot;</span>, <span class="php-var">$selected</span>);
<a href="#5541" id="5541" class="l">5541: </a>    <span class="php-var">$select</span> = <span class="php-quote">&quot;&lt;select name=\&quot;</span><span class="php-var">{$name}</span><span class="php-quote">\&quot; id=\&quot;</span><span class="php-var">{$name}</span><span class="php-quote">\&quot;&gt;\n&quot;</span>;
<a href="#5542" id="5542" class="l">5542: </a>    <span class="php-keyword1">foreach</span>(<span class="php-var">$timezones</span> <span class="php-keyword1">as</span> <span class="php-var">$timezone</span> =&gt; <span class="php-var">$label</span>)
<a href="#5543" id="5543" class="l">5543: </a>    {
<a href="#5544" id="5544" class="l">5544: </a>        <span class="php-var">$selected_add</span> = <span class="php-quote">&quot;&quot;</span>;
<a href="#5545" id="5545" class="l">5545: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$selected</span> == <span class="php-var">$timezone</span>)
<a href="#5546" id="5546" class="l">5546: </a>        {
<a href="#5547" id="5547" class="l">5547: </a>            <span class="php-var">$selected_add</span> = <span class="php-quote">&quot; selected=\&quot;selected\&quot;&quot;</span>;
<a href="#5548" id="5548" class="l">5548: </a>        }
<a href="#5549" id="5549" class="l">5549: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$short</span> == <span class="php-keyword1">true</span>)
<a href="#5550" id="5550" class="l">5550: </a>        {
<a href="#5551" id="5551" class="l">5551: </a>            <span class="php-var">$label</span> = <span class="php-quote">''</span>;
<a href="#5552" id="5552" class="l">5552: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$timezone</span> != <span class="php-num">0</span>)
<a href="#5553" id="5553" class="l">5553: </a>            {
<a href="#5554" id="5554" class="l">5554: </a>                <span class="php-var">$label</span> = <span class="php-var">$timezone</span>;
<a href="#5555" id="5555" class="l">5555: </a>                <span class="php-keyword1">if</span>(<span class="php-var">$timezone</span> &gt; <span class="php-num">0</span>)
<a href="#5556" id="5556" class="l">5556: </a>                {
<a href="#5557" id="5557" class="l">5557: </a>                    <span class="php-var">$label</span> = <span class="php-quote">&quot;+</span><span class="php-var">{$label}</span><span class="php-quote">&quot;</span>;
<a href="#5558" id="5558" class="l">5558: </a>                }
<a href="#5559" id="5559" class="l">5559: </a>                <span class="php-keyword1">if</span>(<span class="php-keyword2">strpos</span>(<span class="php-var">$timezone</span>, <span class="php-quote">&quot;.&quot;</span>) !== <span class="php-keyword1">false</span>)
<a href="#5560" id="5560" class="l">5560: </a>                {
<a href="#5561" id="5561" class="l">5561: </a>                    <span class="php-var">$label</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;.&quot;</span>, <span class="php-quote">&quot;:&quot;</span>, <span class="php-var">$label</span>);
<a href="#5562" id="5562" class="l">5562: </a>                    <span class="php-var">$label</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;:5&quot;</span>, <span class="php-quote">&quot;:30&quot;</span>, <span class="php-var">$label</span>);
<a href="#5563" id="5563" class="l">5563: </a>                }
<a href="#5564" id="5564" class="l">5564: </a>                <span class="php-keyword1">else</span>
<a href="#5565" id="5565" class="l">5565: </a>                {
<a href="#5566" id="5566" class="l">5566: </a>                    <span class="php-var">$label</span> .= <span class="php-quote">&quot;:00&quot;</span>;
<a href="#5567" id="5567" class="l">5567: </a>                }
<a href="#5568" id="5568" class="l">5568: </a>            }
<a href="#5569" id="5569" class="l">5569: </a>            <span class="php-var">$time_in_zone</span> = my_date(<span class="php-var">$mybb</span>-&gt;settings[<span class="php-quote">'timeformat'</span>], TIME_NOW, <span class="php-var">$timezone</span>);
<a href="#5570" id="5570" class="l">5570: </a>            <span class="php-var">$label</span> = <span class="php-var">$lang</span>-&gt;<span class="php-keyword2">sprintf</span>(<span class="php-var">$lang</span>-&gt;timezone_gmt_short, <span class="php-var">$label</span>.<span class="php-quote">&quot; &quot;</span>, <span class="php-var">$time_in_zone</span>);
<a href="#5571" id="5571" class="l">5571: </a>        }
<a href="#5572" id="5572" class="l">5572: </a>        <span class="php-var">$select</span> .= <span class="php-quote">&quot;&lt;option value=\&quot;</span><span class="php-var">{$timezone}</span><span class="php-quote">\&quot;</span><span class="php-var">{$selected_add}</span><span class="php-quote">&gt;</span><span class="php-var">{$label}</span><span class="php-quote">&lt;/option&gt;\n&quot;</span>;
<a href="#5573" id="5573" class="l">5573: </a>    }
<a href="#5574" id="5574" class="l">5574: </a>    <span class="php-var">$select</span> .= <span class="php-quote">&quot;&lt;/select&gt;&quot;</span>;
<a href="#5575" id="5575" class="l">5575: </a>    <span class="php-keyword1">return</span> <span class="php-var">$select</span>;
<a href="#5576" id="5576" class="l">5576: </a>}
<a href="#5577" id="5577" class="l">5577: </a>
<a href="#5578" id="5578" class="l">5578: </a><span class="php-comment">/**
</span><a href="#5579" id="5579" class="l">5579: </a><span class="php-comment"> * Fetch the contents of a remote fle.
</span><a href="#5580" id="5580" class="l">5580: </a><span class="php-comment"> *
</span><a href="#5581" id="5581" class="l">5581: </a><span class="php-comment"> * @param string The URL of the remote file
</span><a href="#5582" id="5582" class="l">5582: </a><span class="php-comment"> * @return string The remote file contents.
</span><a href="#5583" id="5583" class="l">5583: </a><span class="php-comment"> */</span>
<a href="#5584" id="5584" class="l">5584: </a><span class="php-keyword1">function</span> fetch_remote_file(<span class="php-var">$url</span>, <span class="php-var">$post_data</span>=<span class="php-keyword1">array</span>())
<a href="#5585" id="5585" class="l">5585: </a>{
<a href="#5586" id="5586" class="l">5586: </a>    <span class="php-var">$post_body</span> = <span class="php-quote">''</span>;
<a href="#5587" id="5587" class="l">5587: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword1">empty</span>(<span class="php-var">$post_data</span>))
<a href="#5588" id="5588" class="l">5588: </a>    {
<a href="#5589" id="5589" class="l">5589: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$post_data</span> <span class="php-keyword1">as</span> <span class="php-var">$key</span> =&gt; <span class="php-var">$val</span>)
<a href="#5590" id="5590" class="l">5590: </a>        {
<a href="#5591" id="5591" class="l">5591: </a>            <span class="php-var">$post_body</span> .= <span class="php-quote">'&amp;'</span>.<span class="php-keyword2">urlencode</span>(<span class="php-var">$key</span>).<span class="php-quote">'='</span>.<span class="php-keyword2">urlencode</span>(<span class="php-var">$val</span>);
<a href="#5592" id="5592" class="l">5592: </a>        }
<a href="#5593" id="5593" class="l">5593: </a>        <span class="php-var">$post_body</span> = <span class="php-keyword2">ltrim</span>(<span class="php-var">$post_body</span>, <span class="php-quote">'&amp;'</span>);
<a href="#5594" id="5594" class="l">5594: </a>    }
<a href="#5595" id="5595" class="l">5595: </a>    
<a href="#5596" id="5596" class="l">5596: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">function_exists</span>(<span class="php-quote">&quot;curl_init&quot;</span>))
<a href="#5597" id="5597" class="l">5597: </a>    {
<a href="#5598" id="5598" class="l">5598: </a>        <span class="php-var">$ch</span> = <span class="php-keyword2">curl_init</span>();
<a href="#5599" id="5599" class="l">5599: </a>        <span class="php-keyword2">curl_setopt</span>(<span class="php-var">$ch</span>, CURLOPT_URL, <span class="php-var">$url</span>);
<a href="#5600" id="5600" class="l">5600: </a>        <span class="php-keyword2">curl_setopt</span>(<span class="php-var">$ch</span>, CURLOPT_HEADER, <span class="php-num">0</span>);
<a href="#5601" id="5601" class="l">5601: </a>        <span class="php-keyword2">curl_setopt</span>(<span class="php-var">$ch</span>, CURLOPT_TIMEOUT, <span class="php-num">10</span>);
<a href="#5602" id="5602" class="l">5602: </a>        <span class="php-keyword2">curl_setopt</span>(<span class="php-var">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="php-num">1</span>);
<a href="#5603" id="5603" class="l">5603: </a>        <span class="php-keyword1">if</span>(!<span class="php-keyword1">empty</span>(<span class="php-var">$post_body</span>))
<a href="#5604" id="5604" class="l">5604: </a>        {
<a href="#5605" id="5605" class="l">5605: </a>            <span class="php-keyword2">curl_setopt</span>(<span class="php-var">$ch</span>, CURLOPT_POST, <span class="php-num">1</span>);
<a href="#5606" id="5606" class="l">5606: </a>            <span class="php-keyword2">curl_setopt</span>(<span class="php-var">$ch</span>, CURLOPT_POSTFIELDS, <span class="php-var">$post_body</span>);
<a href="#5607" id="5607" class="l">5607: </a>        }
<a href="#5608" id="5608" class="l">5608: </a>        <span class="php-var">$data</span> = <span class="php-keyword2">curl_exec</span>(<span class="php-var">$ch</span>);
<a href="#5609" id="5609" class="l">5609: </a>        <span class="php-keyword2">curl_close</span>(<span class="php-var">$ch</span>);
<a href="#5610" id="5610" class="l">5610: </a>        <span class="php-keyword1">return</span> <span class="php-var">$data</span>;
<a href="#5611" id="5611" class="l">5611: </a>    }
<a href="#5612" id="5612" class="l">5612: </a>    <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(<span class="php-keyword2">function_exists</span>(<span class="php-quote">&quot;fsockopen&quot;</span>))
<a href="#5613" id="5613" class="l">5613: </a>    {
<a href="#5614" id="5614" class="l">5614: </a>        <span class="php-var">$url</span> = @<span class="php-keyword2">parse_url</span>(<span class="php-var">$url</span>);
<a href="#5615" id="5615" class="l">5615: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$url</span>[<span class="php-quote">'host'</span>])
<a href="#5616" id="5616" class="l">5616: </a>        {
<a href="#5617" id="5617" class="l">5617: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#5618" id="5618" class="l">5618: </a>        }
<a href="#5619" id="5619" class="l">5619: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$url</span>[<span class="php-quote">'port'</span>])
<a href="#5620" id="5620" class="l">5620: </a>        {
<a href="#5621" id="5621" class="l">5621: </a>            <span class="php-var">$url</span>[<span class="php-quote">'port'</span>] = <span class="php-num">80</span>;
<a href="#5622" id="5622" class="l">5622: </a>        }
<a href="#5623" id="5623" class="l">5623: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$url</span>[<span class="php-quote">'path'</span>])
<a href="#5624" id="5624" class="l">5624: </a>        {
<a href="#5625" id="5625" class="l">5625: </a>            <span class="php-var">$url</span>[<span class="php-quote">'path'</span>] = <span class="php-quote">&quot;/&quot;</span>;
<a href="#5626" id="5626" class="l">5626: </a>        }
<a href="#5627" id="5627" class="l">5627: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$url</span>[<span class="php-quote">'query'</span>])
<a href="#5628" id="5628" class="l">5628: </a>        {
<a href="#5629" id="5629" class="l">5629: </a>            <span class="php-var">$url</span>[<span class="php-quote">'path'</span>] .= <span class="php-quote">&quot;?</span><span class="php-var">{$url['query']}</span><span class="php-quote">&quot;</span>;
<a href="#5630" id="5630" class="l">5630: </a>        }
<a href="#5631" id="5631" class="l">5631: </a>        <span class="php-var">$fp</span> = @<span class="php-keyword2">fsockopen</span>(<span class="php-var">$url</span>[<span class="php-quote">'host'</span>], <span class="php-var">$url</span>[<span class="php-quote">'port'</span>], <span class="php-var">$error_no</span>, <span class="php-var">$error</span>, <span class="php-num">10</span>);
<a href="#5632" id="5632" class="l">5632: </a>        @<span class="php-keyword2">stream_set_timeout</span>(<span class="php-var">$fp</span>, <span class="php-num">10</span>);
<a href="#5633" id="5633" class="l">5633: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$fp</span>)
<a href="#5634" id="5634" class="l">5634: </a>        {
<a href="#5635" id="5635" class="l">5635: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#5636" id="5636" class="l">5636: </a>        }
<a href="#5637" id="5637" class="l">5637: </a>        <span class="php-var">$headers</span> = <span class="php-keyword1">array</span>();
<a href="#5638" id="5638" class="l">5638: </a>        <span class="php-keyword1">if</span>(!<span class="php-keyword1">empty</span>(<span class="php-var">$post_body</span>))
<a href="#5639" id="5639" class="l">5639: </a>        {
<a href="#5640" id="5640" class="l">5640: </a>            <span class="php-var">$headers</span>[] = <span class="php-quote">&quot;POST </span><span class="php-var">{$url['path']}</span><span class="php-quote"> HTTP/1.0&quot;</span>;
<a href="#5641" id="5641" class="l">5641: </a>            <span class="php-var">$headers</span>[] = <span class="php-quote">&quot;Content-Length: &quot;</span>.<span class="php-keyword2">strlen</span>(<span class="php-var">$post_body</span>);
<a href="#5642" id="5642" class="l">5642: </a>            <span class="php-var">$headers</span>[] = <span class="php-quote">&quot;Content-Type: application/x-www-form-urlencoded&quot;</span>;
<a href="#5643" id="5643" class="l">5643: </a>        }
<a href="#5644" id="5644" class="l">5644: </a>        <span class="php-keyword1">else</span>
<a href="#5645" id="5645" class="l">5645: </a>        {
<a href="#5646" id="5646" class="l">5646: </a>            <span class="php-var">$headers</span>[] = <span class="php-quote">&quot;GET </span><span class="php-var">{$url['path']}</span><span class="php-quote"> HTTP/1.0&quot;</span>;
<a href="#5647" id="5647" class="l">5647: </a>        }
<a href="#5648" id="5648" class="l">5648: </a>        
<a href="#5649" id="5649" class="l">5649: </a>        <span class="php-var">$headers</span>[] = <span class="php-quote">&quot;Host: </span><span class="php-var">{$url['host']}</span><span class="php-quote">&quot;</span>;
<a href="#5650" id="5650" class="l">5650: </a>        <span class="php-var">$headers</span>[] = <span class="php-quote">&quot;Connection: Close&quot;</span>;
<a href="#5651" id="5651" class="l">5651: </a>        <span class="php-var">$headers</span>[] = <span class="php-quote">''</span>;
<a href="#5652" id="5652" class="l">5652: </a>        
<a href="#5653" id="5653" class="l">5653: </a>        <span class="php-keyword1">if</span>(!<span class="php-keyword1">empty</span>(<span class="php-var">$post_body</span>))
<a href="#5654" id="5654" class="l">5654: </a>        {
<a href="#5655" id="5655" class="l">5655: </a>            <span class="php-var">$headers</span>[] = <span class="php-var">$post_body</span>;
<a href="#5656" id="5656" class="l">5656: </a>        }
<a href="#5657" id="5657" class="l">5657: </a>        <span class="php-keyword1">else</span>
<a href="#5658" id="5658" class="l">5658: </a>        {
<a href="#5659" id="5659" class="l">5659: </a>            <span class="php-comment">// If we have no post body, we need to add an empty element to make sure we've got \r\n\r\n before the (non-existent) body starts</span>
<a href="#5660" id="5660" class="l">5660: </a>            <span class="php-var">$headers</span>[] = <span class="php-quote">''</span>;
<a href="#5661" id="5661" class="l">5661: </a>        }
<a href="#5662" id="5662" class="l">5662: </a>        
<a href="#5663" id="5663" class="l">5663: </a>        <span class="php-var">$headers</span> = <span class="php-keyword2">implode</span>(<span class="php-quote">&quot;\r\n&quot;</span>, <span class="php-var">$headers</span>);   
<a href="#5664" id="5664" class="l">5664: </a>        <span class="php-keyword1">if</span>(!@<span class="php-keyword2">fwrite</span>(<span class="php-var">$fp</span>, <span class="php-var">$headers</span>))
<a href="#5665" id="5665" class="l">5665: </a>        {
<a href="#5666" id="5666" class="l">5666: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#5667" id="5667" class="l">5667: </a>        }
<a href="#5668" id="5668" class="l">5668: </a>        <span class="php-keyword1">while</span>(!<span class="php-keyword2">feof</span>(<span class="php-var">$fp</span>))
<a href="#5669" id="5669" class="l">5669: </a>        {
<a href="#5670" id="5670" class="l">5670: </a>            <span class="php-var">$data</span> .= <span class="php-keyword2">fgets</span>(<span class="php-var">$fp</span>, <span class="php-num">12800</span>);
<a href="#5671" id="5671" class="l">5671: </a>        }
<a href="#5672" id="5672" class="l">5672: </a>        <span class="php-keyword2">fclose</span>(<span class="php-var">$fp</span>);
<a href="#5673" id="5673" class="l">5673: </a>        <span class="php-var">$data</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">&quot;\r\n\r\n&quot;</span>, <span class="php-var">$data</span>, <span class="php-num">2</span>);
<a href="#5674" id="5674" class="l">5674: </a>        <span class="php-keyword1">return</span> <span class="php-var">$data</span>[<span class="php-num">1</span>];
<a href="#5675" id="5675" class="l">5675: </a>    }
<a href="#5676" id="5676" class="l">5676: </a>    <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(<span class="php-keyword1">empty</span>(<span class="php-var">$post_data</span>))
<a href="#5677" id="5677" class="l">5677: </a>    {
<a href="#5678" id="5678" class="l">5678: </a>        <span class="php-keyword1">return</span> @<span class="php-keyword2">implode</span>(<span class="php-quote">&quot;&quot;</span>, @<span class="php-keyword2">file</span>(<span class="php-var">$url</span>));
<a href="#5679" id="5679" class="l">5679: </a>    }
<a href="#5680" id="5680" class="l">5680: </a>    <span class="php-keyword1">else</span>
<a href="#5681" id="5681" class="l">5681: </a>    {
<a href="#5682" id="5682" class="l">5682: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#5683" id="5683" class="l">5683: </a>    }
<a href="#5684" id="5684" class="l">5684: </a>}
<a href="#5685" id="5685" class="l">5685: </a>
<a href="#5686" id="5686" class="l">5686: </a><span class="php-comment">/**
</span><a href="#5687" id="5687" class="l">5687: </a><span class="php-comment"> * Checks if a particular user is a super administrator.
</span><a href="#5688" id="5688" class="l">5688: </a><span class="php-comment"> *
</span><a href="#5689" id="5689" class="l">5689: </a><span class="php-comment"> * @param int The user ID to check against the list of super admins
</span><a href="#5690" id="5690" class="l">5690: </a><span class="php-comment"> * @return boolean True if a super admin, false if not
</span><a href="#5691" id="5691" class="l">5691: </a><span class="php-comment"> */</span>
<a href="#5692" id="5692" class="l">5692: </a><span class="php-keyword1">function</span> is_super_admin(<span class="php-var">$uid</span>)
<a href="#5693" id="5693" class="l">5693: </a>{
<a href="#5694" id="5694" class="l">5694: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>;
<a href="#5695" id="5695" class="l">5695: </a>    
<a href="#5696" id="5696" class="l">5696: </a>    <span class="php-var">$mybb</span>-&gt;config[<span class="php-quote">'super_admins'</span>] = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot; &quot;</span>, <span class="php-quote">&quot;&quot;</span>, <span class="php-var">$mybb</span>-&gt;config[<span class="php-quote">'super_admins'</span>]);
<a href="#5697" id="5697" class="l">5697: </a>    <span class="php-keyword1">if</span>(my_strpos(<span class="php-quote">&quot;,</span><span class="php-var">{$mybb-&gt;config['super_admins']}</span><span class="php-quote">,&quot;</span>, <span class="php-quote">&quot;,</span><span class="php-var">{$uid}</span><span class="php-quote">,&quot;</span>) === <span class="php-keyword1">false</span>)
<a href="#5698" id="5698" class="l">5698: </a>    {
<a href="#5699" id="5699" class="l">5699: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#5700" id="5700" class="l">5700: </a>    }
<a href="#5701" id="5701" class="l">5701: </a>    <span class="php-keyword1">else</span>
<a href="#5702" id="5702" class="l">5702: </a>    {
<a href="#5703" id="5703" class="l">5703: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
<a href="#5704" id="5704" class="l">5704: </a>    }
<a href="#5705" id="5705" class="l">5705: </a>}
<a href="#5706" id="5706" class="l">5706: </a>
<a href="#5707" id="5707" class="l">5707: </a><span class="php-comment">/**
</span><a href="#5708" id="5708" class="l">5708: </a><span class="php-comment"> * Split a string based on the specified delimeter, ignoring said delimeter in escaped strings.
</span><a href="#5709" id="5709" class="l">5709: </a><span class="php-comment"> * Ex: the &quot;quick brown fox&quot; jumped, could return 1 =&gt; the, 2 =&gt; quick brown fox, 3 =&gt; jumped
</span><a href="#5710" id="5710" class="l">5710: </a><span class="php-comment"> *
</span><a href="#5711" id="5711" class="l">5711: </a><span class="php-comment"> * @param string The delimeter to split by
</span><a href="#5712" id="5712" class="l">5712: </a><span class="php-comment"> * @param string The string to split
</span><a href="#5713" id="5713" class="l">5713: </a><span class="php-comment"> * @param string The escape character or string if we have one.
</span><a href="#5714" id="5714" class="l">5714: </a><span class="php-comment"> * @return array Array of split string
</span><a href="#5715" id="5715" class="l">5715: </a><span class="php-comment"> */</span>
<a href="#5716" id="5716" class="l">5716: </a><span class="php-keyword1">function</span> escaped_explode(<span class="php-var">$delimeter</span>, <span class="php-var">$string</span>, <span class="php-var">$escape</span>=<span class="php-quote">&quot;&quot;</span>)
<a href="#5717" id="5717" class="l">5717: </a>{
<a href="#5718" id="5718" class="l">5718: </a>    <span class="php-var">$strings</span> = <span class="php-keyword1">array</span>();
<a href="#5719" id="5719" class="l">5719: </a>    <span class="php-var">$original</span> = <span class="php-var">$string</span>;
<a href="#5720" id="5720" class="l">5720: </a>    <span class="php-var">$in_escape</span> = <span class="php-keyword1">false</span>;
<a href="#5721" id="5721" class="l">5721: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$escape</span>)
<a href="#5722" id="5722" class="l">5722: </a>    {
<a href="#5723" id="5723" class="l">5723: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$escape</span>))
<a href="#5724" id="5724" class="l">5724: </a>        {
<a href="#5725" id="5725" class="l">5725: </a>            <span class="php-keyword1">function</span> escaped_explode_escape(<span class="php-var">$string</span>)
<a href="#5726" id="5726" class="l">5726: </a>            {
<a href="#5727" id="5727" class="l">5727: </a>                <span class="php-keyword1">return</span> <span class="php-keyword2">preg_quote</span>(<span class="php-var">$string</span>, <span class="php-quote">&quot;#&quot;</span>);
<a href="#5728" id="5728" class="l">5728: </a>            }
<a href="#5729" id="5729" class="l">5729: </a>            <span class="php-var">$escape_preg</span> = <span class="php-quote">&quot;(&quot;</span>.<span class="php-keyword2">implode</span>(<span class="php-quote">&quot;|&quot;</span>, <span class="php-keyword2">array_map</span>(<span class="php-quote">&quot;escaped_explode_escape&quot;</span>, <span class="php-var">$escape</span>)).<span class="php-quote">&quot;)&quot;</span>;
<a href="#5730" id="5730" class="l">5730: </a>        }
<a href="#5731" id="5731" class="l">5731: </a>        <span class="php-keyword1">else</span>
<a href="#5732" id="5732" class="l">5732: </a>        {
<a href="#5733" id="5733" class="l">5733: </a>            <span class="php-var">$escape_preg</span> = <span class="php-keyword2">preg_quote</span>(<span class="php-var">$escape</span>, <span class="php-quote">&quot;#&quot;</span>);
<a href="#5734" id="5734" class="l">5734: </a>        }
<a href="#5735" id="5735" class="l">5735: </a>        <span class="php-var">$quoted_strings</span> = <span class="php-keyword2">preg_split</span>(<span class="php-quote">&quot;#(?&lt;!\\\)</span><span class="php-var">{$escape_preg}</span><span class="php-quote">#&quot;</span>, <span class="php-var">$string</span>);
<a href="#5736" id="5736" class="l">5736: </a>    }
<a href="#5737" id="5737" class="l">5737: </a>    <span class="php-keyword1">else</span>
<a href="#5738" id="5738" class="l">5738: </a>    {
<a href="#5739" id="5739" class="l">5739: </a>        <span class="php-var">$quoted_strings</span> = <span class="php-keyword1">array</span>(<span class="php-var">$string</span>);
<a href="#5740" id="5740" class="l">5740: </a>    }
<a href="#5741" id="5741" class="l">5741: </a>    <span class="php-keyword1">foreach</span>(<span class="php-var">$quoted_strings</span> <span class="php-keyword1">as</span> <span class="php-var">$string</span>)
<a href="#5742" id="5742" class="l">5742: </a>    {
<a href="#5743" id="5743" class="l">5743: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$string</span> != <span class="php-quote">&quot;&quot;</span>) 
<a href="#5744" id="5744" class="l">5744: </a>        {
<a href="#5745" id="5745" class="l">5745: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$in_escape</span>)
<a href="#5746" id="5746" class="l">5746: </a>            {
<a href="#5747" id="5747" class="l">5747: </a>                <span class="php-var">$strings</span>[] = <span class="php-keyword2">trim</span>(<span class="php-var">$string</span>);
<a href="#5748" id="5748" class="l">5748: </a>            }
<a href="#5749" id="5749" class="l">5749: </a>            <span class="php-keyword1">else</span>
<a href="#5750" id="5750" class="l">5750: </a>            {
<a href="#5751" id="5751" class="l">5751: </a>                <span class="php-var">$split_strings</span> = <span class="php-keyword2">explode</span>(<span class="php-var">$delimeter</span>, <span class="php-var">$string</span>);
<a href="#5752" id="5752" class="l">5752: </a>                <span class="php-keyword1">foreach</span>(<span class="php-var">$split_strings</span> <span class="php-keyword1">as</span> <span class="php-var">$string</span>)
<a href="#5753" id="5753" class="l">5753: </a>                {
<a href="#5754" id="5754" class="l">5754: </a>                    <span class="php-keyword1">if</span>(<span class="php-var">$string</span> == <span class="php-quote">&quot;&quot;</span>) <span class="php-keyword1">continue</span>;
<a href="#5755" id="5755" class="l">5755: </a>                    <span class="php-var">$strings</span>[] = <span class="php-keyword2">trim</span>(<span class="php-var">$string</span>);
<a href="#5756" id="5756" class="l">5756: </a>                }
<a href="#5757" id="5757" class="l">5757: </a>            }
<a href="#5758" id="5758" class="l">5758: </a>        }
<a href="#5759" id="5759" class="l">5759: </a>        <span class="php-var">$in_escape</span> = !<span class="php-var">$in_escape</span>;
<a href="#5760" id="5760" class="l">5760: </a>    }
<a href="#5761" id="5761" class="l">5761: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">count</span>(<span class="php-var">$strings</span>))
<a href="#5762" id="5762" class="l">5762: </a>    {
<a href="#5763" id="5763" class="l">5763: </a>        <span class="php-keyword1">return</span> <span class="php-var">$original</span>;
<a href="#5764" id="5764" class="l">5764: </a>    }
<a href="#5765" id="5765" class="l">5765: </a>    <span class="php-keyword1">return</span> <span class="php-var">$strings</span>;
<a href="#5766" id="5766" class="l">5766: </a>}
<a href="#5767" id="5767" class="l">5767: </a>
<a href="#5768" id="5768" class="l">5768: </a><span class="php-comment">/**
</span><a href="#5769" id="5769" class="l">5769: </a><span class="php-comment"> * Fetch an IPv4 long formatted range for searching IPv4 IP addresses.
</span><a href="#5770" id="5770" class="l">5770: </a><span class="php-comment"> *
</span><a href="#5771" id="5771" class="l">5771: </a><span class="php-comment"> * @param string The IP address to convert to a range based LONG
</span><a href="#5772" id="5772" class="l">5772: </a><span class="php-comment"> * @rturn mixed If a full IP address is provided, the ip2long equivalent, otherwise an array of the upper &amp; lower extremities of the IP
</span><a href="#5773" id="5773" class="l">5773: </a><span class="php-comment"> */</span>
<a href="#5774" id="5774" class="l">5774: </a><span class="php-keyword1">function</span> fetch_longipv4_range(<span class="php-var">$ip</span>)
<a href="#5775" id="5775" class="l">5775: </a>{
<a href="#5776" id="5776" class="l">5776: </a>    <span class="php-var">$ip_bits</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">&quot;.&quot;</span>, <span class="php-var">$ip</span>);
<a href="#5777" id="5777" class="l">5777: </a>    <span class="php-var">$ip_string1</span> = <span class="php-var">$ip_string2</span> = <span class="php-quote">&quot;&quot;</span>;
<a href="#5778" id="5778" class="l">5778: </a>
<a href="#5779" id="5779" class="l">5779: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$ip</span> == <span class="php-quote">&quot;*&quot;</span>)
<a href="#5780" id="5780" class="l">5780: </a>    {
<a href="#5781" id="5781" class="l">5781: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">array</span>(<span class="php-keyword2">ip2long</span>(<span class="php-quote">'0.0.0.0'</span>), <span class="php-keyword2">ip2long</span>(<span class="php-quote">'255.255.255.255'</span>));
<a href="#5782" id="5782" class="l">5782: </a>    }
<a href="#5783" id="5783" class="l">5783: </a>
<a href="#5784" id="5784" class="l">5784: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">strpos</span>(<span class="php-var">$ip</span>, <span class="php-quote">&quot;.*&quot;</span>) === <span class="php-keyword1">false</span>)
<a href="#5785" id="5785" class="l">5785: </a>    {
<a href="#5786" id="5786" class="l">5786: </a>        <span class="php-var">$ip</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;*&quot;</span>, <span class="php-quote">&quot;&quot;</span>, <span class="php-var">$ip</span>);
<a href="#5787" id="5787" class="l">5787: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">count</span>(<span class="php-var">$ip_bits</span>) == <span class="php-num">4</span>)
<a href="#5788" id="5788" class="l">5788: </a>        {
<a href="#5789" id="5789" class="l">5789: </a>            <span class="php-keyword1">return</span> <span class="php-keyword2">ip2long</span>(<span class="php-var">$ip</span>);
<a href="#5790" id="5790" class="l">5790: </a>        }
<a href="#5791" id="5791" class="l">5791: </a>        <span class="php-keyword1">else</span>
<a href="#5792" id="5792" class="l">5792: </a>        {
<a href="#5793" id="5793" class="l">5793: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">array</span>(<span class="php-keyword2">ip2long</span>(<span class="php-var">$ip</span>.<span class="php-quote">&quot;.0&quot;</span>), <span class="php-keyword2">ip2long</span>(<span class="php-var">$ip</span>.<span class="php-quote">&quot;.255&quot;</span>));
<a href="#5794" id="5794" class="l">5794: </a>        }
<a href="#5795" id="5795" class="l">5795: </a>    }
<a href="#5796" id="5796" class="l">5796: </a>    <span class="php-comment">// Wildcard based IP provided</span>
<a href="#5797" id="5797" class="l">5797: </a>    <span class="php-keyword1">else</span>
<a href="#5798" id="5798" class="l">5798: </a>    {
<a href="#5799" id="5799" class="l">5799: </a>        <span class="php-var">$sep</span> = <span class="php-quote">&quot;&quot;</span>;
<a href="#5800" id="5800" class="l">5800: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$ip_bits</span> <span class="php-keyword1">as</span> <span class="php-var">$piece</span>)
<a href="#5801" id="5801" class="l">5801: </a>        {
<a href="#5802" id="5802" class="l">5802: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$piece</span> == <span class="php-quote">&quot;*&quot;</span>)
<a href="#5803" id="5803" class="l">5803: </a>            {
<a href="#5804" id="5804" class="l">5804: </a>                <span class="php-var">$ip_string1</span> .= <span class="php-var">$sep</span>.<span class="php-quote">&quot;0&quot;</span>;
<a href="#5805" id="5805" class="l">5805: </a>                <span class="php-var">$ip_string2</span> .= <span class="php-var">$sep</span>.<span class="php-quote">&quot;255&quot;</span>;
<a href="#5806" id="5806" class="l">5806: </a>            }
<a href="#5807" id="5807" class="l">5807: </a>            <span class="php-keyword1">else</span>
<a href="#5808" id="5808" class="l">5808: </a>            {
<a href="#5809" id="5809" class="l">5809: </a>                <span class="php-var">$ip_string1</span> .= <span class="php-var">$sep</span>.<span class="php-var">$piece</span>;
<a href="#5810" id="5810" class="l">5810: </a>                <span class="php-var">$ip_string2</span> .= <span class="php-var">$sep</span>.<span class="php-var">$piece</span>;
<a href="#5811" id="5811" class="l">5811: </a>            }
<a href="#5812" id="5812" class="l">5812: </a>            <span class="php-var">$sep</span> = <span class="php-quote">&quot;.&quot;</span>;
<a href="#5813" id="5813" class="l">5813: </a>        }
<a href="#5814" id="5814" class="l">5814: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">array</span>(<span class="php-keyword2">ip2long</span>(<span class="php-var">$ip_string1</span>), <span class="php-keyword2">ip2long</span>(<span class="php-var">$ip_string2</span>));
<a href="#5815" id="5815" class="l">5815: </a>    }
<a href="#5816" id="5816" class="l">5816: </a>} 
<a href="#5817" id="5817" class="l">5817: </a>
<a href="#5818" id="5818" class="l">5818: </a><span class="php-comment">/**
</span><a href="#5819" id="5819" class="l">5819: </a><span class="php-comment"> * Fetch a list of ban times for a user account.
</span><a href="#5820" id="5820" class="l">5820: </a><span class="php-comment"> *
</span><a href="#5821" id="5821" class="l">5821: </a><span class="php-comment"> * @return array Array of ban times
</span><a href="#5822" id="5822" class="l">5822: </a><span class="php-comment"> */</span>
<a href="#5823" id="5823" class="l">5823: </a><span class="php-keyword1">function</span> fetch_ban_times()
<a href="#5824" id="5824" class="l">5824: </a>{
<a href="#5825" id="5825" class="l">5825: </a>    <span class="php-keyword1">global</span> <span class="php-var">$plugins</span>, <span class="php-var">$lang</span>;
<a href="#5826" id="5826" class="l">5826: </a>
<a href="#5827" id="5827" class="l">5827: </a>    <span class="php-comment">// Days-Months-Years</span>
<a href="#5828" id="5828" class="l">5828: </a>    <span class="php-var">$ban_times</span> = <span class="php-keyword1">array</span>(
<a href="#5829" id="5829" class="l">5829: </a>        <span class="php-quote">&quot;1-0-0&quot;</span> =&gt; <span class="php-quote">&quot;1 </span><span class="php-var">{$lang-&gt;day}</span><span class="php-quote">&quot;</span>,
<a href="#5830" id="5830" class="l">5830: </a>        <span class="php-quote">&quot;2-0-0&quot;</span> =&gt; <span class="php-quote">&quot;2 </span><span class="php-var">{$lang-&gt;days}</span><span class="php-quote">&quot;</span>,
<a href="#5831" id="5831" class="l">5831: </a>        <span class="php-quote">&quot;3-0-0&quot;</span> =&gt; <span class="php-quote">&quot;3 </span><span class="php-var">{$lang-&gt;days}</span><span class="php-quote">&quot;</span>,
<a href="#5832" id="5832" class="l">5832: </a>        <span class="php-quote">&quot;4-0-0&quot;</span> =&gt; <span class="php-quote">&quot;4 </span><span class="php-var">{$lang-&gt;days}</span><span class="php-quote">&quot;</span>,
<a href="#5833" id="5833" class="l">5833: </a>        <span class="php-quote">&quot;5-0-0&quot;</span> =&gt; <span class="php-quote">&quot;5 </span><span class="php-var">{$lang-&gt;days}</span><span class="php-quote">&quot;</span>,
<a href="#5834" id="5834" class="l">5834: </a>        <span class="php-quote">&quot;6-0-0&quot;</span> =&gt; <span class="php-quote">&quot;6 </span><span class="php-var">{$lang-&gt;days}</span><span class="php-quote">&quot;</span>,
<a href="#5835" id="5835" class="l">5835: </a>        <span class="php-quote">&quot;7-0-0&quot;</span> =&gt; <span class="php-quote">&quot;1 </span><span class="php-var">{$lang-&gt;week}</span><span class="php-quote">&quot;</span>,
<a href="#5836" id="5836" class="l">5836: </a>        <span class="php-quote">&quot;14-0-0&quot;</span> =&gt; <span class="php-quote">&quot;2 </span><span class="php-var">{$lang-&gt;weeks}</span><span class="php-quote">&quot;</span>,
<a href="#5837" id="5837" class="l">5837: </a>        <span class="php-quote">&quot;21-0-0&quot;</span> =&gt; <span class="php-quote">&quot;3 </span><span class="php-var">{$lang-&gt;weeks}</span><span class="php-quote">&quot;</span>,
<a href="#5838" id="5838" class="l">5838: </a>        <span class="php-quote">&quot;0-1-0&quot;</span> =&gt; <span class="php-quote">&quot;1 </span><span class="php-var">{$lang-&gt;month}</span><span class="php-quote">&quot;</span>,
<a href="#5839" id="5839" class="l">5839: </a>        <span class="php-quote">&quot;0-2-0&quot;</span> =&gt; <span class="php-quote">&quot;2 </span><span class="php-var">{$lang-&gt;months}</span><span class="php-quote">&quot;</span>,
<a href="#5840" id="5840" class="l">5840: </a>        <span class="php-quote">&quot;0-3-0&quot;</span> =&gt; <span class="php-quote">&quot;3 </span><span class="php-var">{$lang-&gt;months}</span><span class="php-quote">&quot;</span>,
<a href="#5841" id="5841" class="l">5841: </a>        <span class="php-quote">&quot;0-4-0&quot;</span> =&gt; <span class="php-quote">&quot;4 </span><span class="php-var">{$lang-&gt;months}</span><span class="php-quote">&quot;</span>,
<a href="#5842" id="5842" class="l">5842: </a>        <span class="php-quote">&quot;0-5-0&quot;</span> =&gt; <span class="php-quote">&quot;5 </span><span class="php-var">{$lang-&gt;months}</span><span class="php-quote">&quot;</span>,
<a href="#5843" id="5843" class="l">5843: </a>        <span class="php-quote">&quot;0-6-0&quot;</span> =&gt; <span class="php-quote">&quot;6 </span><span class="php-var">{$lang-&gt;months}</span><span class="php-quote">&quot;</span>,
<a href="#5844" id="5844" class="l">5844: </a>        <span class="php-quote">&quot;0-0-1&quot;</span> =&gt; <span class="php-quote">&quot;1 </span><span class="php-var">{$lang-&gt;year}</span><span class="php-quote">&quot;</span>,
<a href="#5845" id="5845" class="l">5845: </a>        <span class="php-quote">&quot;0-0-2&quot;</span> =&gt; <span class="php-quote">&quot;2 </span><span class="php-var">{$lang-&gt;years}</span><span class="php-quote">&quot;</span>
<a href="#5846" id="5846" class="l">5846: </a>    );
<a href="#5847" id="5847" class="l">5847: </a>
<a href="#5848" id="5848" class="l">5848: </a>    <span class="php-var">$ban_times</span> = <span class="php-var">$plugins</span>-&gt;run_hooks(<span class="php-quote">&quot;functions_fetch_ban_times&quot;</span>, <span class="php-var">$ban_times</span>);
<a href="#5849" id="5849" class="l">5849: </a>
<a href="#5850" id="5850" class="l">5850: </a>    <span class="php-var">$ban_times</span>[<span class="php-quote">'---'</span>] = <span class="php-var">$lang</span>-&gt;permanent;
<a href="#5851" id="5851" class="l">5851: </a>    <span class="php-keyword1">return</span> <span class="php-var">$ban_times</span>;
<a href="#5852" id="5852" class="l">5852: </a>}
<a href="#5853" id="5853" class="l">5853: </a>
<a href="#5854" id="5854" class="l">5854: </a><span class="php-comment">/**
</span><a href="#5855" id="5855" class="l">5855: </a><span class="php-comment"> * Format a ban length in to a UNIX timestamp.
</span><a href="#5856" id="5856" class="l">5856: </a><span class="php-comment"> *
</span><a href="#5857" id="5857" class="l">5857: </a><span class="php-comment"> * @param string The ban length string
</span><a href="#5858" id="5858" class="l">5858: </a><span class="php-comment"> * @param int The optional UNIX timestamp, if 0, current time is used.
</span><a href="#5859" id="5859" class="l">5859: </a><span class="php-comment"> * @return int The UNIX timestamp when the ban will be lifted
</span><a href="#5860" id="5860" class="l">5860: </a><span class="php-comment"> */</span>
<a href="#5861" id="5861" class="l">5861: </a><span class="php-keyword1">function</span> ban_date2timestamp(<span class="php-var">$date</span>, <span class="php-var">$stamp</span>=<span class="php-num">0</span>)
<a href="#5862" id="5862" class="l">5862: </a>{
<a href="#5863" id="5863" class="l">5863: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$stamp</span> == <span class="php-num">0</span>)
<a href="#5864" id="5864" class="l">5864: </a>    {
<a href="#5865" id="5865" class="l">5865: </a>        <span class="php-var">$stamp</span> = TIME_NOW;
<a href="#5866" id="5866" class="l">5866: </a>    }
<a href="#5867" id="5867" class="l">5867: </a>    <span class="php-var">$d</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">'-'</span>, <span class="php-var">$date</span>);
<a href="#5868" id="5868" class="l">5868: </a>    <span class="php-var">$nowdate</span> = <span class="php-keyword2">date</span>(<span class="php-quote">&quot;H-j-n-Y&quot;</span>, <span class="php-var">$stamp</span>);
<a href="#5869" id="5869" class="l">5869: </a>    <span class="php-var">$n</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">'-'</span>, <span class="php-var">$nowdate</span>);
<a href="#5870" id="5870" class="l">5870: </a>    <span class="php-var">$n</span>[<span class="php-num">1</span>] += <span class="php-var">$d</span>[<span class="php-num">0</span>];
<a href="#5871" id="5871" class="l">5871: </a>    <span class="php-var">$n</span>[<span class="php-num">2</span>] += <span class="php-var">$d</span>[<span class="php-num">1</span>];
<a href="#5872" id="5872" class="l">5872: </a>    <span class="php-var">$n</span>[<span class="php-num">3</span>] += <span class="php-var">$d</span>[<span class="php-num">2</span>];
<a href="#5873" id="5873" class="l">5873: </a>    <span class="php-keyword1">return</span> <span class="php-keyword2">mktime</span>(<span class="php-keyword2">date</span>(<span class="php-quote">&quot;G&quot;</span>), <span class="php-keyword2">date</span>(<span class="php-quote">&quot;i&quot;</span>), <span class="php-num">0</span>, <span class="php-var">$n</span>[<span class="php-num">2</span>], <span class="php-var">$n</span>[<span class="php-num">1</span>], <span class="php-var">$n</span>[<span class="php-num">3</span>]);
<a href="#5874" id="5874" class="l">5874: </a>}
<a href="#5875" id="5875" class="l">5875: </a>
<a href="#5876" id="5876" class="l">5876: </a><span class="php-comment">/**
</span><a href="#5877" id="5877" class="l">5877: </a><span class="php-comment"> * Expire old warnings in the database.
</span><a href="#5878" id="5878" class="l">5878: </a><span class="php-comment"> *
</span><a href="#5879" id="5879" class="l">5879: </a><span class="php-comment"> */</span>
<a href="#5880" id="5880" class="l">5880: </a><span class="php-keyword1">function</span> expire_warnings()
<a href="#5881" id="5881" class="l">5881: </a>{
<a href="#5882" id="5882" class="l">5882: </a>    <span class="php-keyword1">global</span> <span class="php-var">$db</span>;
<a href="#5883" id="5883" class="l">5883: </a>    
<a href="#5884" id="5884" class="l">5884: </a>    <span class="php-var">$users</span> = <span class="php-keyword1">array</span>();
<a href="#5885" id="5885" class="l">5885: </a>    
<a href="#5886" id="5886" class="l">5886: </a>    <span class="php-var">$query</span> = <span class="php-var">$db</span>-&gt;query(<span class="php-quote">&quot;
</span><a href="#5887" id="5887" class="l">5887: </a><span class="php-quote">        SELECT w.wid, w.uid, w.points, u.warningpoints
</span><a href="#5888" id="5888" class="l">5888: </a><span class="php-quote">        FROM &quot;</span>.TABLE_PREFIX.<span class="php-quote">&quot;warnings w
</span><a href="#5889" id="5889" class="l">5889: </a><span class="php-quote">        LEFT JOIN &quot;</span>.TABLE_PREFIX.<span class="php-quote">&quot;users u ON (u.uid=w.uid)
</span><a href="#5890" id="5890" class="l">5890: </a><span class="php-quote">        WHERE expires&lt;&quot;</span>.TIME_NOW.<span class="php-quote">&quot; AND expires!=0 AND expired!=1
</span><a href="#5891" id="5891" class="l">5891: </a><span class="php-quote">    &quot;</span>);
<a href="#5892" id="5892" class="l">5892: </a>    <span class="php-keyword1">while</span>(<span class="php-var">$warning</span> = <span class="php-var">$db</span>-&gt;fetch_array(<span class="php-var">$query</span>))
<a href="#5893" id="5893" class="l">5893: </a>    {
<a href="#5894" id="5894" class="l">5894: </a>        <span class="php-var">$updated_warning</span> = <span class="php-keyword1">array</span>(
<a href="#5895" id="5895" class="l">5895: </a>            <span class="php-quote">&quot;expired&quot;</span> =&gt; <span class="php-num">1</span>
<a href="#5896" id="5896" class="l">5896: </a>        );
<a href="#5897" id="5897" class="l">5897: </a>        <span class="php-var">$db</span>-&gt;update_query(<span class="php-quote">&quot;warnings&quot;</span>, <span class="php-var">$updated_warning</span>, <span class="php-quote">&quot;wid='</span><span class="php-var">{$warning['wid']}</span><span class="php-quote">'&quot;</span>);
<a href="#5898" id="5898" class="l">5898: </a>        
<a href="#5899" id="5899" class="l">5899: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">array_key_exists</span>(<span class="php-var">$warning</span>[<span class="php-quote">'uid'</span>], <span class="php-var">$users</span>))
<a href="#5900" id="5900" class="l">5900: </a>        {
<a href="#5901" id="5901" class="l">5901: </a>            <span class="php-var">$users</span>[<span class="php-var">$warning</span>[<span class="php-quote">'uid'</span>]] -= <span class="php-var">$warning</span>[<span class="php-quote">'points'</span>];
<a href="#5902" id="5902" class="l">5902: </a>        }
<a href="#5903" id="5903" class="l">5903: </a>        <span class="php-keyword1">else</span>
<a href="#5904" id="5904" class="l">5904: </a>        {
<a href="#5905" id="5905" class="l">5905: </a>            <span class="php-var">$users</span>[<span class="php-var">$warning</span>[<span class="php-quote">'uid'</span>]] = <span class="php-var">$warning</span>[<span class="php-quote">'warningpoints'</span>]-<span class="php-var">$warning</span>[<span class="php-quote">'points'</span>];
<a href="#5906" id="5906" class="l">5906: </a>        }
<a href="#5907" id="5907" class="l">5907: </a>    }
<a href="#5908" id="5908" class="l">5908: </a>    
<a href="#5909" id="5909" class="l">5909: </a>    <span class="php-keyword1">foreach</span>(<span class="php-var">$users</span> <span class="php-keyword1">as</span> <span class="php-var">$uid</span> =&gt; <span class="php-var">$warningpoints</span>)
<a href="#5910" id="5910" class="l">5910: </a>    {
<a href="#5911" id="5911" class="l">5911: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$warningpoints</span> &lt; <span class="php-num">0</span>)
<a href="#5912" id="5912" class="l">5912: </a>        {
<a href="#5913" id="5913" class="l">5913: </a>            <span class="php-var">$warningpoints</span> = <span class="php-num">0</span>;
<a href="#5914" id="5914" class="l">5914: </a>        }
<a href="#5915" id="5915" class="l">5915: </a>        
<a href="#5916" id="5916" class="l">5916: </a>        <span class="php-var">$updated_user</span> = <span class="php-keyword1">array</span>(
<a href="#5917" id="5917" class="l">5917: </a>            <span class="php-quote">&quot;warningpoints&quot;</span> =&gt; <span class="php-keyword2">intval</span>(<span class="php-var">$warningpoints</span>)
<a href="#5918" id="5918" class="l">5918: </a>        );
<a href="#5919" id="5919" class="l">5919: </a>        <span class="php-var">$db</span>-&gt;update_query(<span class="php-quote">&quot;users&quot;</span>, <span class="php-var">$updated_user</span>, <span class="php-quote">&quot;uid='&quot;</span>.<span class="php-keyword2">intval</span>(<span class="php-var">$uid</span>).<span class="php-quote">&quot;'&quot;</span>);
<a href="#5920" id="5920" class="l">5920: </a>    }
<a href="#5921" id="5921" class="l">5921: </a>}
<a href="#5922" id="5922" class="l">5922: </a>
<a href="#5923" id="5923" class="l">5923: </a><span class="php-comment">/**
</span><a href="#5924" id="5924" class="l">5924: </a><span class="php-comment"> * Custom chmod function to fix problems with hosts who's server configurations screw up umasks
</span><a href="#5925" id="5925" class="l">5925: </a><span class="php-comment"> *
</span><a href="#5926" id="5926" class="l">5926: </a><span class="php-comment"> * @param string The file to chmod
</span><a href="#5927" id="5927" class="l">5927: </a><span class="php-comment"> * @param string The mode to chmod(i.e. 0666)
</span><a href="#5928" id="5928" class="l">5928: </a><span class="php-comment"> */</span>
<a href="#5929" id="5929" class="l">5929: </a><span class="php-keyword1">function</span> my_chmod(<span class="php-var">$file</span>, <span class="php-var">$mode</span>)
<a href="#5930" id="5930" class="l">5930: </a>{
<a href="#5931" id="5931" class="l">5931: </a>    <span class="php-comment">// Passing $mode as an octal number causes strlen and substr to return incorrect values. Instead pass as a string</span>
<a href="#5932" id="5932" class="l">5932: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">substr</span>(<span class="php-var">$mode</span>, <span class="php-num">0</span>, <span class="php-num">1</span>) != <span class="php-quote">'0'</span> || <span class="php-keyword2">strlen</span>(<span class="php-var">$mode</span>) !== <span class="php-num">4</span>)
<a href="#5933" id="5933" class="l">5933: </a>    {
<a href="#5934" id="5934" class="l">5934: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<a href="#5935" id="5935" class="l">5935: </a>    }
<a href="#5936" id="5936" class="l">5936: </a>    <span class="php-var">$old_umask</span> = <span class="php-keyword2">umask</span>(<span class="php-num">0</span>);
<a href="#5937" id="5937" class="l">5937: </a>    
<a href="#5938" id="5938" class="l">5938: </a>    <span class="php-comment">// We convert the octal string to a decimal number because passing a octal string doesn't work with chmod</span>
<a href="#5939" id="5939" class="l">5939: </a>    <span class="php-comment">// and type casting subsequently removes the prepended 0 which is needed for octal numbers</span>
<a href="#5940" id="5940" class="l">5940: </a>    <span class="php-var">$result</span> = <span class="php-keyword2">chmod</span>(<span class="php-var">$file</span>, <span class="php-keyword2">octdec</span>(<span class="php-var">$mode</span>));
<a href="#5941" id="5941" class="l">5941: </a>    <span class="php-keyword2">umask</span>(<span class="php-var">$old_umask</span>);
<a href="#5942" id="5942" class="l">5942: </a>    <span class="php-keyword1">return</span> <span class="php-var">$result</span>;
<a href="#5943" id="5943" class="l">5943: </a>}
<a href="#5944" id="5944" class="l">5944: </a>
<a href="#5945" id="5945" class="l">5945: </a><span class="php-comment">/**
</span><a href="#5946" id="5946" class="l">5946: </a><span class="php-comment"> * Custom rmdir function to loop through an entire directory and delete all files/folders within
</span><a href="#5947" id="5947" class="l">5947: </a><span class="php-comment"> *
</span><a href="#5948" id="5948" class="l">5948: </a><span class="php-comment"> * @param string The path to the directory
</span><a href="#5949" id="5949" class="l">5949: </a><span class="php-comment"> * @param array Any files you wish to ignore (optional)
</span><a href="#5950" id="5950" class="l">5950: </a><span class="php-comment"> */</span>
<a href="#5951" id="5951" class="l">5951: </a><span class="php-keyword1">function</span> my_rmdir_recursive(<span class="php-var">$path</span>, <span class="php-var">$ignore</span>=<span class="php-keyword1">array</span>())
<a href="#5952" id="5952" class="l">5952: </a>{
<a href="#5953" id="5953" class="l">5953: </a>    <span class="php-keyword1">global</span> <span class="php-var">$orig_dir</span>;
<a href="#5954" id="5954" class="l">5954: </a>    
<a href="#5955" id="5955" class="l">5955: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword1">isset</span>(<span class="php-var">$orig_dir</span>))
<a href="#5956" id="5956" class="l">5956: </a>    {
<a href="#5957" id="5957" class="l">5957: </a>        <span class="php-var">$orig_dir</span> = <span class="php-var">$path</span>;
<a href="#5958" id="5958" class="l">5958: </a>    }
<a href="#5959" id="5959" class="l">5959: </a>    
<a href="#5960" id="5960" class="l">5960: </a>    <span class="php-keyword1">if</span>(@<span class="php-keyword2">is_dir</span>(<span class="php-var">$path</span>) &amp;&amp; !@<span class="php-keyword2">is_link</span>(<span class="php-var">$path</span>))
<a href="#5961" id="5961" class="l">5961: </a>    {
<a href="#5962" id="5962" class="l">5962: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$dh</span> = @<span class="php-keyword2">opendir</span>(<span class="php-var">$path</span>))
<a href="#5963" id="5963" class="l">5963: </a>        {
<a href="#5964" id="5964" class="l">5964: </a>            <span class="php-keyword1">while</span>((<span class="php-var">$file</span> = @<span class="php-keyword2">readdir</span>(<span class="php-var">$dh</span>)) !== <span class="php-keyword1">false</span>)
<a href="#5965" id="5965" class="l">5965: </a>            {
<a href="#5966" id="5966" class="l">5966: </a>                <span class="php-keyword1">if</span>(<span class="php-var">$file</span> == <span class="php-quote">'.'</span> || <span class="php-var">$file</span> == <span class="php-quote">'..'</span> || <span class="php-var">$file</span> == <span class="php-quote">'.svn'</span> || <span class="php-keyword2">in_array</span>(<span class="php-var">$path</span>.<span class="php-quote">'/'</span>.<span class="php-var">$file</span>, <span class="php-var">$ignore</span>) || !my_rmdir_recursive(<span class="php-var">$path</span>.<span class="php-quote">'/'</span>.<span class="php-var">$file</span>))
<a href="#5967" id="5967" class="l">5967: </a>                {
<a href="#5968" id="5968" class="l">5968: </a>                    <span class="php-keyword1">continue</span>;
<a href="#5969" id="5969" class="l">5969: </a>                }
<a href="#5970" id="5970" class="l">5970: </a>            }
<a href="#5971" id="5971" class="l">5971: </a>           @<span class="php-keyword2">closedir</span>(<span class="php-var">$dh</span>);
<a href="#5972" id="5972" class="l">5972: </a>        }
<a href="#5973" id="5973" class="l">5973: </a>        
<a href="#5974" id="5974" class="l">5974: </a>        <span class="php-comment">// Are we done? Don't delete the main folder too and return true</span>
<a href="#5975" id="5975" class="l">5975: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$path</span> == <span class="php-var">$orig_dir</span>)
<a href="#5976" id="5976" class="l">5976: </a>        {
<a href="#5977" id="5977" class="l">5977: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
<a href="#5978" id="5978" class="l">5978: </a>        }
<a href="#5979" id="5979" class="l">5979: </a>        
<a href="#5980" id="5980" class="l">5980: </a>        <span class="php-keyword1">return</span> @<span class="php-keyword2">rmdir</span>(<span class="php-var">$path</span>);
<a href="#5981" id="5981" class="l">5981: </a>    }
<a href="#5982" id="5982" class="l">5982: </a>    
<a href="#5983" id="5983" class="l">5983: </a>    <span class="php-keyword1">return</span> @<span class="php-keyword2">unlink</span>(<span class="php-var">$path</span>);
<a href="#5984" id="5984" class="l">5984: </a>}
<a href="#5985" id="5985" class="l">5985: </a>
<a href="#5986" id="5986" class="l">5986: </a><span class="php-comment">/**
</span><a href="#5987" id="5987" class="l">5987: </a><span class="php-comment"> * Counts the number of subforums in a array([pid][disporder][fid]) starting from the pid
</span><a href="#5988" id="5988" class="l">5988: </a><span class="php-comment"> *
</span><a href="#5989" id="5989" class="l">5989: </a><span class="php-comment"> * @param array The array of forums
</span><a href="#5990" id="5990" class="l">5990: </a><span class="php-comment"> * @return integer The number of sub forums
</span><a href="#5991" id="5991" class="l">5991: </a><span class="php-comment"> */</span>
<a href="#5992" id="5992" class="l">5992: </a><span class="php-keyword1">function</span> subforums_count(<span class="php-var">$array</span>)
<a href="#5993" id="5993" class="l">5993: </a>{
<a href="#5994" id="5994" class="l">5994: </a>    <span class="php-var">$count</span> = <span class="php-num">0</span>;
<a href="#5995" id="5995" class="l">5995: </a>    <span class="php-keyword1">foreach</span>(<span class="php-var">$array</span> <span class="php-keyword1">as</span> <span class="php-var">$array2</span>)
<a href="#5996" id="5996" class="l">5996: </a>    {
<a href="#5997" id="5997" class="l">5997: </a>        <span class="php-var">$count</span> += <span class="php-keyword2">count</span>(<span class="php-var">$array2</span>);
<a href="#5998" id="5998" class="l">5998: </a>    }
<a href="#5999" id="5999" class="l">5999: </a>    
<a href="#6000" id="6000" class="l">6000: </a>    <span class="php-keyword1">return</span> <span class="php-var">$count</span>;
<a href="#6001" id="6001" class="l">6001: </a>}
<a href="#6002" id="6002" class="l">6002: </a>
<a href="#6003" id="6003" class="l">6003: </a><span class="php-comment">/**
</span><a href="#6004" id="6004" class="l">6004: </a><span class="php-comment"> * Fix for PHP's ip2long to guarantee a 32-bit signed integer value is produced (this is aimed
</span><a href="#6005" id="6005" class="l">6005: </a><span class="php-comment"> * at 64-bit versions of PHP)
</span><a href="#6006" id="6006" class="l">6006: </a><span class="php-comment"> *
</span><a href="#6007" id="6007" class="l">6007: </a><span class="php-comment"> * @param string The IP to convert
</span><a href="#6008" id="6008" class="l">6008: </a><span class="php-comment"> * @return integer IP in 32-bit signed format
</span><a href="#6009" id="6009" class="l">6009: </a><span class="php-comment"> */</span>
<a href="#6010" id="6010" class="l">6010: </a><span class="php-keyword1">function</span> my_ip2long(<span class="php-var">$ip</span>)
<a href="#6011" id="6011" class="l">6011: </a>{
<a href="#6012" id="6012" class="l">6012: </a>    <span class="php-var">$ip_long</span> = <span class="php-keyword2">ip2long</span>(<span class="php-var">$ip</span>);
<a href="#6013" id="6013" class="l">6013: </a>
<a href="#6014" id="6014" class="l">6014: </a>    <span class="php-keyword1">if</span>(!<span class="php-var">$ip_long</span>)
<a href="#6015" id="6015" class="l">6015: </a>    {
<a href="#6016" id="6016" class="l">6016: </a>        <span class="php-var">$ip_long</span> = <span class="php-keyword2">sprintf</span>(<span class="php-quote">&quot;%u&quot;</span>, <span class="php-keyword2">ip2long</span>(<span class="php-var">$ip</span>));
<a href="#6017" id="6017" class="l">6017: </a>        
<a href="#6018" id="6018" class="l">6018: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$ip_long</span>)
<a href="#6019" id="6019" class="l">6019: </a>        {
<a href="#6020" id="6020" class="l">6020: </a>            <span class="php-keyword1">return</span> <span class="php-num">0</span>;
<a href="#6021" id="6021" class="l">6021: </a>        }
<a href="#6022" id="6022" class="l">6022: </a>    }
<a href="#6023" id="6023" class="l">6023: </a>
<a href="#6024" id="6024" class="l">6024: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$ip_long</span> &gt;= <span class="php-num">2147483648</span>) <span class="php-comment">// Won't occur on 32-bit PHP</span>
<a href="#6025" id="6025" class="l">6025: </a>    {
<a href="#6026" id="6026" class="l">6026: </a>        <span class="php-var">$ip_long</span> -= <span class="php-num">4294967296</span>;
<a href="#6027" id="6027" class="l">6027: </a>    }
<a href="#6028" id="6028" class="l">6028: </a>
<a href="#6029" id="6029" class="l">6029: </a>    <span class="php-keyword1">return</span> <span class="php-var">$ip_long</span>;
<a href="#6030" id="6030" class="l">6030: </a>}
<a href="#6031" id="6031" class="l">6031: </a>
<a href="#6032" id="6032" class="l">6032: </a><span class="php-comment">/**
</span><a href="#6033" id="6033" class="l">6033: </a><span class="php-comment"> * As above, fix for PHP's long2ip on 64-bit versions
</span><a href="#6034" id="6034" class="l">6034: </a><span class="php-comment"> *
</span><a href="#6035" id="6035" class="l">6035: </a><span class="php-comment"> * @param integer The IP to convert (will accept 64-bit IPs as well)
</span><a href="#6036" id="6036" class="l">6036: </a><span class="php-comment"> * @return string IP in IPv4 format
</span><a href="#6037" id="6037" class="l">6037: </a><span class="php-comment"> */</span>
<a href="#6038" id="6038" class="l">6038: </a><span class="php-keyword1">function</span> my_long2ip(<span class="php-var">$long</span>)
<a href="#6039" id="6039" class="l">6039: </a>{
<a href="#6040" id="6040" class="l">6040: </a>    <span class="php-comment">// On 64-bit machines is_int will return true. On 32-bit it will return false</span>
<a href="#6041" id="6041" class="l">6041: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$long</span> &lt; <span class="php-num">0</span> &amp;&amp; <span class="php-keyword2">is_int</span>(<span class="php-num">2147483648</span>))
<a href="#6042" id="6042" class="l">6042: </a>    {
<a href="#6043" id="6043" class="l">6043: </a>        <span class="php-comment">// We have a 64-bit system</span>
<a href="#6044" id="6044" class="l">6044: </a>        <span class="php-var">$long</span> += <span class="php-num">4294967296</span>;
<a href="#6045" id="6045" class="l">6045: </a>    }
<a href="#6046" id="6046" class="l">6046: </a>    <span class="php-keyword1">return</span> <span class="php-keyword2">long2ip</span>(<span class="php-var">$long</span>);
<a href="#6047" id="6047" class="l">6047: </a>}
<a href="#6048" id="6048" class="l">6048: </a>
<a href="#6049" id="6049" class="l">6049: </a>
<a href="#6050" id="6050" class="l">6050: </a><span class="php-comment">/**
</span><a href="#6051" id="6051" class="l">6051: </a><span class="php-comment"> * Processes a checksum list on MyBB files and returns a result set
</span><a href="#6052" id="6052" class="l">6052: </a><span class="php-comment"> *
</span><a href="#6053" id="6053" class="l">6053: </a><span class="php-comment"> * @param array The array of checksums and their corresponding files
</span><a href="#6054" id="6054" class="l">6054: </a><span class="php-comment"> * @return array The bad files
</span><a href="#6055" id="6055" class="l">6055: </a><span class="php-comment"> */</span>
<a href="#6056" id="6056" class="l">6056: </a><span class="php-keyword1">function</span> verify_files(<span class="php-var">$path</span>=MYBB_ROOT, <span class="php-var">$count</span>=<span class="php-num">0</span>)
<a href="#6057" id="6057" class="l">6057: </a>{
<a href="#6058" id="6058" class="l">6058: </a>    <span class="php-keyword1">global</span> <span class="php-var">$mybb</span>, <span class="php-var">$checksums</span>, <span class="php-var">$bad_verify_files</span>;
<a href="#6059" id="6059" class="l">6059: </a>    
<a href="#6060" id="6060" class="l">6060: </a>    <span class="php-comment">// We don't need to check these types of files</span>
<a href="#6061" id="6061" class="l">6061: </a>    <span class="php-var">$ignore</span> = <span class="php-keyword1">array</span>(<span class="php-quote">&quot;.&quot;</span>, <span class="php-quote">&quot;..&quot;</span>, <span class="php-quote">&quot;.svn&quot;</span>, <span class="php-quote">&quot;config.php&quot;</span>, <span class="php-quote">&quot;settings.php&quot;</span>, <span class="php-quote">&quot;Thumb.db&quot;</span>, <span class="php-quote">&quot;config.default.php&quot;</span>, <span class="php-quote">&quot;lock&quot;</span>, <span class="php-quote">&quot;htaccess.txt&quot;</span>, <span class="php-quote">&quot;logo.gif&quot;</span>);
<a href="#6062" id="6062" class="l">6062: </a>    <span class="php-var">$ignore_ext</span> = <span class="php-keyword1">array</span>(<span class="php-quote">&quot;attach&quot;</span>);
<a href="#6063" id="6063" class="l">6063: </a>    
<a href="#6064" id="6064" class="l">6064: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">substr</span>(<span class="php-var">$path</span>, -<span class="php-num">1</span>, <span class="php-num">1</span>) == <span class="php-quote">&quot;/&quot;</span>)
<a href="#6065" id="6065" class="l">6065: </a>    {
<a href="#6066" id="6066" class="l">6066: </a>        <span class="php-var">$path</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$path</span>, <span class="php-num">0</span>, -<span class="php-num">1</span>);
<a href="#6067" id="6067" class="l">6067: </a>    }
<a href="#6068" id="6068" class="l">6068: </a>    
<a href="#6069" id="6069" class="l">6069: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$bad_verify_files</span>))
<a href="#6070" id="6070" class="l">6070: </a>    {
<a href="#6071" id="6071" class="l">6071: </a>        <span class="php-var">$bad_verify_files</span> = <span class="php-keyword1">array</span>();
<a href="#6072" id="6072" class="l">6072: </a>    }
<a href="#6073" id="6073" class="l">6073: </a>    
<a href="#6074" id="6074" class="l">6074: </a>    <span class="php-comment">// Make sure that we're in a directory and it's not a symbolic link</span>
<a href="#6075" id="6075" class="l">6075: </a>    <span class="php-keyword1">if</span>(@<span class="php-keyword2">is_dir</span>(<span class="php-var">$path</span>) &amp;&amp; !@<span class="php-keyword2">is_link</span>(<span class="php-var">$path</span>))
<a href="#6076" id="6076" class="l">6076: </a>    {
<a href="#6077" id="6077" class="l">6077: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$dh</span> = @<span class="php-keyword2">opendir</span>(<span class="php-var">$path</span>))
<a href="#6078" id="6078" class="l">6078: </a>        {
<a href="#6079" id="6079" class="l">6079: </a>            <span class="php-comment">// Loop through all the files/directories in this directory</span>
<a href="#6080" id="6080" class="l">6080: </a>            <span class="php-keyword1">while</span>((<span class="php-var">$file</span> = @<span class="php-keyword2">readdir</span>(<span class="php-var">$dh</span>)) !== <span class="php-keyword1">false</span>)
<a href="#6081" id="6081" class="l">6081: </a>            {
<a href="#6082" id="6082" class="l">6082: </a>                <span class="php-keyword1">if</span>(<span class="php-keyword2">in_array</span>(<span class="php-var">$file</span>, <span class="php-var">$ignore</span>) || <span class="php-keyword2">in_array</span>(get_extension(<span class="php-var">$file</span>), <span class="php-var">$ignore_ext</span>))
<a href="#6083" id="6083" class="l">6083: </a>                {
<a href="#6084" id="6084" class="l">6084: </a>                    <span class="php-keyword1">continue</span>;
<a href="#6085" id="6085" class="l">6085: </a>                }
<a href="#6086" id="6086" class="l">6086: </a>                
<a href="#6087" id="6087" class="l">6087: </a>                <span class="php-comment">// Recurse through the directory tree</span>
<a href="#6088" id="6088" class="l">6088: </a>                <span class="php-keyword1">if</span>(<span class="php-keyword2">is_dir</span>(<span class="php-var">$path</span>.<span class="php-quote">&quot;/&quot;</span>.<span class="php-var">$file</span>))
<a href="#6089" id="6089" class="l">6089: </a>                {
<a href="#6090" id="6090" class="l">6090: </a>                    verify_files(<span class="php-var">$path</span>.<span class="php-quote">&quot;/&quot;</span>.<span class="php-var">$file</span>, (<span class="php-var">$count</span>+<span class="php-num">1</span>));
<a href="#6091" id="6091" class="l">6091: </a>                    <span class="php-keyword1">continue</span>;
<a href="#6092" id="6092" class="l">6092: </a>                }
<a href="#6093" id="6093" class="l">6093: </a>                
<a href="#6094" id="6094" class="l">6094: </a>                <span class="php-comment">// We only need the last part of the path (from the MyBB directory to the file. i.e. inc/functions.php)</span>
<a href="#6095" id="6095" class="l">6095: </a>                <span class="php-var">$file_path</span> = <span class="php-quote">&quot;.&quot;</span>.<span class="php-keyword2">str_replace</span>(<span class="php-keyword2">substr</span>(MYBB_ROOT, <span class="php-num">0</span>, -<span class="php-num">1</span>), <span class="php-quote">&quot;&quot;</span>, <span class="php-var">$path</span>).<span class="php-quote">&quot;/&quot;</span>.<span class="php-var">$file</span>;
<a href="#6096" id="6096" class="l">6096: </a>                
<a href="#6097" id="6097" class="l">6097: </a>                <span class="php-comment">// Does this file even exist in our official list? Perhaps it's a plugin</span>
<a href="#6098" id="6098" class="l">6098: </a>                <span class="php-keyword1">if</span>(<span class="php-keyword2">array_key_exists</span>(<span class="php-var">$file_path</span>, <span class="php-var">$checksums</span>))
<a href="#6099" id="6099" class="l">6099: </a>                {
<a href="#6100" id="6100" class="l">6100: </a>                    <span class="php-var">$filename</span> = <span class="php-var">$path</span>.<span class="php-quote">&quot;/&quot;</span>.<span class="php-var">$file</span>;
<a href="#6101" id="6101" class="l">6101: </a>                    <span class="php-var">$handle</span> = <span class="php-keyword2">fopen</span>(<span class="php-var">$filename</span>, <span class="php-quote">&quot;rb&quot;</span>);
<a href="#6102" id="6102" class="l">6102: </a>                    <span class="php-var">$contents</span> = <span class="php-quote">''</span>;
<a href="#6103" id="6103" class="l">6103: </a>                    <span class="php-keyword1">while</span>(!<span class="php-keyword2">feof</span>(<span class="php-var">$handle</span>))
<a href="#6104" id="6104" class="l">6104: </a>                    {
<a href="#6105" id="6105" class="l">6105: </a>                        <span class="php-var">$contents</span> .= <span class="php-keyword2">fread</span>(<span class="php-var">$handle</span>, <span class="php-num">8192</span>);
<a href="#6106" id="6106" class="l">6106: </a>                    }
<a href="#6107" id="6107" class="l">6107: </a>                    <span class="php-keyword2">fclose</span>(<span class="php-var">$handle</span>);
<a href="#6108" id="6108" class="l">6108: </a>                    
<a href="#6109" id="6109" class="l">6109: </a>                    <span class="php-var">$md5</span> = <span class="php-keyword2">md5</span>(<span class="php-var">$contents</span>);
<a href="#6110" id="6110" class="l">6110: </a>                    
<a href="#6111" id="6111" class="l">6111: </a>                    <span class="php-comment">// Does it match any of our hashes (unix/windows new lines taken into consideration with the hashes)</span>
<a href="#6112" id="6112" class="l">6112: </a>                    <span class="php-keyword1">if</span>(!<span class="php-keyword2">in_array</span>(<span class="php-var">$md5</span>, <span class="php-var">$checksums</span>[<span class="php-var">$file_path</span>]))
<a href="#6113" id="6113" class="l">6113: </a>                    {                       
<a href="#6114" id="6114" class="l">6114: </a>                        <span class="php-var">$bad_verify_files</span>[] = <span class="php-keyword1">array</span>(<span class="php-quote">&quot;status&quot;</span> =&gt; <span class="php-quote">&quot;changed&quot;</span>, <span class="php-quote">&quot;path&quot;</span> =&gt; <span class="php-var">$file_path</span>);
<a href="#6115" id="6115" class="l">6115: </a>                    }
<a href="#6116" id="6116" class="l">6116: </a>                }
<a href="#6117" id="6117" class="l">6117: </a>                <span class="php-keyword1">unset</span>(<span class="php-var">$checksums</span>[<span class="php-var">$file_path</span>]);
<a href="#6118" id="6118" class="l">6118: </a>            }
<a href="#6119" id="6119" class="l">6119: </a>           @<span class="php-keyword2">closedir</span>(<span class="php-var">$dh</span>);
<a href="#6120" id="6120" class="l">6120: </a>        }
<a href="#6121" id="6121" class="l">6121: </a>    }
<a href="#6122" id="6122" class="l">6122: </a>    
<a href="#6123" id="6123" class="l">6123: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$count</span> == <span class="php-num">0</span>)
<a href="#6124" id="6124" class="l">6124: </a>    {
<a href="#6125" id="6125" class="l">6125: </a>        <span class="php-keyword1">if</span>(!<span class="php-keyword1">empty</span>(<span class="php-var">$checksums</span>))
<a href="#6126" id="6126" class="l">6126: </a>        {
<a href="#6127" id="6127" class="l">6127: </a>            <span class="php-keyword1">foreach</span>(<span class="php-var">$checksums</span> <span class="php-keyword1">as</span> <span class="php-var">$file_path</span> =&gt; <span class="php-var">$hashes</span>)
<a href="#6128" id="6128" class="l">6128: </a>            {
<a href="#6129" id="6129" class="l">6129: </a>                <span class="php-keyword1">if</span>(<span class="php-keyword2">in_array</span>(<span class="php-keyword2">basename</span>(<span class="php-var">$file_path</span>), <span class="php-var">$ignore</span>))
<a href="#6130" id="6130" class="l">6130: </a>                {
<a href="#6131" id="6131" class="l">6131: </a>                    <span class="php-keyword1">continue</span>;
<a href="#6132" id="6132" class="l">6132: </a>                }
<a href="#6133" id="6133" class="l">6133: </a>                <span class="php-var">$bad_verify_files</span>[] = <span class="php-keyword1">array</span>(<span class="php-quote">&quot;status&quot;</span> =&gt; <span class="php-quote">&quot;missing&quot;</span>, <span class="php-quote">&quot;path&quot;</span> =&gt; <span class="php-var">$file_path</span>);
<a href="#6134" id="6134" class="l">6134: </a>            }
<a href="#6135" id="6135" class="l">6135: </a>        }
<a href="#6136" id="6136" class="l">6136: </a>    }
<a href="#6137" id="6137" class="l">6137: </a>    
<a href="#6138" id="6138" class="l">6138: </a>    <span class="php-comment">// uh oh</span>
<a href="#6139" id="6139" class="l">6139: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$count</span> == <span class="php-num">0</span>)
<a href="#6140" id="6140" class="l">6140: </a>    {
<a href="#6141" id="6141" class="l">6141: </a>        <span class="php-keyword1">return</span> <span class="php-var">$bad_verify_files</span>;
<a href="#6142" id="6142" class="l">6142: </a>    }
<a href="#6143" id="6143" class="l">6143: </a>}
<a href="#6144" id="6144" class="l">6144: </a>
<a href="#6145" id="6145" class="l">6145: </a><span class="php-comment">/**
</span><a href="#6146" id="6146" class="l">6146: </a><span class="php-comment"> * Returns a signed value equal to an integer
</span><a href="#6147" id="6147" class="l">6147: </a><span class="php-comment"> *
</span><a href="#6148" id="6148" class="l">6148: </a><span class="php-comment"> * @param int The integer
</span><a href="#6149" id="6149" class="l">6149: </a><span class="php-comment"> * @return string The signed equivalent
</span><a href="#6150" id="6150" class="l">6150: </a><span class="php-comment"> */</span>
<a href="#6151" id="6151" class="l">6151: </a><span class="php-keyword1">function</span> signed(<span class="php-var">$int</span>)
<a href="#6152" id="6152" class="l">6152: </a>{
<a href="#6153" id="6153" class="l">6153: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$int</span> &lt; <span class="php-num">0</span>)
<a href="#6154" id="6154" class="l">6154: </a>    {
<a href="#6155" id="6155" class="l">6155: </a>        <span class="php-keyword1">return</span> <span class="php-quote">&quot;</span><span class="php-var">$int</span><span class="php-quote">&quot;</span>;
<a href="#6156" id="6156" class="l">6156: </a>    }
<a href="#6157" id="6157" class="l">6157: </a>    <span class="php-keyword1">else</span>
<a href="#6158" id="6158" class="l">6158: </a>    {
<a href="#6159" id="6159" class="l">6159: </a>        <span class="php-keyword1">return</span> <span class="php-quote">&quot;+</span><span class="php-var">$int</span><span class="php-quote">&quot;</span>;
<a href="#6160" id="6160" class="l">6160: </a>    }
<a href="#6161" id="6161" class="l">6161: </a>}
<a href="#6162" id="6162" class="l">6162: </a>
<a href="#6163" id="6163" class="l">6163: </a><span class="php-comment">/**
</span><a href="#6164" id="6164" class="l">6164: </a><span class="php-comment"> * Returns a securely generated seed for PHP's RNG (Random Number Generator)
</span><a href="#6165" id="6165" class="l">6165: </a><span class="php-comment"> *
</span><a href="#6166" id="6166" class="l">6166: </a><span class="php-comment"> * @param int Length of the seed bytes (8 is default. Provides good cryptographic variance)
</span><a href="#6167" id="6167" class="l">6167: </a><span class="php-comment"> * @return int An integer equivalent of a secure hexadecimal seed
</span><a href="#6168" id="6168" class="l">6168: </a><span class="php-comment"> */</span>
<a href="#6169" id="6169" class="l">6169: </a><span class="php-keyword1">function</span> secure_seed_rng(<span class="php-var">$count</span>=<span class="php-num">8</span>)
<a href="#6170" id="6170" class="l">6170: </a>{
<a href="#6171" id="6171" class="l">6171: </a>    <span class="php-var">$output</span> = <span class="php-quote">''</span>;
<a href="#6172" id="6172" class="l">6172: </a>    
<a href="#6173" id="6173" class="l">6173: </a>    <span class="php-comment">// Try the unix/linux method</span>
<a href="#6174" id="6174" class="l">6174: </a>    <span class="php-keyword1">if</span>(@<span class="php-keyword2">is_readable</span>(<span class="php-quote">'/dev/urandom'</span>) &amp;&amp; (<span class="php-var">$handle</span> = @<span class="php-keyword2">fopen</span>(<span class="php-quote">'/dev/urandom'</span>, <span class="php-quote">'rb'</span>)))
<a href="#6175" id="6175" class="l">6175: </a>    {
<a href="#6176" id="6176" class="l">6176: </a>        <span class="php-var">$output</span> = @<span class="php-keyword2">fread</span>(<span class="php-var">$handle</span>, <span class="php-var">$count</span>);
<a href="#6177" id="6177" class="l">6177: </a>        @<span class="php-keyword2">fclose</span>(<span class="php-var">$handle</span>);
<a href="#6178" id="6178" class="l">6178: </a>    }
<a href="#6179" id="6179" class="l">6179: </a>    
<a href="#6180" id="6180" class="l">6180: </a>    <span class="php-comment">// Didn't work? Do we still not have enough bytes? Use our own (less secure) rng generator</span>
<a href="#6181" id="6181" class="l">6181: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">strlen</span>(<span class="php-var">$output</span>) &lt; <span class="php-var">$count</span>)
<a href="#6182" id="6182" class="l">6182: </a>    {
<a href="#6183" id="6183" class="l">6183: </a>        <span class="php-var">$output</span> = <span class="php-quote">''</span>;
<a href="#6184" id="6184" class="l">6184: </a>        
<a href="#6185" id="6185" class="l">6185: </a>        <span class="php-comment">// Close to what PHP basically uses internally to seed, but not quite.</span>
<a href="#6186" id="6186" class="l">6186: </a>        <span class="php-var">$unique_state</span> = <span class="php-keyword2">microtime</span>().@<span class="php-keyword2">getmypid</span>();
<a href="#6187" id="6187" class="l">6187: </a>        
<a href="#6188" id="6188" class="l">6188: </a>        <span class="php-keyword1">for</span>(<span class="php-var">$i</span> = <span class="php-num">0</span>; <span class="php-var">$i</span> &lt; <span class="php-var">$count</span>; <span class="php-var">$i</span> += <span class="php-num">16</span>)
<a href="#6189" id="6189" class="l">6189: </a>        {
<a href="#6190" id="6190" class="l">6190: </a>            <span class="php-var">$unique_state</span> = <span class="php-keyword2">md5</span>(<span class="php-keyword2">microtime</span>().<span class="php-var">$unique_state</span>);
<a href="#6191" id="6191" class="l">6191: </a>            <span class="php-var">$output</span> .= <span class="php-keyword2">pack</span>(<span class="php-quote">'H*'</span>, <span class="php-keyword2">md5</span>(<span class="php-var">$unique_state</span>));
<a href="#6192" id="6192" class="l">6192: </a>        }
<a href="#6193" id="6193" class="l">6193: </a>    }
<a href="#6194" id="6194" class="l">6194: </a>    
<a href="#6195" id="6195" class="l">6195: </a>    <span class="php-comment">// /dev/urandom and openssl will always be twice as long as $count. base64_encode will roughly take up 33% more space but crc32 will put it to 32 characters</span>
<a href="#6196" id="6196" class="l">6196: </a>    <span class="php-var">$output</span> = <span class="php-keyword2">hexdec</span>(<span class="php-keyword2">substr</span>(<span class="php-keyword2">dechex</span>(<span class="php-keyword2">crc32</span>(<span class="php-keyword2">base64_encode</span>(<span class="php-var">$output</span>))), <span class="php-num">0</span>, <span class="php-var">$count</span>));
<a href="#6197" id="6197" class="l">6197: </a>    
<a href="#6198" id="6198" class="l">6198: </a>    <span class="php-keyword1">return</span> <span class="php-var">$output</span>;
<a href="#6199" id="6199" class="l">6199: </a>}
<a href="#6200" id="6200" class="l">6200: </a>
<a href="#6201" id="6201" class="l">6201: </a><span class="php-comment">/**
</span><a href="#6202" id="6202" class="l">6202: </a><span class="php-comment"> * Wrapper function for mt_rand. Automatically seeds using a secure seed once.
</span><a href="#6203" id="6203" class="l">6203: </a><span class="php-comment"> *
</span><a href="#6204" id="6204" class="l">6204: </a><span class="php-comment"> * @param int Optional lowest value to be returned (default: 0) 
</span><a href="#6205" id="6205" class="l">6205: </a><span class="php-comment"> * @param int Optional highest value to be returned (default: mt_getrandmax()) 
</span><a href="#6206" id="6206" class="l">6206: </a><span class="php-comment"> * @param boolean True forces it to reseed the RNG first
</span><a href="#6207" id="6207" class="l">6207: </a><span class="php-comment"> * @return int An integer equivalent of a secure hexadecimal seed
</span><a href="#6208" id="6208" class="l">6208: </a><span class="php-comment"> */</span>
<a href="#6209" id="6209" class="l">6209: </a><span class="php-keyword1">function</span> my_rand(<span class="php-var">$min</span>=<span class="php-keyword1">null</span>, <span class="php-var">$max</span>=<span class="php-keyword1">null</span>, <span class="php-var">$force_seed</span>=<span class="php-keyword1">false</span>)
<a href="#6210" id="6210" class="l">6210: </a>{
<a href="#6211" id="6211" class="l">6211: </a>    <span class="php-keyword1">static</span> <span class="php-var">$seeded</span> = <span class="php-keyword1">false</span>;
<a href="#6212" id="6212" class="l">6212: </a>    <span class="php-keyword1">static</span> <span class="php-var">$obfuscator</span> = <span class="php-num">0</span>;
<a href="#6213" id="6213" class="l">6213: </a>
<a href="#6214" id="6214" class="l">6214: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$seeded</span> == <span class="php-keyword1">false</span> || <span class="php-var">$force_seed</span> == <span class="php-keyword1">true</span>)
<a href="#6215" id="6215" class="l">6215: </a>    {
<a href="#6216" id="6216" class="l">6216: </a>        <span class="php-keyword2">mt_srand</span>(secure_seed_rng());
<a href="#6217" id="6217" class="l">6217: </a>        <span class="php-var">$seeded</span> = <span class="php-keyword1">true</span>;
<a href="#6218" id="6218" class="l">6218: </a>
<a href="#6219" id="6219" class="l">6219: </a>        <span class="php-var">$obfuscator</span> = <span class="php-keyword2">abs</span>((int) secure_seed_rng());
<a href="#6220" id="6220" class="l">6220: </a>        
<a href="#6221" id="6221" class="l">6221: </a>        <span class="php-comment">// Ensure that $obfuscator is &lt;= mt_getrandmax() for 64 bit systems.</span>
<a href="#6222" id="6222" class="l">6222: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$obfuscator</span> &gt; <span class="php-keyword2">mt_getrandmax</span>())
<a href="#6223" id="6223" class="l">6223: </a>        {
<a href="#6224" id="6224" class="l">6224: </a>            <span class="php-var">$obfuscator</span> -= <span class="php-keyword2">mt_getrandmax</span>();
<a href="#6225" id="6225" class="l">6225: </a>        }
<a href="#6226" id="6226" class="l">6226: </a>    }
<a href="#6227" id="6227" class="l">6227: </a>
<a href="#6228" id="6228" class="l">6228: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$min</span> !== <span class="php-keyword1">null</span> &amp;&amp; <span class="php-var">$max</span> !== <span class="php-keyword1">null</span>)
<a href="#6229" id="6229" class="l">6229: </a>    {
<a href="#6230" id="6230" class="l">6230: </a>        <span class="php-var">$distance</span> = <span class="php-var">$max</span> - <span class="php-var">$min</span>;
<a href="#6231" id="6231" class="l">6231: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$distance</span> &gt; <span class="php-num">0</span>)
<a href="#6232" id="6232" class="l">6232: </a>        {
<a href="#6233" id="6233" class="l">6233: </a>            <span class="php-keyword1">return</span> <span class="php-var">$min</span> + (int)((float)(<span class="php-var">$distance</span> + <span class="php-num">1</span>) * (float)(<span class="php-keyword2">mt_rand</span>() ^ <span class="php-var">$obfuscator</span>) / (<span class="php-keyword2">mt_getrandmax</span>() + <span class="php-num">1</span>));
<a href="#6234" id="6234" class="l">6234: </a>        }
<a href="#6235" id="6235" class="l">6235: </a>        <span class="php-keyword1">else</span>
<a href="#6236" id="6236" class="l">6236: </a>        {
<a href="#6237" id="6237" class="l">6237: </a>            <span class="php-keyword1">return</span> <span class="php-keyword2">mt_rand</span>(<span class="php-var">$min</span>, <span class="php-var">$max</span>);
<a href="#6238" id="6238" class="l">6238: </a>        }
<a href="#6239" id="6239" class="l">6239: </a>    }
<a href="#6240" id="6240" class="l">6240: </a>    <span class="php-keyword1">else</span>
<a href="#6241" id="6241" class="l">6241: </a>    {
<a href="#6242" id="6242" class="l">6242: </a>        <span class="php-var">$val</span> = <span class="php-keyword2">mt_rand</span>() ^ <span class="php-var">$obfuscator</span>;
<a href="#6243" id="6243" class="l">6243: </a>        <span class="php-keyword1">return</span> <span class="php-var">$val</span>;
<a href="#6244" id="6244" class="l">6244: </a>    }
<a href="#6245" id="6245" class="l">6245: </a>}
<a href="#6246" id="6246" class="l">6246: </a>
<a href="#6247" id="6247" class="l">6247: </a><span class="php-comment">/**
</span><a href="#6248" id="6248" class="l">6248: </a><span class="php-comment"> * More robust version of PHP's trim() function. It includes a list of UTF-16 blank characters
</span><a href="#6249" id="6249" class="l">6249: </a><span class="php-comment"> * from http://kb.mozillazine.org/Network.IDN.blacklist_chars
</span><a href="#6250" id="6250" class="l">6250: </a><span class="php-comment"> *
</span><a href="#6251" id="6251" class="l">6251: </a><span class="php-comment"> * @param string The string to trim from
</span><a href="#6252" id="6252" class="l">6252: </a><span class="php-comment"> * @param string Optional. The stripped characters can also be specified using the charlist parameter
</span><a href="#6253" id="6253" class="l">6253: </a><span class="php-comment"> * @return string The trimmed string
</span><a href="#6254" id="6254" class="l">6254: </a><span class="php-comment"> */</span>
<a href="#6255" id="6255" class="l">6255: </a><span class="php-keyword1">function</span> trim_blank_chrs(<span class="php-var">$string</span>, <span class="php-var">$charlist</span>=<span class="php-keyword1">false</span>)
<a href="#6256" id="6256" class="l">6256: </a>{
<a href="#6257" id="6257" class="l">6257: </a>    <span class="php-var">$hex_chrs</span> = <span class="php-keyword1">array</span>(
<a href="#6258" id="6258" class="l">6258: </a>        <span class="php-num">0x20</span> =&gt; <span class="php-num">1</span>,
<a href="#6259" id="6259" class="l">6259: </a>        <span class="php-num">0x09</span> =&gt; <span class="php-num">1</span>,
<a href="#6260" id="6260" class="l">6260: </a>        <span class="php-num">0x0A</span> =&gt; <span class="php-num">1</span>,
<a href="#6261" id="6261" class="l">6261: </a>        <span class="php-num">0x0D</span> =&gt; <span class="php-num">1</span>,
<a href="#6262" id="6262" class="l">6262: </a>        <span class="php-num">0x0B</span> =&gt; <span class="php-num">1</span>,
<a href="#6263" id="6263" class="l">6263: </a>        <span class="php-num">0xAD</span> =&gt; <span class="php-num">1</span>,
<a href="#6264" id="6264" class="l">6264: </a>        <span class="php-num">0xA0</span> =&gt; <span class="php-num">1</span>,
<a href="#6265" id="6265" class="l">6265: </a>        <span class="php-num">0xAD</span> =&gt; <span class="php-num">1</span>,
<a href="#6266" id="6266" class="l">6266: </a>        <span class="php-num">0xBF</span> =&gt; <span class="php-num">1</span>,
<a href="#6267" id="6267" class="l">6267: </a>        <span class="php-num">0x81</span> =&gt; <span class="php-num">1</span>,
<a href="#6268" id="6268" class="l">6268: </a>        <span class="php-num">0x8D</span> =&gt; <span class="php-num">1</span>,
<a href="#6269" id="6269" class="l">6269: </a>        <span class="php-num">0x90</span> =&gt; <span class="php-num">1</span>,
<a href="#6270" id="6270" class="l">6270: </a>        <span class="php-num">0x9D</span> =&gt; <span class="php-num">1</span>,
<a href="#6271" id="6271" class="l">6271: </a>        <span class="php-num">0xCC</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xB7</span> =&gt; <span class="php-num">1</span>, <span class="php-num">0xB8</span> =&gt; <span class="php-num">1</span>), <span class="php-comment">// \x{0337} or \x{0338}</span>
<a href="#6272" id="6272" class="l">6272: </a>        <span class="php-num">0xE1</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x85</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x9F</span> =&gt; <span class="php-num">1</span>, <span class="php-num">0xA0</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{115F} or \x{1160}</span>
<a href="#6273" id="6273" class="l">6273: </a>        <span class="php-num">0xE2</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x80</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x80</span> =&gt; <span class="php-num">1</span>, <span class="php-num">0x81</span> =&gt; <span class="php-num">1</span>, <span class="php-num">0x82</span> =&gt; <span class="php-num">1</span>, <span class="php-num">0x83</span> =&gt; <span class="php-num">1</span>, <span class="php-num">0x84</span> =&gt; <span class="php-num">1</span>, <span class="php-num">0x85</span> =&gt; <span class="php-num">1</span>, <span class="php-num">0x86</span> =&gt; <span class="php-num">1</span>, <span class="php-num">0x87</span> =&gt; <span class="php-num">1</span>, <span class="php-num">0x88</span> =&gt; <span class="php-num">1</span>, <span class="php-num">0x89</span> =&gt; <span class="php-num">1</span>, <span class="php-num">0x8A</span> =&gt; <span class="php-num">1</span>, <span class="php-num">0x8B</span> =&gt; <span class="php-num">1</span>, <span class="php-comment">// \x{2000} to \x{200B}</span>
<a href="#6274" id="6274" class="l">6274: </a>                                    <span class="php-num">0xA8</span> =&gt; <span class="php-num">1</span>, <span class="php-num">0xA9</span> =&gt; <span class="php-num">1</span>, <span class="php-num">0xAA</span> =&gt; <span class="php-num">1</span>, <span class="php-num">0xAB</span> =&gt; <span class="php-num">1</span>, <span class="php-num">0xAC</span> =&gt; <span class="php-num">1</span>, <span class="php-num">0xAD</span> =&gt; <span class="php-num">1</span>, <span class="php-num">0xAE</span> =&gt; <span class="php-num">1</span>, <span class="php-num">0xAF</span> =&gt; <span class="php-num">1</span>), <span class="php-comment">// \x{2028} to \x{202F}</span>
<a href="#6275" id="6275" class="l">6275: </a>                      <span class="php-num">0x81</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x9F</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{205F}</span>
<a href="#6276" id="6276" class="l">6276: </a>        <span class="php-num">0xE3</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x80</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x80</span> =&gt; <span class="php-num">1</span>), <span class="php-comment">// \x{3000}</span>
<a href="#6277" id="6277" class="l">6277: </a>                      <span class="php-num">0x85</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xA4</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{3164}</span>
<a href="#6278" id="6278" class="l">6278: </a>        <span class="php-num">0xEF</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xBB</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xBF</span> =&gt; <span class="php-num">1</span>), <span class="php-comment">// \x{FEFF}</span>
<a href="#6279" id="6279" class="l">6279: </a>                      <span class="php-num">0xBE</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xA0</span> =&gt; <span class="php-num">1</span>), <span class="php-comment">// \x{FFA0}</span>
<a href="#6280" id="6280" class="l">6280: </a>                      <span class="php-num">0xBF</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xB9</span> =&gt; <span class="php-num">1</span>, <span class="php-num">0xBA</span> =&gt; <span class="php-num">1</span>, <span class="php-num">0xBB</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{FFF9} to \x{FFFB}</span>
<a href="#6281" id="6281" class="l">6281: </a>    );
<a href="#6282" id="6282" class="l">6282: </a>    
<a href="#6283" id="6283" class="l">6283: </a>    <span class="php-var">$hex_chrs_rev</span> = <span class="php-keyword1">array</span>(
<a href="#6284" id="6284" class="l">6284: </a>        <span class="php-num">0x20</span> =&gt; <span class="php-num">1</span>,
<a href="#6285" id="6285" class="l">6285: </a>        <span class="php-num">0x09</span> =&gt; <span class="php-num">1</span>,
<a href="#6286" id="6286" class="l">6286: </a>        <span class="php-num">0x0A</span> =&gt; <span class="php-num">1</span>,
<a href="#6287" id="6287" class="l">6287: </a>        <span class="php-num">0x0D</span> =&gt; <span class="php-num">1</span>,
<a href="#6288" id="6288" class="l">6288: </a>        <span class="php-num">0x0B</span> =&gt; <span class="php-num">1</span>,
<a href="#6289" id="6289" class="l">6289: </a>        <span class="php-num">0xA0</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xC2</span> =&gt; <span class="php-num">1</span>),
<a href="#6290" id="6290" class="l">6290: </a>        <span class="php-num">0xAD</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xC2</span> =&gt; <span class="php-num">1</span>),
<a href="#6291" id="6291" class="l">6291: </a>        <span class="php-num">0xBF</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xC2</span> =&gt; <span class="php-num">1</span>),
<a href="#6292" id="6292" class="l">6292: </a>        <span class="php-num">0x81</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xC2</span> =&gt; <span class="php-num">1</span>),
<a href="#6293" id="6293" class="l">6293: </a>        <span class="php-num">0x8D</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xC2</span> =&gt; <span class="php-num">1</span>),
<a href="#6294" id="6294" class="l">6294: </a>        <span class="php-num">0x90</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xC2</span> =&gt; <span class="php-num">1</span>),
<a href="#6295" id="6295" class="l">6295: </a>        <span class="php-num">0x9D</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xC2</span> =&gt; <span class="php-num">1</span>),
<a href="#6296" id="6296" class="l">6296: </a>        <span class="php-num">0xB8</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xCC</span> =&gt; <span class="php-num">1</span>), <span class="php-comment">// \x{0338}</span>
<a href="#6297" id="6297" class="l">6297: </a>        <span class="php-num">0xB7</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xCC</span> =&gt; <span class="php-num">1</span>), <span class="php-comment">// \x{0337}</span>
<a href="#6298" id="6298" class="l">6298: </a>        <span class="php-num">0xA0</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x85</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xE1</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{1160}</span>
<a href="#6299" id="6299" class="l">6299: </a>        <span class="php-num">0x9F</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x85</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xE1</span> =&gt; <span class="php-num">1</span>), <span class="php-comment">// \x{115F}</span>
<a href="#6300" id="6300" class="l">6300: </a>                      <span class="php-num">0x81</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xE2</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{205F}</span>
<a href="#6301" id="6301" class="l">6301: </a>        <span class="php-num">0x80</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x80</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xE3</span> =&gt; <span class="php-num">1</span>, <span class="php-num">0xE2</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{3000}, \x{2000}</span>
<a href="#6302" id="6302" class="l">6302: </a>        <span class="php-num">0x81</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x80</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xE2</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{2001}</span>
<a href="#6303" id="6303" class="l">6303: </a>        <span class="php-num">0x82</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x80</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xE2</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{2002}</span>
<a href="#6304" id="6304" class="l">6304: </a>        <span class="php-num">0x83</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x80</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xE2</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{2003}</span>
<a href="#6305" id="6305" class="l">6305: </a>        <span class="php-num">0x84</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x80</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xE2</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{2004}</span>
<a href="#6306" id="6306" class="l">6306: </a>        <span class="php-num">0x85</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x80</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xE2</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{2005}</span>
<a href="#6307" id="6307" class="l">6307: </a>        <span class="php-num">0x86</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x80</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xE2</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{2006}</span>
<a href="#6308" id="6308" class="l">6308: </a>        <span class="php-num">0x87</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x80</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xE2</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{2007}</span>
<a href="#6309" id="6309" class="l">6309: </a>        <span class="php-num">0x88</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x80</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xE2</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{2008}</span>
<a href="#6310" id="6310" class="l">6310: </a>        <span class="php-num">0x89</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x80</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xE2</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{2009}</span>
<a href="#6311" id="6311" class="l">6311: </a>        <span class="php-num">0x8A</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x80</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xE2</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{200A}</span>
<a href="#6312" id="6312" class="l">6312: </a>        <span class="php-num">0x8B</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x80</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xE2</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{200B}</span>
<a href="#6313" id="6313" class="l">6313: </a>        <span class="php-num">0xA8</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x80</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xE2</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{2028}</span>
<a href="#6314" id="6314" class="l">6314: </a>        <span class="php-num">0xA9</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x80</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xE2</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{2029}</span>
<a href="#6315" id="6315" class="l">6315: </a>        <span class="php-num">0xAA</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x80</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xE2</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{202A}</span>
<a href="#6316" id="6316" class="l">6316: </a>        <span class="php-num">0xAB</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x80</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xE2</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{202B}</span>
<a href="#6317" id="6317" class="l">6317: </a>        <span class="php-num">0xAC</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x80</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xE2</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{202C}</span>
<a href="#6318" id="6318" class="l">6318: </a>        <span class="php-num">0xAD</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x80</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xE2</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{202D}</span>
<a href="#6319" id="6319" class="l">6319: </a>        <span class="php-num">0xAE</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x80</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xE2</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{202E}</span>
<a href="#6320" id="6320" class="l">6320: </a>        <span class="php-num">0xAF</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x80</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xE2</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{202F}</span>
<a href="#6321" id="6321" class="l">6321: </a>        <span class="php-num">0xA4</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0x85</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xE3</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{3164}</span>
<a href="#6322" id="6322" class="l">6322: </a>        <span class="php-num">0xBF</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xBB</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xEF</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{FEFF}</span>
<a href="#6323" id="6323" class="l">6323: </a>        <span class="php-num">0xA0</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xBE</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xEF</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{FFA0}</span>
<a href="#6324" id="6324" class="l">6324: </a>        <span class="php-num">0xB9</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xBF</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xEF</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{FFF9}</span>
<a href="#6325" id="6325" class="l">6325: </a>        <span class="php-num">0xBA</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xBF</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xEF</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{FFFA}</span>
<a href="#6326" id="6326" class="l">6326: </a>        <span class="php-num">0xBB</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xBF</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-num">0xEF</span> =&gt; <span class="php-num">1</span>)), <span class="php-comment">// \x{FFFB}</span>
<a href="#6327" id="6327" class="l">6327: </a>    );
<a href="#6328" id="6328" class="l">6328: </a>    
<a href="#6329" id="6329" class="l">6329: </a>    <span class="php-comment">// Start from the beginning and work our way in</span>
<a href="#6330" id="6330" class="l">6330: </a>    <span class="php-keyword1">do</span>
<a href="#6331" id="6331" class="l">6331: </a>    {
<a href="#6332" id="6332" class="l">6332: </a>        <span class="php-comment">// Check to see if we have matched a first character in our utf-16 array</span>
<a href="#6333" id="6333" class="l">6333: </a>        <span class="php-var">$offset</span> = match_sequence(<span class="php-var">$string</span>, <span class="php-var">$hex_chrs</span>);
<a href="#6334" id="6334" class="l">6334: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$offset</span>)
<a href="#6335" id="6335" class="l">6335: </a>        {
<a href="#6336" id="6336" class="l">6336: </a>            <span class="php-comment">// If not, then we must have a &quot;good&quot; character and we don't need to do anymore processing</span>
<a href="#6337" id="6337" class="l">6337: </a>            <span class="php-keyword1">break</span>;
<a href="#6338" id="6338" class="l">6338: </a>        }
<a href="#6339" id="6339" class="l">6339: </a>        <span class="php-var">$string</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$string</span>, <span class="php-var">$offset</span>);
<a href="#6340" id="6340" class="l">6340: </a>    }
<a href="#6341" id="6341" class="l">6341: </a>    <span class="php-keyword1">while</span>(++<span class="php-var">$i</span>);
<a href="#6342" id="6342" class="l">6342: </a>    
<a href="#6343" id="6343" class="l">6343: </a>    <span class="php-comment">// Start from the end and work our way in</span>
<a href="#6344" id="6344" class="l">6344: </a>    <span class="php-var">$string</span> = <span class="php-keyword2">strrev</span>(<span class="php-var">$string</span>);
<a href="#6345" id="6345" class="l">6345: </a>    <span class="php-keyword1">do</span>
<a href="#6346" id="6346" class="l">6346: </a>    {
<a href="#6347" id="6347" class="l">6347: </a>        <span class="php-comment">// Check to see if we have matched a first character in our utf-16 array</span>
<a href="#6348" id="6348" class="l">6348: </a>        <span class="php-var">$offset</span> = match_sequence(<span class="php-var">$string</span>, <span class="php-var">$hex_chrs_rev</span>);
<a href="#6349" id="6349" class="l">6349: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$offset</span>)
<a href="#6350" id="6350" class="l">6350: </a>        {
<a href="#6351" id="6351" class="l">6351: </a>            <span class="php-comment">// If not, then we must have a &quot;good&quot; character and we don't need to do anymore processing</span>
<a href="#6352" id="6352" class="l">6352: </a>            <span class="php-keyword1">break</span>;
<a href="#6353" id="6353" class="l">6353: </a>        }
<a href="#6354" id="6354" class="l">6354: </a>        <span class="php-var">$string</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$string</span>, <span class="php-var">$offset</span>);
<a href="#6355" id="6355" class="l">6355: </a>    }
<a href="#6356" id="6356" class="l">6356: </a>    <span class="php-keyword1">while</span>(++<span class="php-var">$i</span>);
<a href="#6357" id="6357" class="l">6357: </a>    <span class="php-var">$string</span> = <span class="php-keyword2">strrev</span>(<span class="php-var">$string</span>);
<a href="#6358" id="6358" class="l">6358: </a>    
<a href="#6359" id="6359" class="l">6359: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$charlist</span> !== <span class="php-keyword1">false</span>)
<a href="#6360" id="6360" class="l">6360: </a>    {
<a href="#6361" id="6361" class="l">6361: </a>        <span class="php-var">$string</span> = <span class="php-keyword2">trim</span>(<span class="php-var">$string</span>, <span class="php-var">$charlist</span>);
<a href="#6362" id="6362" class="l">6362: </a>    }
<a href="#6363" id="6363" class="l">6363: </a>    <span class="php-keyword1">else</span>
<a href="#6364" id="6364" class="l">6364: </a>    {
<a href="#6365" id="6365" class="l">6365: </a>        <span class="php-var">$string</span> = <span class="php-keyword2">trim</span>(<span class="php-var">$string</span>);
<a href="#6366" id="6366" class="l">6366: </a>    }
<a href="#6367" id="6367" class="l">6367: </a>    
<a href="#6368" id="6368" class="l">6368: </a>    <span class="php-keyword1">return</span> <span class="php-var">$string</span>;
<a href="#6369" id="6369" class="l">6369: </a>}
<a href="#6370" id="6370" class="l">6370: </a>
<a href="#6371" id="6371" class="l">6371: </a><span class="php-keyword1">function</span> match_sequence(<span class="php-var">$string</span>, <span class="php-var">$array</span>, <span class="php-var">$i</span>=<span class="php-num">0</span>, <span class="php-var">$n</span>=<span class="php-num">0</span>)
<a href="#6372" id="6372" class="l">6372: </a>{
<a href="#6373" id="6373" class="l">6373: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$string</span> === <span class="php-quote">&quot;&quot;</span>)
<a href="#6374" id="6374" class="l">6374: </a>    {
<a href="#6375" id="6375" class="l">6375: </a>        <span class="php-keyword1">return</span> <span class="php-num">0</span>;
<a href="#6376" id="6376" class="l">6376: </a>    }
<a href="#6377" id="6377" class="l">6377: </a>    
<a href="#6378" id="6378" class="l">6378: </a>    <span class="php-var">$ord</span> = <span class="php-keyword2">ord</span>(<span class="php-var">$string</span>[<span class="php-var">$i</span>]);
<a href="#6379" id="6379" class="l">6379: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">array_key_exists</span>(<span class="php-var">$ord</span>, <span class="php-var">$array</span>))
<a href="#6380" id="6380" class="l">6380: </a>    {
<a href="#6381" id="6381" class="l">6381: </a>        <span class="php-var">$level</span> = <span class="php-var">$array</span>[<span class="php-var">$ord</span>];
<a href="#6382" id="6382" class="l">6382: </a>        ++<span class="php-var">$n</span>;
<a href="#6383" id="6383" class="l">6383: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$level</span>))
<a href="#6384" id="6384" class="l">6384: </a>        {
<a href="#6385" id="6385" class="l">6385: </a>            ++<span class="php-var">$i</span>;
<a href="#6386" id="6386" class="l">6386: </a>            <span class="php-keyword1">return</span> match_sequence(<span class="php-var">$string</span>, <span class="php-var">$level</span>, <span class="php-var">$i</span>, <span class="php-var">$n</span>);
<a href="#6387" id="6387" class="l">6387: </a>        }
<a href="#6388" id="6388" class="l">6388: </a>        <span class="php-keyword1">return</span> <span class="php-var">$n</span>;
<a href="#6389" id="6389" class="l">6389: </a>    }
<a href="#6390" id="6390" class="l">6390: </a>    
<a href="#6391" id="6391" class="l">6391: </a>    <span class="php-keyword1">return</span> <span class="php-num">0</span>;
<a href="#6392" id="6392" class="l">6392: </a>}
<a href="#6393" id="6393" class="l">6393: </a>
<a href="#6394" id="6394" class="l">6394: </a><span class="php-comment">/**
</span><a href="#6395" id="6395" class="l">6395: </a><span class="php-comment"> * Obtain the version of GD installed.
</span><a href="#6396" id="6396" class="l">6396: </a><span class="php-comment"> *
</span><a href="#6397" id="6397" class="l">6397: </a><span class="php-comment"> * @return float Version of GD
</span><a href="#6398" id="6398" class="l">6398: </a><span class="php-comment"> */</span>
<a href="#6399" id="6399" class="l">6399: </a><span class="php-keyword1">function</span> gd_version()
<a href="#6400" id="6400" class="l">6400: </a>{
<a href="#6401" id="6401" class="l">6401: </a>    <span class="php-keyword1">static</span> <span class="php-var">$gd_version</span>;
<a href="#6402" id="6402" class="l">6402: </a>    
<a href="#6403" id="6403" class="l">6403: </a>    <span class="php-keyword1">if</span>(<span class="php-var">$gd_version</span>)
<a href="#6404" id="6404" class="l">6404: </a>    {
<a href="#6405" id="6405" class="l">6405: </a>        <span class="php-keyword1">return</span> <span class="php-var">$gd_version</span>;
<a href="#6406" id="6406" class="l">6406: </a>    }
<a href="#6407" id="6407" class="l">6407: </a>    <span class="php-keyword1">if</span>(!<span class="php-keyword2">extension_loaded</span>(<span class="php-quote">'gd'</span>))
<a href="#6408" id="6408" class="l">6408: </a>    {
<a href="#6409" id="6409" class="l">6409: </a>        <span class="php-keyword1">return</span>;
<a href="#6410" id="6410" class="l">6410: </a>    }
<a href="#6411" id="6411" class="l">6411: </a>    
<a href="#6412" id="6412" class="l">6412: </a>    <span class="php-keyword1">if</span>(<span class="php-keyword2">function_exists</span>(<span class="php-quote">&quot;gd_info&quot;</span>))
<a href="#6413" id="6413" class="l">6413: </a>    {
<a href="#6414" id="6414" class="l">6414: </a>        <span class="php-var">$gd_info</span> = <span class="php-keyword2">gd_info</span>();
<a href="#6415" id="6415" class="l">6415: </a>        <span class="php-keyword2">preg_match</span>(<span class="php-quote">'/\d/'</span>, <span class="php-var">$gd_info</span>[<span class="php-quote">'GD Version'</span>], <span class="php-var">$gd</span>);
<a href="#6416" id="6416" class="l">6416: </a>        <span class="php-var">$gd_version</span> = <span class="php-var">$gd</span>[<span class="php-num">0</span>];
<a href="#6417" id="6417" class="l">6417: </a>    }
<a href="#6418" id="6418" class="l">6418: </a>    <span class="php-keyword1">else</span>
<a href="#6419" id="6419" class="l">6419: </a>    {
<a href="#6420" id="6420" class="l">6420: </a>        <span class="php-keyword2">ob_start</span>();
<a href="#6421" id="6421" class="l">6421: </a>        <span class="php-keyword2">phpinfo</span>(<span class="php-num">8</span>);
<a href="#6422" id="6422" class="l">6422: </a>        <span class="php-var">$info</span> = <span class="php-keyword2">ob_get_contents</span>();
<a href="#6423" id="6423" class="l">6423: </a>        <span class="php-keyword2">ob_end_clean</span>();
<a href="#6424" id="6424" class="l">6424: </a>        <span class="php-var">$info</span> = <span class="php-keyword2">stristr</span>(<span class="php-var">$info</span>, <span class="php-quote">'gd version'</span>);
<a href="#6425" id="6425" class="l">6425: </a>        <span class="php-keyword2">preg_match</span>(<span class="php-quote">'/\d/'</span>, <span class="php-var">$info</span>, <span class="php-var">$gd</span>);
<a href="#6426" id="6426" class="l">6426: </a>        <span class="php-var">$gd_version</span> = <span class="php-var">$gd</span>[<span class="php-num">0</span>];
<a href="#6427" id="6427" class="l">6427: </a>    }
<a href="#6428" id="6428" class="l">6428: </a>    
<a href="#6429" id="6429" class="l">6429: </a>    <span class="php-keyword1">return</span> <span class="php-var">$gd_version</span>;
<a href="#6430" id="6430" class="l">6430: </a>}
<a href="#6431" id="6431" class="l">6431: </a>
<a href="#6432" id="6432" class="l">6432: </a><span class="xlang">?&gt;</span></code></pre>

	<div id="footer">
		 API documentation generated by <a href="http://apigen.org">ApiGen 2.6.1</a>
	</div>
</div>
</div>
</body>
</html>
